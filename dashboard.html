<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dashboard | OneOrigin Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="api-config.js"></script>
    <script type="module" src="shared-storage.js"></script>
    <script type="module" src="firestore-db.js"></script>
    <style>
        :root {
    --sidebar-collapsed: 75px;
    --sidebar-expanded: 240px;
    /* Official Google Gemini Primary Blue */
    --primary-blue: #4285F4; 
    /* Gemini Dark Mode Background (Material Grey) */
    --bg-dark: #131314; 
    --card-bg: #1e1f20;
    --border-color: #30363d;
    --header-height: 100px;
    /* High-emphasis text for Dark Mode (87% opacity white) */
    --text-main: #e3e3e3; 
    /* Medium-emphasis text for Dark Mode (60% opacity white) */
    --text-secondary: #b4b4b4; 
    --transition-speed: 0.5s;
/* Card size management */
#assignedCourseGrid .course-card {
    max-height: 450px; /* Limits the overall height of the card */
    overflow: hidden;
}

.definition-scroll-container {
    max-height: 120px; /* Height of about 5-6 lines */
    overflow-y: auto;
    padding-right: 10px;
    margin-bottom: 15px;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-blue) transparent;
}

/* Custom scrollbar for Chrome/Safari */
.definition-scroll-container::-webkit-scrollbar {
    width: 4px;
}
.definition-scroll-container::-webkit-scrollbar-thumb {
    background-color: var(--primary-blue);
    border-radius: 10px;
}

	/* Fix for My Assigned Courses Layout */
.loader {
    border: 4px solid var(--border-color);
    border-top: 4px solid var(--primary-blue);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Professional Row Layout for My Assigned Courses */
#assignedCourseGrid .course-card {
    display: flex;
    flex-direction: row;
    align-items: center; /* Vertically centers the 25% thumbnail */
    padding: 30px;
    gap: 35px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-left: 5px solid var(--primary-blue);
    margin-bottom: 25px;
    transition: transform 0.2s ease;
}

#assignedCourseGrid .course-card:hover {
    border-color: var(--primary-blue);
}

/* Thumbnail Constraint (25%) */
#assignedCourseGrid .thumbnail-wrapper {
    width: 25%;
    flex-shrink: 0;
}

#assignedCourseGrid .video-thumb-container {
    width: 100%;
    aspect-ratio: 16/9;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    position: relative;
}

/* Typography & Content Block */
#assignedCourseGrid .course-info {
    flex: 1;
}

#assignedCourseGrid .course-info h3 {
    font-size: 26px !important;
    margin: 0 0 20px 0;
    color: var(--primary-blue);
}

.definition-block {
    margin-bottom: 20px;
}

.definition-label {
    font-size: 12px !important;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--primary-blue);
    font-weight: 800 !important;
    display: block;
    margin-bottom: 8px;
    opacity: 0.9;
}

.definition-content {
    font-size: 16px !important;
    line-height: 1.7; /* Better readability for long text */
    color: var(--text-main);
    margin: 0;
    font-weight: 400 !important; /* Lighter weight for the body text */
}

#assignedCourseGrid .btn-primary {
    width: fit-content !important;
    margin: 15px 0 0 0 !important;
    padding: 12px 30px !important;
    font-size: 16px !important;
}
/* Mobile Responsiveness */
@media (max-width: 768px) {
    #assignedCourseGrid .course-card {
        flex-direction: column;
    }
    #assignedCourseGrid .thumbnail-wrapper {
        width: 100%;
    }
}
    /* Courses listing: three stacked type sections, each with its own grid */
#dynamicCourseGrid {
    display: flex;
    flex-direction: column;
    gap: 28px;
    width: 100%;
}

.course-section h3 { margin: 20px 0 10px 0; color: var(--primary-blue); font-size: 18px; cursor: default; pointer-events: none; user-select: none; }
#beginner-courses, #intermediate-courses, #advanced-courses {
    border: 1px solid var(--border-color);
    padding: 20px 24px;
    margin-bottom: 30px;
    border-radius: 10px;
    box-sizing: border-box;
}
.course-type-section { background: transparent; border: 0; padding: 6px 0; }
.course-type-section h3 { margin: 0 0 12px 0; color: var(--primary-blue); font-size: 18px; }
/* Thin divider between course type sections */
.course-type-section + .course-type-section { border-top: 1px solid var(--border-color); padding-top: 18px; margin-top: 12px; }
.type-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; padding: 8px 4px; box-sizing: border-box; }
.type-grid .course-card { border: 1px solid var(--border-color); padding: 10px; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; height: 100%; width: 100%; box-sizing: border-box; }
.type-grid .course-card:hover { transform: translateY(-8px); box-shadow: 0 10px 18px rgba(0,0,0,0.18); border-color: var(--primary-blue); }

/* In-app player overlay */
.course-player-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
    backdrop-filter: blur(4px);
}

.course-player-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    width: 75vw;
    max-width: 1400px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.35);
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.course-player-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--text-main);
    font-weight: 600;
}

.course-player-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 20px;
    cursor: pointer;
    transition: color 0.2s ease, transform 0.2s ease;
}

.course-player-close:hover { color: #f85149; transform: scale(1.1); }

.course-player-frame {
    position: relative;
    height: 75vh;
    border-radius: 10px;
    overflow: hidden;
    background: #000;
    border: 1px solid var(--border-color);
}

.course-player-frame iframe {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border: 0;
}

.course-player-play {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.65);
    color: #fff;
    border: 2px solid #fff;
    border-radius: 50%;
    width: 68px; height: 68px;
    font-size: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    z-index: 2;
}

.course-player-play:hover {
    transform: translate(-50%, -50%) scale(1.07);
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    background: rgba(0,0,0,0.8);
}

/* Measure & Master Styles */
.quiz-option {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-main);
}

.quiz-option:hover {
    border-color: var(--primary-blue);
    background: rgba(66, 133, 244, 0.1);
}

.quiz-option.selected {
    border-color: var(--primary-blue);
    background: rgba(66, 133, 244, 0.2);
}

.assigned-course-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 15px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
}

.assigned-course-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

.course-thumbnail-wrapper {
    position: relative;
    margin-bottom: 15px;
}

.course-thumbnail-wrapper img {
    width: 100%;
    border-radius: 8px;
    cursor: pointer;
}

.course-definition {
    background: rgba(66, 133, 244, 0.05);
    padding: 12px;
    border-radius: 6px;
    margin-top: 10px;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.6;
}

.course-uses {
    margin-top: 8px;
    padding: 10px;
    background: rgba(76, 175, 80, 0.05);
    border-radius: 6px;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.6;
}

@media (max-width: 1200px) {
    .type-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 600px) {
    .type-grid { grid-template-columns: 1fr; }
}
	.admin-table th:last-child, .admin-table td:last-child { text-align: center; width: 80px; }
	.btn-delete { background: none; border: none; cursor: pointer; font-size: 18px; color: #f85149; transition: transform 0.2s, opacity 0.2s; display: inline-block; line-height: 1; }
	.btn-delete:hover { transform: scale(1.2); opacity: 0.8; }
	#timeGreeting { font-size: 22px !important; font-style: italic; color: var(--primary-blue); margin: 0; font-weight: 500; }
	#admin-view, #course-mgmt-view, #log-view { display: flex; flex-direction: column; align-items: flex-start !important; text-align: left !important; width: 100%; }
	#leaderboard-view { display: flex; flex-direction: column; align-items: flex-start !important; text-align: left !important; width: 100%; padding: 0; }
	#course-mgmt-view, #admin-view, #log-view { display: flex; flex-direction: column; align-items: flex-start !important; text-align: left !important; }
	#settings-view { display: flex; flex-direction: column; align-items: flex-start; text-align: left; width: 100%; }
	#news-container, #announcements-container { max-height: 500px; overflow-y: auto; padding-right: 12px; scrollbar-width: thin; }
	.news-item, .announcement-item {font-size: 14px; margin-bottom: 15px; padding: 10px; border-radius: 8px; border-bottom: 1px solid var(--border-color); transition: background 0.2s; }
	.news-item:hover, .announcement-item:hover {background: rgba(66, 133, 244, 0.05); /* Subtle blue glow on hover */}

/* Player View Specifics */
#player-view { max-width: 1000px; margin: 0 auto; }
.video-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
#playerTitle { color: var(--primary-blue); margin: 0; }
.video-container { position: relative; background: #000; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); }
.video-placeholder { padding-bottom: 56.25%; position: relative; }
#playerContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

#startOverlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 10;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}

	/* Layout for Home View Blocks */
.home-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 25px;
}

.home-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    min-height: 350px;
}

.home-card h2 {
    color: var(--primary-blue);
    font-size: 20px;
    margin-top: 0;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* About the Hub cards (Home) */
.home-about {
    margin-top: 14px;
}

/* My Progress (employee) */
.progress-wrap {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 18px;
    width: 100%;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid var(--border-color);
    background: rgba(255,255,255,0.03);
    color: var(--text-main);
    white-space: nowrap;
}

.status-badge.good {
    border-color: rgba(76,175,80,0.55);
    background: rgba(76,175,80,0.12);
}

.status-badge.warn {
    border-color: rgba(240,173,78,0.6);
    background: rgba(240,173,78,0.14);
}

.status-badge.bad {
    border-color: rgba(248,81,73,0.6);
    background: rgba(248,81,73,0.12);
}

/* Course assessment overlay */
.assessment-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 4200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 22px;
}

.assessment-modal {
    width: 100%;
    max-width: 880px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 14px;
    overflow: hidden;
}

.assessment-modal-head {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border-color);
}

.assessment-modal-title {
    display:flex;
    flex-direction: column;
    gap: 2px;
}

.assessment-modal-title b {
    color: var(--text-main);
    font-size: 14px;
}

.assessment-modal-title span {
    color: var(--text-secondary);
    font-size: 12px;
}

.assessment-modal-body {
    padding: 16px;
}

.home-about-head {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
    gap: 8px;
}

.home-about-title {
    margin: 0;
    color: var(--primary-blue);
    font-size: 18px;
}

.home-about-hero {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 14px;
    padding: 18px;
}

.home-about-subtitle {
    margin: 0;
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.5;
    max-width: 980px;
}

.home-about-subcopy {
    margin: 0;
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.55;
    max-width: 980px;
}

.home-about-bullets {
    margin: 6px 0 0 0;
    padding-left: 18px;
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.55;
    max-width: 980px;
}

.home-about-bullets li {
    margin: 6px 0;
}

.home-about-highlights {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 12px;
}

.home-about-pill {
    border: 1px solid var(--border-color);
    background: rgba(255,255,255,0.03);
    border-radius: 999px;
    padding: 8px 12px;
    font-size: 12px;
    color: var(--text-main);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.home-about-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 16px;
    margin-top: 14px;
}

@media (max-width: 1200px) {
    .home-about-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}

@media (max-width: 700px) {
    .home-about-grid { grid-template-columns: 1fr; }
}

.home-about-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    min-height: 360px;
    transition: transform 0.14s ease, box-shadow 0.14s ease, border-color 0.14s ease;
    position: relative;
    overflow: hidden;
}

/* Attractive color fills per tile (subtle gradient overlay, keeps text readable) */
.home-about-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 20% 15%, rgba(255,255,255,0.10), rgba(0,0,0,0) 55%),
                linear-gradient(135deg, rgba(66,133,244,0.10), rgba(0,0,0,0));
    opacity: 1;
    pointer-events: none;
}
.home-about-card > * { position: relative; z-index: 1; }

.home-about-grid .home-about-card:nth-child(1)::before {
    background: radial-gradient(circle at 18% 18%, rgba(88,166,255,0.22), rgba(0,0,0,0) 55%),
                linear-gradient(135deg, rgba(88,166,255,0.14), rgba(124,58,237,0.08));
}
.home-about-grid .home-about-card:nth-child(2)::before {
    background: radial-gradient(circle at 18% 18%, rgba(76,175,80,0.20), rgba(0,0,0,0) 55%),
                linear-gradient(135deg, rgba(76,175,80,0.12), rgba(32,20,90,0.08));
}
.home-about-grid .home-about-card:nth-child(3)::before {
    background: radial-gradient(circle at 18% 18%, rgba(255,124,229,0.18), rgba(0,0,0,0) 55%),
                linear-gradient(135deg, rgba(255,124,229,0.10), rgba(108,75,255,0.10));
}
.home-about-grid .home-about-card:nth-child(4)::before {
    background: radial-gradient(circle at 18% 18%, rgba(240,173,78,0.22), rgba(0,0,0,0) 55%),
                linear-gradient(135deg, rgba(240,173,78,0.12), rgba(66,133,244,0.06));
}
.home-about-grid .home-about-card:nth-child(5)::before {
    background: radial-gradient(circle at 18% 18%, rgba(248,81,73,0.18), rgba(0,0,0,0) 55%),
                linear-gradient(135deg, rgba(248,81,73,0.10), rgba(124,58,237,0.08));
}
.home-about-grid .home-about-card:nth-child(6)::before {
    background: radial-gradient(circle at 18% 18%, rgba(0,212,255,0.18), rgba(0,0,0,0) 55%),
                linear-gradient(135deg, rgba(0,212,255,0.10), rgba(32,20,90,0.10));
}
.home-about-grid .home-about-card:nth-child(7)::before {
    background: radial-gradient(circle at 18% 18%, rgba(170,255,0,0.16), rgba(0,0,0,0) 55%),
                linear-gradient(135deg, rgba(170,255,0,0.08), rgba(66,133,244,0.08));
}
.home-about-grid .home-about-card:nth-child(8)::before {
    background: radial-gradient(circle at 18% 18%, rgba(156,163,175,0.20), rgba(0,0,0,0) 55%),
                linear-gradient(135deg, rgba(156,163,175,0.10), rgba(108,75,255,0.06));
}

.home-about-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 14px 30px rgba(0,0,0,0.22);
    border-color: rgba(66,133,244,0.55);
}

.home-about-card h3 {
    margin: 0 0 8px 0;
    color: var(--text-main);
    font-size: 15px;
}

.home-about-card p {
    margin: 0 0 12px 0;
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.6;
}

.home-about-kicker {
    margin: 0 0 6px 0;
    font-size: 12px;
    color: var(--text-main);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    opacity: 0.9;
}

.home-about-list {
    margin: 0 0 12px 18px;
    padding: 0;
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.7;
}

.home-about-list li {
    margin: 4px 0;
}

.home-about-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: auto;
    padding-top: 12px;
}

.home-card {
    transition: transform 0.14s ease, box-shadow 0.14s ease, border-color 0.14s ease;
}
.home-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 14px 30px rgba(0,0,0,0.20);
    border-color: rgba(66,133,244,0.45);
}

.news-item, .announcement-item {
    font-size: 14px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.item-date {
    font-size: 11px;
    color: var(--text-secondary);
    display: block;
}
}

body.light-theme { --bg-dark: #f0f4f9; --card-bg: #ffffff; --border-color: #dee1e5; --text-main: #1f1f1f; --text-secondary: #444746; --primary-blue: #0b57d0; --sidebar-active-bg: #f1f3f4; }
        * { font-weight: 700 !important; }
        body { font-family: 'Calibri', 'Candara', 'Segoe UI', 'Optima', Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: all 0.3s; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .dashboard-header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 0 32px; height: var(--header-height); background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); z-index: 2000; flex-shrink: 0; }
        .header-left img { height: 65px; width: auto; object-fit: contain; }
	.hub-title { font-size: 36px !important; color: var(--primary-blue); display: flex; gap: 2px; font-family: 'Calibri', sans-serif; font-weight: 800; letter-spacing: -0.5px; margin: 0; }
	.hub-subtitle { color: var(--text-secondary); font-size: 14px; font-family: 'Calibri', sans-serif; font-weight: 400; opacity: 0.8; margin-top: -2px; text-align: center; }
	.hub-title span { display: inline-block; transform: none !important; }
	@keyframes gentleBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .header-right { display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
        .user-badge {background: #21262d; padding: 8px 18px; border-radius: 20px; border: 1px solid var(--border-color); font-size: 14px;color: var(--text-main) !important; /* Forces light text in dark mode */display: flex;align-items: center; justify-content: center;}
/* Override for Light Theme */
body.light-theme .user-badge { 
    background: #ebf2ff; 
    border: 1px solid #d0d7de; 
    color: #24292f !important; /* Forces dark text in light mode */
}
        .btn-primary, .btn-logout, .btn-add { background: transparent !important; color: #4285F4 !important; border: 1px solid #4285F4 !important; padding: 10px 20px; border-radius: 8px; font-weight: 700 !important; cursor: pointer; transition: all 0.2s ease; box-shadow: none !important; text-shadow: none !important; display: flex; align-items: center; justify-content: center; }
        .btn-primary { width: calc(25% - 40px); margin: 25px auto 0 auto; display: block; padding: 15px; font-size: 16px; background: transparent !important; color: #4285F4 !important; border: 1px solid #4285F4 !important; border-radius: 8px; box-shadow: none !important; cursor: pointer; text-align: center; }
        .btn-logout { background: transparent !important; color: #4285F4 !important; border: 1px solid #4285F4 !important; padding: 8px 16px; border-radius: 8px; box-shadow: none !important; }
        /* Subtle hover lift for all buttons and clickable items */
        button, .btn-primary, .btn-logout, .btn-add, .sidebar-item, .toggle-btn {
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        button:hover, .btn-primary:hover, .btn-logout:hover, .btn-add:hover, .sidebar-item:hover, .toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.18);
        }
        .app-body { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: var(--sidebar-collapsed); background-color: var(--card-bg); border-right: 1px solid var(--border-color); transition: width var(--transition-speed) cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; flex-direction: column; box-shadow: none !important; }
        .sidebar.expanded { width: var(--sidebar-expanded); }
        .toggle-container { padding: 20px; text-align: center; }
        .toggle-btn { cursor: pointer; color: var(--primary-blue); font-size: 22px; background: rgba(88, 166, 255, 0.1); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; }
        .sidebar.expanded .toggle-btn { transform: rotate(180deg); }
        .sidebar-nav { flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 8px; }
        .sidebar-footer { border-top: 1px solid var(--border-color); padding: 15px 10px; display: flex; flex-direction: column; gap: 8px; }
        .sidebar-item { display: flex; align-items: center; padding: 12px 15px; color: var(--text-secondary); text-decoration: none; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; white-space: nowrap; border: 1px solid transparent; box-shadow: none !important; position: relative; }
        .sidebar-item:hover { background: rgba(255, 255, 255, 0.04) !important; color: #4285F4 !important; transform: translateX(5px); box-shadow: none !important; }
	.sidebar-item.active { background: #1e1f20 !important; color: #4285F4 !important; border: 1px solid #4285F4 !important; box-shadow: none !important; border-radius: 8px; }
	body.light-theme .sidebar-item.active { background: #f1f3f4 !important; color: #0b57d0 !important; border: 1px solid #0b57d0 !important; }
        .sidebar-text { margin-left: 15px; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .sidebar.expanded .sidebar-text { opacity: 1; }

        /* Sidebar tooltip when collapsed */
        .sidebar:not(.expanded) .sidebar-item[data-tooltip]::after,
        .sidebar:not(.expanded) .sidebar-item[data-tooltip]::before {
            opacity: 0;
            transform: translateY(-50%) translateX(-4px);
            transition: opacity 0.12s ease, transform 0.12s ease;
            pointer-events: none;
        }
        .sidebar:not(.expanded) .sidebar-item[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: calc(100% + 10px);
            top: 50%;
            transform: translateY(-50%) translateX(0);
            opacity: 1;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 8px 10px;
            border-radius: 10px;
            white-space: nowrap;
            z-index: 3000;
            box-shadow: 0 14px 30px rgba(0,0,0,0.35);
        }
        .sidebar:not(.expanded) .sidebar-item[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            left: calc(100% + 4px);
            top: 50%;
            transform: translateY(-50%);
            opacity: 1;
            width: 0;
            height: 0;
            border-top: 7px solid transparent;
            border-bottom: 7px solid transparent;
            border-right: 7px solid var(--border-color);
            z-index: 2999;
        }

        .sidebar-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 18px;
            min-width: 18px;
            padding: 0 6px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 900 !important;
            line-height: 18px;
            color: #fff;
            background: #f85149;
            border: 1px solid rgba(0,0,0,0.25);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        body.light-theme .sidebar-badge { border-color: rgba(0,0,0,0.15); }

        #talkspace-view { padding: 0; }
        .talkspace-embed {
            width: 100%;
            height: calc(100vh - var(--header-height) - 80px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-dark);
        }
        .talkspace-embed iframe { width: 100%; height: 100%; border: 0; background: transparent; }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; width: 100%; }
        .course-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; margin-bottom: 15px; padding-bottom: 15px; height: 100%; }
        .course-card h3 { font-size: 18px; margin: 15px 15px 5px 15px; text-align: left; color: var(--primary-blue); }

        /* Hub Bot refreshed styles */
        .hub-bot-shell { background: linear-gradient(135deg, rgba(88, 71, 195, 0.7), rgba(32, 20, 90, 0.8)), radial-gradient(circle at 20% 20%, rgba(255,255,255,0.06), rgba(0,0,0,0)); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; padding: 22px; max-width: 980px; margin: 0 auto; box-shadow: 0 18px 36px rgba(0,0,0,0.3); backdrop-filter: blur(6px); }
        .hub-bot-hero { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; margin-bottom:14px; }
        .hub-bot-meta { display:flex; align-items:center; gap:12px; }
        .hub-bot-avatar { width:52px; height:52px; border-radius:14px; background: linear-gradient(135deg, #ff7ce5, #6c4bff); display:flex; align-items:center; justify-content:center; font-size:26px; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
        .hub-bot-title { color:#fff; font-weight:800; font-size:22px; letter-spacing:0.2px; }
        .hub-bot-sub { color: rgba(255,255,255,0.72); font-size:13px; }
        .hub-bot-status { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
        .pill { padding:8px 12px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid rgba(255,255,255,0.18); color:#fff; backdrop-filter: blur(4px); }
        .pill.live { background: rgba(76, 175, 80, 0.16); border-color: rgba(76,175,80,0.35); }
        .pill.alt { background: rgba(255,255,255,0.06); }
        .ghost { background: rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.18); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
        .ghost:hover { background: rgba(255,255,255,0.16); }
        .hub-bot-prompts { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 14px 0; }
        .prompt-chip { background: rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.16); border-radius:12px; padding:8px 12px; font-size:12px; cursor:pointer; transition: transform 0.12s ease, box-shadow 0.12s ease; }
        .prompt-chip:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,0.2); }
        .hub-bot-messages { background: rgba(10,12,20,0.55); border:1px solid rgba(255,255,255,0.1); border-radius:14px; padding:12px; min-height:320px; max-height:520px; overflow-y:auto; color:#e9ecf5; box-shadow: inset 0 1px 0 rgba(255,255,255,0.03); }
        .hub-bot-input { display:flex; gap:10px; margin-top:12px; background: rgba(0,0,0,0.38); border:1px solid rgba(255,255,255,0.12); border-radius:12px; padding:8px; align-items:center; }
        .hub-bot-input input { flex:1; padding:12px; background: transparent; border:none; color:#fff; outline:none; font-size:14px; }
        .hub-bot-input button { background:#6c4bff; color:white; border:none; padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:800; box-shadow: 0 10px 20px rgba(108,75,255,0.35); }
        .hub-bot-input button:hover { transform: translateY(-1px); }
        .topic-summary { padding: 0 20px; font-size: 14px; line-height: 1.6; color: var(--text-secondary); flex-grow: 1; }
        .topic-summary b { color: var(--text-main); display: block; margin-top: 12px; font-size: 13px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 8px; }
        .caution-box { margin-top: 15px; padding: 10px; border-radius: 6px; background: rgba(248, 81, 73, 0.1); border-left: 3px solid #f85149; font-size: 13px; color: #f85149; }
        .assessment-wrapper { background: var(--card-bg); border: 1px solid var(--border-color); padding: 30px; border-radius: 12px; max-width: 900px; margin: 0 auto; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--card-bg); }
        .admin-table th, .admin-table td { text-align: left; padding: 15px; border-bottom: 1px solid var(--border-color); }

        /* ====== Added: Quick learning (Shorts-style feed) ====== */
        .quick-learning-feed {
            max-width: 430px;
            margin: 0 auto;
            height: calc(100vh - var(--header-height) - 210px);
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            padding-right: 6px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .quick-learning-item {
            scroll-snap-align: start;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 18px 36px rgba(0,0,0,0.25);
        }
        .quick-learning-video {
            position: relative;
            width: 100%;
            aspect-ratio: 9 / 16;
            background: #000;
        }
        .quick-learning-video iframe {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .quick-learning-meta { padding: 12px 14px; }
        .quick-learning-title {
            color: var(--text-main);
            font-weight: 900;
            font-size: 13px;
            line-height: 1.3;
            margin-bottom: 6px;
        }
        .quick-learning-sub {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .quick-learning-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            flex-wrap: wrap;
        }

        .quick-learning-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.86);
            z-index: 5200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 18px;
        }
        .quick-learning-modal {
            width: min(480px, 96vw);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.55);
        }
        .quick-learning-modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-color);
        }
        .quick-learning-modal-title {
            display:flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }
        .quick-learning-modal-title b {
            color: var(--text-main);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .quick-learning-modal-title span {
            color: var(--text-secondary);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .quick-learning-viewport {
            position: relative;
            width: 100%;
            aspect-ratio: 9 / 16;
            background: #000;
        }
        .quick-learning-viewport iframe {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .quick-learning-embed-notice {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            text-align: center;
            color: var(--text-main);
            background: rgba(0,0,0,0.78);
            border-top: 1px solid rgba(255,255,255,0.06);
            font-size: 13px;
            line-height: 1.5;
        }
        .quick-learning-modal-actions {
            display:flex;
            gap: 10px;
            justify-content: space-between;
            padding: 12px 14px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }
        .quick-learning-nav {
            display:flex;
            gap: 10px;
        }
        .video-player-container { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); position: relative; box-sizing: border-box; max-width: 1100px; margin: 0 auto; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; }
        #playerContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* ====== Added: Similar Videos UI (keeps same font sizes & theme) ====== */
        .similar-section {
            margin-top: 14px;
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
        }
        .similar-title {
            font-size: 13px;
            color: var(--text-main);
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 0.3px;
        }
        .similar-list {
            max-height: 220px;
            overflow-y: auto;
            padding-right: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .similar-item {
            display: flex;
            gap: 12px;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.02);
        }
        .similar-thumb {
            width: 110px;
            height: 62px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: #000;
        }
        .similar-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .similar-meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 0;
            flex: 1;
        }
        .similar-meta .t {
            font-size: 13px;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .similar-meta .s {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .btn-secondary {
            background: transparent;
            color: var(--primary-blue);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        /* ====== Added: Showcase Forum (matches dashboard aesthetic) ====== */
        /* Showcase should feel like a full page (not a centered card) */
        /* Harden: Showcase must always be full-width */
        #showcase-view { width: 100%; }
        #showcase-view > .showcase-shell { width: 100% !important; max-width: none !important; margin: 0 !important; }
        .showcase-shell { width: 100%; max-width: none; margin: 0; }
        .showcase-hero { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; margin-bottom:14px; }
        .showcase-hero-left { display:flex; align-items:center; gap:12px; }
        .showcase-icon { width:52px; height:52px; border-radius:14px; background: linear-gradient(135deg, #00d2ff, #6c4bff); display:flex; align-items:center; justify-content:center; font-size:26px; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
        .showcase-title { color:#fff; font-weight:800; font-size:22px; letter-spacing:0.2px; }
        body.light-theme .showcase-title { color: var(--text-main); }
        .showcase-sub { color: rgba(255,255,255,0.72); font-size:13px; }
        body.light-theme .showcase-sub { color: var(--text-secondary); }
        .showcase-actions { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

        .sc-panel { background: rgba(10,12,20,0.55); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; padding: 14px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.03); }
        body.light-theme .sc-panel { background: rgba(255,255,255,0.7); border: 1px solid var(--border-color); }
        .sc-controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
        .sc-search { flex:1; min-width:260px; display:flex; gap:10px; align-items:center; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 10px 12px; }
        body.light-theme .sc-search { background: rgba(0,0,0,0.02); border: 1px solid var(--border-color); }
        .sc-search input { width:100%; border:none; background:transparent; color: var(--text-main); outline:none; font-size:14px; }
        .sc-sort { display:flex; gap:10px; align-items:center; border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 10px 12px; background: rgba(255,255,255,0.06); }
        body.light-theme .sc-sort { background: rgba(0,0,0,0.02); border: 1px solid var(--border-color); }
        .sc-sort label { display:flex; gap:6px; align-items:center; color: rgba(255,255,255,0.75); font-weight:800; font-size:12px; cursor:pointer; }
        body.light-theme .sc-sort label { color: var(--text-secondary); }

        .sc-tagbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
        .sc-chip { background: rgba(255,255,255,0.08); color:#fff; border: 1px solid rgba(255,255,255,0.16); border-radius: 999px; padding: 8px 12px; font-size:12px; cursor:pointer; transition: transform 0.12s ease, box-shadow 0.12s ease; }
        body.light-theme .sc-chip { background: rgba(0,0,0,0.03); color: var(--text-main); border: 1px solid var(--border-color); }
        .sc-chip.active { border-color: rgba(66,133,244,0.8); box-shadow: 0 10px 20px rgba(66,133,244,0.12); }
        /* Showcase grid: 5 per row (like Courses), responsive */
        .sc-grid { display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 14px; }
        @media (max-width: 1400px) { .sc-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        @media (max-width: 1100px) { .sc-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (max-width: 820px) { .sc-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (max-width: 520px) { .sc-grid { grid-template-columns: 1fr; } }
        /* Showcase cards: match Courses grid card sizing */
        .sc-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; padding: 10px; cursor:pointer; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.2s ease; height: 100%; width: 100%; box-sizing: border-box; }
        body.light-theme .sc-card { background: #fff; border: 1px solid var(--border-color); }
        .sc-card:hover { transform: translateY(-8px); border-color: var(--primary-blue); box-shadow: 0 10px 18px rgba(0,0,0,0.18); }

        .sc-card-thumb { width: 100%; aspect-ratio: 16/9; border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.06); margin-bottom: 10px; display:block; }
        body.light-theme .sc-card-thumb { background: rgba(0,0,0,0.04); }
        .sc-card-thumb img { width: 100%; height: 100%; object-fit: cover; display:block; }
        .sc-card-thumb.sc-thumb-fallback { display:flex; align-items:center; justify-content:center; color: rgba(255,255,255,0.85); font-weight: 900; letter-spacing: 0.06em; }
        body.light-theme .sc-card-thumb.sc-thumb-fallback { color: var(--text-main); }

        .sc-card-title { margin:10px 0 5px 0; text-align:center; color: var(--text-main); font-weight: 700; font-size: 14px; }
        .sc-card-sub { color: var(--text-secondary); text-align:center; display:block; font-size: 12px; }
        .sc-card-hook { margin-top:8px; color: var(--text-secondary); font-size:12px; line-height:1.35; text-align:center; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .sc-card-meta { margin-top: 12px; display:flex; justify-content:center; align-items:center; gap:10px; }
        .sc-counts { display:flex; gap:10px; align-items:center; color: var(--text-secondary); font-size:12px; }

        .sc-form { display:grid; gap:12px; margin-top:10px; }
        .sc-field { display:flex; flex-direction:column; gap:6px; }
        .sc-field label { font-size: 12px; font-weight: 900; color: rgba(255,255,255,0.72); text-transform: uppercase; letter-spacing: 0.08em; }
        body.light-theme .sc-field label { color: var(--text-secondary); }
        .sc-field input, .sc-field textarea {
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06);
            color: #fff;
            border-radius: 12px;
            padding: 10px 12px;
            outline: none;
            font-size: 14px;
        }
        body.light-theme .sc-field input, body.light-theme .sc-field textarea { background: rgba(0,0,0,0.02); color: var(--text-main); border: 1px solid var(--border-color); }
        .sc-field textarea { min-height: 120px; resize: vertical; line-height: 1.45; }

        .sc-wizard-actions { display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
        .sc-dots { display:flex; gap:6px; align-items:center; }
        .sc-dot { width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,0.15); }
        .sc-dot.active { background: var(--primary-blue); }

        .sc-hero-media { width:100%; border-radius: 14px; border: 1px solid rgba(255,255,255,0.12); overflow:hidden; background:#000; max-height: 420px; object-fit: cover; }
        body.light-theme .sc-hero-media { border: 1px solid var(--border-color); }
        .sc-link { color: var(--primary-blue); text-decoration: none; font-weight: 900; }
        .sc-link:hover { text-decoration: underline; }

        #scThread { display:flex; flex-direction:column; gap: 5px; }
        .sc-comment { border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 6px 8px; margin-top: 0; background: rgba(255,255,255,0.042); }
        body.light-theme .sc-comment { border: 1px solid var(--border-color); background: rgba(255,255,255,0.75); }
        .sc-comment-head { display:flex; justify-content:space-between; align-items:center; gap:10px; }
        .sc-comment-author { font-size: 12px; font-weight: 900; }
        .sc-head-right { display:flex; align-items:center; gap:8px; }
        .sc-comment-time { opacity: 0.65; font-size: 11px; white-space: nowrap; }
        .sc-comment-body { margin-top: 2px; white-space: pre-wrap; line-height: 1.22; font-size: 12px; opacity: 0.95; }
        .sc-badge { display:inline-flex; align-items:center; gap:6px; margin-left:6px; padding:2px 7px; border-radius: 999px; border: 1px solid rgba(66,133,244,0.85); color: var(--primary-blue); font-size: 10px; font-weight: 950; letter-spacing: 0.02em; }

        /* Maker vs others */
        .sc-comment.sc-by-maker { background: rgba(66,133,244,0.12); border-color: rgba(66,133,244,0.28); }
        body.light-theme .sc-comment.sc-by-maker { background: rgba(66,133,244,0.10); border-color: rgba(66,133,244,0.35); }
        .sc-comment.sc-by-user { background: rgba(255,255,255,0.040); }
        body.light-theme .sc-comment.sc-by-user { background: rgba(255,255,255,0.75); }

        .sc-icon-btn {
            width: 26px;
            height: 26px;
            padding: 0;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.85);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
        }
        .sc-icon-btn:hover { transform: translateY(-1px); border-color: rgba(66,133,244,0.75); background: rgba(66,133,244,0.10); }
        body.light-theme .sc-icon-btn { background: rgba(0,0,0,0.02); color: var(--text-main); border: 1px solid var(--border-color); }

        .sc-thread-row { display:flex; align-items:center; gap:8px; margin-top: 2px; }
        .sc-thread-toggle { width: 22px; height: 22px; border-radius: 10px; }
        .sc-thread-count { font-size: 11px; color: rgba(255,255,255,0.72); font-weight: 900; line-height: 1.2; }
        body.light-theme .sc-thread-count { color: var(--text-secondary); }

        /* Threaded replies (compact like chat threads) */
        .sc-replies {
            margin-top: 6px;
            padding-left: 12px;
            border-left: 2px solid rgba(66,133,244,0.28);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sc-replies.is-collapsed { display: none; }
        .sc-comment.sc-reply { padding: 7px 9px; border-radius: 12px; }
        body.light-theme .sc-comment.sc-reply { background: rgba(255,255,255,0.6); }
        .sc-reply-toggle { width: 28px; height: 28px; }
        .sc-replybox textarea { min-height: 72px; }

        /* Comment composer: compact (10% of previous height) */
        #scCommentBody { min-height: 5vh; height: 5vh; max-height: 10vh; resize: vertical; }
        #scCommentForm .sc-field label { font-size: 10px; letter-spacing: 0.06em; }

        .sc-input-wrap { position: relative; width: 200%; }
        .sc-input-wrap textarea { padding-right: 44px; }
        @media (max-width: 900px) {
            .sc-input-wrap { width: 100%; }
        }
        .sc-send-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 32px;
            height: 32px;
            border-radius: 12px;
            border: 1px solid rgba(66,133,244,0.55);
            background: rgba(66,133,244,0.12);
            color: #fff;
            font-weight: 950;
            cursor: pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            transition: transform 0.12s ease, background 0.12s ease, border-color 0.12s ease;
        }
        .sc-send-btn:hover { transform: translateY(-1px); background: rgba(66,133,244,0.18); border-color: rgba(66,133,244,0.75); }
        body.light-theme .sc-send-btn { color: var(--text-main); background: rgba(66,133,244,0.10); }

        .sc-reply-count {
            display:inline-flex;
            align-items:center;
            margin-left: 6px;
            padding: 2px 7px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.82);
            font-size: 10px;
            font-weight: 950;
            letter-spacing: 0.02em;
            white-space: nowrap;
        }
        body.light-theme .sc-reply-count { background: rgba(0,0,0,0.03); color: var(--text-secondary); border: 1px solid var(--border-color); }

        .sc-comment.is-thread { cursor: pointer; }
        .sc-comment.is-thread:hover { border-color: rgba(66,133,244,0.35); }

        /* Project deep-dive: separate blocks for field/value */
        .sc-block {
            margin-top: 12px;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.035);
        }
        body.light-theme .sc-block {
            background: rgba(0,0,0,0.02);
            border: 1px solid var(--border-color);
        }
        .sc-block-title { font-weight: 950; font-size: 14px; margin: 0 0 6px 0; }
        .sc-block-body { font-size: 13px; line-height: 1.35; opacity: 0.95; }

        /* Standard (non-emoji) icons  colored + modern badge style */
        .ui-ico{
            width:1.05em;
            height:1.05em;
            display:inline-block;
            vertical-align:-0.16em;
            flex:0 0 auto;
            fill:currentColor;
            color: var(--ico-fg, #58a6ff);
            background:
                radial-gradient(120% 120% at 28% 22%, rgba(255,255,255,0.60) 0%, rgba(255,255,255,0.18) 26%, rgba(0,0,0,0.10) 62%, rgba(0,0,0,0.22) 100%),
                linear-gradient(145deg, rgba(255,255,255,0.22), rgba(0,0,0,0.22)),
                var(--ico-bg, rgba(88,166,255,0.18));
            border: 1px solid var(--ico-brd, rgba(88,166,255,0.28));
            border-radius: 999px;
            padding: 0.18em;
            box-sizing: content-box;
            box-shadow:
                0 14px 26px rgba(0,0,0,0.42),
                0 2px 0 rgba(255,255,255,0.06),
                inset 0 1px 0 rgba(255,255,255,0.55),
                inset 0 -6px 12px rgba(0,0,0,0.34);
        }
        body.light-theme .ui-ico{
            background:
                radial-gradient(120% 120% at 28% 22%, rgba(255,255,255,0.90) 0%, rgba(255,255,255,0.44) 28%, rgba(0,0,0,0.05) 62%, rgba(0,0,0,0.10) 100%),
                linear-gradient(145deg, rgba(255,255,255,0.45), rgba(0,0,0,0.08)),
                var(--ico-bg, rgba(66,133,244,0.14));
            border-color: var(--ico-brd, rgba(66,133,244,0.24));
            box-shadow:
                0 12px 22px rgba(0,0,0,0.18),
                0 2px 0 rgba(255,255,255,0.10),
                inset 0 1px 0 rgba(255,255,255,0.75),
                inset 0 -5px 10px rgba(0,0,0,0.14);
        }

        .ui-ico.sm{width:0.95em;height:0.95em;padding:0.16em;}
        .ui-ico.lg{width:1.15em;height:1.15em;padding:0.20em;}

        /* When icons sit inside already-styled buttons, don't double-badge */
        .sc-send-btn .ui-ico,
        .btn-secondary .ui-ico,
        .btn-logout .ui-ico,
        #hubBotWidget button .ui-ico{
            background: transparent;
            border: none;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.45));
            color: currentColor;
        }

        .ui-ico-wrap{display:inline-flex;align-items:center;gap:10px;}

        /* Semantic color helpers (optional per-instance) */
        .ui-ico.is-info{--ico-fg:#58a6ff;--ico-bg:rgba(88,166,255,0.18);--ico-brd:rgba(88,166,255,0.30);}
        .ui-ico.is-success{--ico-fg:#4CAF50;--ico-bg:rgba(76,175,80,0.16);--ico-brd:rgba(76,175,80,0.32);}
        .ui-ico.is-warn{--ico-fg:#f0ad4e;--ico-bg:rgba(240,173,78,0.16);--ico-brd:rgba(240,173,78,0.34);}
        .ui-ico.is-danger{--ico-fg:#f85149;--ico-bg:rgba(248,81,73,0.16);--ico-brd:rgba(248,81,73,0.34);}
        .ui-ico.is-purple{--ico-fg:#a371f7;--ico-bg:rgba(163,113,247,0.16);--ico-brd:rgba(163,113,247,0.32);}
        .ui-ico.is-cyan{--ico-fg:#39c5bb;--ico-bg:rgba(57,197,187,0.16);--ico-brd:rgba(57,197,187,0.32);}
        .ui-ico.is-pink{--ico-fg:#ff7b72;--ico-bg:rgba(255,123,114,0.14);--ico-brd:rgba(255,123,114,0.30);}
        .ui-ico.is-gold{--ico-fg:#f7d774;--ico-bg:rgba(247,215,116,0.16);--ico-brd:rgba(247,215,116,0.34);}
        .ui-ico.is-muted{--ico-fg:rgba(255,255,255,0.78);--ico-bg:rgba(255,255,255,0.08);--ico-brd:rgba(255,255,255,0.12);}
        body.light-theme .ui-ico.is-muted{--ico-fg:var(--text-secondary);--ico-bg:rgba(0,0,0,0.03);--ico-brd:var(--border-color);}

        /* Sidebar: give each item a distinct color (standard app look) */
        .sidebar-nav .sidebar-item:nth-child(1) .ui-ico{--ico-fg:#58a6ff;--ico-bg:rgba(88,166,255,0.18);--ico-brd:rgba(88,166,255,0.30);} /* Home */
        .sidebar-nav .sidebar-item:nth-child(2) .ui-ico{--ico-fg:#a371f7;--ico-bg:rgba(163,113,247,0.16);--ico-brd:rgba(163,113,247,0.32);} /* Courses */
        .sidebar-nav .sidebar-item:nth-child(3) .ui-ico{--ico-fg:#f0ad4e;--ico-bg:rgba(240,173,78,0.16);--ico-brd:rgba(240,173,78,0.34);} /* Measure & Master */
        .sidebar-nav .sidebar-item:nth-child(4) .ui-ico{--ico-fg:#ff7b72;--ico-bg:rgba(255,123,114,0.14);--ico-brd:rgba(255,123,114,0.30);} /* Quick learning */
        .sidebar-nav .sidebar-item:nth-child(5) .ui-ico{--ico-fg:#4CAF50;--ico-bg:rgba(76,175,80,0.16);--ico-brd:rgba(76,175,80,0.32);} /* My Progress */
        .sidebar-nav .sidebar-item:nth-child(6) .ui-ico{--ico-fg:#f7d774;--ico-bg:rgba(247,215,116,0.16);--ico-brd:rgba(247,215,116,0.34);} /* Leaderboard */
        .sidebar-nav .sidebar-item:nth-child(7) .ui-ico{--ico-fg:#39c5bb;--ico-bg:rgba(57,197,187,0.16);--ico-brd:rgba(57,197,187,0.32);} /* Hub Bot */
        .sidebar-nav .sidebar-item:nth-child(8) .ui-ico{--ico-fg:#ff7b72;--ico-bg:rgba(255,123,114,0.14);--ico-brd:rgba(255,123,114,0.30);} /* Showcase */

        .sidebar-footer .sidebar-item:nth-child(1) .ui-ico{--ico-fg:#a371f7;--ico-bg:rgba(163,113,247,0.16);--ico-brd:rgba(163,113,247,0.32);} /* Course Mgmt */
        .sidebar-footer .sidebar-item:nth-child(2) .ui-ico{--ico-fg:#39c5bb;--ico-bg:rgba(57,197,187,0.16);--ico-brd:rgba(57,197,187,0.32);} /* Role Mgmt */
        .sidebar-footer .sidebar-item:nth-child(3) .ui-ico{--ico-fg:#f7d774;--ico-bg:rgba(247,215,116,0.16);--ico-brd:rgba(247,215,116,0.34);} /* Activity Logs */
        .sidebar-footer .sidebar-item:nth-child(4) .ui-ico{--ico-fg:rgba(255,255,255,0.80);--ico-bg:rgba(255,255,255,0.08);--ico-brd:rgba(255,255,255,0.14);} /* Settings */
        body.light-theme .sidebar-footer .sidebar-item:nth-child(4) .ui-ico{--ico-fg:var(--text-secondary);--ico-bg:rgba(0,0,0,0.03);--ico-brd:var(--border-color);} 

        /* Make icons a bit larger in nav for readability */
        .sidebar .ui-ico{width:1.1em;height:1.1em;padding:0.20em;}

        /* Hub Bot floating button icon should be clean (no badge) */
        #hubBotFloatBtn .ui-ico{background:transparent;border:none;padding:0;box-shadow:none;filter:drop-shadow(0 6px 12px rgba(0,0,0,0.55));color:#fff;}
        body.light-theme #hubBotFloatBtn .ui-ico{color:#fff;}
        /* ====== End Added ====== */
        /* ====== End Added ====== */
    </style>
</head>

<body>
<!-- Standard icon sprite (non-emoji) -->
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true" focusable="false">
        <symbol id="ico-home" viewBox="0 0 24 24"><path d="M12 3l9 8h-3v10h-5v-6H11v6H6V11H3z"/></symbol>
        <symbol id="ico-book" viewBox="0 0 24 24"><path d="M5 4h11a3 3 0 0 1 3 3v13H8a3 3 0 0 0-3 3V4zm3 2v14h11V7a1 1 0 0 0-1-1H8z"/></symbol>
        <symbol id="ico-bar" viewBox="0 0 24 24"><path d="M4 20V10h3v10H4zm6 0V4h3v16h-3zm6 0v-7h3v7h-3z"/></symbol>
        <symbol id="ico-line" viewBox="0 0 24 24"><path d="M4 16l6-6 4 4 6-8 2 1.5-7.5 10-4-4-5 5z"/></symbol>
        <symbol id="ico-trophy" viewBox="0 0 24 24"><path d="M6 4h12v2h2v3a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.8V20h4v2H10v-2h4v-2.2A6 6 0 0 1 10 14H9a5 5 0 0 1-5-5V6h2V4zm0 4v1a3 3 0 0 0 3 3h1V6H6zm12 0h-4v6h1a3 3 0 0 0 3-3V8z"/></symbol>
        <symbol id="ico-bot" viewBox="0 0 24 24"><path d="M11 2h2v2h-2zM7 7h10a4 4 0 0 1 4 4v6a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4v-6a4 4 0 0 1 4-4zm2.5 5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm5 0a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/></symbol>
        <symbol id="ico-puzzle" viewBox="0 0 24 24"><path d="M14 3a2 2 0 0 1 2 2v1h2a2 2 0 0 1 2 2v3h-2a2 2 0 1 0 0 4h2v3a2 2 0 0 1-2 2h-3v-2a2 2 0 1 0-4 0v2H8a2 2 0 0 1-2-2v-2h2a2 2 0 1 0 0-4H6V8a2 2 0 0 1 2-2h3V5a2 2 0 0 1 2-2z"/></symbol>
        <symbol id="ico-gear" viewBox="0 0 24 24"><path d="M19.4 13a7.8 7.8 0 0 0 0-2l2-1.2-2-3.4-2.2.7a7.5 7.5 0 0 0-1.7-1l-.3-2.3H11l-.3 2.3a7.5 7.5 0 0 0-1.7 1l-2.2-.7-2 3.4L6.6 11a7.8 7.8 0 0 0 0 2l-2 1.2 2 3.4 2.2-.7c.5.4 1.1.7 1.7 1l.3 2.3h4l.3-2.3c.6-.3 1.2-.6 1.7-1l2.2.7 2-3.4-2-1.2zM13 12a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></symbol>
        <symbol id="ico-users" viewBox="0 0 24 24"><path d="M16 11a4 4 0 1 0-4-4 4 4 0 0 0 4 4zM8 12a3 3 0 1 0-3-3 3 3 0 0 0 3 3zm8 2c-3.3 0-6 1.7-6 4v2h12v-2c0-2.3-2.7-4-6-4zM8 14c-2.7 0-5 1.4-5 3.2V20h6v-1.8c0-1.3.5-2.4 1.4-3.2A8 8 0 0 0 8 14z"/></symbol>
        <symbol id="ico-refresh" viewBox="0 0 24 24"><path d="M17.7 6.3A8 8 0 0 0 4 12H2l3.5 3.5L9 12H6a6 6 0 0 1 10.2-4.2L14 10h8V2l-4.3 4.3zM20 12a8 8 0 0 1-14 5.7L10 14H2v8l4.3-4.3A8 8 0 0 0 22 12z"/></symbol>
        <symbol id="ico-news" viewBox="0 0 24 24"><path d="M4 4h14v16H4zM2 6h2v14a2 2 0 0 0 2 2h14v-2H6V6H2zm4 2h10v2H6V8zm0 4h10v2H6v-2zm0 4h7v2H6v-2z"/></symbol>
        <symbol id="ico-rocket" viewBox="0 0 24 24"><path d="M12 2c4.5 1.2 7 5.2 7 10l-4 4c-4.8 0-8.8-2.5-10-7l3-3c.3 1.5 1.6 2.8 3 3l2-2c.2-1.4-1-2.7-2.6-3L12 2zm-5.5 9.5L4 14v6h6l2.5-2.5c-2.5-.4-4.6-2.5-6-6z"/></symbol>
        <symbol id="ico-megaphone" viewBox="0 0 24 24"><path d="M3 11v2a3 3 0 0 0 3 3h1l2 6h2l-1.5-6H12l8 3V5l-8 3H6a3 3 0 0 0-3 3zm15-3.4v8.8L12 14H6a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1h6l6-2.4z"/></symbol>
        <symbol id="ico-history" viewBox="0 0 24 24"><path d="M13 3a9 9 0 1 1-8.3 5.5H2V3l2.3 2.3A11 11 0 1 0 13 1v2zm-1 4h2v6l4 2-1 1.7-5-2.7V7z"/></symbol>
        <symbol id="ico-trash" viewBox="0 0 24 24"><path d="M7 21a2 2 0 0 1-2-2V7h14v12a2 2 0 0 1-2 2H7zM9 3h6l1 2h4v2H4V5h4l1-2z"/></symbol>
        <symbol id="ico-note" viewBox="0 0 24 24"><path d="M6 2h9l3 3v17H6V2zm9 1.5V6h2.5L15 3.5zM8 9h8v2H8V9zm0 4h8v2H8v-2zm0 4h6v2H8v-2z"/></symbol>
        <symbol id="ico-calendar" viewBox="0 0 24 24"><path d="M7 2h2v2h6V2h2v2h3v18H4V4h3V2zm13 6H6v12h14V8z"/></symbol>
        <symbol id="ico-tool" viewBox="0 0 24 24"><path d="M22 19.6 14.4 12a6 6 0 0 1-7.7-7.7l3 3 2.3-2.3-3-3A6 6 0 0 1 16 9.6l7.6 7.6-1.6 2.4z"/></symbol>
        <symbol id="ico-cards" viewBox="0 0 24 24"><path d="M4 7h12v14H4V7zm2 2v10h8V9H6zm12-4h2v14h-2V5z"/></symbol>
        <symbol id="ico-check" viewBox="0 0 24 24"><path d="M9 16.2 4.8 12 3.4 13.4 9 19l12-12-1.4-1.4z"/></symbol>
        <symbol id="ico-x" viewBox="0 0 24 24"><path d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3 10.6 10.6 16.9 4.3z"/></symbol>
        <symbol id="ico-warning" viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-5h2v5z"/></symbol>
        <symbol id="ico-search" viewBox="0 0 24 24"><path d="M10 2a8 8 0 1 1 5 14.2L20.7 22 19.3 23.4l-5.7-5.7A8 8 0 0 1 10 2zm0 2a6 6 0 1 0 0 12 6 6 0 0 0 0-12z"/></symbol>
        <symbol id="ico-pin" viewBox="0 0 24 24"><path d="M14 2 10 6v5l-2 2v2h8v-2l-2-2V6l4-4-2-2zM11 17h2v5h-2z"/></symbol>
        <symbol id="ico-lock" viewBox="0 0 24 24"><path d="M17 10h-1V8a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2zm-7-2a2 2 0 0 1 4 0v2h-4V8z"/></symbol>
        <symbol id="ico-star" viewBox="0 0 24 24"><path d="M12 17.3 6.8 20.4l1.4-6-4.6-4 6-.5L12 4l2.4 5.9 6 .5-4.6 4 1.4 6z"/></symbol>
        <symbol id="ico-thumb" viewBox="0 0 24 24"><path d="M2 10h4v12H2V10zm20 1a2 2 0 0 0-2-2h-6.3l.9-4.3.1-.6a1.7 1.7 0 0 0-.5-1.2L13 2 7.6 7.4A2 2 0 0 0 7 8.8V20a2 2 0 0 0 2 2h7a2 2 0 0 0 1.9-1.4l2.1-7a2 2 0 0 0 .0-.6V11z"/></symbol>
        <symbol id="ico-comment" viewBox="0 0 24 24"><path d="M4 4h16v12H7l-3 3V4zm2 2v9.2L6.2 15H18V6H6z"/></symbol>
        <symbol id="ico-send" viewBox="0 0 24 24"><path d="M2 21 23 12 2 3v7l15 2-15 2v7z"/></symbol>
</svg>
<script>
    window.uiIcon = function (name, cls) {
        const safe = String(name || '').replace(/[^a-z0-9_-]/gi, '');
        const c = String(cls || '').trim();
        return `<svg class="ui-ico ${c}"><use href="#ico-${safe}"></use></svg>`;
    };
</script>
<header class="dashboard-header">
    <div class="header-left"><img src="oo new semi arch white blue (4).png" id="mainLogo"></div>
    <div class="header-center" style="display: flex; flex-direction: column; align-items: center;">
        <div class="hub-title" id="bouncingTitle"></div>
        <div class="hub-subtitle">Empowering your technical growth through AI-driven learning</div>
    </div>
    <div class="header-right"><div class="user-badge" id="userName">User</div><button class="btn-logout" onclick="logout()">Log out</button></div>
</header>

<div class="app-body">
    <aside class="sidebar" id="sidebar">
        <div class="toggle-container"><button class="toggle-btn" onclick="toggleSidebar()"></button></div>
        <div class="sidebar-nav">
            <div class="sidebar-item active" onclick="switchTab('home-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-home"></use></svg></span> <span class="sidebar-text">Home</span></div>
            <div class="sidebar-item" onclick="switchTab('courses-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-book"></use></svg></span> <span class="sidebar-text">Courses</span></div>
            <div class="sidebar-item" onclick="switchTab('measure-master-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-bar"></use></svg></span> <span class="sidebar-text">Measure & Master</span></div>
            <div class="sidebar-item" onclick="switchTab('quick-learning-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-rocket"></use></svg></span> <span class="sidebar-text">Quick learning</span></div>
            <div class="sidebar-item" onclick="switchTab('my-progress-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-line"></use></svg></span> <span class="sidebar-text">My Progress</span></div>
            <div class="sidebar-item" onclick="switchTab('leaderboard-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-trophy"></use></svg></span> <span class="sidebar-text">Leaderboard</span></div>
            <div class="sidebar-item" onclick="switchTab('hub-bot-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-bot"></use></svg></span> <span class="sidebar-text">Hub Bot</span></div>
            <div class="sidebar-item" onclick="switchTab('showcase-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-puzzle"></use></svg></span> <span class="sidebar-text">Showcase Forum</span></div>
            <div class="sidebar-item" id="talkspaceSidebarItem" onclick="switchTab('talkspace-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-comment"></use></svg></span> <span class="sidebar-text">TalkSpace</span><span class="sidebar-badge" id="talkspaceUnreadBadge" style="display:none"></span></div>
        </div>
        <div class="sidebar-footer">
            <div class="sidebar-item" id="courseMgmtSidebarItem" onclick="switchTab('course-mgmt-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-book"></use></svg></span> <span class="sidebar-text">Course Mgmt</span></div>
            <div class="sidebar-item" id="roleMgmtSidebarItem" onclick="switchTab('role-mgmt-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-users"></use></svg></span> <span class="sidebar-text">Role Mgmt</span></div>
            <div class="sidebar-item" id="activityLogsSidebarItem" onclick="switchTab('activity-logs-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-history"></use></svg></span> <span class="sidebar-text">Activity Logs</span></div>
            <div class="sidebar-item" onclick="switchTab('settings-view', this)"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-gear"></use></svg></span> <span class="sidebar-text">Settings</span></div>
        </div>
    </aside>

    <main class="main-content">
        <section id="home-view">
            <h1 id="timeGreeting"></h1>

            <div class="home-about">
                <div class="home-about-hero">
                    <div class="home-about-head">
                        <h2 class="home-about-title">About the Hub</h2>
                        <p class="home-about-subtitle">OneOrigin Hub is an AI-powered learning hub built for modern teams  learn faster with curated courses, measure mastery with checkpoints, and get instant help from Hub Bot. Everything is designed to keep your progress consistent, trackable, and easy to continue across devices.</p>
                        <p class="home-about-subcopy">Think of it as your personal learning operating system: it combines structured learning paths, micro-learning Shorts, and an AI assistant that helps you troubleshoot, summarize, and plan what to learn next. Whether you have 5 minutes or 50, the Hub keeps your momentum.</p>
                        <ul class="home-about-bullets">
                            <li><b style="color:var(--text-main);">AI guidance</b> via Hub Bot for explanations, summaries, practice plans, and debugging help.</li>
                            <li><b style="color:var(--text-main);">Progress you can trust</b> with checkpoint-style learning and cross-device continuity.</li>
                            <li><b style="color:var(--text-main);">Quick learning</b> with tech-only Shorts you can swipe through and open on YouTube when needed.</li>
                            <li><b style="color:var(--text-main);">Team visibility</b> with shared courses, activity logs (admin), and consistent learning standards.</li>
                        </ul>
                    </div>

                    <div class="home-about-highlights">
                        <div class="home-about-pill"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-check"></use></svg></span> Playable tutorials</div>
                        <div class="home-about-pill"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-refresh"></use></svg></span> Shared progress</div>
                        <div class="home-about-pill"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-comment"></use></svg></span> Chat continuity</div>
                        <div class="home-about-pill"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-bot"></use></svg></span> AI learning help</div>
                        <div class="home-about-pill"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-rocket"></use></svg></span> Tech Shorts feed</div>
                    </div>
                </div>

                <div class="home-about-grid">
                    <div class="home-about-card">
                        <h3><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-book"></use></svg></span> Courses</h3>
                        <p>Start learning with assigned tutorials that are validated to be playable and easy to continue across devices.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>You get courses assigned by your Admin (or automatically from curated sources).</li>
                            <li>Assignments prefer embeddable videos; if a video cant be embedded, the Hub provides a safe fallback and Watch on YouTube.</li>
                            <li>Your assigned course list is stored in shared storage so it remains consistent after refresh or on another device.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Open a course, watch it in the Hub, and continue where you left off.</li>
                            <li>Stay aligned to your learning path with minimal friction.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('courses-view', null)">Go to Courses</button>
                        </div>
                    </div>

                    <div class="home-about-card">
                        <h3><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-bar"></use></svg></span> Measure &amp; Master</h3>
                        <p>Turn learning into measurable progress by practicing consistently and tracking your mastery.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>Use structured checkpoints to measure understanding and identify gaps.</li>
                            <li>Follow a repeatable practice rhythm (review  apply  reinforce).</li>
                            <li>Focus on strengthening weak areas before moving to advanced topics.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Build a practice plan and keep your learning on track.</li>
                            <li>Improve retention with intentional repetition.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('measure-master-view', null)">Go to Measure &amp; Master</button>
                        </div>
                    </div>

                    <div class="home-about-card">
                        <h3><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-bot"></use></svg></span> Hub Bot</h3>
                        <p>Your AI assistant for learning support: summaries, troubleshooting, and next-step guidance  with chat history for continuity.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>Ask questions and Hub Bot responds with context from your ongoing conversation.</li>
                            <li>Chat sessions are saved so you can revisit prior topics from the Chat history list.</li>
                            <li>Use quick prompts to generate summaries, flashcards, practice plans, and debug help faster.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Get explanations for errors and step-by-step troubleshooting.</li>
                            <li>Create practice plans that match your current course work.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('hub-bot-view', null)">Go to Hub Bot</button>
                        </div>
                    </div>

                    <div class="home-about-card">
                        <h3><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-rocket"></use></svg></span> Quick learning</h3>
                        <p>Shorts-style learning feed for fast tech concepts. Browse a grid (5 per row) and open a vertical viewer to swipe through.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>By default, the feed uses your learning topics to pull tech-related Shorts-style videos from YouTube search.</li>
                            <li>Open any card to view in a vertical Shorts player with Next/Prev navigation.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Search any topic and quickly skim multiple short videos.</li>
                            <li>Switch videos like Shorts and open on YouTube when needed.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('quick-learning-view', null)">Go to Quick learning</button>
                        </div>
                    </div>

                    <div class="home-about-card">
                        <h3><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-line"></use></svg></span> My Progress</h3>
                        <p>See your course progress, assessment outcomes, and recent activity in one place.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>Progress and scores are tracked per course and summarized into a quick table.</li>
                            <li>Passed courses contribute to your points.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Resume learning and retake assessments when needed.</li>
                            <li>Track what you completed and whats next.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('my-progress-view', null)">Go to My Progress</button>
                        </div>
                    </div>

                    <div class="home-about-card">
                        <h3><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-trophy"></use></svg></span> Leaderboard</h3>
                        <p>Friendly competition to stay consistent  points update when you pass assessments.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>Points are added when a course is marked as Passed.</li>
                            <li>Higher levels award more points.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Compare progress and stay motivated to finish courses.</li>
                            <li>Use it as a weekly consistency tracker.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('leaderboard-view', null)">Go to Leaderboard</button>
                        </div>
                    </div>

                    <div class="home-about-card">
                        <h3><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-puzzle"></use></svg></span> Showcase Forum</h3>
                        <p>Share project ideas and demos, browse others work, and organize feedback.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>Browse and submit projects inside the hub.</li>
                            <li>Updates sync so everyone sees new entries.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Post your project and collect feedback.</li>
                            <li>Explore what others are building.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('showcase-view', null)">Go to Showcase</button>
                        </div>
                    </div>

                    <div class="home-about-card">
                        <h3><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-comment"></use></svg></span> TalkSpace</h3>
                        <p>Quick communication space for discussions and updates  without leaving the hub.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>TalkSpace is embedded so it opens instantly.</li>
                            <li>Unread badges show when new messages arrive.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Ask questions, coordinate, and share quick updates.</li>
                            <li>Keep learning conversations in one place.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('talkspace-view', null)">Go to TalkSpace</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="home-grid">
                <div class="home-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-news"></use></svg></span> Daily AI News</h2>
                        <button id="adminRefreshNewsBtn" onclick="forceRefreshNews()" style="background:#111; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold;"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-refresh"></use></svg></span> Refresh News</button>
                    </div>
                    <div id="news-container"></div>
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 8px; color: var(--primary-blue); font-size: 14px;"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-rocket"></use></svg></span> AI Updates (Last 24 Hours)</h3>
                        <div id="ai-updates-container"></div>
                    </div>
                </div>
                <div class="home-card">
                    <h2><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-megaphone"></use></svg></span> Announcements</h2>
                    <div id="announcements-container">
                        <!-- Announcements will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <section id="talkspace-view" style="display: none;">
            <div class="talkspace-embed">
                <iframe id="talkspaceFrame" src="talkspace.html?embed=1" title="TalkSpace"></iframe>
            </div>
        </section>

        <!-- Project Showcase & Community Forum -->
        <section id="showcase-view" style="display: none;">
            <div class="showcase-shell">
                <div class="showcase-hero">
                    <div class="showcase-hero-left">
                        <div class="showcase-icon"><svg class="ui-ico ui-ico-xl" style="width:28px;height:28px;"><use href="#ico-puzzle"></use></svg></div>
                        <div>
                            <div class="showcase-title">Project Showcase &amp; Community Forum</div>
                            <div class="showcase-sub">A gallery + discussion board for creators. Launch instantly, upvote ideas, and keep feedback organized.</div>
                        </div>
                    </div>
                    <div class="showcase-actions">
                        <button class="ghost" id="scBrowseBtn" type="button">Browse</button>
                        <button class="ghost" id="scSubmitBtn" type="button">Submit</button>
                        <button class="ghost" id="scRefreshBtn" type="button">Refresh</button>
                    </div>
                </div>

                <!-- HOME MODE -->
                <div id="scModeHome">
                    <div class="sc-panel">
                        <div class="sc-controls">
                            <div class="sc-search">
                                <span style="color: rgba(255,255,255,0.72); font-size:12px;">Search</span>
                                <input id="scSearchInput" type="text" placeholder="Find projects by name" />
                            </div>
                            <div class="sc-sort" aria-label="Sort">
                                <label><input id="scSortTrending" name="scSort" type="radio" checked /> Trending</label>
                                <label><input id="scSortNewest" name="scSort" type="radio" /> Newest</label>
                            </div>
                        </div>
                        <div class="sc-tagbar" id="scTagBar"></div>
                    </div>

                    <div id="scEmptyState" class="sc-panel" style="margin-top:14px; color: rgba(255,255,255,0.72); display:none;">
                        No projects yet. Click Submit to launch the first one.
                    </div>

                    <div class="sc-grid" id="scProjectGrid" style="margin-top:14px;"></div>
                </div>

                <!-- SUBMIT MODE -->
                <div id="scModeSubmit" style="display:none;">
                    <div class="sc-panel">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                            <div>
                                <div style="font-weight:950; font-size:18px;" id="scStepTitle">Basics</div>
                                <div style="color: rgba(255,255,255,0.72); font-size:13px;">Step-by-step launch flow. Projects appear immediately; Firestore sync makes them visible to everyone.</div>
                            </div>
                            <div class="sc-dots" id="scStepDots"></div>
                        </div>

                        <div id="scStep1" style="margin-top:12px;">
                            <div class="sc-form">
                                <div class="sc-field">
                                    <label>Project Name</label>
                                    <input id="scFName" type="text" placeholder="e.g., Smart Resume Reviewer" />
                                </div>
                                <div class="sc-field">
                                    <label>One-line Tagline (Hook)</label>
                                    <input id="scFTagline" type="text" placeholder="e.g., AI that explains how to improve your resume in seconds" />
                                </div>
                                <div class="sc-field">
                                    <label>Tags (comma-separated)</label>
                                    <input id="scFTags" type="text" placeholder="AI, Design, Hardware" />
                                </div>
                            </div>
                        </div>

                        <div id="scStep2" style="display:none; margin-top:12px;">
                            <div class="sc-form">
                                <div class="sc-field">
                                    <label>Long-form Description (Story of the build)</label>
                                    <textarea id="scFDescription" placeholder="What did you build, why, what was hard, what did you learn"></textarea>
                                </div>
                                <div class="sc-field">
                                    <label>Preview Image URL (optional)</label>
                                    <input id="scFImageUrl" type="url" placeholder="https://..." />
                                </div>
                            </div>
                        </div>

                        <div id="scStep3" style="display:none; margin-top:12px;">
                            <div class="sc-form">
                                <div class="sc-field">
                                    <label>Live Demo URL (optional)</label>
                                    <input id="scFDemoUrl" type="url" placeholder="https://..." />
                                </div>
                                <div class="sc-field">
                                    <label>Demo Video URL (optional)</label>
                                    <input id="scFDemoVideoUrl" type="url" placeholder="https://... (mp4/webm hosted)" />
                                </div>
                                <div class="sc-field">
                                    <label>OR Upload Demo Video (optional)</label>
                                    <input id="scFDemoVideoFile" type="file" accept="video/mp4,video/webm,video/quicktime" />
                                    <div id="scVideoUploadStatus" style="color: rgba(255,255,255,0.72); font-size:12px;">Tip: Upload uses Firebase Storage (if enabled). Keep it reasonably small.</div>
                                </div>
                                <div class="sc-field">
                                    <label>Code URL (optional if you paste code below)</label>
                                    <input id="scFCodeUrl" type="url" placeholder="https://github.com/..." />
                                </div>
                                <div class="sc-field">
                                    <label>Code Snippet (optional if you provide a Code URL)</label>
                                    <textarea id="scFCodeSnippet" placeholder="Paste a key file, config, or minimal runnable snippet"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="sc-wizard-actions">
                            <button class="ghost" id="scBtnPrev" type="button">Back</button>
                            <button class="ghost" id="scBtnNext" type="button">Next</button>
                            <button class="ghost" id="scBtnLaunch" type="button" style="display:none;">Launch</button>
                        </div>
                    </div>
                </div>

                <!-- PROJECT MODE -->
                <div id="scModeProject" style="display:none;">
                    <div class="sc-panel">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
                            <button class="ghost" id="scBackBtn" type="button"> Back</button>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button class="ghost" id="scUpvoteBtn" type="button"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-thumb"></use></svg></span> Upvote</button>
                                <button class="ghost" id="scSuggestBtn" type="button">Share</button>
                                <div style="color: rgba(255,255,255,0.75); font-size:12px; font-weight:900;"><span class="ui-ico-wrap"><svg class="ui-ico sm"><use href="#ico-thumb"></use></svg></span> <span id="scUpvoteCount">0</span></div>
                                <div style="color: rgba(255,255,255,0.75); font-size:12px; font-weight:900;"><span class="ui-ico-wrap"><svg class="ui-ico sm"><use href="#ico-comment"></use></svg></span> <span id="scCommentCount">0</span></div>
                                <div style="color: rgba(255,255,255,0.75); font-size:12px; font-weight:900;"><span class="ui-ico-wrap"><svg class="ui-ico sm"><use href="#ico-send"></use></svg></span> <span id="scSuggestCount">0</span></div>
                            </div>
                        </div>

                        <div style="margin-top:12px;">
                            <div style="font-size:22px; font-weight:950;" id="scPTitle">Project</div>
                            <div style="color: rgba(255,255,255,0.72); font-size:12px;" id="scPMeta"></div>
                            <div style="height:8px"></div>
                            <div style="color: rgba(255,255,255,0.72);" id="scPTagline"></div>
                        </div>

                        <img id="scPImage" class="sc-hero-media" alt="" style="margin-top:12px; display:none;" />
                        <video id="scPVideo" class="sc-hero-media" controls playsinline style="margin-top:12px; display:none;"></video>

                        <div class="sc-block">
                            <div class="sc-block-title">Story</div>
                            <div id="scPDescription" class="sc-block-body" style="white-space:pre-wrap;"></div>
                        </div>

                        <div class="sc-block">
                            <div class="sc-block-title">Tags</div>
                            <div class="sc-tagbar" id="scPTags" style="margin-top:8px;"></div>
                        </div>

                        <div class="sc-block">
                            <div class="sc-block-title">Links</div>
                            <div id="scPLinks" class="sc-block-body" style="margin-top:6px;"></div>
                        </div>

                        <div class="sc-block">
                            <div class="sc-block-title">Code</div>
                            <button class="ghost" id="scCopyCodeBtn" type="button" style="margin-top:8px; display:none;">Copy snippet</button>
                            <pre id="scCodeBlock" style="margin-top:10px; display:none;"></pre>
                            <div id="scCodeHint" class="sc-block-body" style="color: rgba(255,255,255,0.72); margin-top:8px;">If no snippet is shown, use the Code link above.</div>
                        </div>

                        <div class="sc-block">
                            <div class="sc-block-title">Discussion</div>
                            <form id="scCommentForm" class="sc-form" style="margin-top:0;">
                                <div class="sc-field">
                                    <label>Leave a comment</label>
                                    <div class="sc-input-wrap">
                                        <textarea id="scCommentBody" placeholder="Ask a question, give feedback, or share ideas"></textarea>
                                        <button class="sc-send-btn" type="submit" title="Send"><svg class="ui-ico" style="width:16px;height:16px;"><use href="#ico-send"></use></svg></button>
                                    </div>
                                </div>
                            </form>
                            <div id="scThread" style="margin-top:10px;"></div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Hub Bot Page -->
        <section id="hub-bot-view" style="display: none;">
            <div class="hub-bot-shell">
                <div class="hub-bot-hero">
                    <div class="hub-bot-meta">
                        <div class="hub-bot-avatar">HB</div>
                        <div>
                            <div class="hub-bot-title">Hub Bot</div>
                            <div class="hub-bot-sub">Your AI copilot for courses & troubleshooting</div>
                        </div>
                    </div>
                    <div class="hub-bot-status">
                        <span class="pill live">Live</span>
                        <span class="pill alt">Powered by Gemini</span>
                        <button class="ghost" onclick="toggleHubBotHistory()"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-history"></use></svg></span> Chat history</button>
                        <button class="ghost" onclick="clearHubBotChat()"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-trash"></use></svg></span> Clear chat</button>
                    </div>
                </div>

                <div id="hubBotHistoryPanel" style="display:none; border:1px solid var(--border-color); border-radius:10px; background: rgba(255,255,255,0.03); padding:12px; margin: 12px 0;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div style="color:var(--text-main); font-weight:800;">Chat history</div>
                        <button class="ghost" onclick="toggleHubBotHistory()">Close</button>
                    </div>
                    <div id="hubBotHistoryList" style="max-height:220px; overflow:auto;"></div>
                </div>

                <div class="hub-bot-prompts">
                    <div class="prompt-chip" onclick="hubBotInsert('Summarize this course: ')" title="Summarize course"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-note"></use></svg></span> Summarize this course</div>
                    <div class="prompt-chip" onclick="hubBotInsert('Give me a practice plan for ')" title="Practice plan"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-calendar"></use></svg></span> Practice plan</div>
                    <div class="prompt-chip" onclick="hubBotInsert('Explain this error: ')" title="Debug help"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-tool"></use></svg></span> Debug my issue</div>
                    <div class="prompt-chip" onclick="hubBotInsert('Create flashcards for ')" title="Flashcards"><span class="ui-ico-wrap"><svg class="ui-ico"><use href="#ico-cards"></use></svg></span> Flashcards</div>
                </div>

                <div id="hubBotPageMessages" class="hub-bot-messages">
                    <!-- Messages render here -->
                </div>

                <div class="hub-bot-input">
                    <input id="hubBotPageInput" type="text" placeholder="Ask anything about courses, errors, or learning paths..." />
                    <button onclick="sendHubBotMessage('page')">Send</button>
                </div>
            </div>
        </section>
        <!-- User Management Section -->
        <section id="user-mgmt-view" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;">
                <h2 style="color: var(--primary-blue); margin: 0;">User Management</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button style="background: var(--primary-blue); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;" onclick="openAddUserModal()">+ Add User</button>
                    <label style="font-size:12px; color:var(--text-secondary)">Bulk Upload CSV</label>
                    <input type="file" accept=".csv" onchange="handleCSVUpload(event)" style="background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border-color); padding:8px; border-radius:6px;">
                </div>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Employee name</th>
                        <th>Email ID</th>
                        <th>Role</th>
                        <th>Last active date&time</th>
                    </tr>
                </thead>
                <tbody id="userMgmtTableBody">
                    <!-- User rows will be rendered here -->
                </tbody>
            </table>
        </section>

        <!-- Role Management Section -->
        <section id="role-mgmt-view" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;">
                <h2 style="color: var(--primary-blue); margin: 0;">Role Management</h2>
                <div style="display:flex; gap:10px;">
                    <button style="background: var(--primary-blue); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;" onclick="openAddUserModal()">+ Add User</button>
                    <button style="background: #f85149; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;" onclick="deleteSelectedRoles()">Delete Selected</button>
                </div>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th style="width:50px; text-align:center;">
                            <input type="checkbox" id="selectAllRoles" onchange="toggleAllRoleChecks(this.checked)">
                        </th>
                        <th>Employee ID</th>
                        <th>Employee name</th>
                        <th>Email ID</th>
                        <th>Role</th>
                        <th>Last active date&time</th>
                        <th>Reset Assessment</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="roleMgmtTableBody">
                    <!-- Rows will be populated here -->
                </tbody>
            </table>
        </section>
        <section id="courses-view" style="display: none;">
            <h2 style="color: var(--primary-blue);">Courses</h2>
            <div style="margin: 10px 0 20px; width: 100%;">
                <input id="courseSearchInput" type="search" placeholder="Search courses..." 
                    style="width: 100%; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-main);">
            </div>
            <div id="beginner-courses" class="course-section">
                <h3>Beginner</h3>
                <div class="type-grid">
                    <!-- Beginner courses -->
                </div>
            </div>
            <div id="intermediate-courses" class="course-section">
                <h3>Intermediate</h3>
                <div class="type-grid">
                    <!-- Intermediate courses -->
                </div>
            </div>
            <div id="advanced-courses" class="course-section">
                <h3>Advanced</h3>
                <div class="type-grid">
                    <!-- Advanced courses -->
                </div>
            </div>
        </section>

        <section id="course-mgmt-view" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;">
                <h2 style="color: var(--primary-blue); margin: 0;">Course Management</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="clearAllCoursesBtn" style="display:none; background:#f85149; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; display:inline-flex; align-items:center; gap:8px;" onclick="clearAllCoursesOneTime()"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-trash"></use></svg></span>Clear All Courses</button>
                    <button style="background: var(--primary-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;" onclick="openAddCourseModal()">+ Add Course</button>
                </div>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Sl No.</th>
                        <th>Course name</th>
                        <th>Course Type</th>
                        <th>Video ID</th>
                        <th>Upload date</th>
                        <th>Source</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="courseMgmtTableBody">
                    <!-- Rows will be populated here -->
                </tbody>
            </table>
        </section>

        <section id="measure-master-view" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary-blue); margin: 0;">Measure & Master</h2>
                <button id="resetAllAssessmentsBtn" onclick="resetAllAssessments()" style="background: #f85149; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display:inline-flex; align-items:center; gap:8px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-refresh"></use></svg></span>Reset All</button>
            </div>
            
            <!-- Initial Assessment Button -->
            <div id="initialAssessmentContainer" style="text-align:center; padding:40px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; margin-bottom: 30px;">
                <p style="color:var(--text-secondary); margin-bottom:20px;">Test your knowledge across Web Development, LLMs, Transformers, OCR, AI and more!</p>
                <div id="initialAssessmentStatus"></div>
                <button id="startAssessmentBtn" onclick="startInitialAssessment()" style="background:var(--primary-blue); color:white; border:none; padding:15px 30px; border-radius:8px; cursor:pointer; font-size:16px; font-weight:bold;">Start Assessment</button>
            </div>

            <!-- Assessment Quiz Container -->
            <div id="assessmentQuizContainer" style="display:none; max-width:800px; margin:0 auto;">
                <div id="quizProgress" style="color:var(--text-secondary); margin-bottom:15px;"></div>
                <div id="quizQuestion" style="background:var(--card-bg); padding:20px; border:1px solid var(--border-color); border-radius:8px; margin-bottom:20px;">
                    <h3 id="questionText" style="color:var(--text-main); margin-bottom:15px;"></h3>
                    <div id="optionsContainer"></div>
                </div>
                <button id="nextQuestionBtn" onclick="nextQuestion()" style="background:var(--primary-blue); color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">Next Question</button>
                <button id="submitAssessmentBtn" onclick="submitAssessment()" style="display:none; background:#4CAF50; color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">Submit Assessment</button>
            </div>

            <!-- Results Container -->
            <div id="assessmentResults" style="display:none; max-width:800px; margin:20px auto; background:var(--card-bg); padding:30px; border:1px solid var(--border-color); border-radius:8px; text-align:center;">
                <h3 style="color:var(--primary-blue); margin-bottom:15px;">Assessment Complete!</h3>
                <div id="scoreDisplay" style="font-size:48px; font-weight:bold; color:var(--text-main); margin:20px 0;"></div>
                <div id="levelDisplay" style="font-size:24px; margin-bottom:20px;"></div>
                <div id="videoSuggestionContainer" style="margin-top:30px;">
                    <p style="color:var(--text-secondary); margin-bottom:15px;">Fetching personalized course recommendation...</p>
                </div>
                <div id="answersReviewContainer" style="margin-top:18px; text-align:left;"></div>
            </div>

            <!-- My Assigned Courses Section -->
            <div id="assignedCoursesSection" style="margin-top:40px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; padding: 20px;">
                <h3 style="color:var(--primary-blue); margin-bottom:20px;">My Assigned Courses (In Progress)</h3>
                <div id="assignedCoursesGrid" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:20px;">
                    <!-- Assigned courses will be rendered here -->
                </div>
            </div>

            <!-- Passed Courses Section -->
            <div id="passedCoursesSection" style="margin-top:30px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; padding: 20px;">
                <h3 style="color:#4CAF50; margin-bottom:20px;"> Passed Courses (Available Anytime)</h3>
                <div id="passedCoursesGrid" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:20px;">
                    <!-- Passed courses will be rendered here -->
                </div>
            </div>
        </section>

        <section id="quick-learning-view" style="display: none;">
            <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 12px;">
                <div>
                    <h2 style="color: var(--primary-blue); margin: 0;">Quick learning</h2>
                    <div style="color:var(--text-secondary); font-size:12px; margin-top:4px;">SimplilearnOfficial Shorts feed (cached locally). Browse like Courses (5 per row), then open a vertical viewer to swipe through.</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn-secondary" onclick="loadQuickLearning(true)">Refresh feed</button>
                    <button class="btn-secondary" onclick="clearQuickLearningCache()">Clear cache</button>
                </div>
            </div>

            <div style="color:var(--text-secondary); font-size:12px; margin: 8px 0 14px; line-height:1.5;">
                Source: <b style="color:var(--text-main);">https://www.youtube.com/@SimplilearnOfficial/shorts</b>
                <span style="opacity:0.9;"></span>
                Tip: use <b style="color:var(--text-main);">Refresh feed</b> to update, or <b style="color:var(--text-main);">Clear cache</b> if you want a fresh reload.
            </div>

            <div id="quickLearningStatus" style="color:var(--text-secondary); font-size:12px; margin-bottom:10px;"></div>

            <div class="course-section" style="margin-top: 8px;">
                <h3>Shorts for you</h3>
                <div id="quickLearningGrid" class="type-grid">
                    <div style="color:var(--text-secondary);">Loading</div>
                </div>
            </div>
        </section>

        <section id="my-progress-view" style="display: none;">
            <h2 style="color: var(--primary-blue); margin-top: 0;">My Progress</h2>
            <div class="progress-wrap">
                <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 14px;">
                    <div>
                        <div style="color:var(--text-main); font-size:14px;">Track your course activity and assessment results.</div>
                        <div style="color:var(--text-secondary); font-size:12px; margin-top:4px;">Assessments have <b>10 questions</b> for Beginner/Intermediate and <b>20 questions</b> for Advanced.</div>
                    </div>
                    <button class="btn-secondary" onclick="loadMyProgress()">Refresh</button>
                </div>

                <table class="admin-table" style="margin-top: 0;">
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th style="width:120px;">Level</th>
                            <th style="width:210px;">Status</th>
                            <th style="width:120px;">Last Score</th>
                            <th style="width:150px;">Last Activity</th>
                            <th style="width:230px; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="myProgressTableBody">
                        <tr>
                            <td colspan="6" style="color:var(--text-secondary);">Loading</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="leaderboard-view" style="display: none;">
            <h2 style="color: var(--primary-blue); margin-top: 0;">Leaderboard</h2>
            <div class="progress-wrap">
                <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 14px;">
                    <div>
                        <div style="color:var(--text-main); font-size:14px;">Points are awarded when a course is <b>Passed</b>.</div>
                        <div style="color:var(--text-secondary); font-size:12px; margin-top:4px;">Beginner: <b>2</b> points  Intermediate: <b>5</b> points  Advanced: <b>10</b> points</div>
                    </div>
                    <button class="btn-secondary" onclick="loadLeaderboard()">Refresh</button>
                </div>

                <table class="admin-table" style="margin-top: 0;">
                    <thead>
                        <tr>
                            <th style="width:90px;">Rank</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th style="width:140px;">Points</th>
                            <th style="width:170px;">Last Updated</th>
                            <th id="leaderboardViewColView" style="width:90px; text-align:center; display:none;">View</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody">
                        <tr>
                            <td colspan="6" style="color:var(--text-secondary);">Loading</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="activity-logs-view" style="display:none;">
            <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 14px;">
                <div>
                    <h2 style="color: var(--primary-blue); margin: 0;">Activity Logs</h2>
                    <div style="color:var(--text-secondary); font-size:12px; margin-top:4px;">Admin-only audit trail of actions in the hub.</div>
                </div>
                <button class="btn-secondary" onclick="loadActivityLogs()">Refresh</button>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 10px;">
                <input id="activityLogsFilter" type="search" placeholder="Filter (email, action, keyword)"
                    style="flex:1; min-width: 260px; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-main);">
            </div>

            <table class="admin-table" style="margin-top: 0;">
                <thead>
                    <tr>
                        <th style="width:190px;">Timestamp</th>
                        <th style="width:230px;">Who</th>
                        <th style="width:180px;">Action</th>
                        <th>Summary</th>
                    </tr>
                </thead>
                <tbody id="activityLogsTableBody">
                    <tr><td colspan="4" style="color:var(--text-secondary);">Loading</td></tr>
                </tbody>
            </table>
        </section>

        <section id="settings-view" style="display: none;">
            <h2 style="color: var(--primary-blue);">Settings</h2>
            <div style="padding: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; max-width: 400px;">
                <label style="display: block; margin-bottom: 10px; color: var(--text-main);">Interface Theme</label>
                <select id="themeToggle" onchange="toggleTheme(this.value)" style="width: 100%; padding: 10px; background: var(--bg-dark); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 6px;">
                    <option value="dark">Dark Theme</option>
                    <option value="light">Light Theme</option>
                </select>
            </div>
        </section>
    </main>
</div>

<!-- Floating Hub Bot Widget -->
<button id="hubBotFloatBtn" onclick="toggleHubBotWidget()" style="position:fixed; bottom:20px; right:20px; z-index:3500; background: var(--primary-blue); color: white; border: none; padding: 12px 16px; border-radius: 999px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); cursor: pointer; font-weight: 700; display:flex; align-items:center; gap:8px;">
    <span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-bot"></use></svg></span>
    Hub Bot
</button>

<div id="hubBotWidget" style="display:none; position:fixed; bottom:80px; right:20px; width:340px; max-height:520px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 12px 32px rgba(0,0,0,0.45); z-index:4000; overflow:hidden;">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border-color);">
        <div style="display:flex; align-items:center; gap:8px;">
            <div style="width:24px; height:24px; border-radius:50%; background: var(--primary-blue); display:flex; align-items:center; justify-content:center; color:white; font-weight:700;"><svg class="ui-ico" style="width:16px; height:16px; fill:currentColor;"><use href="#ico-bot"></use></svg></div>
            <div style="color:var(--text-main); font-weight:700;">Hub Bot</div>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <button onclick="clearHubBotChat()" title="Clear chat" aria-label="Clear chat" style="background: transparent; color: var(--text-secondary); border:1px solid var(--border-color); padding:4px 8px; border-radius:6px; cursor:pointer;"><svg class="ui-ico" style="width:16px; height:16px;"><use href="#ico-trash"></use></svg></button>
            <button onclick="minimizeHubBotWidget()" title="Minimize" style="background: transparent; color: var(--text-secondary); border:1px solid var(--border-color); padding:4px 8px; border-radius:6px; cursor:pointer; font-size:16px;"></button>
            <button onclick="closeHubBotWidget()" title="Close" style="background: transparent; color: var(--text-secondary); border:none; cursor:pointer; font-size:18px;"></button>
        </div>
    </div>
    <div id="hubBotMessages" style="padding:10px; max-height:380px; overflow-y:auto;">
        <!-- Messages render here -->
    </div>
    <div style="display:flex; gap:6px; padding:10px; border-top:1px solid var(--border-color);">
        <input id="hubBotInput" type="text" placeholder="Ask anything..." style="flex:1; padding:10px; background: var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color: var(--text-main);">
        <button onclick="sendHubBotMessage('widget')" style="background: var(--primary-blue); color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer;">Send</button>
    </div>
</div>
<!-- Add User Modal -->
<div id="addUserModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center; animation: bounceIn 0.5s ease-out;">
    <div style="background:var(--card-bg); padding:30px; border-radius:12px; border:1px solid var(--border-color); width:420px; position:relative; animation: modalBounce 0.6s ease-out;">
        <h2 style="color:var(--primary-blue); margin-top:0;">Add User</h2>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Employee ID</label>
            <input type="text" id="newEmpId" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Employee name</label>
            <input type="text" id="newEmpName" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Email ID</label>
            <input type="email" id="newEmpEmail" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Role</label>
            <select id="newEmpRole" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
                <option value="User" selected>User</option>
                <option value="Admin">Admin</option>
            </select>
        </div>
        <div style="display:flex; gap:10px;">
            <button style="background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="saveNewUser()">Save User</button>
            <button style="background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="closeAddUserModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Add Role Modal -->
<div id="addRoleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center; animation: bounceIn 0.5s ease-out;">
    <div style="background:var(--card-bg); padding:30px; border-radius:12px; border:1px solid var(--border-color); width:420px; position:relative; animation: modalBounce 0.6s ease-out;">
        <h2 style="color:var(--primary-blue); margin-top:0;">Add Role</h2>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Role name</label>
            <input type="text" id="newRoleName" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>
        <div style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Course (from Course Mgmt)</label>
            <select id="newRoleCourse" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);"></select>
            <small style="color:var(--text-secondary);">Courses listed here come from the Course Management tab.</small>
        </div>
        <div style="display:flex; gap:10px;">
            <button style="background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="saveNewRole()">Save Role</button>
            <button style="background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="closeAddRoleModal()">Cancel</button>
        </div>
    </div>
</div>

<script type="module">
// Import Firestore functions
import { 
    saveUser, getAllUsers, getUserByEmail, updateUserRole, deleteUser,
    saveCourse, getAllCourses, deleteCourse,
    saveUserCourse, getUserCourses, deleteUserCourse,
    saveAnnouncement, getAllAnnouncements,
    migrateLocalStorageToFirestore,
    upsertLeaderboardEntry, getLeaderboardEntries
} from './firestore-db.js';

// Make functions globally available
window.firestoreDB = {
    saveUser, getAllUsers, getUserByEmail, updateUserRole, deleteUser,
    saveCourse, getAllCourses, deleteCourse,
    saveUserCourse, getUserCourses, deleteUserCourse,
    saveAnnouncement, getAllAnnouncements,
    migrateLocalStorageToFirestore,
    upsertLeaderboardEntry, getLeaderboardEntries
};

// Auto-migrate on first load
const userEmail = localStorage.getItem('userEmail');
if (userEmail && !localStorage.getItem('migrated_to_firestore')) {
    migrateLocalStorageToFirestore(userEmail).then(result => {
        if (result.success) {
            localStorage.setItem('migrated_to_firestore', 'true');
            console.log('Data migrated to Firestore successfully!');
            location.reload(); // Reload to load from Firestore
        }
    });
}
</script>

<script>
// Check if running through server (not file://)
if (window.location.protocol === 'file:') {
    alert('ERROR: Please access this app through the server!\n\nRun: npm start\nThen open: http://localhost:3000\n\nThe app cannot work from local files.');
    window.location.href = 'server-required.html';
}

function displayNews(newsArray) {
    const newsContainer = document.getElementById('news-container');
    const safeItems = Array.isArray(newsArray) ? newsArray : [];
    newsContainer.innerHTML = safeItems.map(item => {
        const url = (item && item.url) ? String(item.url).trim() : '';
        const hasGoodUrl = url && !isPlaceholderOrBadUrl(url);
        const linkHtml = hasGoodUrl
            ? `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary-blue); font-size: 13px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; background: rgba(66,133,244,0.1); border-radius: 6px; border: 1px solid var(--primary-blue); transition: all 0.2s;">
                <span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-news"></use></svg></span>
                Read Full Article 
            </a>`
            : `<div style="color:var(--text-secondary); font-size:12px; padding:6px 0;">Link unavailable (refreshing news...)</div>`;

        return `
        <div class="news-item">
            <span class="item-date" style="color: var(--primary-blue); font-size: 11px; font-weight: bold;">${item.date}</span>
            <div style="font-weight: 700; margin: 4px 0; color: var(--text-main); font-size: 14px;">${item.headline}</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 10px;">
                ${item.summary}
            </div>
            ${linkHtml}
        </div>
    `;
    }).join('');
}

function displayAIUpdates(items) {
    const container = document.getElementById('ai-updates-container');
    if (!container) return;

    if (!Array.isArray(items) || items.length === 0) {
        container.innerHTML = '<div class="news-item" style="color:var(--text-secondary);">No updates found.</div>';
        return;
    }

    container.innerHTML = items.map(item => `
        <div class="news-item">
            <span class="item-date" style="color: var(--primary-blue); font-size: 11px; font-weight: bold;">${item.date}</span>
            <div style="font-weight: 700; margin: 4px 0; color: var(--text-main); font-size: 14px;">${item.title}</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 10px;">
                ${item.summary}
            </div>
            <a href="${item.url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary-blue); font-size: 13px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; background: rgba(66,133,244,0.1); border-radius: 6px; border: 1px solid var(--primary-blue); transition: all 0.2s;">
                 Open Update 
            </a>
        </div>
    `).join('');
}

async function checkUrlAccessible(url) {
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 4500);
        const resp = await fetch(`/api/url/check?url=${encodeURIComponent(url)}`, { signal: controller.signal });
        clearTimeout(timeout);
        if (!resp.ok) return { ok: false, status: resp.status };
        return await resp.json();
    } catch (_) {
        // If the validator endpoint is unreachable, treat as NOT accessible.
        // This prevents users being sent to 404/error pages (hallucinated links).
        return { ok: false, reason: 'validator_unreachable' };
    }
}

function isPlaceholderOrBadUrl(url) {
    try {
        const u = new URL(url);
        const host = (u.hostname || '').toLowerCase();
        if (!host) return true;
        if (host === 'example.com' || host === 'example.org' || host === 'example.net') return true;
        return false;
    } catch (_) {
        return true;
    }
}

function isBlockedNewsDomain(url) {
    try {
        const u = new URL(url);
        const host = (u.hostname || '').toLowerCase();
        if (!host) return true;
        // Block known paywalled/login-first domains to keep news accessible.
        const blocked = [
            'bloomberg.com',
            'wsj.com',
            'ft.com',
            'economist.com',
            'nytimes.com',
            'theinformation.com',
        ];
        if (blocked.some(d => host === d || host.endsWith('.' + d))) return true;
        return false;
    } catch (_) {
        return true;
    }
}

function isLikelyHomepage(url) {
    try {
        const u = new URL(url);
        const path = (u.pathname || '').trim();
        return !path || path === '/' || path.length < 2;
    } catch (_) {
        return true;
    }
}

async function filterAccessibleItems(items, urlField = 'url') {
    if (!Array.isArray(items)) return [];
    const filtered = [];
    for (const item of items) {
        const url = (item && item[urlField]) ? String(item[urlField]).trim() : '';
        if (!url) continue;
        if (isPlaceholderOrBadUrl(url)) continue;
        if (isBlockedNewsDomain(url)) continue;
        if (isLikelyHomepage(url)) continue;
        const check = await checkUrlAccessible(url);
        const finalUrl = (check && check.finalUrl) ? String(check.finalUrl) : url;
        if (check && check.ok && !isPlaceholderOrBadUrl(finalUrl) && !isBlockedNewsDomain(finalUrl)) {
            filtered.push({ ...item, [urlField]: finalUrl });
        }
    }
    return filtered;
}

async function fetchAINews() {
    const newsContainer = document.getElementById('news-container');

    if (!newsContainer) return;

    // Fetch fresh news
    newsContainer.innerHTML = '<div class="news-item">Fetching real-time AI news...</div>';

    try {
        const today = promptTodayShortDate();
        const data = await callGeminiAPI(
            `Use Google Search to find exactly 10 REAL, ACCESSIBLE AI news articles published in the LAST 24 HOURS ONLY (today: ${today}).

Only use OPEN-ACCESS sources where employees can read the full article without paywall/login.

Preferred open sources (pick from these first):
- Official AI/company blogs (OpenAI, Google/DeepMind, Anthropic, Meta AI, Microsoft, NVIDIA)
- Hugging Face blog
- GitHub blog
- arXiv (papers)
- Major project release posts (PyTorch, TensorFlow, LangChain, etc.)

Avoid paywalled sources (do NOT use): Bloomberg, WSJ, Financial Times, The Economist.

CRITICAL REQUIREMENTS:
1. Articles MUST be from the LAST 24 HOURS ONLY
2. Sources MUST be reputable AND open-access. Prefer official blogs, arXiv, and release notes.
3. The "url" field MUST be the COMPLETE, DIRECT URL to the specific article page (not homepage)
4. URLs must be real, working links that users can click and read the full article WITHOUT login/paywall
5. NEVER use placeholder links like example.com (do not fabricate URLs)
6. Focus on TOP/TRENDING AI news stories only
7. Each article must have the actual publication date in "MMM D, YYYY" format
8. Summary should be 2-3 sentences about what the article covers

Return ONLY a valid JSON array with NO markdown formatting:
[{"date": "Jan 2, 2026", "headline": "Actual Article Title", "summary": "Clear 2-3 sentence summary of the article content", "url": "https://complete-direct-url-to-article"}]`,
            'gemini-2.5-flash'
        );

        if (data.error) throw new Error(data.error.message);

        const textResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const rawNewsArray = await parseJsonArrayFromGeminiText(
            textResponse,
            `[{"date":"${today}","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`
        );

        // Validate links via server so we don't show broken/blank articles
        let newsArray = await filterAccessibleItems(rawNewsArray, 'url');

        // If we got too few items after filtering, broaden slightly (still open-access) and merge.
        if (!newsArray || newsArray.length < 8) {
            const more = await callGeminiAPI(
                `Use Google Search to find 15 REAL, OPEN-ACCESS AI news links from the LAST 24 HOURS (today: ${today}).

Only include sources where the full article is readable without paywall/login.
Prefer: official AI/company blogs, Hugging Face blog, GitHub blog, arXiv, project release posts.

Return ONLY valid JSON array:
[{"date":"Jan 2, 2026","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`,
                'gemini-2.5-flash'
            );
            const txt = more?.candidates?.[0]?.content?.parts?.[0]?.text || '';
            const rawMore = await parseJsonArrayFromGeminiText(
                txt,
                `[{"date":"${today}","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`
            );
            const merged = [...rawNewsArray, ...(Array.isArray(rawMore) ? rawMore : [])];
            newsArray = await filterAccessibleItems(merged, 'url');
        }

        // Ensure we show a full set (up to 10). If validator is down, filterAccessibleItems will still pass safe URLs.
        if (Array.isArray(newsArray) && newsArray.length > 10) {
            newsArray = newsArray.slice(0, 10);
        }

        // If filtering removed everything, fall back to latest (last 7 days) so users still see real links
        if (!newsArray || newsArray.length === 0) {
            const fallback = await callGeminiAPI(
                `Use Google Search to find up to 10 REAL, ACCESSIBLE AI news articles from the LAST 7 DAYS (including today: ${today}).

Only use OPEN-ACCESS sources (no paywalls/logins). Prefer official AI blogs, Hugging Face, GitHub blog, arXiv, and project release posts.

CRITICAL REQUIREMENTS:
1. Prefer articles from the last 24 hours, but allow up to 7 days if needed
2. Provide COMPLETE, DIRECT article URLs (not homepages)
3. Avoid paywalls/login-only links
4. NEVER use placeholder links like example.com (do not fabricate URLs)

Return ONLY valid JSON array:
[{"date":"Jan 2, 2026","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`,
                'gemini-2.5-flash'
            );
            const txt = fallback?.candidates?.[0]?.content?.parts?.[0]?.text || '';
            const raw2 = await parseJsonArrayFromGeminiText(
                txt,
                `[{"date":"${today}","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`
            );
            newsArray = await filterAccessibleItems(raw2, 'url');
        }

        // If we still have too few (e.g., strict filtering), fill from raw list with safe non-placeholder URLs.
        if (Array.isArray(newsArray) && newsArray.length < 8) {
            const seen = new Set(newsArray.map(n => String(n.url || '').trim()));
            for (const it of (Array.isArray(rawNewsArray) ? rawNewsArray : [])) {
                if (newsArray.length >= 10) break;
                const u = String(it?.url || '').trim();
                if (!u || isPlaceholderOrBadUrl(u) || isBlockedNewsDomain(u) || isLikelyHomepage(u)) continue;
                if (seen.has(u)) continue;
                newsArray.push(it);
                seen.add(u);
            }
        }

        // Validate that we got proper news data
        if (Array.isArray(newsArray) && newsArray.length > 0) {
            displayNews(newsArray);
            console.log('Fetched and displayed fresh AI news');
        } else {
            throw new Error('Invalid news data received');
        }

    } catch (error) {
        console.error("AI News fetch error:", error);
        newsContainer.innerHTML = `<div class="news-item" style="color:#f85149; display:flex; gap:8px; align-items:flex-start;"><span class="ui-ico-wrap" aria-hidden="true" style="margin-top:2px;"><svg class="ui-ico"><use href="#ico-warning"></use></svg></span><div>Error loading news: ${error.message}<br><small>Please click Refresh News again.</small></div></div>`;
    }
}

async function fetchAIUpdates() {
    const container = document.getElementById('ai-updates-container');
    if (!container) return;

    container.innerHTML = '<div class="news-item">Fetching AI updates...</div>';

async function fetchUpdatesWithPrompt(prompt) {
    const data = await callGeminiAPI(
        prompt,
        'gemini-2.5-flash'
    );
    if (data.error) throw new Error(data.error.message);

    const textResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const today = promptTodayShortDate();
    const raw = await parseJsonArrayFromGeminiText(
        textResponse,
        `[{"date":"${today}","title":"Release title","summary":"What changed","url":"https://direct-url"}]`
    );
    return await filterAccessibleItems(raw, 'url');
    }

    try {
        const today = promptTodayShortDate();
        let filtered = await fetchUpdatesWithPrompt(
            `Use Google Search to find exactly 8 REAL AI updates from the LAST 24 HOURS ONLY (today: ${today}).

These are NOT general news headlinesfocus on releases/updates such as:
- New AI model releases or updates (OpenAI, Google, Anthropic, Meta, etc.)
- Framework/library releases (PyTorch, TensorFlow, Transformers, LangChain, etc.)
- Product feature launches (Copilots, assistants, API updates)
- Security/patch releases related to AI tooling

CRITICAL REQUIREMENTS:
1. Items MUST be from the last 24 hours only
2. Provide DIRECT, WORKING URLs (no homepages)
3. Avoid paywalls/login-only links
4. NEVER use placeholder links like example.com (do not fabricate URLs)
4. Each item must have a date "MMM D, YYYY"
5. Summary must be 1-2 sentences describing what changed/released

Return ONLY a valid JSON array with NO markdown:
[{"date":"Jan 2, 2026","title":"Release title","summary":"What changed","url":"https://direct-url"}]`
        );

        // If none found in last 24h, fall back to latest available updates (last 7 days)
        if (!filtered || filtered.length === 0) {
            filtered = await fetchUpdatesWithPrompt(
                `Use Google Search to find exactly 8 REAL AI updates from the LAST 7 DAYS (including today: ${today}).

Focus on releases/updates such as model releases, library/framework releases, and product update notes.

CRITICAL REQUIREMENTS:
1. Provide DIRECT, WORKING URLs (no homepages)
2. Avoid paywalls/login-only links
3. NEVER use placeholder links like example.com (do not fabricate URLs)
4. Each item must have a date "MMM D, YYYY"
5. Summary must be 1-2 sentences describing what changed/released

Return ONLY valid JSON array:
[{"date":"Jan 2, 2026","title":"Release title","summary":"What changed","url":"https://direct-url"}]`
            );
        }
        displayAIUpdates(filtered);
    } catch (error) {
        console.error('AI Updates fetch error:', error);
        container.innerHTML = `<div class="news-item" style="color:#f85149; display:flex; gap:8px; align-items:flex-start;"><span class="ui-ico-wrap" aria-hidden="true" style="margin-top:2px;"><svg class="ui-ico"><use href="#ico-warning"></use></svg></span><div>Error loading updates: ${error.message}</div></div>`;
    }
}

async function updateAnnouncements() {
    const container = document.getElementById('announcements-container');
    if (!container) return;

    // Get announcements from shared API storage
    const announcements = await getSharedAnnouncements();
    const hasStartedTechAssessment = localStorage.getItem('initialAssessmentStarted') === 'true';

    const items = [];
    if (!hasStartedTechAssessment) {
        items.push({ date: 'Urgent', message: 'New Technical Gateway Assessment is now live.', type: 'system' });
    }
    announcements.forEach(a => items.push({ date: a.date || '', message: a.message, type: a.type || 'general' }));

    if (items.length === 0) {
        container.innerHTML = '<div class="announcement-item" style="color:var(--text-secondary);">No announcements.</div>';
        return;
    }

    container.innerHTML = items.map(item => `
        <div class="announcement-item">
            ${item.date ? `<span class="item-date" style="color: var(--primary-blue); font-size: 11px; margin-right:6px;">${item.date}</span>` : ''}
            <span style="color:var(--text-main)">${item.message}</span>
        </div>
    `).join('');
}

function updateGreeting() {
    const hour = new Date().getHours();
    const greetingElement = document.getElementById('timeGreeting');
    let timeMsg = "";

    if (hour < 12) timeMsg = "Good Morning, ";
    else if (hour < 18) timeMsg = "Good Afternoon, ";
    else timeMsg = "Good Evening, ";

    if (greetingElement) {
        greetingElement.innerText = timeMsg + "Welcome to the Hub.";
    }
}

function switchTab(viewId, element) {
    // Hide all sections
    document.querySelectorAll('main > section').forEach(section => {
        section.style.display = 'none';
    });
    // Show the selected section
    document.getElementById(viewId).style.display = 'block';

    // Persist current view so refresh stays on the same page.
    try {
        localStorage.setItem('oo_active_view', viewId);
    } catch (_) {}
    try {
        const base = `${window.location.pathname || ''}${window.location.search || ''}`;
        if (history && typeof history.replaceState === 'function') {
            history.replaceState(null, '', `${base}#${viewId}`);
        } else {
            window.location.hash = viewId;
        }
    } catch (_) {}

    // Update active sidebar item
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
    });

    const safeElement = element || document.querySelector(`.sidebar-item[onclick*="'${viewId}'"]`);
    if (safeElement) {
        safeElement.classList.add('active');
    }
    // Load content if needed
    if (viewId === 'courses-view') {
        loadCoursesView();
    } else if (viewId === 'role-mgmt-view') {
        loadRoles();
    } else if (viewId === 'my-progress-view') {
        loadMyProgress();
    } else if (viewId === 'leaderboard-view') {
        loadLeaderboard();
    } else if (viewId === 'quick-learning-view') {
        loadQuickLearning(false);
    } else if (viewId === 'activity-logs-view') {
        loadActivityLogs();
    } else if (viewId === 'showcase-view') {
        if (window.showcaseForum && typeof window.showcaseForum.onOpen === 'function') {
            window.showcaseForum.onOpen();
        }
    }
}

function initSidebarTooltips() {
    try {
        document.querySelectorAll('.sidebar-item').forEach((item) => {
            const label = item.querySelector('.sidebar-text');
            const text = (label && label.textContent ? label.textContent : '').trim();
            if (!text) return;
            item.setAttribute('data-tooltip', text);
            // Fallback: native tooltip if CSS pseudo-tooltip is blocked by layout.
            if (!item.getAttribute('title')) item.setAttribute('title', text);
        });
    } catch (_) {}
}

function enableSidebarHoverOverlayTooltips() {
    try {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar) return;

        let tip = document.getElementById('ooSidebarTooltip');
        if (!tip) {
            tip = document.createElement('div');
            tip.id = 'ooSidebarTooltip';
            tip.style.cssText = [
                'position:fixed',
                'left:-9999px',
                'top:-9999px',
                'opacity:0',
                'pointer-events:none',
                'z-index:999999',
                'background:var(--card-bg)',
                'border:1px solid var(--border-color)',
                'color:var(--text-main)',
                'padding:8px 10px',
                'border-radius:10px',
                'white-space:nowrap',
                'box-shadow:0 14px 30px rgba(0,0,0,0.35)',
                'transition:opacity 0.12s ease'
            ].join(';');
            document.body.appendChild(tip);
        }

        const hide = () => {
            tip.style.opacity = '0';
            tip.style.left = '-9999px';
            tip.style.top = '-9999px';
        };

        const showFor = (item) => {
            if (!item) return;
            if (sidebar.classList.contains('expanded')) return hide();

            const text = String(item.getAttribute('data-tooltip') || item.getAttribute('title') || '').trim();
            if (!text) return hide();

            tip.textContent = text;

            const rect = item.getBoundingClientRect();
            const x = rect.right + 10;
            let y = rect.top + rect.height / 2;

            // Keep on-screen vertically.
            const margin = 10;
            const tipRect = tip.getBoundingClientRect();
            const halfH = (tipRect.height || 36) / 2;
            y = Math.max(margin + halfH, Math.min(window.innerHeight - margin - halfH, y));

            tip.style.left = `${Math.round(x)}px`;
            tip.style.top = `${Math.round(y)}px`;
            tip.style.transform = 'translateY(-50%)';
            tip.style.opacity = '1';
        };

        sidebar.addEventListener('mouseenter', (e) => {
            const item = e.target && e.target.closest ? e.target.closest('.sidebar-item') : null;
            if (item) showFor(item);
        }, true);

        sidebar.addEventListener('mousemove', (e) => {
            const item = e.target && e.target.closest ? e.target.closest('.sidebar-item') : null;
            if (item) showFor(item);
        }, true);

        sidebar.addEventListener('mouseleave', () => hide(), true);
        window.addEventListener('scroll', () => hide(), true);
        window.addEventListener('resize', () => hide(), true);
    } catch (_) {}
}

function getPreferredInitialViewId() {
    try {
        const hash = (window.location.hash || '').replace(/^#/, '').trim();
        if (hash) return hash;
    } catch (_) {}

    try {
        return (localStorage.getItem('oo_active_view') || '').trim();
    } catch (_) {
        return '';
    }
}

function isAdminOnlyView(viewId) {
    return viewId === 'course-mgmt-view' || viewId === 'role-mgmt-view' || viewId === 'activity-logs-view';
}

function restorePreferredInitialView() {
    const target = getPreferredInitialViewId();
    if (!target) return false;
    if (!document.getElementById(target)) return false;

    try {
        const role = (localStorage.getItem('userRole') || '').toLowerCase();
        if (isAdminOnlyView(target) && role !== 'admin') return false;
    } catch (_) {}

    switchTab(target, null);
    return true;
}

// Restore view as early as possible so a refresh doesn't flash/reset to Home.
document.addEventListener('DOMContentLoaded', () => {
    initSidebarTooltips();
    enableSidebarHoverOverlayTooltips();
    try { restorePreferredInitialView(); } catch (_) {}
});

// Listen for unread count updates from embedded TalkSpace
(function initTalkspaceUnreadBadge() {
    const badge = document.getElementById('talkspaceUnreadBadge');
    const frame = document.getElementById('talkspaceFrame');
    if (!badge) return;

    function setBadge(count) {
        const n = Math.max(0, Number(count) || 0);
        if (n > 0) {
            badge.textContent = n > 99 ? '99+' : String(n);
            badge.style.display = 'inline-flex';
        } else {
            badge.textContent = '';
            badge.style.display = 'none';
        }
    }

    window.addEventListener('message', (event) => {
        const data = event && event.data;
        if (!data || typeof data !== 'object') return;
        if (data.type !== 'talkspace_unread') return;
        if (frame && event.source && frame.contentWindow && event.source !== frame.contentWindow) return;
        setBadge(data.count);
    });
})();

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if (sidebar.classList.contains('expanded')) {
        sidebar.classList.remove('expanded');
        if (mainContent) mainContent.style.marginLeft = '';
    } else {
        sidebar.classList.add('expanded');
        if (mainContent) mainContent.style.marginLeft = '';
    }
}

function toggleTheme(theme) {
    if (theme === 'light') {
        document.body.classList.add('light-theme');
    } else {
        document.body.classList.remove('light-theme');
    }
    localStorage.setItem('hubTheme', theme);
    // Update logo if needed
    const logo = document.getElementById('mainLogo');
    if (logo) {
        logo.src = theme === 'light' ? 'new oneorigin semi arch (1) 1 (5).png' : 'oo new semi arch white blue (4).png';
    }
}

function deriveNameFromEmail(email) {
    if (!email) return '';
    const local = email.split('@')[0] || '';
    const parts = local.split(/[._]/).filter(Boolean);
    if (parts.length === 0) return '';
    return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
}

function setUserBadge() {
    const badge = document.getElementById('userName');
    if (!badge) return;
    const email = localStorage.getItem('userEmail') || '';
    const stored = (localStorage.getItem('userName') || '').trim();
    const derived = deriveNameFromEmail(email);
    badge.textContent = stored || derived || 'User';
}

// Quick insert helper for Hub Bot prompt chips
function hubBotInsert(text) {
    const input = document.getElementById('hubBotPageInput');
    if (!input) return;
    input.value = text;
    input.focus();
}

window.onload = async () => {
    try { console.log('[OneOrigin] dashboard build: 2026-02-07.2'); } catch (_) {}
    // Check if user is logged in - redirect to login if not
    const userEmail = localStorage.getItem('userEmail');
    if (!userEmail) {
        window.location.href = 'index.html';
        return;
    }
    
    // Cloud-backed auto-registration + role sync + reset flag (fallback to local only if cloud not available)
    const __userSyncPromise = (async () => {
        const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
        const now = new Date().toLocaleString();
        const displayName = (localStorage.getItem('userName') || '').trim() || deriveNameFromEmail(userEmail);

        try {
            if (window.upsertSharedUser && window.getSharedUserByEmail) {
                // Upsert ensures user exists in Firestore and updates lastActive
                await window.upsertSharedUser({
                    email: userEmail,
                    name: displayName,
                    lastActive: now
                });

                const me = await window.getSharedUserByEmail(userEmail);
                if (me?.role) {
                    localStorage.setItem('userRole', String(me.role).toLowerCase() === 'admin' ? 'admin' : 'user');
                }
                if (me?.employeeId) {
                    localStorage.setItem('employeeId', me.employeeId);
                }

                if (me?.resetAssessmentFlag === true && window.setUserResetAssessmentFlag) {
                    localStorage.removeItem('initialAssessmentScore');
                    localStorage.removeItem('userLevel');
                    localStorage.removeItem('initialAssessmentStarted');
                    localStorage.setItem('assignedCourses', '[]');
                    localStorage.removeItem('upcomingCourse');
                    await window.setUserResetAssessmentFlag(userEmail, false);
                    console.log('Assessment data cleared for user via cloud flag:', userEmail);
                }

                // Ensure superadmin stays admin in local session
                if (String(userEmail).toLowerCase() === SUPERADMIN_EMAIL.toLowerCase()) {
                    localStorage.setItem('userRole', 'admin');
                }

                return;
            }
        } catch (e) {
            console.warn('Cloud user sync failed; using local fallback', e);
        }

        // Local fallback (single-device)
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const existingUserIndex = users.findIndex(u => u.email && u.email.toLowerCase() === userEmail.toLowerCase());

        if (existingUserIndex === -1 && userEmail.toLowerCase() !== SUPERADMIN_EMAIL.toLowerCase()) {
            const newUser = {
                employeeId: 'EMP-' + Date.now(),
                name: displayName,
                email: userEmail,
                role: 'User',
                lastActive: now
            };
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('userRole', 'User');
        } else if (existingUserIndex !== -1) {
            users[existingUserIndex].lastActive = now;
            if (users[existingUserIndex].resetAssessmentFlag === true) {
                localStorage.removeItem('initialAssessmentScore');
                localStorage.removeItem('userLevel');
                localStorage.removeItem('initialAssessmentStarted');
                localStorage.setItem('assignedCourses', '[]');
                localStorage.removeItem('upcomingCourse');
                delete users[existingUserIndex].resetAssessmentFlag;
            }
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('userRole', users[existingUserIndex].role || 'User');
        }
    })();
    
    // Generate Static Title
    const titleText = "OneOrigin Learning Hub";
    const titleContainer = document.getElementById('bouncingTitle');
    if (titleContainer) {
        titleContainer.innerHTML = "";
        titleText.split("").forEach((char) => {
            const span = document.createElement('span');
            if (char === " ") {
                span.className = "space";
                span.style.width = "10px";
            } else {
                span.innerText = char;
            }
            titleContainer.appendChild(span);
        });
    }

    // Update Dynamic Time-Based Greeting
    updateGreeting();

    // Fetch AI News
    fetchAINews();
    fetchAIUpdates();

    // Load saved theme
    const savedTheme = localStorage.getItem('hubTheme') || 'dark';
    toggleTheme(savedTheme);
    document.getElementById('themeToggle').value = savedTheme;

    // Backup and restore data from sessionStorage to prevent data loss
    backupAndRestoreData();

    // Update badge using email-derived full name when available
    setUserBadge();

    // Initialize role-based access control (SUPERADMIN logic is here)
    await __userSyncPromise;
    await syncCurrentUserRole();
    checkAdminStatus();
    
    // Load all course data
    loadCourses();
    loadCoursesView();
    const searchInput = document.getElementById('courseSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => loadCoursesView(e.target.value));
    }

    // Quick learning no longer uses topic search; it loads the SimplilearnOfficial Shorts feed.

    // Activity logs: live filter
    try {
        const f = document.getElementById('activityLogsFilter');
        if (f && !f.__filterHooked) {
            f.addEventListener('input', () => renderActivityLogsFromCache());
            f.__filterHooked = true;
        }
    } catch (_) {}
    loadAssignedCourses();
    
    // Load user and role data
    updateAnnouncements();
    // These may be async (cloud-backed)
    Promise.resolve(loadUsers()).catch(() => {});
    Promise.resolve(loadRoles()).catch(() => {});

    // Initialize collapsed-sidebar hover labels and restore the last active view.
    initSidebarTooltips();
    enableSidebarHoverOverlayTooltips();
    if (!restorePreferredInitialView()) {
        switchTab('home-view', null);
    }
};

// =====================
// Quick learning (Shorts-style)
// =====================

window.__quickLearningItems = window.__quickLearningItems || [];
window.__quickLearningIndex = Number(window.__quickLearningIndex || 0);

function quickLearningBackdropClick(event) {
    if (event && event.target && event.target.id === 'quickLearningOverlay') {
        closeQuickLearningOverlay();
    }
}

function closeQuickLearningOverlay() {
    const overlay = document.getElementById('quickLearningOverlay');
    if (overlay) overlay.style.display = 'none';
    const frame = document.getElementById('quickLearningOverlayFrame');
    if (frame) frame.src = 'about:blank';
}

function setQuickLearningOverlayIndex(idx) {
    const items = Array.isArray(window.__quickLearningItems) ? window.__quickLearningItems : [];
    if (!items.length) return;
    const i = Math.max(0, Math.min(items.length - 1, Number(idx) || 0));
    window.__quickLearningIndex = i;
    const item = items[i] || {};

    const titleEl = document.getElementById('quickLearningOverlayTitle');
    const subEl = document.getElementById('quickLearningOverlaySub');
    const frame = document.getElementById('quickLearningOverlayFrame');
    const notice = document.getElementById('quickLearningOverlayNotice');
    if (titleEl) titleEl.textContent = String(item.title || 'Quick learning');
    if (subEl) subEl.textContent = String(item.authorName || item.authorUrl || '');

    const token = (window.__quickLearningOverlayToken = Number(window.__quickLearningOverlayToken || 0) + 1);
    const vid = String(item.videoId || '').trim();
    if (notice) {
        notice.style.display = 'none';
        notice.textContent = '';
    }

    if (!frame) return;
    if (!vid) {
        frame.src = 'about:blank';
        return;
    }

    // Set a placeholder immediately, then validate embeddability best-effort.
    frame.src = `https://www.youtube.com/embed/${encodeURIComponent(vid)}?playsinline=1&rel=0&autoplay=1&mute=1`;

    (async () => {
        try {
            const resp = await fetch(`/api/youtube/check?videoId=${encodeURIComponent(vid)}`);
            if (Number(window.__quickLearningOverlayToken || 0) !== token) return;
            if (resp.status === 404) return;
            const info = resp.ok ? await resp.json() : null;
            if (!info || info.ok !== true) {
                if (notice) {
                    notice.textContent = 'This Short cannot be embedded here. Use Watch on YouTube.';
                    notice.style.display = 'flex';
                }
                // Keep the frame as-is; YouTube will show its own message, but we provide a clear fallback.
            } else {
                if (titleEl && info.title) titleEl.textContent = String(info.title);
                if (subEl) subEl.textContent = String(info.authorName || info.authorUrl || item.authorName || item.authorUrl || '');
            }
        } catch (_) {
            // Ignore validation failures; embed may still work.
        }
    })();
}

function openQuickLearningOverlay(index) {
    const overlay = document.getElementById('quickLearningOverlay');
    if (!overlay) return;
    overlay.style.display = 'flex';
    setQuickLearningOverlayIndex(index);
}

function quickLearningNext() {
    const items = Array.isArray(window.__quickLearningItems) ? window.__quickLearningItems : [];
    if (!items.length) return;
    const i = Number(window.__quickLearningIndex || 0);
    setQuickLearningOverlayIndex(Math.min(items.length - 1, i + 1));
}

function quickLearningPrev() {
    const items = Array.isArray(window.__quickLearningItems) ? window.__quickLearningItems : [];
    if (!items.length) return;
    const i = Number(window.__quickLearningIndex || 0);
    setQuickLearningOverlayIndex(Math.max(0, i - 1));
}

function openQuickLearningOnYouTube() {
    const items = Array.isArray(window.__quickLearningItems) ? window.__quickLearningItems : [];
    const i = Number(window.__quickLearningIndex || 0);
    const vid = String(items[i]?.videoId || '').trim();
    if (!vid) return;
    window.open(`https://www.youtube.com/shorts/${encodeURIComponent(vid)}`, '_blank', 'noopener');
}

// Keyboard + swipe navigation for the overlay
(function initQuickLearningOverlayNav() {
    try {
        document.addEventListener('keydown', (e) => {
            const overlay = document.getElementById('quickLearningOverlay');
            if (!overlay || overlay.style.display !== 'flex') return;
            if (e.key === 'ArrowDown' || e.key === 'PageDown') {
                e.preventDefault();
                quickLearningNext();
            } else if (e.key === 'ArrowUp' || e.key === 'PageUp') {
                e.preventDefault();
                quickLearningPrev();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                closeQuickLearningOverlay();
            }
        }, { passive: false });

        // Use document-level delegation so this works even if the overlay element
        // doesn't exist yet at script evaluation time.
        let startY = null;
        document.addEventListener('touchstart', (e) => {
            const overlay = document.getElementById('quickLearningOverlay');
            if (!overlay || overlay.style.display !== 'flex') return;
            const within = e?.target && overlay.contains ? overlay.contains(e.target) : false;
            if (!within) return;
            const y = e?.touches?.[0]?.clientY;
            startY = typeof y === 'number' ? y : null;
        }, { passive: true });
        document.addEventListener('touchend', (e) => {
            const overlay = document.getElementById('quickLearningOverlay');
            if (!overlay || overlay.style.display !== 'flex') return;
            if (startY === null) return;
            const endY = e?.changedTouches?.[0]?.clientY;
            if (typeof endY !== 'number') return;
            const delta = endY - startY;
            const threshold = 40;
            if (delta <= -threshold) quickLearningNext();
            else if (delta >= threshold) quickLearningPrev();
            startY = null;
        }, { passive: true });
    } catch (_) {}
})();

function ooPickQuickLearningTopics() {
    const topics = [];
    try {
        const assigned = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
        if (Array.isArray(assigned)) {
            for (const a of assigned) {
                const t = String(a?.topic || '').trim();
                if (t) topics.push(t);
            }
        }
    } catch (_) {}

    // Fallback: derive from course names
    if (topics.length < 2) {
        try {
            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
            const names = Array.isArray(courses) ? courses.map(c => String(c?.name || '').trim()).filter(Boolean) : [];
            topics.push(...names);
        } catch (_) {}
    }

    const stop = new Set([
        'the','and','for','with','from','this','that','you','your','into','about','what','when','where','how',
        'course','courses','tutorial','tutorials','beginner','intermediate','advanced','full','complete','guide',
        'learn','learning','official','video','videos','short','shorts','episode','part','in','on','of','to','a','an'
    ]);

    const counts = new Map();
    for (const raw of topics) {
        const words = String(raw || '').toLowerCase().replace(/[^a-z0-9\s]/g, ' ').split(/\s+/).filter(Boolean);
        for (const w of words) {
            if (w.length < 3) continue;
            if (stop.has(w)) continue;
            counts.set(w, (counts.get(w) || 0) + 1);
        }
    }

    const ranked = [...counts.entries()].sort((a, b) => b[1] - a[1]).map(([w]) => w);
    const defaults = ['ai','python','javascript','sql','react','node','cloud','docker','kubernetes','llm','transformer'];
    const picked = [...new Set([...ranked.slice(0, 6), ...defaults])];
    return picked.slice(0, 6);
}

function clearQuickLearningCache() {
    try { localStorage.removeItem('oo_quick_learning_simplilearn_shorts_v1'); } catch (_) {}
    try { localStorage.removeItem('oo_quick_learning_simplilearn_shorts_v1_meta'); } catch (_) {}
    window.__quickLearningItems = [];
    const statusEl = document.getElementById('quickLearningStatus');
    const grid = document.getElementById('quickLearningGrid');
    if (statusEl) statusEl.textContent = 'Cache cleared. Click Refresh feed to reload.';
    if (grid) grid.innerHTML = '<div style="color:var(--text-secondary);">Cache cleared.</div>';
}

async function loadQuickLearning(forceRefresh) {
    const grid = document.getElementById('quickLearningGrid');
    const statusEl = document.getElementById('quickLearningStatus');
    if (!grid || !statusEl) return;

    const CACHE_KEY = 'oo_quick_learning_simplilearn_shorts_v1';
    const now = Date.now();
    const ttlMs = 1000 * 60 * 60 * 12; // 12 hours
    const force = !!forceRefresh;

    const render = (items, meta) => {
        const list = Array.isArray(items) ? items : [];
        if (!list.length) {
            statusEl.textContent = 'No Shorts found.';
            grid.innerHTML = '<div style="color:var(--text-secondary);">No videos found.</div>';
            return;
        }

        const total = list.length;
        const showCount = Math.min(60, total);
        const shown = list.slice(0, showCount);
        const updated = meta && meta.tsMs ? new Date(meta.tsMs).toLocaleString() : '';
        statusEl.textContent = `Showing ${showCount} of ${total} Shorts${updated ? `  Cached: ${updated}` : ''}`;
        grid.innerHTML = '';

        window.__quickLearningItems = list;
        shown.forEach((v, index) => {
            const card = document.createElement('div');
            card.className = 'course-card';
            const title = String(v.title || '').trim() || `Simplilearn Short #${index + 1}`;
            const author = String(v.authorName || '').trim() || 'SimplilearnOfficial';
            card.innerHTML = `
                <div onclick="openQuickLearningOverlay(${index})">
                    <img src="https://img.youtube.com/vi/${encodeURIComponent(v.videoId)}/hqdefault.jpg" alt="${escapeHtml(title)}" style="width: 100%; height: auto; border-radius:8px; margin-bottom: 10px; display: block;">
                </div>
                <p style="margin:10px 0 5px 0; text-align:center; color:var(--text-main); font-weight:500;">${escapeHtml(title)}</p>
                <small style="color:var(--text-secondary); text-align:center; display:block;">${escapeHtml(author)}</small>
                <div style="display:flex; justify-content:center; gap:10px; margin-top:12px; flex-wrap:wrap;">
                    <button class="btn-secondary" onclick="event.stopPropagation(); openQuickLearningOverlay(${index})">Open</button>
                    <button class="btn-secondary" onclick="event.stopPropagation(); window.open('https://www.youtube.com/shorts/${encodeURIComponent(v.videoId)}','_blank','noopener')">YouTube</button>
                </div>
            `;
            grid.appendChild(card);
        });
    };

    if (!force && Array.isArray(window.__quickLearningItems) && window.__quickLearningItems.length) {
        // Already loaded in this session.
        render(window.__quickLearningItems, null);
        return;
    }

    // Try local cache first.
    if (!force) {
        try {
            const cachedRaw = localStorage.getItem(CACHE_KEY);
            const cached = cachedRaw ? JSON.parse(cachedRaw) : null;
            const tsMs = Number(cached?.tsMs || 0);
            const ids = Array.isArray(cached?.videoIds) ? cached.videoIds : [];
            if (tsMs && (now - tsMs) < ttlMs && ids.length) {
                const items = ids.map((id, idx) => ({
                    videoId: String(id),
                    title: `Simplilearn Short #${idx + 1}`,
                    authorName: 'SimplilearnOfficial',
                    authorUrl: 'https://www.youtube.com/@SimplilearnOfficial'
                }));
                render(items, { tsMs });
                return;
            }
        } catch (_) {}
    }

    statusEl.textContent = 'Loading SimplilearnOfficial Shorts';
    grid.innerHTML = '<div style="color:var(--text-secondary);">Loading</div>';

    try {
        let apiMissing = false;
        const resp = await fetch(`/api/youtube/channel-shorts?handle=SimplilearnOfficial&max=1000`);
        if (resp.status === 404) apiMissing = true;
        const data = (!apiMissing && resp.ok) ? await resp.json() : { ok: false, videoIds: [] };
        const ids = Array.isArray(data?.videoIds) ? data.videoIds : [];

        if (apiMissing) {
            statusEl.textContent = 'Quick learning API not found (404).';
            grid.innerHTML = `
                <div style="color:var(--text-secondary); line-height:1.6;">
                    <div style="color:var(--text-main); font-weight:800; margin-bottom:6px;">Looks like the app is running without the backend.</div>
                    <div>Quick learning needs the local server to provide <b>/api/youtube/channel-shorts</b> and <b>/api/youtube/check</b>.</div>
                    <div style="margin-top:10px;">Start it with: <b>npm start</b> (or <b>npm run dev</b>)</div>
                    <div>Then open: <b>http://localhost:3000/dashboard.html</b> (avoid Live Server for this page).</div>
                </div>
            `;
            return;
        }

        if (!ids.length) {
            statusEl.textContent = 'No Shorts found.';
            grid.innerHTML = '<div style="color:var(--text-secondary);">No videos found from the channel. Try Refresh feed.</div>';
            return;
        }

        // Persist in local cache so the feed doesn't reload every app open.
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify({ tsMs: now, videoIds: ids }));
        } catch (_) {}

        const items = ids.map((id, idx) => ({
            videoId: String(id),
            title: `Simplilearn Short #${idx + 1}`,
            authorName: 'SimplilearnOfficial',
            authorUrl: 'https://www.youtube.com/@SimplilearnOfficial'
        }));

        render(items, { tsMs: now });
    } catch (e) {
        console.error('Quick learning load failed:', e);
        statusEl.textContent = 'Failed to load.';
        grid.innerHTML = '<div style="color:var(--text-secondary);">Failed to load videos. Please try again.</div>';
    }
}

// =====================
// Activity Logs (admin)
// =====================

window.__activityLogsCache = window.__activityLogsCache || [];

function renderActivityLogsFromCache() {
    const logs = Array.isArray(window.__activityLogsCache) ? window.__activityLogsCache : [];
    const filterValue = (document.getElementById('activityLogsFilter')?.value || '').trim().toLowerCase();
    const filtered = !filterValue
        ? logs
        : logs.filter(l => {
            const blob = [
                l?.actorEmail,
                l?.actorName,
                l?.actorRole,
                l?.action,
                l?.summary,
                l?.entityType,
                l?.entityId,
                l?.source,
                JSON.stringify(l?.details || {}),
            ].join(' ').toLowerCase();
            return blob.includes(filterValue);
        });

    const tbody = document.getElementById('activityLogsTableBody');
    if (!tbody) return;
    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="4" style="color:var(--text-secondary);">No activity yet.</td></tr>';
        return;
    }

    const formatWhen = (log) => {
        const ms = Number(log?.tsMs || 0);
        if (ms) return new Date(ms).toLocaleString();
        const iso = String(log?.tsIso || '').trim();
        if (iso) {
            const d = new Date(iso);
            if (!Number.isNaN(d.getTime())) return d.toLocaleString();
        }
        return '-';
    };

    tbody.innerHTML = filtered.map(l => {
        const who = [l?.actorName, l?.actorEmail].filter(Boolean).join('  ') || (l?.actorEmail || '-');
        const action = l?.action || '-';
        const summary = l?.summary || '';
        const entity = [l?.entityType, l?.entityId].filter(Boolean).join(': ');
        const source = l?.source ? `Source: ${l.source}` : '';
        const sub = [entity, source].filter(Boolean).join('  ');
        return `
            <tr>
                <td style="white-space:nowrap; color:var(--text-secondary);">${escapeHtml(formatWhen(l))}</td>
                <td>${escapeHtml(who)}</td>
                <td><span style="color:var(--primary-blue); font-weight:900;">${escapeHtml(action)}</span></td>
                <td>
                    <div style="color:var(--text-main); font-weight:700;">${escapeHtml(summary)}</div>
                    ${sub ? `<div style="color:var(--text-secondary); font-size:12px; margin-top:4px;">${escapeHtml(sub)}</div>` : ''}
                </td>
            </tr>
        `;
    }).join('');
}

async function loadActivityLogs() {
    const tbody = document.getElementById('activityLogsTableBody');
    if (!tbody) return;

    if (!isAdminSession()) {
        tbody.innerHTML = '<tr><td colspan="4" style="color:var(--text-secondary);">Admins only.</td></tr>';
        return;
    }

    tbody.innerHTML = '<tr><td colspan="4" style="color:var(--text-secondary);">Loading</td></tr>';
    try {
        const logs = window.getActivityLogs ? await window.getActivityLogs(200) : [];
        window.__activityLogsCache = Array.isArray(logs) ? logs : [];
        renderActivityLogsFromCache();
    } catch (e) {
        console.error('Failed loading activity logs:', e);
        tbody.innerHTML = '<tr><td colspan="4" style="color:var(--text-secondary);">Failed to load logs.</td></tr>';
    }
}

// Backup data to sessionStorage and restore if localStorage is cleared
function backupAndRestoreData() {
    // List of keys to backup
    const keysToBackup = ['users', 'courses', 'announcements', 'userCourses'];
    
    // Backup: Copy from localStorage to sessionStorage
    keysToBackup.forEach(key => {
        const data = localStorage.getItem(key);
        if (data && data !== '[]' && data !== 'null') {
            sessionStorage.setItem(key + '_backup', data);
        }
    });
    
    // Restore only if the key is truly missing (not when intentionally an empty array)
    keysToBackup.forEach(key => {
        const localData = localStorage.getItem(key);
        const backupData = sessionStorage.getItem(key + '_backup');
        
        if ((localData === null || localData === 'null') && backupData) {
            localStorage.setItem(key, backupData);
        }
    });
}

</script>

<!-- In-app course player overlay -->
<div id="coursePlayerOverlay" class="course-player-overlay" onclick="overlayBackdropClick(event)">
    <div class="course-player-content">
        <div class="course-player-header">
            <span id="coursePlayerTitle">Now Playing</span>
            <button class="course-player-close" onclick="closeCoursePlayer()"></button>
        </div>
        <div class="course-player-frame">
            <div id="coursePlayerFrame" style="width:100%; height:100%;"></div>
            <button id="coursePlayerPlay" class="course-player-play" onclick="startCoursePlayer()"></button>
        </div>
        <div id="coursePlayerInfoPanel" style="margin-top: 15px; padding: 15px; background: rgba(66,133,244,0.1); border: 1px solid var(--primary-blue); border-radius: 8px; text-align: center;">
            <div style="font-size: 11px; color: var(--text-secondary); font-family: monospace;">
                Video ID: <span id="coursePlayerVideoId" style="color: var(--primary-blue); font-weight: bold;">-</span>
            </div>

            <div style="margin-top: 12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                <button id="coursePlayerAssessmentBtn" class="btn-secondary" onclick="startCatalogAssessmentFromPlayer()" disabled>Take Assessment</button>
            </div>
            <div id="coursePlayerAssessmentHint" style="margin-top:8px; font-size:12px; color:var(--text-secondary);">Finish watching the full video to unlock the assessment.</div>
        </div>
    </div>
</div>

<!-- Quick learning (Shorts-style) overlay -->
<div id="quickLearningOverlay" class="quick-learning-overlay" onclick="quickLearningBackdropClick(event)">
    <div class="quick-learning-modal">
        <div class="quick-learning-modal-head">
            <div class="quick-learning-modal-title">
                <b id="quickLearningOverlayTitle">Quick learning</b>
                <span id="quickLearningOverlaySub"></span>
            </div>
            <button class="course-player-close" onclick="closeQuickLearningOverlay()"></button>
        </div>
        <div class="quick-learning-viewport" id="quickLearningOverlayViewport">
            <iframe id="quickLearningOverlayFrame" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            <div id="quickLearningOverlayNotice" class="quick-learning-embed-notice" style="display:none;"></div>
        </div>
        <div class="quick-learning-modal-actions">
            <div class="quick-learning-nav">
                <button class="btn-secondary" onclick="quickLearningPrev()">Prev</button>
                <button class="btn-secondary" onclick="quickLearningNext()">Next</button>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                <button class="btn-secondary" onclick="openQuickLearningOnYouTube()">Watch on YouTube</button>
            </div>
        </div>
    </div>
</div>

<!-- Admin: View employee course progress -->
<div id="employeeProgressModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.82); z-index:3500; align-items:center; justify-content:center;">
    <div style="background:var(--card-bg); border:1px solid var(--border-color); border-radius:12px; width:min(980px, 96vw); max-height:86vh; overflow:hidden; box-shadow:0 18px 48px rgba(0,0,0,0.55);">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border-color);">
            <div>
                <div id="employeeProgressTitle" style="color:var(--text-main); font-weight:900; font-size:16px;">User Progress</div>
                <div id="employeeProgressSub" style="color:var(--text-secondary); font-size:12px; margin-top:2px;"></div>
            </div>
            <button class="course-player-close" onclick="closeEmployeeProgressModal()"></button>
        </div>
        <div style="padding:14px 16px; overflow:auto; max-height: calc(86vh - 58px);">
            <div id="employeeProgressBody" style="color:var(--text-secondary);">Loading</div>
        </div>
    </div>
</div>

<!-- Course assessment overlay (Courses catalog) -->
<div id="courseAssessmentOverlay" class="assessment-overlay" onclick="courseAssessmentBackdropClick(event)">
    <div class="assessment-modal">
        <div class="assessment-modal-head">
            <div class="assessment-modal-title">
                <b id="courseAssessmentTitle">Course Assessment</b>
                <span id="courseAssessmentMeta"></span>
            </div>
            <button class="course-player-close" onclick="closeCourseAssessment()"></button>
        </div>
        <div class="assessment-modal-body">
            <div id="courseAssessmentBody" style="color:var(--text-secondary);">Loading</div>
        </div>
    </div>
</div>

<div id="addCourseModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center; animation: bounceIn 0.5s ease-out;">
    <div style="background:var(--card-bg); padding:30px; border-radius:12px; border:1px solid var(--border-color); width:400px; position:relative; animation: modalBounce 0.6s ease-out;">
        <h2 style="color:var(--primary-blue); margin-top:0;">Add New Course</h2>
        
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Course Name</label>
            <input type="text" id="newCourseName" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>

        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Course Type</label>
            <select id="newCourseType" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            </select>
        </div>

        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">YouTube Video ID</label>
            <input type="text" id="newVideoId" placeholder="e.g., aircAruvnKk" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>

        <div style="display:flex; gap:10px;">
            <button style="background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="saveNewCourse()">Save Course</button>
            <button style="background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="closeAddCourseModal()">Cancel</button>
        </div>
    </div>
</div>

<style>
@keyframes bounceIn {
    0% { opacity: 0; transform: scale(0.3); }
    50% { opacity: 1; transform: scale(1.05); }
    70% { transform: scale(0.9); }
    100% { opacity: 1; transform: scale(1); }
}

@keyframes modalBounce {
    0% { transform: scale(0.7) rotate(-5deg); }
    50% { transform: scale(1.1) rotate(2deg); }
    100% { transform: scale(1) rotate(0deg); }
}
</style>

<script>
function openAddCourseModal() {
    const modal = document.getElementById('addCourseModal');
    if (modal) {
        modal.style.display = 'flex';
    } else {
        console.error('Add Course Modal not found!');
    }
}

function closeAddCourseModal() {
    document.getElementById('addCourseModal').style.display = 'none';
}

async function saveNewCourse() {
    const name = document.getElementById('newCourseName').value.trim();
    const type = document.getElementById('newCourseType').value;
    const videoId = document.getElementById('newVideoId').value.trim();

    if (!name || !videoId) {
        alert('Please fill in all required fields.');
        return;
    }

    const uploadDate = new Date().toLocaleDateString();
    const id = Date.now();
    const newCourse = { id, name, type, videoId, uploadDate, source: 'Admin' };
    
    // Save to shared API storage so ALL users can see it
    await addSharedCourse(newCourse);
    
    // Add announcement
    const announcement = {
        message: `New course added: ${name} (${type})`,
        date: new Date().toLocaleString(),
        type: 'course'
    };
    await addSharedAnnouncement(announcement);

    await loadCourses();
    await loadCoursesView();
    loadRoles();
    if (typeof updateAnnouncements === 'function') await updateAnnouncements();

    // Clear the form
    document.getElementById('newCourseName').value = '';
    document.getElementById('newVideoId').value = '';

    closeAddCourseModal();
}

async function deleteCourse(id) {
    if (!confirm('Are you sure you want to delete this course?')) return;
    
    try {
        if (!id) {
            alert('Unable to delete: missing course identifier.');
            return;
        }

        const key = String(id).trim();
        console.log('Deleting course:', key);

        // 1. Delete from Firestore/Shared Storage
        if (window.firestoreDB && typeof window.firestoreDB.deleteCourse === 'function') {
            await window.firestoreDB.deleteCourse(key);
        } else if (window.deleteSharedCourse) {
            await window.deleteSharedCourse(key);
        } else {
            // Local fallback
            const courses = JSON.parse(localStorage.getItem('courses') || '[]')
                .filter(c => String(c.id) !== key && String(c.videoId) !== key);
            localStorage.setItem('courses', JSON.stringify(courses));
        }

        // 2. Clear session backups to prevent "ghost" data on reload
        sessionStorage.removeItem('courses_backup');

        // 3. Refresh the UI components
        await loadCourses();
        if (typeof loadCoursesView === 'function') await loadCoursesView();
        
        console.log('Course deleted successfully');
    } catch (error) {
        console.error('Error deleting course:', error);
        alert('Failed to delete course: ' + error.message);
    }
}

async function loadCourses() {
    // Sync shared courses from API/Firestore
    const courses = window.syncSharedCourses ? await window.syncSharedCourses() : (JSON.parse(localStorage.getItem('courses') || '[]'));
    
    const tbody = document.getElementById('courseMgmtTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    courses.forEach((course, index) => {
        const row = tbody.insertRow();
        const deleteKey = course.id || course.videoId; // Ensure we have a valid identifier
        
        row.insertCell(0).innerText = index + 1;
        row.insertCell(1).innerText = course.name || 'Untitled';
        row.insertCell(2).innerText = course.type || '-';
        row.insertCell(3).innerText = course.videoId || '-';
        row.insertCell(4).innerText = course.uploadDate || '-';

        row.insertCell(5).innerText = course.source || course.addedBy || 'Admin';

        const deleteCell = row.insertCell(6);
        deleteCell.innerHTML = `<button style="background:#f85149; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" 
            onclick="deleteCourse('${deleteKey}')">Delete</button>`;
    });
}

let currentCourseVideoId = '';
let currentCourseTitle = '';
let currentCourseType = '';

// ============ Catalog Course Progress + Assessments ============
const COURSE_PROGRESS_LOCAL_KEY = 'catalogCourseProgress'; // local fallback map { [videoId]: progress }

function prettyLevel(type) {
    const t = String(type || '').toLowerCase();
    if (t === 'advanced') return 'Advanced';
    if (t === 'intermediate') return 'Intermediate';
    return 'Beginner';
}

function questionCountForType(type) {
    const t = String(type || '').toLowerCase();
    return t === 'advanced' ? 20 : 10;
}

function pointsForType(type) {
    const t = String(type || '').toLowerCase();
    if (t === 'advanced') return 10;
    if (t === 'intermediate') return 5;
    return 2;
}

function deriveDisplayName() {
    const stored = (localStorage.getItem('userName') || '').trim();
    const email = safeUserEmail();
    if (stored) return stored;
    try {
        if (!email) return 'User';
        const local = email.split('@')[0] || '';
        const parts = local.split(/[._]/).filter(Boolean);
        if (parts.length === 0) return email;
        return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
    } catch (_) {
        return 'User';
    }
}

async function computeMyPoints() {
    const courses = window.syncSharedCourses ? await window.syncSharedCourses() : JSON.parse(localStorage.getItem('courses') || '[]');
    const progressMap = await getAllProgressMap();

    let points = 0;
    const counted = new Set();
    for (const c of (Array.isArray(courses) ? courses : [])) {
        const vid = String(c?.videoId || '').trim();
        if (!vid) continue;
        const p = progressMap[vid] || {};
        const passed = Boolean(p?.assessment?.passed);
        if (!passed) continue;
        if (!counted.has(vid)) {
            points += pointsForType(c?.type || p?.courseType || 'beginner');
            counted.add(vid);
        }
    }

    // Include Measure & Master assigned courses (local) with same point rules
    try {
        const assigned = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
        for (const c of (Array.isArray(assigned) ? assigned : [])) {
            const vid = String(c?.videoId || '').trim();
            if (!vid || counted.has(vid)) continue;
            const p = progressMap[vid] || {};
            const passed = Boolean(p?.assessment?.passed) || Boolean(c?.passed);
            if (!passed) continue;
            points += pointsForType(String(c?.level || p?.courseType || 'beginner').toLowerCase());
            counted.add(vid);
        }
    } catch (_) {}

    return points;
}

async function updateMyLeaderboardPoints() {
    const email = safeUserEmail();
    if (!email) return;
    const points = await computeMyPoints();
    try {
        if (window.firestoreDB && typeof window.firestoreDB.upsertLeaderboardEntry === 'function') {
            await window.firestoreDB.upsertLeaderboardEntry(email, {
                name: deriveDisplayName(),
                points
            });
        }
    } catch (e) {
        console.warn('Failed updating leaderboard:', e);
    }
}

function safeUserEmail() {
    return (localStorage.getItem('userEmail') || '').trim();
}

function isAdminSession() {
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const userEmail = (localStorage.getItem('userEmail') || '').toLowerCase();
    const role = (localStorage.getItem('userRole') || '').toLowerCase();
    return role === 'admin' || userEmail === SUPERADMIN_EMAIL.toLowerCase();
}

function formatSecondsToHms(totalSeconds) {
    const s = Math.max(0, Math.floor(Number(totalSeconds) || 0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    const pad = (n) => String(n).padStart(2, '0');
    return h > 0 ? `${h}:${pad(m)}:${pad(ss)}` : `${m}:${pad(ss)}`;
}

function safeIsoToDate(iso) {
    try {
        if (!iso) return null;
        const d = new Date(iso);
        return Number.isNaN(d.getTime()) ? null : d;
    } catch (_) {
        return null;
    }
}

function normalizeCourseLevel(levelOrType) {
    const t = String(levelOrType || '').toLowerCase();
    if (t.includes('advanced')) return 'advanced';
    if (t.includes('intermediate')) return 'intermediate';
    if (t.includes('beginner')) return 'beginner';
    return t || 'beginner';
}

function extractJsonArrayFromText(text) {
    const raw = String(text || '').trim();
    if (!raw) throw new Error('Empty response');
    let cleaned = raw.replace(/```json\s*|```/g, '').trim();
    const m = cleaned.match(/\[[\s\S]*\]/);
    if (!m) throw new Error('API returned invalid format. Please try refreshing.');
    cleaned = m[0];
    const parsed = JSON.parse(cleaned);
    if (!Array.isArray(parsed)) throw new Error('API returned invalid format. Please try refreshing.');
    return parsed;
}

function promptTodayShortDate() {
    const d = new Date();
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function truncateForPrompt(text, maxChars = 8000) {
    const s = String(text || '');
    if (s.length <= maxChars) return s;
    return s.slice(0, maxChars) + `\n\n... (truncated ${s.length - maxChars} chars)`;
}

async function parseJsonArrayFromGeminiText(text, schemaHint = '') {
    try {
        return extractJsonArrayFromText(text);
    } catch (_) {
        // One repair attempt: ask Gemini to output only JSON.
        const repairPrompt = `Convert the following into ONLY a valid JSON array.${schemaHint ? `\n\nRequired structure example:\n${schemaHint}` : ''}

Return ONLY the JSON array, no markdown, no commentary.

TEXT TO CONVERT:\n${truncateForPrompt(text, 8000)}`;
        const repaired = await callGeminiAPI(repairPrompt, 'gemini-2.5-flash');
        if (repaired?.error) throw new Error(repaired.error.message);
        const repairedText = repaired?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        return extractJsonArrayFromText(repairedText);
    }
}

function coursePlayerSetAssessmentLock(locked, reason = '') {
    const btn = document.getElementById('coursePlayerAssessmentBtn');
    const hint = document.getElementById('coursePlayerAssessmentHint');
    if (btn) btn.disabled = !!locked;
    if (hint) {
        hint.textContent = locked
            ? (reason || 'Finish watching the full video to unlock the assessment.')
            : 'Unlocked. You can now take the assessment.';
        hint.style.color = locked ? 'var(--text-secondary)' : '#4CAF50';
    }
}

async function ensureWatchCompletedOrBlock(videoId) {
    const vid = String(videoId || '').trim();
    if (!vid) return false;
    const map = await getAllProgressMap();
    const p = map[vid] || {};
    const completed = p?.watch?.completed === true;
    if (completed) return true;
    alert('Assessment is locked until you watch the full course video.');
    return false;
}

function loadCatalogProgressLocal() {
    try {
        const raw = localStorage.getItem(COURSE_PROGRESS_LOCAL_KEY);
        const parsed = raw ? JSON.parse(raw) : {};
        return parsed && typeof parsed === 'object' ? parsed : {};
    } catch (_) {
        return {};
    }
}

function saveCatalogProgressLocal(map) {
    try {
        localStorage.setItem(COURSE_PROGRESS_LOCAL_KEY, JSON.stringify(map || {}));
    } catch (_) {}
}

async function upsertCourseProgress(videoId, patch) {
    const email = safeUserEmail();
    const key = String(videoId || '').trim();
    if (!key) return;

    // Local fallback
    const map = loadCatalogProgressLocal();
    const existing = map[key] && typeof map[key] === 'object' ? map[key] : {};

    // Shallow merge at top-level, but deep-merge known nested objects so we don't
    // wipe fields like watch.lastSeconds when only watch.durationSeconds is updated.
    const next = { ...existing, ...patch, videoId: key };

    if (existing.watch || patch?.watch) {
        const existingWatch = (existing && typeof existing.watch === 'object') ? existing.watch : {};
        const patchWatch = (patch && typeof patch.watch === 'object') ? patch.watch : {};
        const mergedWatch = { ...existingWatch, ...patchWatch };
        // Once completed, never revert to false.
        if (existingWatch?.completed === true) mergedWatch.completed = true;
        if (existingWatch?.completedAt && !mergedWatch.completedAt) mergedWatch.completedAt = existingWatch.completedAt;
        next.watch = mergedWatch;
    }

    if (existing.assessment || patch?.assessment) {
        const existingAssessment = (existing && typeof existing.assessment === 'object') ? existing.assessment : {};
        const patchAssessment = (patch && typeof patch.assessment === 'object') ? patch.assessment : {};
        next.assessment = { ...existingAssessment, ...patchAssessment };
    }

    map[key] = next;
    saveCatalogProgressLocal(map);

    // Firestore (best effort)
    try {
        if (email && window.firestoreDB && typeof window.firestoreDB.saveUserCourse === 'function') {
            await window.firestoreDB.saveUserCourse(email, next);
        }
    } catch (e) {
        console.warn('Failed saving progress to Firestore, using local fallback only:', e);
    }
}

async function getAllProgressMap() {
    const email = safeUserEmail();
    const merged = loadCatalogProgressLocal();

    try {
        if (email && window.firestoreDB && typeof window.firestoreDB.getUserCourses === 'function') {
            const rows = await window.firestoreDB.getUserCourses(email);
            if (Array.isArray(rows)) {
                for (const r of rows) {
                    const vid = String(r?.videoId || '').trim();
                    if (!vid) continue;

                    const existing = merged[vid] && typeof merged[vid] === 'object' ? merged[vid] : {};
                    const next = { ...existing, ...(r || {}) };

                    // Deep-merge nested objects to avoid wiping local fields.
                    const existingWatch = (existing && typeof existing.watch === 'object') ? existing.watch : {};
                    const remoteWatch = (r && typeof r.watch === 'object') ? r.watch : {};
                    if (existing.watch || r?.watch) {
                        const mergedWatch = { ...existingWatch, ...remoteWatch };
                        if (existingWatch?.completed === true) mergedWatch.completed = true;
                        if (existingWatch?.completedAt && !mergedWatch.completedAt) mergedWatch.completedAt = existingWatch.completedAt;
                        next.watch = mergedWatch;
                    }

                    const existingAssessment = (existing && typeof existing.assessment === 'object') ? existing.assessment : {};
                    const remoteAssessment = (r && typeof r.assessment === 'object') ? r.assessment : {};
                    if (existing.assessment || r?.assessment) {
                        next.assessment = { ...existingAssessment, ...remoteAssessment };
                    }

                    merged[vid] = next;
                }
            }
        }
    } catch (e) {
        console.warn('Failed loading progress from Firestore; falling back to local only:', e);
    }

    return merged;
}

async function inferCourseTypeByVideoId(videoId) {
    const vid = String(videoId || '').trim();
    if (!vid) return '';
    try {
        const list = window.syncSharedCourses ? await window.syncSharedCourses() : JSON.parse(localStorage.getItem('courses') || '[]');
        const match = Array.isArray(list) ? list.find(c => String(c?.videoId || '').trim() === vid) : null;
        return match?.type || '';
    } catch (_) {
        return '';
    }
}

async function recordCourseOpened(videoId, title, type) {
    const nowIso = new Date().toISOString();
    const key = String(videoId || '').trim();
    const existingMap = await getAllProgressMap();
    const existing = existingMap[key] || {};
    await upsertCourseProgress(videoId, {
        courseName: String(title || '').trim() || 'Untitled',
        courseType: String(type || '').toLowerCase() || '',
        lastOpenedAt: nowIso,
        startedAt: existing?.startedAt || nowIso
    });
}

function openCoursePlayer(videoId, title, type = '') {
    const overlay = document.getElementById('coursePlayerOverlay');
    const frame = document.getElementById('coursePlayerFrame');
    const titleEl = document.getElementById('coursePlayerTitle');
    const playBtn = document.getElementById('coursePlayerPlay');
    const videoIdDisplay = document.getElementById('coursePlayerVideoId');
    
    currentCourseVideoId = videoId;
    currentCourseTitle = title || '';
    currentCourseType = type || '';
    
    if (overlay && frame && titleEl) {
        window.__coursePlayerMode = 'youtube';
        titleEl.textContent = title || 'Now Playing';
        overlay.style.display = 'flex';
        if (playBtn) playBtn.style.display = 'flex';

        const infoPanel = document.getElementById('coursePlayerInfoPanel');
        if (infoPanel) infoPanel.style.display = 'block';
        
        // Display Video ID
        if (videoIdDisplay) {
            videoIdDisplay.textContent = videoId;
        }

        // Do not autoplay; wait for explicit play click
        coursePlayerSetAssessmentLock(true);
    }

    // Best-effort progress tracking
    (async () => {
        let courseType = String(currentCourseType || '').trim();
        if (!courseType) courseType = await inferCourseTypeByVideoId(videoId);
        currentCourseType = courseType;
        await recordCourseOpened(videoId, title, courseType);

        // Unlock assessment only if watch is complete
        try {
            const map = await getAllProgressMap();
            const p = map[String(videoId || '').trim()] || {};
            coursePlayerSetAssessmentLock(!(p?.watch?.completed === true));
        } catch (_) {
            coursePlayerSetAssessmentLock(true);
        }
    })();
}

// Showcase: play an uploaded demo video (mp4/webm) using the same overlay shell as Courses
function openUrlVideoPlayer(videoUrl, title = 'Demo Video') {
    const url = String(videoUrl || '').trim();
    if (!url) return;
    const overlay = document.getElementById('coursePlayerOverlay');
    const frame = document.getElementById('coursePlayerFrame');
    const titleEl = document.getElementById('coursePlayerTitle');
    const playBtn = document.getElementById('coursePlayerPlay');
    const infoPanel = document.getElementById('coursePlayerInfoPanel');

    window.__coursePlayerMode = 'url';
    currentCourseVideoId = '';
    currentCourseTitle = String(title || '').trim();
    currentCourseType = '';

    if (titleEl) titleEl.textContent = currentCourseTitle || 'Demo Video';
    if (overlay) overlay.style.display = 'flex';
    if (playBtn) playBtn.style.display = 'none';
    if (infoPanel) infoPanel.style.display = 'none';

    if (frame) {
        // Use native HTML5 video for Storage URLs
        frame.innerHTML = `
            <video
                src="${url.replaceAll('"', '&quot;')}"
                controls
                playsinline
                style="width:100%; height:100%; border-radius:10px; background:#000;"
            ></video>
        `;
    }
}

window.openUrlVideoPlayer = openUrlVideoPlayer;

// ===== Catalog Course Assessment Overlay =====
let catalogAssessmentQuestions = [];
let catalogAssessmentIndex = 0;
let catalogAssessmentAnswers = [];
let catalogAssessmentMeta = null; // { videoId, title, type, questionCount }

function courseAssessmentBackdropClick(event) {
    if (event.target && event.target.id === 'courseAssessmentOverlay') closeCourseAssessment();
}

function closeCourseAssessment() {
    const overlay = document.getElementById('courseAssessmentOverlay');
    if (overlay) overlay.style.display = 'none';
    catalogAssessmentQuestions = [];
    catalogAssessmentIndex = 0;
    catalogAssessmentAnswers = [];
    catalogAssessmentMeta = null;
}

function startCatalogAssessmentFromPlayer() {
    const vid = String(currentCourseVideoId || '').trim();
    const title = String(currentCourseTitle || '').trim();
    const type = String(currentCourseType || '').trim();
    if (!vid) {
        alert('No course selected.');
        return;
    }
    startCatalogAssessment(vid, title, type);
}

async function startCatalogAssessment(videoId, title, type = '') {
    const vid = String(videoId || '').trim();
    if (!vid) return;

    // Enforce watch-before-assessment
    const ok = await ensureWatchCompletedOrBlock(vid);
    if (!ok) return;

    let courseType = String(type || '').trim();
    if (!courseType) courseType = await inferCourseTypeByVideoId(vid);
    const qCount = questionCountForType(courseType);

    catalogAssessmentMeta = {
        videoId: vid,
        title: String(title || '').trim() || currentCourseTitle || 'Course',
        type: String(courseType || '').toLowerCase() || 'beginner',
        questionCount: qCount
    };

    const overlay = document.getElementById('courseAssessmentOverlay');
    const titleEl = document.getElementById('courseAssessmentTitle');
    const metaEl = document.getElementById('courseAssessmentMeta');
    const body = document.getElementById('courseAssessmentBody');
    if (!overlay || !titleEl || !metaEl || !body) return;

    titleEl.textContent = `${catalogAssessmentMeta.title}  Assessment`;
    metaEl.textContent = `${prettyLevel(catalogAssessmentMeta.type)}  ${qCount} questions  Pass: 80%`;
    body.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding: 10px;">Generating questions</div>';
    overlay.style.display = 'flex';

    await generateCatalogAssessmentQuestions();
    renderCatalogAssessmentQuestion();
}

async function generateCatalogAssessmentQuestions() {
    try {
        const meta = catalogAssessmentMeta;
        if (!meta) throw new Error('Missing assessment metadata');

        const prompt = `Generate exactly ${meta.questionCount} multiple-choice questions for a ${prettyLevel(meta.type)} learner based on the course topic "${meta.title}".

Rules:
- Each question must have 4 options labeled A) B) C) D)
- Exactly one correct answer
- Mix practical + conceptual questions
- Keep questions relevant to the course topic

Return ONLY valid JSON array (no markdown):
[{"question":"...","options":["A) ...","B) ...","C) ...","D) ..."],"correctAnswer":"A"}]`;

        const data = await callGeminiAPI(prompt, 'gemini-2.5-flash');
        if (data.error) throw new Error(data.error.message);

        const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const clean = String(textResponse).replace(/```json|```/g, '').trim();
        const match = clean.match(/\[[\s\S]*\]/);
        const jsonStr = match ? match[0] : clean;

        const parsed = JSON.parse(jsonStr);
        if (!Array.isArray(parsed) || parsed.length === 0) throw new Error('Invalid questions format');

        catalogAssessmentQuestions = parsed;
        catalogAssessmentIndex = 0;
        catalogAssessmentAnswers = [];
    } catch (e) {
        console.error('Catalog assessment generation failed:', e);
        const body = document.getElementById('courseAssessmentBody');
        if (body) {
            body.innerHTML = `
                <div style="background:rgba(248,81,73,0.1); border:1px solid #f85149; border-radius:10px; padding:14px;">
                    <div style="color:#f85149; font-weight:800; margin-bottom:6px;">Failed to generate assessment</div>
                    <div style="color:var(--text-main); font-size:13px;">${String(e?.message || e)}</div>
                    <button class="btn-secondary" style="margin-top:12px;" onclick="startCatalogAssessment('${catalogAssessmentMeta?.videoId || ''}', '${String(catalogAssessmentMeta?.title || '').replace(/'/g, "\\'")}', '${catalogAssessmentMeta?.type || ''}')">Try again</button>
                </div>
            `;
        }
    }
}

function renderCatalogAssessmentQuestion() {
    const body = document.getElementById('courseAssessmentBody');
    if (!body) return;
    if (catalogAssessmentIndex >= catalogAssessmentQuestions.length) return;

    const q = catalogAssessmentQuestions[catalogAssessmentIndex];
    const total = catalogAssessmentQuestions.length;

    body.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
            <div style="color:var(--text-secondary);">Question ${catalogAssessmentIndex + 1} of ${total}</div>
            <div style="color:var(--text-secondary); font-size:12px;">Select one option</div>
        </div>
        <div style="background:var(--card-bg); padding:16px; border:1px solid var(--border-color); border-radius:10px; margin-bottom:12px;">
            <div style="color:var(--text-main); font-size:15px; margin-bottom:12px;">${q.question}</div>
            <div>
                ${(Array.isArray(q.options) ? q.options : []).map((opt, idx) => `
                    <div class="quiz-option" onclick="catalogAssessmentSelect(${idx})" data-ca="${idx}">${opt}</div>
                `).join('')}
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            ${catalogAssessmentIndex < total - 1
                ? '<button class="btn-secondary" onclick="catalogAssessmentNext()">Next</button>'
                : '<button class="btn-secondary" onclick="catalogAssessmentSubmit()" style="border-color: rgba(76,175,80,0.7);">Submit</button>'}
        </div>
    `;
}

function catalogAssessmentSelect(optionIndex) {
    document.querySelectorAll('[data-ca]').forEach(el => el.classList.remove('selected'));
    const selected = document.querySelector(`[data-ca="${optionIndex}"]`);
    if (selected) selected.classList.add('selected');
    catalogAssessmentAnswers[catalogAssessmentIndex] = String.fromCharCode(65 + optionIndex);
}

function catalogAssessmentNext() {
    if (!catalogAssessmentAnswers[catalogAssessmentIndex]) {
        alert('Please select an answer before proceeding.');
        return;
    }
    catalogAssessmentIndex++;
    renderCatalogAssessmentQuestion();
}

function catalogAssessmentScore() {
    let correct = 0;
    catalogAssessmentQuestions.forEach((q, idx) => {
        if (catalogAssessmentAnswers[idx] === q.correctAnswer) correct++;
    });
    return correct;
}

async function catalogAssessmentSubmit() {
    if (!catalogAssessmentAnswers[catalogAssessmentIndex]) {
        alert('Please select an answer before submitting.');
        return;
    }

    const correct = catalogAssessmentScore();
    const total = catalogAssessmentQuestions.length;
    const percent = Math.round((correct / total) * 100);
    const passed = percent >= 80;
    const nowIso = new Date().toISOString();
    const meta = catalogAssessmentMeta;

    // Update persisted progress
    const progressPatch = {
        courseName: meta?.title || 'Course',
        courseType: String(meta?.type || '').toLowerCase(),
        lastActivityAt: nowIso,
        ...(passed ? { completedAt: nowIso } : {}),
        assessment: {
            questionCount: total,
            correct,
            percent,
            passed,
            lastAttemptedAt: nowIso
        }
    };

    // Increment attempts
    const existingMap = await getAllProgressMap();
    const existing = existingMap[String(meta?.videoId || '').trim()] || {};
    const attempts = (existing?.assessment?.attempts || existing?.attempts || 0) + 1;
    progressPatch.assessment.attempts = attempts;

    await upsertCourseProgress(meta.videoId, progressPatch);

    // Update leaderboard only when passed
    if (passed) {
        await updateMyLeaderboardPoints();
    }

    const body = document.getElementById('courseAssessmentBody');
    if (body) {
        body.innerHTML = `
            <div style="background:rgba(${passed ? '76,175,80' : '248,81,73'},0.1); border:1px solid ${passed ? '#4CAF50' : '#f85149'}; border-radius:12px; padding:16px;">
                <div style="color:${passed ? '#4CAF50' : '#f85149'}; font-weight:900; font-size:16px; margin-bottom:6px;">${passed ? ' Assessment Passed' : ' Assessment Not Passed'}</div>
                <div style="color:var(--text-main);">Score: <b>${correct}/${total}</b> (${percent}%)</div>
                <div style="color:var(--text-secondary); font-size:12px; margin-top:6px;">Attempts: ${attempts}  Saved to My Progress</div>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px; flex-wrap:wrap;">
                    <button class="btn-secondary" onclick="closeCourseAssessment()">Close</button>
                    <button class="btn-secondary" onclick="loadMyProgress(); switchTab('my-progress-view', null)">View My Progress</button>
                </div>
            </div>
            ${renderAssessmentAnswersReviewHtml(catalogAssessmentQuestions, catalogAssessmentAnswers, {
                title: 'Answer Review'
            })}
        `;
    }

    // Soft-refresh progress table if open
    const currentView = document.querySelector('section[style*="display: block"], section[style*="display:block"]');
    if (currentView && currentView.id === 'my-progress-view') {
        loadMyProgress();
    }
}

async function loadLeaderboard() {
    const tbody = document.getElementById('leaderboardTableBody');
    if (!tbody) return;

    const admin = isAdminSession();
    const thView = document.getElementById('leaderboardViewColView');
    if (thView) thView.style.display = admin ? 'table-cell' : 'none';
    tbody.innerHTML = `<tr><td colspan="${admin ? 6 : 5}" style="color:var(--text-secondary);">Loading</td></tr>`;

    // Ensure current user's points are up-to-date (best effort)
    await updateMyLeaderboardPoints();

    // 1) Load ALL registered users (Role Mgmt source)
    let users = [];
    try {
        if (typeof window.getSharedUsers === 'function') {
            const list = await window.getSharedUsers();
            users = Array.isArray(list) ? list : [];
        }
    } catch (e) {
        console.warn('Failed loading shared users for leaderboard:', e);
    }

    if (!Array.isArray(users) || users.length === 0) {
        // Local fallback (single-device)
        try {
            users = JSON.parse(localStorage.getItem('users') || '[]');
        } catch (_) {
            users = [];
        }
    }

    // Normalize users by email
    const registered = (Array.isArray(users) ? users : [])
        .filter(u => u && u.email)
        .map(u => ({
            email: String(u.email || '').trim().toLowerCase(),
            name: String(u.name || '').trim(),
            employeeId: String(u.employeeId || '').trim()
        }))
        .filter(u => u.email);

    if (registered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${admin ? 6 : 5}" style="color:var(--text-secondary);">No users found in Role Management yet.</td></tr>`;
        return;
    }

    // 2) Load leaderboard points (may be empty). Merge onto registered users.
    let entries = [];
    try {
        if (window.firestoreDB && typeof window.firestoreDB.getLeaderboardEntries === 'function') {
            entries = await window.firestoreDB.getLeaderboardEntries();
        }
    } catch (e) {
        console.warn('Failed loading leaderboard entries:', e);
    }

    const entryByEmail = new Map();
    for (const e of (Array.isArray(entries) ? entries : [])) {
        const email = String(e?.email || e?.id || '').trim().toLowerCase();
        if (!email) continue;
        entryByEmail.set(email, {
            points: Number(e?.points || 0),
            updatedAt: e?.updatedAt || ''
        });
    }

    const merged = registered.map(u => {
        const entry = entryByEmail.get(u.email);
        return {
            email: u.email,
            name: u.name,
            points: entry ? entry.points : 0,
            updatedAt: entry ? entry.updatedAt : ''
        };
    }).sort((a, b) => (b.points - a.points) || a.email.localeCompare(b.email));

    // Tie-aware ranking (dense ranking): 1,1,2,2,3...
    let lastPoints = null;
    let rank = 0;
    tbody.innerHTML = merged.map((e) => {
        if (lastPoints === null || e.points !== lastPoints) {
            rank += 1;
            lastPoints = e.points;
        }
        const last = e.updatedAt ? new Date(e.updatedAt).toLocaleDateString() : '';
        const displayName = e.name || (e.email ? e.email.split('@')[0] : 'User');
        const viewBtn = admin
            ? `<button class="btn-secondary" title="View progress" onclick="openEmployeeProgressModal('${String(e.email).replace(/'/g, "\\'")}', '${String(displayName).replace(/'/g, "\\'")}')" style="padding:6px 10px;"></button>`
            : '';
        return `
            <tr>
                <td>${rank}</td>
                <td>${displayName}</td>
                <td>${e.email}</td>
                <td><b>${e.points}</b></td>
                <td>${last}</td>
                ${admin ? `<td style="text-align:center;">${viewBtn}</td>` : ''}
            </tr>
        `;
    }).join('');
}

function closeEmployeeProgressModal() {
    const modal = document.getElementById('employeeProgressModal');
    if (modal) modal.style.display = 'none';
    const body = document.getElementById('employeeProgressBody');
    if (body) body.innerHTML = '';
}

async function openEmployeeProgressModal(email, name) {
    if (!isAdminSession()) {
        alert('Only Admins can view employee progress.');
        return;
    }

    const modal = document.getElementById('employeeProgressModal');
    const title = document.getElementById('employeeProgressTitle');
    const sub = document.getElementById('employeeProgressSub');
    const body = document.getElementById('employeeProgressBody');
    if (!modal || !body) return;

    const e = String(email || '').trim();
    const displayName = String(name || '').trim() || (e ? e.split('@')[0] : 'User');
    if (title) title.textContent = `${displayName}  Progress`;
    if (sub) sub.textContent = e;
    body.innerHTML = '<div style="color:var(--text-secondary);">Loading</div>';
    modal.style.display = 'flex';

    try {
        if (!window.firestoreDB || typeof window.firestoreDB.getUserCourses !== 'function') {
            throw new Error('Progress API unavailable');
        }

        const rows = await window.firestoreDB.getUserCourses(e);
        const list = Array.isArray(rows) ? rows : [];

        if (list.length === 0) {
            body.innerHTML = '<div style="color:var(--text-secondary);">No course activity found for this user yet.</div>';
            return;
        }

        const normalized = list.map(r => {
            const startedAt = safeIsoToDate(r?.startedAt || r?.lastOpenedAt);
            const completedAt = safeIsoToDate(r?.completedAt || r?.assessment?.lastAttemptedAt);
            const watchDuration = Number(r?.watch?.durationSeconds || r?.watch?.duration || 0);
            const marks = (typeof r?.assessment?.percent === 'number')
                ? `${r.assessment.percent}%`
                : (r?.assessment?.correct != null && r?.assessment?.questionCount != null)
                    ? `${r.assessment.correct}/${r.assessment.questionCount}`
                    : '';
            const passed = !!r?.assessment?.passed;
            const timeTakenSec = (startedAt && completedAt) ? Math.round((completedAt.getTime() - startedAt.getTime()) / 1000) : null;
            const lastActivity = safeIsoToDate(r?.lastActivityAt || r?.assessment?.lastAttemptedAt || r?.lastOpenedAt || r?.updatedAt);
            return {
                courseName: String(r?.courseName || r?.topic || r?.name || r?.videoId || 'Course'),
                videoId: String(r?.videoId || ''),
                level: prettyLevel(r?.courseType || r?.level || ''),
                watchDuration,
                timeTakenSec,
                marks,
                passed,
                lastActivity
            };
        }).sort((a, b) => (b.lastActivity?.getTime?.() || 0) - (a.lastActivity?.getTime?.() || 0));

        body.innerHTML = `
            <table class="admin-table" style="margin-top: 0;">
                <thead>
                    <tr>
                        <th>Course</th>
                        <th style="width:120px;">Level</th>
                        <th style="width:140px;">Duration</th>
                        <th style="width:160px;">Time Taken</th>
                        <th style="width:130px;">Marks</th>
                        <th style="width:140px;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${normalized.map(n => {
                        const durationText = n.watchDuration ? formatSecondsToHms(n.watchDuration) : '';
                        const timeTakenText = (n.timeTakenSec != null && n.timeTakenSec >= 0)
                            ? formatSecondsToHms(n.timeTakenSec)
                            : 'In progress';
                        const status = n.passed ? '<span style="color:#4CAF50; font-weight:800;">Passed</span>' : '<span style="color:var(--text-secondary);">In progress</span>';
                        const marks = n.passed ? `<span style="color:#4CAF50; font-weight:800;">${n.marks}</span>` : n.marks;
                        return `
                            <tr>
                                <td>
                                    <div style="color:var(--text-main); font-weight:800;">${n.courseName}</div>
                                    ${n.videoId ? `<div style="color:var(--text-secondary); font-size:11px; font-family:monospace;">${n.videoId}</div>` : ''}
                                </td>
                                <td>${n.level}</td>
                                <td>${durationText}</td>
                                <td>${timeTakenText}</td>
                                <td>${marks}</td>
                                <td>${status}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            <div style="margin-top:10px; color:var(--text-secondary); font-size:12px;">
                Time Taken is measured from first course open to assessment completion.
            </div>
        `;
    } catch (err) {
        body.innerHTML = `<div class="news-item" style="color:#f85149; display:flex; gap:8px; align-items:flex-start;"><span class="ui-ico-wrap" aria-hidden="true" style="margin-top:2px;"><svg class="ui-ico"><use href="#ico-warning"></use></svg></span><div>Error loading progress: ${err && err.message ? err.message : 'Unknown error'}</div></div>`;
    }
}

async function loadMyProgress() {
    const tbody = document.getElementById('myProgressTableBody');
    if (!tbody) return;

    tbody.innerHTML = '<tr><td colspan="6" style="color:var(--text-secondary);">Loading</td></tr>';
    const courses = window.syncSharedCourses ? await window.syncSharedCourses() : JSON.parse(localStorage.getItem('courses') || '[]');
    const progressMap = await getAllProgressMap();

    const list = Array.isArray(courses) ? courses : [];
    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="color:var(--text-secondary);">No courses available.</td></tr>';
        return;
    }

    const rows = list
        .slice()
        .sort((a, b) => String(a?.type || '').localeCompare(String(b?.type || '')) || String(a?.name || '').localeCompare(String(b?.name || '')))
        .map(course => {
            const vid = String(course?.videoId || '').trim();
            const name = String(course?.name || 'Untitled');
            const type = String(course?.type || '').toLowerCase();
            const p = vid ? (progressMap[vid] || {}) : {};

            const assessment = p?.assessment || {};
            const hasOpened = Boolean(p?.lastOpenedAt || p?.startedAt);
            const hasAssessment = typeof assessment?.percent === 'number' || typeof assessment?.correct === 'number';
            const passed = Boolean(assessment?.passed);

            let statusHtml = '';
            if (passed) statusHtml = '<span class="status-badge good"> Passed</span>';
            else if (hasAssessment) statusHtml = '<span class="status-badge warn" style="display:inline-flex; align-items:center; gap:6px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-tool"></use></svg></span>Assessment Taken</span>';
            else if (hasOpened) statusHtml = '<span class="status-badge"> In Progress</span>';
            else statusHtml = '<span class="status-badge bad"> Not Started</span>';

            const scoreText = hasAssessment
                ? (typeof assessment.percent === 'number'
                    ? `${assessment.percent}%`
                    : `${assessment.correct || 0}/${assessment.questionCount || questionCountForType(type)}`)
                : '';

            const lastActivity = p?.lastActivityAt || assessment?.lastAttemptedAt || p?.lastOpenedAt || '';
            const lastDate = lastActivity ? new Date(lastActivity).toLocaleDateString() : '';

            const safeName = name.replace(/'/g, "\\'").replace(/\"/g, '&quot;');
            const safeType = String(type).replace(/'/g, "\\'");

            return `
                <tr>
                    <td>${name}</td>
                    <td>${prettyLevel(type)}</td>
                    <td>${statusHtml}</td>
                    <td>${scoreText}</td>
                    <td>${lastDate}</td>
                    <td style="text-align:right;">
                        <button class="btn-secondary" onclick="openCoursePlayer('${vid}', '${safeName}', '${safeType}')">Open</button>
                        <button class="btn-secondary" onclick="startCatalogAssessment('${vid}', '${safeName}', '${safeType}')">${hasAssessment ? 'Retake' : 'Assessment'}</button>
                    </td>
                </tr>
            `;
        });

    tbody.innerHTML = rows.join('');
}

// ===== User Management JS =====
function openAddUserModal() {
    const modal = document.getElementById('addUserModal');
    if (modal) modal.style.display = 'flex';
}
function closeAddUserModal() {
    const modal = document.getElementById('addUserModal');
    if (modal) modal.style.display = 'none';
}

function loadUsers() {
    const tbody = document.getElementById('userMgmtTableBody');
    if (!tbody) return;
    
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    // Prefer Firestore-backed shared users list
    const users = (window.getSharedUsers ? [] : null);
    
    tbody.innerHTML = '';
    const render = (list) => {
        tbody.innerHTML = '';
        list.forEach((u) => {
        const isSuperadmin = u.email && u.email.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase();
        
        const row = tbody.insertRow();
        row.insertCell(0).innerText = u.employeeId || '';
        row.insertCell(1).innerText = u.name || '';
        row.insertCell(2).innerText = u.email || '';
        const roleCell = row.insertCell(3);
        
        if (isSuperadmin) {
            // For superadmin, show locked Admin role with special styling
            roleCell.innerHTML = `<div style="padding:6px; background:rgba(66,133,244,0.1); color:var(--primary-blue); border:1px solid var(--primary-blue); border-radius:6px; font-weight:bold; display:flex; align-items:center; gap:5px;">
                <span style="display:inline-flex; align-items:center; gap:6px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-lock"></use></svg></span>Admin (Superadmin)</span>
            </div>`;
        } else {
            const safeEmail = String(u.email || '').replace(/'/g, "\\'");
            roleCell.innerHTML = `<select onchange="handleRoleChange('${safeEmail}', this.value)" style="padding:6px; background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); border-radius:6px;">
                <option value="User" ${u.role === 'User' ? 'selected' : ''}>User</option>
                <option value="Admin" ${u.role === 'Admin' ? 'selected' : ''}>Admin</option>
            </select>`;
        }
        
        row.insertCell(4).innerText = u.lastActive || '';
        });
    };

    if (window.getSharedUsers) {
        // Async render from cloud
        window.getSharedUsers()
            .then(list => render(Array.isArray(list) ? list : []))
            .catch(() => render(JSON.parse(localStorage.getItem('users') || '[]')));
        return;
    }

    render(JSON.parse(localStorage.getItem('users') || '[]'));
}

async function saveNewUser() {
    const employeeId = document.getElementById('newEmpId').value.trim();
    const name = document.getElementById('newEmpName').value.trim();
    const email = document.getElementById('newEmpEmail').value.trim();
    const role = document.getElementById('newEmpRole').value;
    if (!employeeId || !name || !email) {
        alert('Please fill in Employee ID, Name, and Email');
        return;
    }
    if (window.upsertSharedUser) {
        try {
            await window.upsertSharedUser({ employeeId, name, email, role, lastActive: '' });
            closeAddUserModal();
            Promise.resolve(loadUsers()).catch(() => {});
            Promise.resolve(loadRoles()).catch(() => {});
            syncCurrentUserRole();
            checkAdminStatus();
            return;
        } catch (e) {
            console.warn('Cloud save user failed; falling back to local', e);
        }
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    users.push({ employeeId, name, email, role, lastActive: '' });
    localStorage.setItem('users', JSON.stringify(users));
    closeAddUserModal();
    loadUsers();
    // In case the added user is the current session user, sync the role
    syncCurrentUserRole();
    checkAdminStatus();
}

async function handleRoleChange(userEmail, value) {
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const normalizedEmail = String(userEmail || '').trim().toLowerCase();
    if (!normalizedEmail) return;
    
    // Prevent changing superadmin role
    if (normalizedEmail === SUPERADMIN_EMAIL.toLowerCase()) {
        alert('Cannot change the role of the Superadmin!\n\nravikiran@oneorigin.us always has Admin access.');
        loadUsers(); // Reload to reset the dropdown
        return;
    }

    const usersLocal = JSON.parse(localStorage.getItem('users') || '[]');
    const localMatch = usersLocal.find(u => (u.email || '').toLowerCase() === normalizedEmail);
    const oldRole = localMatch?.role || 'User';
    const employeeName = localMatch?.name || normalizedEmail;
    
    // Show confirmation dialog
    if (!confirm(`Are you sure you want to change ${employeeName}'s role from ${oldRole} to ${value}?`)) {
        // Best-effort: refresh tables to restore correct values
        Promise.resolve(loadUsers()).catch(() => {});
        Promise.resolve(loadRoles()).catch(() => {});
        return;
    }

    // Cloud-first role update
    if (window.updateSharedUserRoleByEmail) {
        try {
            await window.updateSharedUserRoleByEmail(normalizedEmail, value);
        } catch (e) {
            console.warn('Cloud role update failed; falling back to local', e);
            const idx = usersLocal.findIndex(u => (u.email || '').toLowerCase() === normalizedEmail);
            if (idx !== -1) {
                usersLocal[idx].role = value;
                localStorage.setItem('users', JSON.stringify(usersLocal));
                sessionStorage.setItem('users_backup', JSON.stringify(usersLocal));
            }
        }
    } else {
        const idx = usersLocal.findIndex(u => (u.email || '').toLowerCase() === normalizedEmail);
        if (idx !== -1) {
            usersLocal[idx].role = value;
            localStorage.setItem('users', JSON.stringify(usersLocal));
            sessionStorage.setItem('users_backup', JSON.stringify(usersLocal));
        }
    }

    // If the changed user is the current session user, sync and reload page
    const currentEmail = (localStorage.getItem('userEmail') || '').toLowerCase();
    if (currentEmail && currentEmail === normalizedEmail) {
        localStorage.setItem('userRole', String(value).toLowerCase() === 'admin' ? 'admin' : 'user');
        checkAdminStatus();
        alert(`Your role has been changed to ${value}. The page will reload to apply changes.`);
        setTimeout(() => location.reload(), 500);
        return;
    }

    syncCurrentUserRole();
    checkAdminStatus();
    Promise.resolve(loadUsers()).catch(() => {});
    Promise.resolve(loadRoles()).catch(() => {});
}

// ===== Role Management JS =====
function openAddRoleModal() {
    const modal = document.getElementById('addRoleModal');
    const select = document.getElementById('newRoleCourse');
    populateCourseOptions(select);
    if (modal) modal.style.display = 'flex';
}

function closeAddRoleModal() {
    const modal = document.getElementById('addRoleModal');
    if (modal) modal.style.display = 'none';
}

function populateCourseOptions(selectEl, selectedId = '') {
    if (!selectEl) return;
    const courses = JSON.parse(localStorage.getItem('courses') || '[]');
    selectEl.innerHTML = '';
    if (courses.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No courses available';
        selectEl.appendChild(opt);
        selectEl.disabled = true;
        return;
    }
    selectEl.disabled = false;
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Select a course';
    selectEl.appendChild(placeholder);
    let matched = false;
    courses.forEach(course => {
        const opt = document.createElement('option');
        opt.value = String(course.id);
        opt.textContent = `${course.name} (${course.type})`;
        if (String(course.id) === String(selectedId)) {
            opt.selected = true;
            matched = true;
        }
        selectEl.appendChild(opt);
    });
    if (selectedId && !matched) {
        const missing = document.createElement('option');
        missing.value = String(selectedId);
        missing.textContent = `Missing course (ID: ${selectedId})`;
        missing.selected = true;
        selectEl.appendChild(missing);
    }
}

function loadRoles() {
    const tbody = document.getElementById('roleMgmtTableBody');
    if (!tbody) return;
    
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const render = (users) => {
        tbody.innerHTML = '';
        if (!Array.isArray(users) || users.length === 0) {
            const row = tbody.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 8;
            cell.style.color = 'var(--text-secondary)';
            cell.style.textAlign = 'center';
            cell.innerText = 'No users found. Users will be automatically registered when they log in.';
            return;
        }
        users.forEach((u) => {
            const isSuperadmin = u.email && u.email.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase();
            const safeEmail = String(u.email || '').replace(/'/g, "\\'");

            const row = tbody.insertRow();
            const selectCell = row.insertCell(0);
            selectCell.style.textAlign = 'center';
            selectCell.innerHTML = `<input type="checkbox" class="role-row-check" data-email="${String(u.email || '').replace(/"/g, '&quot;')}">`;

            row.insertCell(1).innerText = u.employeeId || '';
            row.insertCell(2).innerText = u.name || '';
            row.insertCell(3).innerText = u.email || '';

            const roleCell = row.insertCell(4);
            if (isSuperadmin) {
                roleCell.innerHTML = `<div style="padding:6px; background:rgba(66,133,244,0.1); color:var(--primary-blue); border:1px solid var(--primary-blue); border-radius:6px; font-weight:bold; display:flex; align-items:center; gap:5px; justify-content:center;">
                    <span style="display:inline-flex; align-items:center; gap:6px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-lock"></use></svg></span>Admin (Superadmin)</span>
                </div>`;
            } else {
                roleCell.innerHTML = `<select onchange="handleRoleChange('${safeEmail}', this.value)" style="padding:6px; background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); border-radius:6px;">
                    <option value="User" ${u.role === 'User' ? 'selected' : ''}>User</option>
                    <option value="Admin" ${u.role === 'Admin' ? 'selected' : ''}>Admin</option>
                </select>`;
            }

            row.insertCell(5).innerText = u.lastActive || '';

            const resetCell = row.insertCell(6);
            resetCell.innerHTML = '<button style="background:#f0ad4e; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:bold; display:inline-flex; align-items:center; gap:6px;" onclick="resetUserAssessment(\'' + safeEmail + '\')" title="Reset this user\'s assessment and assigned courses"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-refresh"></use></svg></span>Reset</button>';

            const deleteCell = row.insertCell(7);
            if (isSuperadmin) {
                deleteCell.innerHTML = '<div style="padding:5px 10px; color:var(--text-secondary); font-size:12px; text-align:center;">Protected</div>';
            } else {
                deleteCell.innerHTML = '<button style="background:#f85149; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="deleteRole(\'' + safeEmail + '\')">Delete</button>';
            }
        });
    };
    
    if (window.getSharedUsers) {
        window.getSharedUsers()
            .then(list => render(Array.isArray(list) ? list : []))
            .catch(() => render(JSON.parse(localStorage.getItem('users') || '[]')));
        return;
    }

    render(JSON.parse(localStorage.getItem('users') || '[]'));
}

function saveNewRole() {
    // Repurpose: add user via existing Add User modal
    openAddUserModal();
}

async function deleteRole(userEmail) {
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const normalizedEmail = String(userEmail || '').trim().toLowerCase();
    if (!normalizedEmail) return;
    
    // Prevent deleting superadmin
    if (normalizedEmail === SUPERADMIN_EMAIL.toLowerCase()) {
        alert('Cannot delete the Superadmin!\n\nravikiran@oneorigin.us is a permanent admin.');
        return;
    }
    
    if (!confirm('Delete this user?')) return;

    if (window.deleteSharedUserByEmail) {
        try {
            await window.deleteSharedUserByEmail(normalizedEmail);
            Promise.resolve(loadUsers()).catch(() => {});
            Promise.resolve(loadRoles()).catch(() => {});
            checkAdminStatus();
            return;
        } catch (e) {
            console.warn('Cloud delete failed; falling back to local', e);
        }
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const idx = users.findIndex(u => (u.email || '').toLowerCase() === normalizedEmail);
    if (idx !== -1) {
        users.splice(idx, 1);
        localStorage.setItem('users', JSON.stringify(users));
        sessionStorage.setItem('users_backup', JSON.stringify(users));
    }
    loadUsers();
    loadRoles();
    checkAdminStatus();
}

function deleteSelectedRoles() {
    const checks = Array.from(document.querySelectorAll('.role-row-check'));
    const selectedEmails = checks
        .filter(c => c.checked)
        .map(c => String(c.dataset.email || '').trim().toLowerCase())
        .filter(Boolean);
    if (selectedEmails.length === 0) {
        alert('Select at least one entry to delete.');
        return;
    }
    
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const superadminSelected = selectedEmails.some(e => e === SUPERADMIN_EMAIL.toLowerCase());
    
    if (superadminSelected) {
        alert('Cannot delete the Superadmin!\n\nravikiran@oneorigin.us cannot be removed.\nPlease deselect and try again.');
        return;
    }
    
    if (!confirm(`Delete ${selectedEmails.length} user(s)?`)) return;

    if (window.deleteSharedUserByEmail) {
        Promise.all(selectedEmails.map(e => window.deleteSharedUserByEmail(e)))
            .then(() => {
                const selectAll = document.getElementById('roleSelectAll');
                if (selectAll) selectAll.checked = false;
                Promise.resolve(loadUsers()).catch(() => {});
                Promise.resolve(loadRoles()).catch(() => {});
                checkAdminStatus();
            })
            .catch(err => {
                console.warn('Cloud bulk delete failed; falling back to local', err);
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const remaining = users.filter(u => !selectedEmails.includes(String(u.email || '').toLowerCase()));
                localStorage.setItem('users', JSON.stringify(remaining));
                const selectAll = document.getElementById('roleSelectAll');
                if (selectAll) selectAll.checked = false;
                loadUsers();
                loadRoles();
                checkAdminStatus();
            });
        return;
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const remaining = users.filter(u => !selectedEmails.includes(String(u.email || '').toLowerCase()));
    localStorage.setItem('users', JSON.stringify(remaining));
    const selectAll = document.getElementById('roleSelectAll');
    if (selectAll) selectAll.checked = false;
    loadUsers();
    loadRoles();
    checkAdminStatus();
}

function toggleSelectAllRoles(master) {
    const checks = document.querySelectorAll('.role-row-check');
    checks.forEach(c => c.checked = master.checked);
}

function toggleAllRoleChecks(isChecked) {
    const checks = document.querySelectorAll('.role-row-check');
    checks.forEach(c => c.checked = isChecked);
}

async function resetUserAssessment(userEmail) {
    if (!userEmail) {
        alert('Invalid user email');
        return;
    }

    const normalizedEmail = String(userEmail).trim().toLowerCase();
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => u.email && u.email.toLowerCase() === normalizedEmail) || { name: normalizedEmail };
    
    const confirmMsg = `Reset assessment for ${user.name}?

This will:
 Clear their initial assessment score and level
 Remove all assigned courses
 Allow them to retake the assessment

Are you sure?`;
    
    if (!confirm(confirmMsg)) return;
    
    // Check if this is the current user
    const currentUserEmail = localStorage.getItem('userEmail') || '';
    const isCurrentUser = currentUserEmail.toLowerCase() === normalizedEmail;
    
    if (isCurrentUser) {
        // Reset current user's data in localStorage
        localStorage.removeItem('initialAssessmentScore');
        localStorage.removeItem('userLevel');
        localStorage.removeItem('initialAssessmentStarted');
        localStorage.setItem('assignedCourses', '[]');
        localStorage.removeItem('upcomingCourse');
        
        if (window.setUserResetAssessmentFlag) {
            try { await window.setUserResetAssessmentFlag(normalizedEmail, false); } catch (_) {}
        }

        try {
            updateInitialAssessmentStatus();
            loadAssignedCourses();
        } catch (_) {}

        alert(`Assessment reset successfully for ${user.name}!\n\nYou can now retake the assessment.`);
    } else {
        // For other users, set a cloud flag so it applies on their device
        if (window.setUserResetAssessmentFlag) {
            try {
                await window.setUserResetAssessmentFlag(normalizedEmail, true);
                alert(`Assessment reset queued for ${user.name}!\n\nIt will apply when they next log in or load the dashboard.`);
                return;
            } catch (e) {
                console.warn('Cloud reset flag failed; falling back to local', e);
            }
        }

        const userIndex = users.findIndex(u => u.email && u.email.toLowerCase() === normalizedEmail);
        if (userIndex !== -1) {
            users[userIndex].resetAssessmentFlag = true;
            localStorage.setItem('users', JSON.stringify(users));
        }
        alert(`Assessment reset queued for ${user.name}!\n\n(Local-only fallback; may not work across devices.)`);
    }
    
    console.log('Assessment reset for user:', userEmail);
}

function handleRoleCSVUpload(event) {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
        try {
            const text = String(reader.result || '').trim();
            const lines = text.split(/\r?\n/).filter(l => l.trim().length);
            if (lines.length < 2) throw new Error('CSV has no data');
            // Support comma or tab separated headers
            const splitRow = (row) => row.split(/[\t,]/).map(h => h.trim());
            const header = splitRow(lines[0]);
            const expected = ['Employee ID','Employee name','Email ID','Role'];
            const matches = expected.every((h, i) => (header[i] || '').toLowerCase() === h.toLowerCase());
            if (!matches) throw new Error('Invalid CSV header. Expected: ' + expected.join(', '));

            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = splitRow(lines[i]).map(c => c.replace(/^\"|\"$/g, ''));
                if (cols.length < 4) continue;
                const [employeeId, name, email, role] = cols;
                rows.push({ employeeId, name, email, role, lastActive: '' });
            }

            if (window.upsertSharedUser) {
                await Promise.all(rows.map(r => window.upsertSharedUser(r)));
            } else {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                rows.forEach(r => users.push(r));
                localStorage.setItem('users', JSON.stringify(users));
            }

            Promise.resolve(loadUsers()).catch(() => {});
            Promise.resolve(loadRoles()).catch(() => {});
            syncCurrentUserRole();
            checkAdminStatus();
            alert('Users uploaded successfully');
        } catch (err) {
            alert('CSV upload failed: ' + err.message);
        }
        event.target.value = '';
    };
    reader.onerror = () => alert('Failed reading file');
    reader.readAsText(file);
}

function handleCSVUpload(event) {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
        try {
            const text = reader.result;
            const lines = String(text).trim().split(/\r?\n/);
            if (lines.length < 2) throw new Error('CSV has no data');
            const header = lines[0].split(',').map(h => h.trim());
            const expected = ['Employee ID','Employee name','Email ID','Role','Last active date&time'];
            const matches = expected.every((h, i) => (header[i] || '').toLowerCase() === h.toLowerCase());
            if (!matches) throw new Error('Invalid CSV header. Expected: ' + expected.join(', '));

            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                if (cols.length < 5) continue;
                const [employeeId, name, email, role, lastActive] = cols;
                rows.push({ employeeId, name, email, role, lastActive: lastActive || '' });
            }

            if (window.upsertSharedUser) {
                await Promise.all(rows.map(r => window.upsertSharedUser(r)));
            } else {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                rows.forEach(r => users.push(r));
                localStorage.setItem('users', JSON.stringify(users));
            }

            Promise.resolve(loadUsers()).catch(() => {});
            alert('Users uploaded successfully');
            // After bulk upload, ensure session role is synced
            syncCurrentUserRole();
            checkAdminStatus();
        } catch (err) {
            alert('CSV upload failed: ' + err.message);
        }
        event.target.value = '';
    };
    reader.onerror = () => alert('Failed reading file');
    reader.readAsText(file);
}

let __ytApiPromise = null;
let __coursePlayer = null;
let __coursePlayerTick = null;
let __courseWatch = { videoId: '', maxSeconds: 0, durationSeconds: 0, completed: false, resumeSeconds: 0 };

function clampNumber(n, min, max) {
    const v = Number(n);
    if (!Number.isFinite(v)) return min;
    return Math.min(Math.max(v, min), max);
}

async function getSavedWatchForVideo(videoId) {
    const vid = String(videoId || '').trim();
    if (!vid) return { completed: false, resumeSeconds: 0, maxSeconds: 0, durationSeconds: 0 };
    try {
        const map = await getAllProgressMap();
        const p = map[vid] || {};
        const w = (p && typeof p === 'object') ? (p.watch || {}) : {};
        const completed = w?.completed === true;
        const durationSeconds = clampNumber(w?.durationSeconds || w?.duration || 0, 0, 24 * 60 * 60);
        const maxSeconds = clampNumber(w?.maxSeconds || 0, 0, 24 * 60 * 60);
        const lastSeconds = clampNumber(w?.lastSeconds || 0, 0, 24 * 60 * 60);

        // Prefer where they actually left off; fall back to furthest watched.
        let resumeSeconds = Math.max(lastSeconds, 0);
        if (!resumeSeconds && maxSeconds) resumeSeconds = maxSeconds;

        // If completed, always start from 0 (replay from start).
        if (completed) resumeSeconds = 0;

        // If we know duration, avoid resuming in the last couple seconds.
        if (durationSeconds > 0 && resumeSeconds >= durationSeconds - 3) resumeSeconds = 0;

        return { completed, resumeSeconds, maxSeconds, durationSeconds };
    } catch (_) {
        return { completed: false, resumeSeconds: 0, maxSeconds: 0, durationSeconds: 0 };
    }
}

async function persistWatchPosition({ videoId, lastSeconds, maxSeconds, durationSeconds, completed }) {
    const vid = String(videoId || '').trim();
    if (!vid) return;
    const nowIso = new Date().toISOString();

    // Never downgrade completion once true.
    let completedFinal = completed === true;
    try {
        if (!completedFinal) {
            const map = loadCatalogProgressLocal();
            const existing = map[vid] && typeof map[vid] === 'object' ? map[vid] : {};
            const existingWatch = (existing && typeof existing.watch === 'object') ? existing.watch : {};
            if (existingWatch?.completed === true) completedFinal = true;
        }
    } catch (_) {}

    const patch = {
        lastActivityAt: nowIso,
        watch: {
            ...(typeof durationSeconds === 'number' && durationSeconds > 0 ? { durationSeconds } : {}),
            ...(typeof maxSeconds === 'number' && maxSeconds >= 0 ? { maxSeconds } : {}),
            ...(typeof lastSeconds === 'number' && lastSeconds >= 0 ? { lastSeconds } : {}),
            completed: completedFinal
        }
    };
    try {
        await upsertCourseProgress(vid, patch);
    } catch (_) {}
}

function loadYouTubeIFrameApiOnce() {
    if (__ytApiPromise) return __ytApiPromise;
    __ytApiPromise = new Promise((resolve, reject) => {
        if (window.YT && window.YT.Player) {
            resolve();
            return;
        }
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        tag.async = true;
        tag.onerror = () => reject(new Error('Failed loading YouTube API'));
        document.head.appendChild(tag);
        const prev = window.onYouTubeIframeAPIReady;
        window.onYouTubeIframeAPIReady = () => {
            try { if (typeof prev === 'function') prev(); } catch (_) {}
            resolve();
        };
    });
    return __ytApiPromise;
}

function stopCoursePlayerTick() {
    if (__coursePlayerTick) {
        clearInterval(__coursePlayerTick);
        __coursePlayerTick = null;
    }
}

async function startCoursePlayer(auto = false) {
    const container = document.getElementById('coursePlayerFrame');
    const playBtn = document.getElementById('coursePlayerPlay');
    if (!container) return;

    const hasValidId = currentCourseVideoId && String(currentCourseVideoId).trim().length === 11;
    if (!hasValidId) {
        alert('Invalid course video.');
        return;
    }

    await loadYouTubeIFrameApiOnce();

    const vid = String(currentCourseVideoId).trim();
    const saved = await getSavedWatchForVideo(vid);
    const resume = clampNumber(saved.resumeSeconds || 0, 0, 24 * 60 * 60);
    const initialMax = Math.max(saved.maxSeconds || 0, saved.resumeSeconds || 0);
    __courseWatch = {
        videoId: vid,
        maxSeconds: initialMax,
        durationSeconds: saved.durationSeconds || 0,
        completed: false,
        resumeSeconds: resume
    };

    // Keep assessment unlocked if already completed previously.
    coursePlayerSetAssessmentLock(!(saved.completed === true));

    const onEnded = async () => {
        stopCoursePlayerTick();
        __courseWatch.completed = true;
        const nowIso = new Date().toISOString();
        await upsertCourseProgress(__courseWatch.videoId, {
            lastActivityAt: nowIso,
            watch: {
                ...(typeof __courseWatch.durationSeconds === 'number' && __courseWatch.durationSeconds > 0 ? { durationSeconds: __courseWatch.durationSeconds } : {}),
                completed: true,
                completedAt: nowIso,
                maxSeconds: __courseWatch.maxSeconds,
                lastSeconds: __courseWatch.maxSeconds
            }
        });
        coursePlayerSetAssessmentLock(false);
    };

    const startTick = () => {
        stopCoursePlayerTick();
        __coursePlayerTick = setInterval(async () => {
            try {
                if (!__coursePlayer || typeof __coursePlayer.getCurrentTime !== 'function') return;
                const t = Number(__coursePlayer.getCurrentTime() || 0);
                const dur = Number(__coursePlayer.getDuration?.() || 0);
                if (dur > 0) __courseWatch.durationSeconds = dur;

                // Anti-skip: prevent large forward jumps
                if (__courseWatch.maxSeconds > 0 && t > (__courseWatch.maxSeconds + 8)) {
                    __coursePlayer.seekTo(__courseWatch.maxSeconds, true);
                    return;
                }

                if (t > __courseWatch.maxSeconds) __courseWatch.maxSeconds = t;

                // Consider completed when max watched time reaches end
                if (!__courseWatch.completed && dur > 0 && __courseWatch.maxSeconds >= (dur - 3)) {
                    await onEnded();
                } else {
                    // Periodically persist watch position so reopen resumes correctly.
                    if (dur > 0 && Math.floor(t) % 5 === 0) {
                        await persistWatchPosition({
                            videoId: __courseWatch.videoId,
                            lastSeconds: t,
                            maxSeconds: __courseWatch.maxSeconds,
                            durationSeconds: dur,
                            completed: false
                        });
                    }
                }
            } catch (_) {}
        }, 1000);
    };

    let resumeApplied = false;
    const trySeekToResume = () => {
        const target = clampNumber(__courseWatch?.resumeSeconds || 0, 0, 24 * 60 * 60);
        if (resumeApplied) return;
        if (!target || target < 2) {
            resumeApplied = true;
            return;
        }
        const attempt = (delayMs) => {
            setTimeout(() => {
                try {
                    if (!__coursePlayer || typeof __coursePlayer.getCurrentTime !== 'function') return;
                    const cur = Number(__coursePlayer.getCurrentTime() || 0);
                    // Only seek if the player is still near the start.
                    if (cur + 1.5 < target) {
                        __coursePlayer.seekTo?.(target, true);
                    } else {
                        resumeApplied = true;
                    }
                } catch (_) {}
            }, delayMs);
        };

        // Multiple attempts handle cases where loadVideoById hasn't buffered yet.
        attempt(180);
        attempt(650);
        attempt(1400);
    };

    if (!__coursePlayer) {
        __coursePlayer = new window.YT.Player('coursePlayerFrame', {
            videoId: __courseWatch.videoId,
            playerVars: { autoplay: 1, rel: 0, modestbranding: 1, playsinline: 1 },
            events: {
                onReady: async () => {
                    try {
                        const dur = Number(__coursePlayer.getDuration?.() || 0);
                        if (dur > 0) {
                            __courseWatch.durationSeconds = dur;
                            await upsertCourseProgress(__courseWatch.videoId, { watch: { durationSeconds: dur } });
                        }
                    } catch (_) {}
                    trySeekToResume();
                    try { __coursePlayer.playVideo?.(); } catch (_) {}
                },
                onStateChange: async (ev) => {
                    if (!ev) return;
                    if (ev.data === 0) {
                        await onEnded();
                    } else if (ev.data === 1) {
                        // Apply resume seek on first play as well (more reliable than onReady alone).
                        trySeekToResume();
                        startTick();
                    } else if (ev.data === 2) {
                        stopCoursePlayerTick();
                        // Persist position on pause.
                        try {
                            const t = Number(__coursePlayer.getCurrentTime?.() || 0);
                            const dur = Number(__coursePlayer.getDuration?.() || 0);
                            if (!__courseWatch.completed) {
                                await persistWatchPosition({
                                    videoId: __courseWatch.videoId,
                                    lastSeconds: t,
                                    maxSeconds: Math.max(__courseWatch.maxSeconds || 0, t),
                                    durationSeconds: dur > 0 ? dur : __courseWatch.durationSeconds,
                                    completed: false
                                });
                            }
                        } catch (_) {}
                    }
                }
            }
        });
    } else {
        try {
            // loadVideoById accepts either (videoId, startSeconds) or an object.
            try {
                __coursePlayer.loadVideoById({ videoId: __courseWatch.videoId, startSeconds: resume || 0 });
            } catch (_) {
                __coursePlayer.loadVideoById(__courseWatch.videoId, resume || 0);
            }
            trySeekToResume();
        } catch (_) {
            try { __coursePlayer.destroy?.(); } catch (_) {}
            __coursePlayer = null;
            return startCoursePlayer(auto);
        }
    }

    if (playBtn) playBtn.style.display = 'none';
}

function closeCoursePlayer() {
    const overlay = document.getElementById('coursePlayerOverlay');
    const frame = document.getElementById('coursePlayerFrame');
    const playBtn = document.getElementById('coursePlayerPlay');
    const infoPanel = document.getElementById('coursePlayerInfoPanel');
    // Persist the latest position before stopping playback.
    (async () => {
        try {
            if (window.__coursePlayerMode !== 'youtube') return;
            if (!__coursePlayer || typeof __coursePlayer.getCurrentTime !== 'function') return;
            if (!__courseWatch || !__courseWatch.videoId) return;
            if (__courseWatch.completed) return;
            const t = Number(__coursePlayer.getCurrentTime() || 0);
            const dur = Number(__coursePlayer.getDuration?.() || 0);
            await persistWatchPosition({
                videoId: __courseWatch.videoId,
                lastSeconds: t,
                maxSeconds: Math.max(__courseWatch.maxSeconds || 0, t),
                durationSeconds: dur > 0 ? dur : __courseWatch.durationSeconds,
                completed: false
            });
        } catch (_) {}
    })();
    stopCoursePlayerTick();
    try { __coursePlayer?.stopVideo?.(); } catch (_) {}
    try {
        if (window.__coursePlayerMode === 'url' && frame) frame.innerHTML = '';
    } catch (_) {}
    if (overlay) overlay.style.display = 'none';
    if (playBtn) playBtn.style.display = 'flex';
    if (infoPanel) infoPanel.style.display = 'block';
    currentCourseVideoId = '';
    window.__coursePlayerMode = '';
    coursePlayerSetAssessmentLock(true);
}

function overlayBackdropClick(event) {
    if (event.target.id === 'coursePlayerOverlay') {
        closeCoursePlayer();
    }
}

async function loadCoursesView(searchTerm = '') {
    // Sync shared courses from API first so all users see the same courses
    console.log('loadCoursesView called with searchTerm:', searchTerm);
    const courses = await syncSharedCourses();
    
    console.log('Loading courses view, found', courses.length, 'courses:', courses);
    
    const sections = {
        beginner: document.querySelector('#beginner-courses .type-grid'),
        intermediate: document.querySelector('#intermediate-courses .type-grid'),
        advanced: document.querySelector('#advanced-courses .type-grid')
    };
    
    // Check if sections exist
    if (!sections.beginner || !sections.intermediate || !sections.advanced) {
        console.error('Course sections not found in DOM');
        return;
    }
    
    // Clear
    Object.values(sections).forEach(grid => {
        if (grid) grid.innerHTML = '';
    });
    
    const term = searchTerm.trim().toLowerCase();
    const matchesTerm = (name) => {
        if (!term) return true;
        const words = name.toLowerCase().split(/\s+/);
        return words.some(w => w.startsWith(term));
    };
    
    let displayedCount = 0;
    courses
        .filter(course => matchesTerm(course.name))
        .forEach(course => {
        const card = document.createElement('div');
        card.className = 'course-card';
        const safeName = String(course.name || '').replace(/'/g, "\\'").replace(/\"/g, '&quot;');
        const safeType = String(course.type || '').replace(/'/g, "\\'");
        card.innerHTML = `
            <div onclick="openCoursePlayer('${course.videoId}', '${safeName}', '${safeType}')">
                <img src="https://img.youtube.com/vi/${course.videoId}/hqdefault.jpg" alt="${course.name}" style="width: 100%; height: auto; border-radius:8px; margin-bottom: 10px; display: block;">
            </div>
            <p style="margin:10px 0 5px 0; text-align:center; color:var(--text-main); font-weight:500;">${course.name}</p>
            <small style="color:var(--text-secondary); text-align:center; display:block;">Uploaded: ${course.uploadDate}</small>
            <small style="color:var(--text-secondary); text-align:center; display:block;">Uploaded by: ${String(course.source || course.addedBy || 'Admin')}</small>
            <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
                <button class="btn-secondary" onclick="event.stopPropagation(); openCoursePlayer('${course.videoId}', '${safeName}', '${safeType}')">Open</button>
                <button class="btn-secondary" onclick="event.stopPropagation(); startCatalogAssessment('${course.videoId}', '${safeName}', '${safeType}')">Assessment</button>
            </div>
        `;
        const targetSection = sections[course.type];
        if (targetSection) {
            targetSection.appendChild(card);
            displayedCount++;
        } else {
            console.warn('No section found for course type:', course.type);
        }
    });
    
    console.log('Displayed', displayedCount, 'courses in the view');
}

// Note: All initialization moved to window.onload above to avoid conflicts

function checkAdminStatus() {
    // Check if user is admin (includes both Superadmin and regular Admin)
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const userEmail = localStorage.getItem('userEmail') || '';
    const userRole = (localStorage.getItem('userRole') || '').toLowerCase();
    const isSuperadmin = userEmail.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase();
    const isAdmin = userRole === 'admin' || isSuperadmin;
    
    console.log('Admin check - Email:', userEmail, 'Role:', userRole, 'Is Admin:', isAdmin);
    
    // Admin Refresh News Button - Admin only
    const refreshBtn = document.getElementById('adminRefreshNewsBtn');
    if (refreshBtn) {
        refreshBtn.style.display = isAdmin ? 'block' : 'none';
    }
    
    // User Management Sidebar - Admin only
    const userMgmtItem = document.getElementById('userMgmtSidebarItem');
    if (userMgmtItem) {
        userMgmtItem.style.display = isAdmin ? 'block' : 'none';
    }
    
    // Role Management Sidebar - Admin only
    const roleMgmtItem = document.getElementById('roleMgmtSidebarItem');
    if (roleMgmtItem) {
        roleMgmtItem.style.display = isAdmin ? 'block' : 'none';
    }
    
    // Course Management Sidebar - Admin only
    const courseMgmtItem = document.getElementById('courseMgmtSidebarItem');
    if (courseMgmtItem) {
        courseMgmtItem.style.display = isAdmin ? 'block' : 'none';
    }

    // Activity Logs Sidebar - Admin only
    const activityLogsItem = document.getElementById('activityLogsSidebarItem');
    if (activityLogsItem) {
        activityLogsItem.style.display = isAdmin ? 'block' : 'none';
    }

    // Clear All Courses button - Admin only
    const clearAllCoursesBtn = document.getElementById('clearAllCoursesBtn');
    if (clearAllCoursesBtn) {
        const alreadyCleared = localStorage.getItem('one_time_courses_cleared') === 'true';
        clearAllCoursesBtn.style.display = (isAdmin && !alreadyCleared) ? 'inline-block' : 'none';
    }
    
    // Reset All button - Admin only
    const resetAllBtn = document.getElementById('resetAllAssessmentsBtn');
    if (resetAllBtn) {
        resetAllBtn.style.display = isAdmin ? 'block' : 'none';
    }
    
    // If non-admin tries to view admin sections, redirect to home
    if (!isAdmin) {
        const currentView = document.querySelector('section[style*="display: block"], section[style*="display:block"]');
        if (currentView) {
            const viewId = currentView.id;
            if (viewId === 'admin-view' || viewId === 'role-mgmt-view' || viewId === 'course-mgmt-view' || viewId === 'activity-logs-view') {
                switchTab('home-view', null);
            }
        }
    }
}

async function clearAllCoursesOneTime() {
    const isAdmin = (localStorage.getItem('userRole') || '').toLowerCase() === 'admin' || (localStorage.getItem('userEmail') || '').toLowerCase() === 'ravikiran@oneorigin.us';
    if (!isAdmin) {
        alert('Only Admin can clear courses.');
        return;
    }

    const alreadyCleared = localStorage.getItem('one_time_courses_cleared') === 'true';
    if (alreadyCleared) {
        alert('Courses were already cleared once.');
        return;
    }

    const typed = prompt('This will permanently delete ALL courses for ALL users (database + local).\n\nType CLEAR ALL to continue:');
    if (String(typed || '').trim().toUpperCase() !== 'CLEAR ALL') {
        alert('Cancelled.');
        return;
    }

    try {
        if (window.deleteAllSharedCourses) {
            await window.deleteAllSharedCourses();
        } else {
            // Fallback: clear local only
            localStorage.setItem('courses', '[]');
        }

        // Prevent restore from sessionStorage backup
        try { sessionStorage.removeItem('courses_backup'); } catch (_) {}

        localStorage.setItem('one_time_courses_cleared', 'true');
        const btn = document.getElementById('clearAllCoursesBtn');
        if (btn) btn.style.display = 'none';

        await loadCourses();
        await loadCoursesView();
        if (typeof loadRoles === 'function') loadRoles();
        alert('All courses cleared successfully.');
    } catch (e) {
        console.error('Failed clearing all courses:', e);
        alert('Failed to clear all courses: ' + (e?.message || e));
    }
}

async function syncCurrentUserRole() {
    const currentName = (localStorage.getItem('userName') || '').trim();
    const currentEmail = (localStorage.getItem('userEmail') || '').trim();
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';

    // Superadmin always admin
    if (currentEmail.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase()) {
        localStorage.setItem('userRole', 'admin');
        return;
    }

    // Prefer cloud role
    try {
        if (window.getSharedUserByEmail) {
            const me = await window.getSharedUserByEmail(currentEmail);
            if (me?.role) {
                localStorage.setItem('userRole', String(me.role).toLowerCase() === 'admin' ? 'admin' : 'user');
                return;
            }
        }
    } catch (e) {
        console.warn('Cloud role lookup failed; using local fallback', e);
    }

    // Local fallback
    try {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const match = users.find(u =>
            (u.email && currentEmail && u.email.toLowerCase() === currentEmail.toLowerCase()) ||
            (u.name && currentName && u.name.toLowerCase() === currentName.toLowerCase())
        );
        if (match && match.role) {
            localStorage.setItem('userRole', String(match.role).toLowerCase());
        } else {
            localStorage.setItem('userRole', 'user');
        }
    } catch (_) {
        localStorage.setItem('userRole', 'user');
    }
}

function forceRefreshNews() {
    // No blocking popups on refresh; just refresh immediately.
    // Best-effort cleanup of old cached keys (news is now always fetched fresh)
    localStorage.removeItem('aiNews');
    localStorage.removeItem('aiNewsTimestamp');
    localStorage.removeItem('aiUpdates');
    localStorage.removeItem('aiUpdatesTimestamp');
    // Fetch fresh news (no cache)
    fetchAINews();
    fetchAIUpdates();
    try {
        if (window.appUI && typeof window.appUI.toast === 'function') {
            window.appUI.toast({ title: 'Refreshing', message: 'AI news is refreshing', type: 'info' });
        }
    } catch (_) {}
}

function logout() {
    // Clear only session identifiers; keep all persisted data (users, roles, courses, news, etc.)
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userName');
    localStorage.removeItem('userRole');
    // Redirect to login page
    window.location.href = 'index.html';
}

// ============ Measure & Master Functions ============
let assessmentQuestions = [];
let currentQuestionIndex = 0;
let userAnswers = [];
let currentAssessmentType = 'initial'; // 'initial' or 'video'
let currentVideoAssessmentCourse = null;

async function startInitialAssessment() {
    document.getElementById('initialAssessmentContainer').style.display = 'none';
    document.getElementById('assessmentQuizContainer').innerHTML = '<p style="text-align:center; color:var(--text-secondary);">Generating personalized questions...</p>';
    document.getElementById('assessmentQuizContainer').style.display = 'block';
    
    currentAssessmentType = 'initial';
    // Mark assessment as started to hide the announcement
    localStorage.setItem('initialAssessmentStarted', 'true');
    if (typeof updateAnnouncements === 'function') updateAnnouncements();
    await generateQuestions();
    displayQuestion();
}

async function generateQuestions() {
    try {
        const prompt = currentAssessmentType === 'initial' 
            ? `Generate exactly 20 multiple-choice questions covering Web Development, Large Language Models (LLMs), Transformers, OCR tools, Artificial Intelligence, Machine Learning, and related technologies. Each question should have 4 options with only one correct answer. Return a JSON array with this exact structure: [{"question": "...", "options": ["A) ...", "B) ...", "C) ...", "D) ..."], "correctAnswer": "A"}]. Make questions challenging and practical.`
            : `Based on the video topic "${currentVideoAssessmentCourse.topic}", generate exactly 10 multiple-choice questions that test understanding of the concepts covered. Each question should have 4 options with only one correct answer. Return a JSON array with this exact structure: [{"question": "...", "options": ["A) ...", "B) ...", "C) ...", "D) ..."], "correctAnswer": "A"}]. Focus on key concepts, definitions, and applications.`;

        const data = await callGeminiAPI(prompt, 'gemini-2.5-flash');
        if (data.error) throw new Error(data.error.message);

        let textResponse = data.candidates[0].content.parts[0].text;
        const cleanJson = textResponse.replace(/```json|```/g, "").trim();
        assessmentQuestions = JSON.parse(cleanJson);
        currentQuestionIndex = 0;
        userAnswers = [];
    } catch (error) {
        console.error("Question generation error:", error);
        alert("Failed to generate questions. Please try again.");
    }
}

function displayQuestion() {
    if (currentQuestionIndex >= assessmentQuestions.length) return;

    const q = assessmentQuestions[currentQuestionIndex];
    const container = document.getElementById('assessmentQuizContainer');
    
    container.innerHTML = `
        <div id="quizProgress" style="color:var(--text-secondary); margin-bottom:15px;">Question ${currentQuestionIndex + 1} of ${assessmentQuestions.length}</div>
        <div id="quizQuestion" style="background:var(--card-bg); padding:20px; border:1px solid var(--border-color); border-radius:8px; margin-bottom:20px;">
            <h3 id="questionText" style="color:var(--text-main); margin-bottom:15px;">${q.question}</h3>
            <div id="optionsContainer">
                ${q.options.map((opt, idx) => `
                    <div class="quiz-option" onclick="selectOption(${idx})" data-option="${idx}">
                        ${opt}
                    </div>
                `).join('')}
            </div>
        </div>
        ${currentQuestionIndex < assessmentQuestions.length - 1 
            ? '<button id="nextQuestionBtn" onclick="nextQuestion()" style="background:var(--primary-blue); color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">Next Question</button>'
            : '<button id="submitAssessmentBtn" onclick="submitAssessment()" style="background:#4CAF50; color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">Submit Assessment</button>'}
    `;
}

function selectOption(optionIndex) {
    document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector(`[data-option="${optionIndex}"]`).classList.add('selected');
    userAnswers[currentQuestionIndex] = String.fromCharCode(65 + optionIndex); // A, B, C, D
}

function nextQuestion() {
    if (!userAnswers[currentQuestionIndex]) {
        alert('Please select an answer before proceeding.');
        return;
    }
    currentQuestionIndex++;
    displayQuestion();
}

async function submitAssessment() {
    if (!userAnswers[currentQuestionIndex]) {
        alert('Please select an answer before submitting.');
        return;
    }

    const score = calculateScore();
    
    if (currentAssessmentType === 'initial') {
        // Store initial assessment score
        localStorage.setItem('initialAssessmentScore', `${score}/${assessmentQuestions.length}`);
        await showInitialResults(score);
    } else {
        await showVideoAssessmentResults(score);
    }
}

function calculateScore() {
    let correct = 0;
    assessmentQuestions.forEach((q, idx) => {
        if (userAnswers[idx] === q.correctAnswer) correct++;
    });
    return correct;
}

async function showInitialResults(score) {
    document.getElementById('assessmentQuizContainer').style.display = 'none';
    
    const scoreOutOf10 = (score / assessmentQuestions.length * 10).toFixed(1);
    let level = '';
    const scoreNum = Number(scoreOutOf10);
    // 05 Beginner, 68 Intermediate, 910 Advanced
    if (scoreNum <= 5) level = 'Beginner';
    else if (scoreNum <= 8) level = 'Intermediate';
    else level = 'Advanced';

    // Persist the results
    localStorage.setItem('initialAssessmentScore', scoreOutOf10);
    localStorage.setItem('userLevel', level);

    const resultsDiv = document.getElementById('assessmentResults');
    resultsDiv.style.display = 'block';
    document.getElementById('scoreDisplay').textContent = `${scoreOutOf10}/10`;
    document.getElementById('levelDisplay').innerHTML = `Level: <span style="color:var(--primary-blue);">${level}</span>`;

    // Show answer review (selected vs correct)
    setAssessmentAnswersReview(assessmentQuestions, userAnswers, {
        title: 'Answer Review (Gateway Assessment)'
    });

    // Refresh the top status UI
    updateInitialAssessmentStatus();

    // Get video suggestion from Gemini
    await getVideoSuggestion(level, scoreOutOf10);
}

async function getVideoSuggestion(level, score) {
    const container = document.getElementById('videoSuggestionContainer');
    container.innerHTML = '<p style="color:var(--text-secondary); display:flex; align-items:center; gap:8px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-search"></use></svg></span>Searching YouTube for verified courses...</p>';

    console.log('Getting video suggestion for level:', level);

    async function checkYouTubeVideo(videoId) {
        try {
            const resp = await fetch(`/api/youtube/check?videoId=${encodeURIComponent(videoId)}`);
            if (!resp.ok) return { ok: false, reason: `HTTP ${resp.status}` };
            return await resp.json();
        } catch (e) {
            return { ok: false, reason: e && e.message ? e.message : 'Network error' };
        }
    }

    // Guaranteed fallback list (known public tutorials). This ensures employees always get a course.
    const FALLBACK_VIDEOS = {
        Beginner: [
            { videoId: 'PkZNo7MFNFg', topic: 'JavaScript Full Course (Beginner) - freeCodeCamp.org' },
            { videoId: 'pQN-pnXPaVg', topic: 'Python for Beginners - freeCodeCamp.org' },
            { videoId: 'kUMe1FH4CHE', topic: 'HTML Full Course - Build a Website Tutorial - freeCodeCamp.org' },
        ],
        Intermediate: [
            { videoId: 'Ke90Tje7VS0', topic: 'React JS Crash Course - Traversy Media' },
            { videoId: 'Oe421EPjeBE', topic: 'Node.js Crash Course - Traversy Media' },
            { videoId: '8mAITcNt710', topic: 'Complete Python Course (Intermediate) - freeCodeCamp.org' },
        ],
        Advanced: [
            { videoId: 'i_LwzRVP7bg', topic: 'Advanced JavaScript Concepts - freeCodeCamp.org' },
            { videoId: 'aircAruvnKk', topic: 'Neural Networks / Deep Learning - 3Blue1Brown' },
            { videoId: 'Z_ikDlimN6A', topic: 'System Design Interview Concepts - freeCodeCamp.org' },
        ]
    };

    // Directly fetch from YouTube using AI with Google Search grounding
    function buildPrompt(extraConstraints = '') {
        return `Use Google Search to find ONE REAL, PUBLICLY AVAILABLE, EMBEDDABLE YouTube tutorial video for a ${level} level learner.

CRITICAL REQUIREMENTS:
1. Video MUST be from verified educational channels: freeCodeCamp, Traversy Media, Programming with Mosh, Academind, The Net Ninja, Web Dev Simplified, or Fireship
2. Video MUST be PUBLIC and EMBEDDABLE (playable in YouTube embed iframe; not private, unlisted, age-restricted, region-blocked, or embed-disabled)
3. Video MUST be a FULL TUTORIAL (not a trailer, promo, or unavailable video)
4. Verify the video ID is correct - test URL: https://www.youtube.com/watch?v={videoId}
5. Extract ONLY the 11-character YouTube video ID (e.g., "dQw4w9WgXcQ")
6. Video should be for ${level === 'Beginner' ? 'beginners with no prior experience' : level === 'Intermediate' ? 'intermediate learners with basic knowledge' : 'advanced developers'}
7. Topics: Web Development (HTML/CSS/JavaScript/React), Python, AI/ML, or general programming

${extraConstraints}

Return ONLY valid JSON (no markdown):
{
  "videoId": "11_CHAR_VIDEO_ID",
  "topic": "Exact video title from YouTube",
  "definition": "What students will learn (2-3 sentences)",
  "uses": "Real-world applications and skills gained"
}

DO NOT return videos that show gray thumbnails or have embedding disabled.`;
    }

    try {
        let lastReject = '';
        let selected = null;

        for (let attempt = 1; attempt <= 3; attempt++) {
            container.innerHTML = `<p style="color:var(--text-secondary); display:flex; align-items:center; gap:8px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-search"></use></svg></span>Searching YouTube for verified courses... (attempt ${attempt}/3)</p>`;

            const extra = lastReject
                ? `IMPORTANT: The previous candidate was rejected because: ${lastReject}. Pick a DIFFERENT video that is playable in embed.`
                : `IMPORTANT: Prefer long-form tutorials (20+ minutes) from the listed channels.`;

            const data = await callGeminiAPI(buildPrompt(extra), 'gemini-2.5-flash');
            if (data.error) throw new Error(data.error.message);

            let textResponse = data.candidates[0].content.parts[0].text;
            let cleanJson = textResponse.replace(/```json|```/g, "").trim();
            const jsonMatch = cleanJson.match(/\{[\s\S]*\}/);
            if (jsonMatch) cleanJson = jsonMatch[0];

            const videoData = JSON.parse(cleanJson);
            console.log('AI suggested course:', videoData);

            if (!videoData.videoId || !videoData.topic) {
                lastReject = 'missing videoId/topic';
                continue;
            }
            if (String(videoData.videoId).length !== 11) {
                lastReject = `invalid videoId format (${videoData.videoId})`;
                continue;
            }

            const check = await checkYouTubeVideo(videoData.videoId);
            if (!check.ok) {
                lastReject = check.reason || check.status || 'video unavailable/unembeddable';
                continue;
            }

            // Use verified title from check if available
            if (check.title && !videoData.topic) videoData.topic = check.title;
            selected = videoData;
            break;
        }

        if (!selected) {
            // Fallback to curated list and validate; if validation fails, still assign the first fallback.
            const candidates = FALLBACK_VIDEOS[level] || FALLBACK_VIDEOS.Beginner;
            for (const c of candidates) {
                const check = await checkYouTubeVideo(c.videoId);
                if (check && check.ok) {
                    selected = {
                        videoId: c.videoId,
                        topic: check.title || c.topic,
                        definition: 'A curated tutorial selected as a reliable fallback when search results are unavailable.',
                        uses: 'Build core practical skills with a long-form training video.'
                    };
                    break;
                }
            }

            if (!selected && candidates.length > 0) {
                // Absolute last resort: assign first fallback without validation.
                selected = {
                    videoId: candidates[0].videoId,
                    topic: candidates[0].topic,
                    definition: 'A curated tutorial selected as a reliable fallback when validation is unavailable.',
                    uses: 'Build core practical skills with a long-form training video.'
                };
            }
        }

        if (!selected) {
            throw new Error('Unable to assign a course at this time.');
        }

        assignCourseToUser(selected, level);
        container.innerHTML = `
            <div style="background:rgba(76,175,80,0.1); padding:15px; border-radius:8px; border:1px solid #4CAF50;">
                <p style="color:#4CAF50; font-weight:bold; margin-bottom:10px;"> YouTube Course Assigned!</p>
                <p style="color:var(--text-main);">The course <strong>${selected.topic}</strong> has been assigned.</p>
                <p style="color:var(--text-secondary); font-size:12px; margin-top:8px; display:flex; align-items:center; gap:6px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-pin"></use></svg></span>Scroll down to "My Assigned Courses" section to start learning</p>
            </div>
        `;
    } catch (error) {
        console.error('Error fetching YouTube course:', error);
        container.innerHTML = `
            <div style="background:rgba(248,81,73,0.1); padding:15px; border-radius:8px; border:1px solid #f85149;">
                <p style="color:#f85149; font-weight:bold; margin-bottom:10px; display:flex; align-items:center; gap:8px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-warning"></use></svg></span>Error Fetching Course</p>
                <p style="color:var(--text-main); font-size:13px;">${error.message}</p>
                <p style="color:var(--text-secondary); font-size:12px; margin-top:8px;">Please try the "Reset All" button and attempt the assessment again, or add a ${level} level course manually in Course Management.</p>
            </div>
        `;
    }
}

function assignCourseToUser(videoData, level) {
    console.log('Assigning course:', videoData);
    const assignedCourses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    const newCourse = {
        id: Date.now(),
        videoId: videoData.videoId,
        topic: videoData.topic,
        definition: videoData.definition,
        uses: videoData.uses,
        level: level,
        assignedDate: new Date().toLocaleDateString(),
        completed: false,
        passed: false
    };
    assignedCourses.push(newCourse);
    localStorage.setItem('assignedCourses', JSON.stringify(assignedCourses));
    console.log('Course assigned successfully. Total courses:', assignedCourses.length);
    
    // Reload the courses display
    loadAssignedCourses();
    
    // Scroll to the assigned courses section after a brief delay
    setTimeout(() => {
        const assignedSection = document.getElementById('assignedCoursesSection');
        if (assignedSection) {
            assignedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 500);
}

function updateInitialAssessmentStatus() {
    const initialScore = localStorage.getItem('initialAssessmentScore');
    const userLevel = localStorage.getItem('userLevel');
    const statusDiv = document.getElementById('initialAssessmentStatus');
    const startBtn = document.getElementById('startAssessmentBtn');
    const container = document.getElementById('initialAssessmentContainer');
    
    if (!statusDiv || !startBtn) return;
    
    if (initialScore) {
        // Hide the start button and instructions
        startBtn.style.display = 'none';
        container.querySelector('p').style.display = 'none';
        
        // Show the persistent result card
        statusDiv.innerHTML = `
            <div style="padding:25px; background:rgba(66, 133, 244, 0.1); border:2px solid var(--primary-blue); border-radius:12px; max-width:500px; margin: 0 auto;">
                <h3 style="color:var(--primary-blue); margin-top:0;">Your Gateway Results</h3>
                <div style="font-size:36px; font-weight:bold; color:var(--text-main); margin:15px 0;">${initialScore}/10</div>
                <div style="font-size:18px; margin-bottom:10px;">Assigned Level: <span style="color:var(--primary-blue); font-weight:800;">${userLevel}</span></div>
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:0;">Assessment locked. Courses below are tailored to this result.</p>
            </div>
        `;
    } else {
        startBtn.style.display = 'block';
        container.querySelector('p').style.display = 'block';
        statusDiv.innerHTML = '';
    }
}

async function loadAssignedCourses() {
    const courses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    const upcomingCourse = JSON.parse(localStorage.getItem('upcomingCourse') || 'null');
    const assignedGrid = document.getElementById('assignedCoursesGrid');
    const passedGrid = document.getElementById('passedCoursesGrid');
    
    // Update initial assessment button status
    updateInitialAssessmentStatus();
    
    if (!assignedGrid || !passedGrid) return;

    // Pull watch completion from the shared progress store
    const progressMap = await getAllProgressMap();

    const activeCourses = courses.filter(c => !c.passed);
    const passedCourses = courses.filter(c => c.passed);

    // Render active courses with locking logic
    if (activeCourses.length === 0) {
        assignedGrid.innerHTML = '<p style="color:var(--text-secondary); grid-column:1/-1; text-align:center;">No active courses. Complete an assessment to get personalized recommendations!</p>';
    } else {
        let activeCoursesHTML = activeCourses.map((course, index) => {
            // Only the first active course is unlocked
            const isLocked = index > 0;
            const previousCourse = index > 0 ? activeCourses[index - 1] : null;

            const vid = String(course?.videoId || '').trim();
            const p = vid ? (progressMap[vid] || {}) : {};
            const watched = p?.watch?.completed === true;
            
            return `
            <div class="assigned-course-card" style="${isLocked ? 'opacity: 0.5; position: relative;' : ''}">
                ${isLocked ? '<div style="position:absolute; top:10px; right:10px; background:#f85149; color:white; padding:5px 10px; border-radius:6px; font-size:11px; font-weight:bold; display:inline-flex; align-items:center; gap:6px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-lock"></use></svg></span>Locked</div>' : ''}
                <div class="course-thumbnail-wrapper">
                    <img src="https://img.youtube.com/vi/${course.videoId}/mqdefault.jpg" alt="${course.topic}" ${!isLocked ? `onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")'` : ''} style="max-width: 50%; margin: 0 auto; display: block; ${!isLocked ? 'cursor: pointer;' : ''} border-radius: 8px;">
                </div>
                <h4 style="color:var(--primary-blue); margin:10px 0;">${course.topic}</h4>
                <p style="color:var(--text-secondary); font-size:12px; margin-bottom:10px;">Level: ${course.level} | Assigned: ${course.assignedDate}</p>
                
                <div class="course-definition">
                    <strong style="color:var(--primary-blue);">Definition:</strong> ${course.definition}
                </div>
                
                <div class="course-uses">
                    <strong style="color:#4CAF50;">Uses:</strong> ${course.uses}
                </div>
                
                ${isLocked 
                    ? `<div style="margin-top:15px; padding:10px; background:rgba(248,81,73,0.1); border:1px solid #f85149; border-radius:6px; text-align:center; color:#f85149; font-size:12px; display:flex; align-items:center; justify-content:center; gap:6px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-lock"></use></svg></span>Complete "${previousCourse.topic}" assessment first</div>`
                    : course.attemptedDate 
                        ? `<button onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")' style="width:100%; margin-top:15px; background:var(--primary-blue); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;"> Start Training</button>
                           <div style="width:100%; margin-top:10px; padding:12px; background:rgba(76,175,80,0.1); border:1px solid #4CAF50; border-radius:6px; text-align:center;">
                               <div style="color:#4CAF50; font-weight:bold; margin-bottom:5px;"> Already Attempted</div>
                               <div style="color:var(--text-main); font-size:14px;">Score: ${course.lastScore}% (${course.attemptCount} attempt${course.attemptCount > 1 ? 's' : ''})</div>
                               <div style="color:var(--text-secondary); font-size:12px; margin-top:3px;">Last: ${course.attemptedDate}</div>
                               ${course.lastScore < 80 ? `<button onclick="startVideoAssessment(${course.id})" style="width:100%; margin-top:8px; background:#f0ad4e; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:12px;">Retake Assessment</button>` : ''}
                           </div>`
                                : `<button onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")' style="width:100%; margin-top:15px; background:var(--primary-blue); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;"> Start Training</button>
                                    ${watched
                                          ? `<button onclick="startVideoAssessment(${course.id})" style="width:100%; margin-top:10px; background:#4CAF50; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">Attend Assessment</button>`
                                          : `<button disabled style="width:100%; margin-top:10px; background:#161b22; color:#484f58; border:1px solid #30363d; padding:10px; border-radius:6px; cursor:not-allowed; font-weight:bold;">Attend Assessment</button>
                                              <div style="margin-top:8px; padding:10px; background:rgba(248,81,73,0.08); border:1px solid #f85149; border-radius:6px; text-align:center; color:#f85149; font-size:12px;">Finish watching the full video to unlock the assessment.</div>`
                                    }`
                }
            </div>
        `;
        }).join('');

        // Add upcoming course preview if available
        if (upcomingCourse) {
            activeCoursesHTML += `
            <div class="assigned-course-card" style="opacity: 0.6; position: relative; border: 2px dashed var(--primary-blue);">
                <div style="position:absolute; top:10px; right:10px; background:var(--primary-blue); color:white; padding:5px 10px; border-radius:6px; font-size:11px; font-weight:bold; display:inline-flex; align-items:center; gap:6px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-star"></use></svg></span>Upcoming</div>
                <div class="course-thumbnail-wrapper">
                    <img src="https://img.youtube.com/vi/${upcomingCourse.videoId}/mqdefault.jpg" alt="${upcomingCourse.topic}" style="max-width: 50%; margin: 0 auto; display: block; border-radius: 8px; filter: grayscale(50%);">
                </div>
                <h4 style="color:var(--primary-blue); margin:10px 0;">${upcomingCourse.topic}</h4>
                <p style="color:var(--text-secondary); font-size:12px; margin-bottom:10px;">Level: ${upcomingCourse.level}</p>
                
                <div class="course-definition">
                    <strong style="color:var(--primary-blue);">Definition:</strong> ${upcomingCourse.definition}
                </div>
                
                <div class="course-uses">
                    <strong style="color:#4CAF50;">Uses:</strong> ${upcomingCourse.uses}
                </div>
                
                <div style="margin-top:15px; padding:10px; background:rgba(66,133,244,0.1); border:1px solid var(--primary-blue); border-radius:6px; text-align:center; color:var(--primary-blue); font-size:12px; display:flex; align-items:center; justify-content:center; gap:6px;"><span class="ui-ico-wrap" aria-hidden="true"><svg class="ui-ico"><use href="#ico-star"></use></svg></span>Available after completing current assessment</div>
            </div>
            `;
        }
        
        assignedGrid.innerHTML = activeCoursesHTML;
    }

    // Render passed courses
    if (passedCourses.length === 0) {
        passedGrid.innerHTML = '<p style="color:var(--text-secondary); grid-column:1/-1; text-align:center;">No passed courses yet. Complete assessments to unlock this section!</p>';
    } else {
        passedGrid.innerHTML = passedCourses.map(course => `
            <div class="assigned-course-card" style="border: 2px solid #4CAF50;">
                <div style="position:absolute; top:10px; right:10px; background:#4CAF50; color:white; padding:5px 10px; border-radius:6px; font-size:11px; font-weight:bold;"> Passed</div>
                <div class="course-thumbnail-wrapper">
                    <img src="https://img.youtube.com/vi/${course.videoId}/mqdefault.jpg" alt="${course.topic}" onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")' style="max-width: 50%; margin: 0 auto; display: block; cursor: pointer; border-radius: 8px;">
                </div>
                <h4 style="color:#4CAF50; margin:10px 0;">${course.topic}</h4>
                <p style="color:var(--text-secondary); font-size:12px; margin-bottom:10px;">Level: ${course.level} | Completed: ${course.assignedDate}</p>
                
                <div class="course-definition">
                    <strong style="color:var(--primary-blue);">Definition:</strong> ${course.definition}
                </div>
                
                <div class="course-uses">
                    <strong style="color:#4CAF50;">Uses:</strong> ${course.uses}
                </div>
                
                <button onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")' style="width:100%; margin-top:15px; background:#4CAF50; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;"> Replay Course</button>
            </div>
        `).join('');
    }
}

function openCoursePlayerAndEnableAssessment(courseId, videoId, topic) {
    openCoursePlayer(videoId, topic);
}

function resetAllAssessments() {
    if (confirm('Are you sure you want to reset all progress? This will clear your score and assigned courses.')) {
        localStorage.removeItem('assignedCourses');
        localStorage.removeItem('initialAssessmentScore');
        localStorage.removeItem('userLevel');
        localStorage.removeItem('initialAssessmentStarted');
        localStorage.removeItem('upcomingCourse');
        
        document.getElementById('assessmentResults').style.display = 'none';
        document.getElementById('assessmentQuizContainer').style.display = 'none';
        document.getElementById('initialAssessmentContainer').style.display = 'block';
        const review = document.getElementById('answersReviewContainer');
        if (review) review.innerHTML = '';
        
        assessmentQuestions = [];
        currentQuestionIndex = 0;
        userAnswers = [];
        
        loadAssignedCourses();
        updateInitialAssessmentStatus();
        alert('Profile reset successfully.');
    }
}

async function startVideoAssessment(courseId) {
    const courses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    currentVideoAssessmentCourse = courses.find(c => c.id === courseId);
    
    if (!currentVideoAssessmentCourse) return;

    // Enforce watch-before-assessment
    const ok = await ensureWatchCompletedOrBlock(currentVideoAssessmentCourse.videoId);
    if (!ok) return;

    // Hide assigned courses, show quiz
    document.getElementById('initialAssessmentContainer').style.display = 'none';
    document.getElementById('assessmentResults').style.display = 'none';
    document.getElementById('assessmentQuizContainer').innerHTML = '<p style="text-align:center; color:var(--text-secondary);">Generating questions based on the video content...</p>';
    document.getElementById('assessmentQuizContainer').style.display = 'block';
    
    // Auto-scroll to quiz section
    setTimeout(() => {
        document.getElementById('assessmentQuizContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
    
    currentAssessmentType = 'video';
    await generateQuestions();
    displayQuestion();
}

async function showVideoAssessmentResults(score) {
    document.getElementById('assessmentQuizContainer').style.display = 'none';
    
    const scorePercentage = (score / assessmentQuestions.length * 100).toFixed(0);
    const passed = scorePercentage >= 80;
    const nowIso = new Date().toISOString();
    
    // Generate upcoming course suggestion immediately (before passing)
    const nextLevel = currentVideoAssessmentCourse.level === 'Beginner' ? 'Intermediate' : currentVideoAssessmentCourse.level === 'Intermediate' ? 'Advanced' : null;
    if (nextLevel) {
        suggestNextLevelCourse(nextLevel, currentVideoAssessmentCourse.level);
    }
    
    // Update course status with score and attempt date
    const courses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    const course = courses.find(c => c.id === currentVideoAssessmentCourse.id);
    if (course) {
        course.lastScore = scorePercentage;
        course.attemptedDate = new Date().toLocaleDateString();
        course.attemptCount = (course.attemptCount || 0) + 1;
        if (passed) {
            course.passed = true;
        }
        localStorage.setItem('assignedCourses', JSON.stringify(courses));
        
        // Move upcoming course to assigned courses if available (only if passed)
        if (passed) {
            const upcomingCourse = JSON.parse(localStorage.getItem('upcomingCourse') || 'null');
            if (upcomingCourse) {
                const assignedCourses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
                const newCourse = {
                    id: Date.now(),
                    videoId: upcomingCourse.videoId,
                    topic: upcomingCourse.topic,
                    definition: upcomingCourse.definition,
                    uses: upcomingCourse.uses,
                    level: upcomingCourse.level,
                    assignedDate: new Date().toLocaleDateString(),
                    completed: false,
                    passed: false
                };
                assignedCourses.push(newCourse);
                localStorage.setItem('assignedCourses', JSON.stringify(assignedCourses));
                localStorage.removeItem('upcomingCourse');
            }
        }
        
        loadAssignedCourses();
    }

    // Persist into shared progress so Admin can view it (and for leaderboard)
    try {
        const vid = String(currentVideoAssessmentCourse.videoId || '').trim();
        if (vid) {
            const patch = {
                courseName: String(currentVideoAssessmentCourse.topic || 'Course'),
                courseType: normalizeCourseLevel(currentVideoAssessmentCourse.level || ''),
                lastActivityAt: nowIso,
                ...(passed ? { completedAt: nowIso } : {}),
                assessment: {
                    questionCount: assessmentQuestions.length,
                    correct: score,
                    percent: Number(scorePercentage),
                    passed,
                    lastAttemptedAt: nowIso,
                    attempts: Number((course && course.attemptCount) ? course.attemptCount : 1)
                }
            };
            await upsertCourseProgress(vid, patch);
            if (passed) await updateMyLeaderboardPoints();
        }
    } catch (e) {
        console.warn('Failed persisting Measure & Master progress:', e);
    }
    
    const resultsDiv = document.getElementById('assessmentResults');
    resultsDiv.style.display = 'block';
    document.getElementById('scoreDisplay').textContent = `${score}/${assessmentQuestions.length}`;
    document.getElementById('levelDisplay').innerHTML = `Score: <span style="color:${passed ? '#4CAF50' : '#f85149'};">${scorePercentage}%</span>`;
    document.getElementById('videoSuggestionContainer').innerHTML = `
        <div style="background:rgba(${passed ? '76,175,80' : '248,81,73'},0.1); padding:20px; border-radius:8px; border:1px solid ${passed ? '#4CAF50' : '#f85149'};">
            <h4 style="color:${passed ? '#4CAF50' : '#f85149'}; margin-bottom:10px;">${passed ? ' Assessment Passed!' : ' Assessment Not Passed'}</h4>
            <p style="color:var(--text-main);">You scored ${score} out of ${assessmentQuestions.length} (${scorePercentage}%) on the "${currentVideoAssessmentCourse.topic}" assessment.</p>
            <p style="color:var(--text-secondary); margin-top:10px;">${passed ? 'Congratulations! You have demonstrated strong understanding of this topic and have passed the course. Your next level course has been unlocked!' : 'You need at least 80% to pass this course. Please review the video again and retake the assessment.'}</p>
            <button onclick="resetAssessment()" style="margin-top:15px; background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">Back to Courses</button>
        </div>
    `;

    // Show answer review (selected vs correct)
    setAssessmentAnswersReview(assessmentQuestions, userAnswers, {
        title: `Answer Review (${currentVideoAssessmentCourse?.topic || 'Course'})`
    });
}

function resetAssessment() {
    document.getElementById('assessmentResults').style.display = 'none';
    document.getElementById('assessmentQuizContainer').style.display = 'none';
    document.getElementById('initialAssessmentContainer').style.display = 'block';
    const review = document.getElementById('answersReviewContainer');
    if (review) review.innerHTML = '';
    assessmentQuestions = [];
    currentQuestionIndex = 0;
    userAnswers = [];
    currentAssessmentType = 'initial';
    currentVideoAssessmentCourse = null;
}

async function suggestNextLevelCourse(nextLevel, previousLevel) {
    const availableCourses = JSON.parse(localStorage.getItem('courses') || '[]');
    const nextLevelCourses = availableCourses.filter(c => c.type.toLowerCase() === nextLevel.toLowerCase());

    if (nextLevelCourses.length > 0) {
        const nextCourse = nextLevelCourses[0];
        localStorage.setItem('upcomingCourse', JSON.stringify({
            videoId: nextCourse.videoId,
            topic: nextCourse.name,
            definition: `Advance your skills with this ${nextLevel} library tutorial.`,
            uses: `Deep-dive into ${nextCourse.name}.`,
            level: nextLevel
        }));
        loadAssignedCourses();
    }
}

// Make ALL functions globally available for onclick handlers
window.openAddCourseModal = openAddCourseModal;
window.closeAddCourseModal = closeAddCourseModal;
window.saveNewCourse = saveNewCourse;
window.loadCourses = loadCourses;
window.loadRoles = loadRoles;
window.deleteSelectedRoles = deleteSelectedRoles;
window.openAddUserModal = openAddUserModal;
window.closeAddUserModal = closeAddUserModal;
window.saveNewUser = saveNewUser;
window.deleteUser = deleteUser;
window.toggleSelectAllRoles = toggleSelectAllRoles;
window.switchTab = switchTab;
window.logout = logout;
window.toggleSidebar = toggleSidebar;
window.forceRefreshNews = forceRefreshNews;
window.hubBotInsert = hubBotInsert;
window.resetAllAssessments = resetAllAssessments;
window.startInitialAssessment = startInitialAssessment;
window.nextQuestion = nextQuestion;
window.submitAssessment = submitAssessment;
window.loadCoursesView = loadCoursesView;
window.openCoursePlayer = openCoursePlayer;
window.handleRoleChange = handleRoleChange;
window.startVideoAssessment = startVideoAssessment;
window.resetAssessment = resetAssessment;
window.loadAssignedCourses = loadAssignedCourses;
window.updateInitialAssessmentStatus = updateInitialAssessmentStatus;

// My Progress + catalog assessments
window.loadMyProgress = loadMyProgress;
window.startCatalogAssessment = startCatalogAssessment;
window.startCatalogAssessmentFromPlayer = startCatalogAssessmentFromPlayer;
window.closeCourseAssessment = closeCourseAssessment;
window.courseAssessmentBackdropClick = courseAssessmentBackdropClick;
window.catalogAssessmentSelect = catalogAssessmentSelect;
window.catalogAssessmentNext = catalogAssessmentNext;
window.catalogAssessmentSubmit = catalogAssessmentSubmit;

// Leaderboard
window.loadLeaderboard = loadLeaderboard;
window.updateMyLeaderboardPoints = updateMyLeaderboardPoints;
window.loadRoles = loadRoles;
window.resetUserAssessment = resetUserAssessment;
window.toggleAllRoleChecks = toggleAllRoleChecks;

</script>

<script>
// ===== Hub Bot (Gemini) =====
const HUB_BOT_HISTORY_KEY = 'hubBotHistory'; // legacy
const HUB_BOT_SESSIONS_KEY = 'hubBotSessions';
const HUB_BOT_ACTIVE_SESSION_KEY = 'hubBotActiveSessionId';
const HUB_BOT_SYSTEM_PROMPT = `You are Hub Bot, an AI assistant for the OneOrigin Learning Hub.
Your duties:
- Answer questions about courses available in the hub accurately using the provided course list.
- If asked about broader technical topics beyond the hub, explain clearly with correct, safe, neutral information.
- Be concise, friendly, and practical. Prefer short paragraphs and bullet points when helpful.
- Never provide harmful, hateful, illegal, or unsafe content.`;

function loadHubBotSessions() {
    try {
        const raw = localStorage.getItem(HUB_BOT_SESSIONS_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
    } catch (_) {
        return [];
    }
}

function saveHubBotSessions(sessions) {
    localStorage.setItem(HUB_BOT_SESSIONS_KEY, JSON.stringify(sessions || []));
}

function getActiveHubBotSessionId() {
    return localStorage.getItem(HUB_BOT_ACTIVE_SESSION_KEY) || '';
}

function setActiveHubBotSessionId(id) {
    localStorage.setItem(HUB_BOT_ACTIVE_SESSION_KEY, String(id));
}

function makeChatTitleFromMessages(messages) {
    const firstUser = (messages || []).find(m => m && m.role === 'user' && String(m.content || '').trim());
    const text = firstUser ? String(firstUser.content).trim() : 'New chat';
    return text.length > 40 ? text.slice(0, 40) + '' : text;
}

function ensureActiveHubBotSession() {
    let sessions = loadHubBotSessions();
    let activeId = getActiveHubBotSessionId();

    // One-time migration from legacy single-history storage
    if (sessions.length === 0) {
        try {
            const legacy = JSON.parse(localStorage.getItem(HUB_BOT_HISTORY_KEY) || '[]');
            if (Array.isArray(legacy) && legacy.length > 0) {
                const id = 'chat-' + Date.now();
                const session = {
                    id,
                    title: makeChatTitleFromMessages(legacy),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    messages: legacy,
                };
                sessions = [session];
                saveHubBotSessions(sessions);
                setActiveHubBotSessionId(id);
                localStorage.removeItem(HUB_BOT_HISTORY_KEY);
                activeId = id;
            }
        } catch (_) {}
    }

    const exists = activeId && sessions.some(s => s.id === activeId);
    if (!exists) {
        const id = 'chat-' + Date.now();
        const seed = [{ role: 'assistant', content: "Hi! I'm Hub Bot. Ask me about our courses or any tech concept." }];
        const session = {
            id,
            title: 'New chat',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            messages: seed,
        };
        sessions.unshift(session);
        saveHubBotSessions(sessions);
        setActiveHubBotSessionId(id);
        activeId = id;
    }
    return { sessions, activeId };
}

function getActiveHubBotMessages() {
    const { sessions, activeId } = ensureActiveHubBotSession();
    const session = sessions.find(s => s.id === activeId);
    return Array.isArray(session?.messages) ? session.messages : [];
}

function setActiveHubBotMessages(messages) {
    const { sessions, activeId } = ensureActiveHubBotSession();
    const idx = sessions.findIndex(s => s.id === activeId);
    if (idx === -1) return;
    const next = Array.isArray(messages) ? messages : [];
    sessions[idx] = {
        ...sessions[idx],
        messages: next,
        title: makeChatTitleFromMessages(next),
        updatedAt: new Date().toISOString(),
    };
    // keep most recent first
    sessions.sort((a, b) => String(b.updatedAt || '').localeCompare(String(a.updatedAt || '')));
    saveHubBotSessions(sessions);
}

function getCoursesContext() {
    const courses = JSON.parse(localStorage.getItem('courses') || '[]');
    const assigned = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    const lines = [];
    if (courses.length) {
        lines.push('Courses (Library):');
        courses.forEach(c => lines.push(`- ${c.name} [${c.type}] (id:${c.id}, videoId:${c.videoId})`));
    }
    if (assigned.length) {
        lines.push('Assigned Courses (My Learning):');
        assigned.forEach(a => lines.push(`- ${a.topic} [${a.level}] (videoId:${a.videoId}) ${a.passed ? ' passed' : ''}`));
    }
    return lines.join('\n');
}

function initHubBot() {
    // Initialize session storage
    ensureActiveHubBotSession();
    // Render if containers exist
    renderHubBotMessages('hubBotMessages');
    renderHubBotMessages('hubBotPageMessages');
    renderHubBotHistoryList();

    // Attach Enter-to-send handlers
    try {
        const widgetInput = document.getElementById('hubBotInput');
        if (widgetInput && !widgetInput.__enterHooked) {
            widgetInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendHubBotMessage('widget');
                }
            });
            widgetInput.__enterHooked = true;
        }
        const pageInput = document.getElementById('hubBotPageInput');
        if (pageInput && !pageInput.__enterHooked) {
            pageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendHubBotMessage('page');
                }
            });
            pageInput.__enterHooked = true;
        }
    } catch (_) { /* no-op */ }
}

function toggleHubBotHistory() {
    const panel = document.getElementById('hubBotHistoryPanel');
    if (!panel) return;
    const shown = panel.style.display === 'block';
    panel.style.display = shown ? 'none' : 'block';
    if (!shown) renderHubBotHistoryList();
}

function renderHubBotHistoryList() {
    const list = document.getElementById('hubBotHistoryList');
    if (!list) return;
    const sessions = loadHubBotSessions();
    const activeId = getActiveHubBotSessionId();
    if (!sessions.length) {
        list.innerHTML = '<div style="color:var(--text-secondary); font-size:12px;">No chats yet.</div>';
        return;
    }
    list.innerHTML = sessions
        .sort((a, b) => String(b.updatedAt || '').localeCompare(String(a.updatedAt || '')))
        .map(s => {
            const isActive = s.id === activeId;
            const title = escapeHtml(s.title || 'New chat');
            const when = escapeHtml((s.updatedAt || '').replace('T', ' ').replace('Z', ''));
            return `
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:${isActive ? 'rgba(66,133,244,0.12)' : 'transparent'}; margin-bottom:8px;">
                    <div style="min-width:0;">
                        <div style="color:var(--text-main); font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title}</div>
                        <div style="color:var(--text-secondary); font-size:11px;">${when}</div>
                    </div>
                    <button class="ghost" onclick="openHubBotChat(${JSON.stringify(s.id)})">Open</button>
                </div>
            `;
        })
        .join('');
}

function openHubBotChat(sessionId) {
    const sessions = loadHubBotSessions();
    const target = sessions.find(s => s.id === sessionId);
    if (!target) return;
    setActiveHubBotSessionId(target.id);
    renderHubBotMessages('hubBotMessages');
    renderHubBotMessages('hubBotPageMessages');
    renderHubBotHistoryList();
}

function toggleHubBotWidget() {
    const panel = document.getElementById('hubBotWidget');
    if (!panel) return;
    const isShown = panel.style.display === 'block';
    panel.style.display = isShown ? 'none' : 'block';
    if (!isShown) initHubBot();
}

function minimizeHubBotWidget() {
    const panel = document.getElementById('hubBotWidget');
    if (!panel) return;
    panel.style.display = 'none';
    // Do not clear chat
}

function closeHubBotWidget() {
    const panel = document.getElementById('hubBotWidget');
    if (!panel) return;
    // Hide only (keep history like Gemini)
    panel.style.display = 'none';
}

function escapeHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function normalizeAnswerLetter(letter) {
    const s = String(letter || '').trim().toUpperCase();
    if (!s) return '';
    // Accept "A", "A)" or "A." etc.
    const m = s.match(/^[A-D]/);
    return m ? m[0] : '';
}

function optionTextByLetter(options, letter) {
    if (!Array.isArray(options)) return '';
    const l = normalizeAnswerLetter(letter);
    if (!l) return '';
    const idx = l.charCodeAt(0) - 65;
    if (idx >= 0 && idx < options.length) return String(options[idx] ?? '');
    // Fallback: try to find "A)" style prefix
    const found = options.find(o => String(o || '').trim().toUpperCase().startsWith(`${l})`));
    return found ? String(found) : '';
}

function renderAssessmentAnswersReviewHtml(questions, answers, opts = {}) {
    if (!Array.isArray(questions) || questions.length === 0) return '';
    const title = escapeHtml(opts.title || 'Answer Review');
    const maxHeight = opts.maxHeight || 360;

    const items = questions.map((q, idx) => {
        const qText = escapeHtml(q?.question || `Question ${idx + 1}`);
        const options = Array.isArray(q?.options) ? q.options : [];
        const selected = normalizeAnswerLetter(Array.isArray(answers) ? answers[idx] : '');
        const correct = normalizeAnswerLetter(q?.correctAnswer || '');
        const isCorrect = selected && correct && selected === correct;

        const selectedText = escapeHtml(optionTextByLetter(options, selected) || '');
        const correctText = escapeHtml(optionTextByLetter(options, correct) || '');

        const border = isCorrect ? '#4CAF50' : '#f85149';
        const bg = isCorrect ? 'rgba(76,175,80,0.06)' : 'rgba(248,81,73,0.06)';

        const yourLine = selected
            ? `<span style="color:${isCorrect ? '#4CAF50' : '#f85149'}; font-weight:800;">${escapeHtml(selected)}</span>${selectedText ? ` <span style="color:var(--text-secondary); font-weight:600;"></span> <span style="color:var(--text-main);">${selectedText}</span>` : ''}`
            : `<span style="color:#f85149; font-weight:800;">Not answered</span>`;

        const correctLine = correct
            ? `<span style="color:#4CAF50; font-weight:900;">${escapeHtml(correct)}</span>${correctText ? ` <span style="color:var(--text-secondary); font-weight:600;"></span> <span style="color:var(--text-main);">${correctText}</span>` : ''}`
            : `<span style="color:var(--text-secondary);">(Missing correct answer)</span>`;

        return `
            <div style="border:1px solid ${border}; background:${bg}; border-radius:12px; padding:12px; margin-top:10px;">
                <div style="color:var(--text-main); font-weight:900; margin-bottom:8px;">Q${idx + 1}. ${qText}</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; font-size:13px; margin-bottom:6px;">
                    <div style="min-width:240px;"><span style="color:var(--text-secondary);">Your answer:</span> ${yourLine}</div>
                    <div style="min-width:240px;"><span style="color:var(--text-secondary);">Correct:</span> ${correctLine}</div>
                </div>
            </div>
        `;
    }).join('');

    return `
        <details style="margin-top:14px;">
            <summary style="cursor:pointer; color:var(--primary-blue); font-weight:900;">${title}</summary>
            <div style="margin-top:10px; max-height:${Number(maxHeight)}px; overflow:auto; padding-right:4px;">
                ${items}
            </div>
        </details>
    `;
}

function setAssessmentAnswersReview(questions, answers, opts = {}) {
    const container = document.getElementById('answersReviewContainer');
    if (!container) return;
    container.innerHTML = renderAssessmentAnswersReviewHtml(questions, answers, opts);
}

function renderHubBotMessages(targetId) {
    const container = document.getElementById(targetId);
    if (!container) return;
    const history = getActiveHubBotMessages();
    container.innerHTML = history.map(msg => {
        const align = msg.role === 'assistant' ? 'flex-start' : 'flex-end';
        const bg = msg.role === 'assistant' ? 'rgba(66,133,244,0.12)' : 'rgba(76,175,80,0.12)';
        const border = msg.role === 'assistant' ? '1px solid var(--border-color)' : '1px solid #4CAF50';
        return `<div style="display:flex; justify-content:${align}; margin:6px 0;">
            <div style="max-width:90%; background:${bg}; border:${border}; color:var(--text-main); padding:10px; border-radius:10px; white-space:pre-wrap;">${escapeHtml(msg.content)}</div>
        </div>`;
    }).join('');
    container.scrollTop = container.scrollHeight;
}

// =====================
// Hub Bot: crowd-triggered auto-add (SimplilearnOfficial only)
// =====================

const OO_SIMPLILEARN_HANDLE_URL = 'https://www.youtube.com/@SimplilearnOfficial';

function ooNormalizeUrl(u) {
    return String(u || '').trim().replace(/\/+$/, '').toLowerCase();
}

function ooNormalizeForMatch(text) {
    return String(text || '')
        .toLowerCase()
        .replace(/[\u2019']/g, '')
        .replace(/[^a-z0-9\s-]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
}

function ooTopicAlreadyPresent(courses, topicDisplay) {
    const topicNorm = ooNormalizeForMatch(topicDisplay);
    if (!topicNorm) return false;
    const list = Array.isArray(courses) ? courses : [];
    return list.some(c => {
        const nameNorm = ooNormalizeForMatch(c?.name);
        return Boolean(nameNorm && (nameNorm.includes(topicNorm) || topicNorm.includes(nameNorm)));
    });
}

async function ooFindSimplilearnOfficialVideo(topicDisplay) {
    const query = `SimplilearnOfficial ${String(topicDisplay || '').trim()}`.trim();
    const searchResp = await fetch(`/api/youtube/search?q=${encodeURIComponent(query)}&max=18`);
    const searchData = searchResp.ok ? await searchResp.json() : { ok: false, videoIds: [] };
    const ids = Array.isArray(searchData?.videoIds) ? searchData.videoIds : [];

    const target = ooNormalizeUrl(OO_SIMPLILEARN_HANDLE_URL);
    for (const id of ids) {
        try {
            const checkResp = await fetch(`/api/youtube/check?videoId=${encodeURIComponent(id)}`);
            const info = checkResp.ok ? await checkResp.json() : null;
            const authorUrl = ooNormalizeUrl(info?.authorUrl);
            if (info?.ok && authorUrl && authorUrl === target) {
                return { videoId: id, title: info?.title || topicDisplay || 'SimplilearnOfficial course', authorName: info?.authorName || 'SimplilearnOfficial', authorUrl: info?.authorUrl || OO_SIMPLILEARN_HANDLE_URL };
            }
        } catch (_) {
            // ignore per-candidate failures
        }
    }
    return null;
}

async function ooHubBotAutoAddCoursesForTopic({ topicKey, topicDisplay }) {
    const actorEmail = (localStorage.getItem('userEmail') || '').trim();

    const courses = window.syncSharedCourses ? await window.syncSharedCourses() : (JSON.parse(localStorage.getItem('courses') || '[]'));
    if (ooTopicAlreadyPresent(courses, topicDisplay)) {
        try {
            if (window.hubBotSuppressTopicCourseAddition) {
                await window.hubBotSuppressTopicCourseAddition({ topicKey, reason: 'Topic already present in courses' });
            }
        } catch (_) {}
        return { ok: true, suppressed: true };
    }

    const pick = await ooFindSimplilearnOfficialVideo(topicDisplay);
    if (!pick) {
        return { ok: false, notFound: true };
    }

    const claim = window.hubBotClaimTopicCourseAddition
        ? await window.hubBotClaimTopicCourseAddition({ topicKey, actorEmail, videoId: pick.videoId, videoTitle: pick.title })
        : { ok: false, claimed: false };

    if (!claim?.ok || !claim?.claimed) {
        return { ok: true, claimed: false, videoId: pick.videoId, title: pick.title };
    }

    const types = ['beginner', 'intermediate', 'advanced'];
    const nowDate = new Date().toLocaleDateString();
    const addedIds = [];
    for (const type of types) {
        const id = `hubbot-${String(topicKey)}-${type}-${pick.videoId}`;
        const already = Array.isArray(courses) && courses.some(c => String(c?.id || '').trim() === id);
        if (already) continue;
        const course = {
            id,
            name: `SimplilearnOfficial: ${String(topicDisplay || '').trim()}`,
            type,
            videoId: pick.videoId,
            uploadDate: nowDate,
            source: 'Hub Bot',
            addedBy: 'Hub Bot',
            channelUrl: OO_SIMPLILEARN_HANDLE_URL,
            topicKey: String(topicKey || ''),
        };
        if (window.addSharedCourse) {
            await window.addSharedCourse(course);
            addedIds.push(id);
        }
    }

    // Announcement (best-effort, single message)
    try {
        if (window.addSharedAnnouncement) {
            await window.addSharedAnnouncement({
                message: `Hub Bot added a new course: ${String(topicDisplay || '').trim()} (SimplilearnOfficial)`,
                date: new Date().toLocaleString(),
                type: 'course'
            });
        }
    } catch (_) {}

    // Refresh UI (best-effort)
    try { await loadCourses(); } catch (_) {}
    try { await loadCoursesView(); } catch (_) {}
    try { if (typeof updateAnnouncements === 'function') await updateAnnouncements(); } catch (_) {}

    return { ok: true, claimed: true, addedIds, videoId: pick.videoId, title: pick.title };
}

async function ooHubBotCrowdTriggerFlow(question, messagesId) {
    if (!window.hubBotRecordTopicQuestion) return;

    const actorEmail = (localStorage.getItem('userEmail') || '').trim();
    const rec = await window.hubBotRecordTopicQuestion({ question, actorEmail });
    if (!rec?.ok) return;

    // Only notify when close to threshold or when threshold reached.
    if (rec.uniqueCount === 4) {
        const updated = getActiveHubBotMessages();
        updated.push({ role: 'assistant', content: `Crowd tracker: 4/5 people have asked about "${rec.topicDisplay}". One more and I will auto-add a SimplilearnOfficial course into Beginner/Intermediate/Advanced.` });
        setActiveHubBotMessages(updated);
        renderHubBotMessages(messagesId);
        return;
    }

    if (!rec.shouldRequest) return;

    const updated = getActiveHubBotMessages();
    updated.push({ role: 'assistant', content: `Crowd tracker: 5/5 reached for "${rec.topicDisplay}". Trying to add a SimplilearnOfficial course now` });
    setActiveHubBotMessages(updated);
    renderHubBotMessages(messagesId);

    const result = await ooHubBotAutoAddCoursesForTopic({ topicKey: rec.topicKey, topicDisplay: rec.topicDisplay });
    const finalHistory = getActiveHubBotMessages();
    if (result?.suppressed) {
        finalHistory.push({ role: 'assistant', content: `No new course added for "${rec.topicDisplay}" because this topic already exists in the Courses library.` });
    } else if (result?.notFound) {
        finalHistory.push({ role: 'assistant', content: `I hit the 5/5 threshold for "${rec.topicDisplay}", but couldn't find an embeddable video from SimplilearnOfficial right now.` });
    } else if (result?.claimed === false) {
        finalHistory.push({ role: 'assistant', content: `Another session already added the course for "${rec.topicDisplay}" (avoided duplicate).` });
    } else if (result?.claimed) {
        finalHistory.push({ role: 'assistant', content: `Added: "${rec.topicDisplay}" (SimplilearnOfficial) into Beginner/Intermediate/Advanced. It will show as Source: Hub Bot in Course Mgmt.` });
    }
    setActiveHubBotMessages(finalHistory);
    renderHubBotMessages(messagesId);
}

async function sendHubBotMessage(source) {
    const inputId = source === 'page' ? 'hubBotPageInput' : 'hubBotInput';
    const messagesId = source === 'page' ? 'hubBotPageMessages' : 'hubBotMessages';
    const input = document.getElementById(inputId);
    if (!input) return;
    const question = (input.value || '').trim();
    if (!question) return;

    // Append user message
    const history = getActiveHubBotMessages();
    history.push({ role: 'user', content: question });
    setActiveHubBotMessages(history);
    renderHubBotMessages(messagesId);
    input.value = '';

    // Show thinking bubble
    const container = document.getElementById(messagesId);
    if (container) {
        container.innerHTML += `<div style="display:flex; justify-content:flex-start; margin:6px 0;"><div style="max-width:90%; background:rgba(66,133,244,0.08); border:1px solid var(--border-color); color:var(--text-secondary); padding:10px; border-radius:10px;">Thinking...</div></div>`;
        container.scrollTop = container.scrollHeight;
    }

    try {
        const context = getCoursesContext();

        // Include conversation history so follow-ups like "Can you teach me that" work.
        const allHistory = getActiveHubBotMessages();
        const recent = allHistory.slice(-20);
        const convo = recent.map(m => `${m.role === 'assistant' ? 'Assistant' : 'User'}: ${m.content}`).join('\n');

        const fullPrompt = `${HUB_BOT_SYSTEM_PROMPT}\n\nConversation so far (do NOT repeat this back; use it only as context):\n${convo}\n\nCourse data (only if needed):\n${context}\n\nAnswer ONLY the user's last message as Hub Bot (no "User:" / "Assistant:" labels).`;
        console.log('Hub Bot: Sending request to Gemini API...');
        const data = await callGeminiAPI(fullPrompt, 'gemini-2.5-flash');
        console.log('Hub Bot: Received response:', data);
        let answer = 'Sorry, I could not fetch an answer right now.';
        if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
            answer = data.candidates[0].content.parts.map(p => p.text || '').join('\n').trim();
        }
        // If the model echoes role labels, strip them.
        answer = answer.replace(/^\s*(User:|Assistant:)\s*/i, '');
        // Append assistant message
        const updated = getActiveHubBotMessages();
        updated.push({ role: 'assistant', content: answer });
        setActiveHubBotMessages(updated);
        renderHubBotMessages(messagesId);

        // After answering, update crowd-topic counters and possibly auto-add courses.
        try {
            ooHubBotCrowdTriggerFlow(question, messagesId);
        } catch (e) {
            console.warn('Hub Bot crowd trigger flow failed:', e);
        }
    } catch (err) {
        console.error('Hub Bot error:', err);
        const updated = getActiveHubBotMessages();
        updated.push({ role: 'assistant', content: `I ran into an issue: ${err.message || 'Unknown error'}. Please check the console for details.` });
        setActiveHubBotMessages(updated);
        renderHubBotMessages(messagesId);
    }
}

function clearHubBotChat() {
    if (!confirm('Clear the Hub Bot chat history?')) return;
    try {
        // Start a NEW chat session (keep old sessions in Chat history)
        const sessions = loadHubBotSessions();
        const id = 'chat-' + Date.now();
        const seed = [{ role: 'assistant', content: "Hi! I'm Hub Bot. Ask me about our courses or any tech concept." }];
        sessions.unshift({
            id,
            title: 'New chat',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            messages: seed,
        });
        saveHubBotSessions(sessions);
        setActiveHubBotSessionId(id);
        // Re-render both views
        renderHubBotMessages('hubBotMessages');
        renderHubBotMessages('hubBotPageMessages');
        renderHubBotHistoryList();
    } catch (e) {
        alert('Unable to clear chat: ' + (e && e.message ? e.message : 'unknown error'));
    }
}

// Initialize Hub Bot on load
window.addEventListener('load', () => {
    initHubBot();
});

// Expose history actions
window.toggleHubBotHistory = toggleHubBotHistory;
window.openHubBotChat = openHubBotChat;
</script>
</script>

<script src="ui-popups.js"></script>
<script type="module" src="showcase-forum.js"></script>

</body>
</html>
