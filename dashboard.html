<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | OneOrigin Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="api-config.js"></script>
    <script type="module" src="shared-storage.js"></script>
    <script type="module" src="firestore-db.js"></script>
    <style>
        :root {
    --sidebar-collapsed: 75px;
    --sidebar-expanded: 240px;
    /* Official Google Gemini Primary Blue */
    --primary-blue: #4285F4; 
    /* Gemini Dark Mode Background (Material Grey) */
    --bg-dark: #131314; 
    --card-bg: #1e1f20;
    --border-color: #30363d;
    --header-height: 100px;
    /* High-emphasis text for Dark Mode (87% opacity white) */
    --text-main: #e3e3e3; 
    /* Medium-emphasis text for Dark Mode (60% opacity white) */
    --text-secondary: #b4b4b4; 
    --transition-speed: 0.5s;
/* Card size management */
#assignedCourseGrid .course-card {
    max-height: 450px; /* Limits the overall height of the card */
    overflow: hidden;
}

.definition-scroll-container {
    max-height: 120px; /* Height of about 5-6 lines */
    overflow-y: auto;
    padding-right: 10px;
    margin-bottom: 15px;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-blue) transparent;
}

/* Custom scrollbar for Chrome/Safari */
.definition-scroll-container::-webkit-scrollbar {
    width: 4px;
}
.definition-scroll-container::-webkit-scrollbar-thumb {
    background-color: var(--primary-blue);
    border-radius: 10px;
}

	/* Fix for My Assigned Courses Layout */
.loader {
    border: 4px solid var(--border-color);
    border-top: 4px solid var(--primary-blue);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Professional Row Layout for My Assigned Courses */
#assignedCourseGrid .course-card {
    display: flex;
    flex-direction: row;
    align-items: center; /* Vertically centers the 25% thumbnail */
    padding: 30px;
    gap: 35px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-left: 5px solid var(--primary-blue);
    margin-bottom: 25px;
    transition: transform 0.2s ease;
}

#assignedCourseGrid .course-card:hover {
    border-color: var(--primary-blue);
}

/* Thumbnail Constraint (25%) */
#assignedCourseGrid .thumbnail-wrapper {
    width: 25%;
    flex-shrink: 0;
}

#assignedCourseGrid .video-thumb-container {
    width: 100%;
    aspect-ratio: 16/9;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
    position: relative;
}

/* Typography & Content Block */
#assignedCourseGrid .course-info {
    flex: 1;
}

#assignedCourseGrid .course-info h3 {
    font-size: 26px !important;
    margin: 0 0 20px 0;
    color: var(--primary-blue);
}

.definition-block {
    margin-bottom: 20px;
}

.definition-label {
    font-size: 12px !important;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--primary-blue);
    font-weight: 800 !important;
    display: block;
    margin-bottom: 8px;
    opacity: 0.9;
}

.definition-content {
    font-size: 16px !important;
    line-height: 1.7; /* Better readability for long text */
    color: var(--text-main);
    margin: 0;
    font-weight: 400 !important; /* Lighter weight for the body text */
}

#assignedCourseGrid .btn-primary {
    width: fit-content !important;
    margin: 15px 0 0 0 !important;
    padding: 12px 30px !important;
    font-size: 16px !important;
}
/* Mobile Responsiveness */
@media (max-width: 768px) {
    #assignedCourseGrid .course-card {
        flex-direction: column;
    }
    #assignedCourseGrid .thumbnail-wrapper {
        width: 100%;
    }
}
    /* Courses listing: three stacked type sections, each with its own grid */
#dynamicCourseGrid {
    display: flex;
    flex-direction: column;
    gap: 28px;
    width: 100%;
}

.course-section h3 { margin: 20px 0 10px 0; color: var(--primary-blue); font-size: 18px; cursor: default; pointer-events: none; user-select: none; }
#beginner-courses, #intermediate-courses, #advanced-courses {
    border: 1px solid var(--border-color);
    padding: 20px 24px;
    margin-bottom: 30px;
    border-radius: 10px;
    box-sizing: border-box;
}
.course-type-section { background: transparent; border: 0; padding: 6px 0; }
.course-type-section h3 { margin: 0 0 12px 0; color: var(--primary-blue); font-size: 18px; }
/* Thin divider between course type sections */
.course-type-section + .course-type-section { border-top: 1px solid var(--border-color); padding-top: 18px; margin-top: 12px; }
.type-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; padding: 8px 4px; box-sizing: border-box; }
.type-grid .course-card { border: 1px solid var(--border-color); padding: 10px; transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; height: 100%; width: 100%; box-sizing: border-box; }
.type-grid .course-card:hover { transform: translateY(-8px); box-shadow: 0 10px 18px rgba(0,0,0,0.18); border-color: var(--primary-blue); }

/* In-app player overlay */
.course-player-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
    backdrop-filter: blur(4px);
}

.course-player-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    width: 75vw;
    max-width: 1400px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.35);
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.course-player-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--text-main);
    font-weight: 600;
}

.course-player-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 20px;
    cursor: pointer;
    transition: color 0.2s ease, transform 0.2s ease;
}

.course-player-close:hover { color: #f85149; transform: scale(1.1); }

.course-player-frame {
    position: relative;
    height: 75vh;
    border-radius: 10px;
    overflow: hidden;
    background: #000;
    border: 1px solid var(--border-color);
}

.course-player-frame iframe {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border: 0;
}

.course-player-play {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.65);
    color: #fff;
    border: 2px solid #fff;
    border-radius: 50%;
    width: 68px; height: 68px;
    font-size: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    z-index: 2;
}

.course-player-play:hover {
    transform: translate(-50%, -50%) scale(1.07);
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    background: rgba(0,0,0,0.8);
}

/* Measure & Master Styles */
.quiz-option {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: var(--text-main);
}

.quiz-option:hover {
    border-color: var(--primary-blue);
    background: rgba(66, 133, 244, 0.1);
}

.quiz-option.selected {
    border-color: var(--primary-blue);
    background: rgba(66, 133, 244, 0.2);
}

.assigned-course-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 15px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    position: relative;
}

.assigned-course-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

.course-thumbnail-wrapper {
    position: relative;
    margin-bottom: 15px;
}

.course-thumbnail-wrapper img {
    width: 100%;
    border-radius: 8px;
    cursor: pointer;
}

.course-definition {
    background: rgba(66, 133, 244, 0.05);
    padding: 12px;
    border-radius: 6px;
    margin-top: 10px;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.6;
}

.course-uses {
    margin-top: 8px;
    padding: 10px;
    background: rgba(76, 175, 80, 0.05);
    border-radius: 6px;
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.6;
}

@media (max-width: 1200px) {
    .type-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 600px) {
    .type-grid { grid-template-columns: 1fr; }
}
	.admin-table th:last-child, .admin-table td:last-child { text-align: center; width: 80px; }
	.btn-delete { background: none; border: none; cursor: pointer; font-size: 18px; color: #f85149; transition: transform 0.2s, opacity 0.2s; display: inline-block; line-height: 1; }
	.btn-delete:hover { transform: scale(1.2); opacity: 0.8; }
	#timeGreeting { font-size: 22px !important; font-style: italic; color: var(--primary-blue); margin: 0; font-weight: 500; }
	#admin-view, #course-mgmt-view, #log-view { display: flex; flex-direction: column; align-items: flex-start !important; text-align: left !important; width: 100%; }
	#leaderboard-view { display: flex; flex-direction: column; align-items: flex-start !important; text-align: left !important; width: 100%; padding: 0; }
	#course-mgmt-view, #admin-view, #log-view { display: flex; flex-direction: column; align-items: flex-start !important; text-align: left !important; }
	#settings-view { display: flex; flex-direction: column; align-items: flex-start; text-align: left; width: 100%; }
	#news-container, #announcements-container { max-height: 500px; overflow-y: auto; padding-right: 12px; scrollbar-width: thin; }
	.news-item, .announcement-item {font-size: 14px; margin-bottom: 15px; padding: 10px; border-radius: 8px; border-bottom: 1px solid var(--border-color); transition: background 0.2s; }
	.news-item:hover, .announcement-item:hover {background: rgba(66, 133, 244, 0.05); /* Subtle blue glow on hover */}

/* Player View Specifics */
#player-view { max-width: 1000px; margin: 0 auto; }
.video-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
#playerTitle { color: var(--primary-blue); margin: 0; }
.video-container { position: relative; background: #000; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); }
.video-placeholder { padding-bottom: 56.25%; position: relative; }
#playerContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

#startOverlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 10;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}

	/* Layout for Home View Blocks */
.home-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 25px;
}

.home-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    min-height: 350px;
}

.home-card h2 {
    color: var(--primary-blue);
    font-size: 20px;
    margin-top: 0;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* About the Hub cards (Home) */
.home-about {
    margin-top: 14px;
}

/* My Progress (employee) */
.progress-wrap {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 18px;
    width: 100%;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid var(--border-color);
    background: rgba(255,255,255,0.03);
    color: var(--text-main);
    white-space: nowrap;
}

.status-badge.good {
    border-color: rgba(76,175,80,0.55);
    background: rgba(76,175,80,0.12);
}

.status-badge.warn {
    border-color: rgba(240,173,78,0.6);
    background: rgba(240,173,78,0.14);
}

.status-badge.bad {
    border-color: rgba(248,81,73,0.6);
    background: rgba(248,81,73,0.12);
}

/* Course assessment overlay */
.assessment-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 4200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 22px;
}

.assessment-modal {
    width: 100%;
    max-width: 880px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 14px;
    overflow: hidden;
}

.assessment-modal-head {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border-color);
}

.assessment-modal-title {
    display:flex;
    flex-direction: column;
    gap: 2px;
}

.assessment-modal-title b {
    color: var(--text-main);
    font-size: 14px;
}

.assessment-modal-title span {
    color: var(--text-secondary);
    font-size: 12px;
}

.assessment-modal-body {
    padding: 16px;
}

.home-about-head {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
    gap: 8px;
}

.home-about-title {
    margin: 0;
    color: var(--primary-blue);
    font-size: 18px;
}

.home-about-hero {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 14px;
    padding: 18px;
}

.home-about-subtitle {
    margin: 0;
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.5;
    max-width: 980px;
}

.home-about-highlights {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 12px;
}

.home-about-pill {
    border: 1px solid var(--border-color);
    background: rgba(255,255,255,0.03);
    border-radius: 999px;
    padding: 8px 12px;
    font-size: 12px;
    color: var(--text-main);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.home-about-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
    margin-top: 14px;
}

.home-about-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
}

.home-about-card h3 {
    margin: 0 0 8px 0;
    color: var(--text-main);
    font-size: 15px;
}

.home-about-card p {
    margin: 0 0 12px 0;
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.6;
}

.home-about-kicker {
    margin: 0 0 6px 0;
    font-size: 12px;
    color: var(--text-main);
    text-transform: uppercase;
    letter-spacing: 0.3px;
    opacity: 0.9;
}

.home-about-list {
    margin: 0 0 12px 18px;
    padding: 0;
    color: var(--text-secondary);
    font-size: 13px;
    line-height: 1.7;
}

.home-about-list li {
    margin: 4px 0;
}

.home-about-actions {
    display: flex;
    justify-content: flex-end;
}

.news-item, .announcement-item {
    font-size: 14px;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.item-date {
    font-size: 11px;
    color: var(--text-secondary);
    display: block;
}
}

body.light-theme { --bg-dark: #f0f4f9; --card-bg: #ffffff; --border-color: #dee1e5; --text-main: #1f1f1f; --text-secondary: #444746; --primary-blue: #0b57d0; --sidebar-active-bg: #f1f3f4; }
        * { font-weight: 700 !important; }
        body { font-family: 'Calibri', 'Candara', 'Segoe UI', 'Optima', Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: all 0.3s; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .dashboard-header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 0 32px; height: var(--header-height); background-color: var(--card-bg); border-bottom: 1px solid var(--border-color); z-index: 2000; flex-shrink: 0; }
        .header-left img { height: 65px; width: auto; object-fit: contain; }
	.hub-title { font-size: 36px !important; color: var(--primary-blue); display: flex; gap: 2px; font-family: 'Calibri', sans-serif; font-weight: 800; letter-spacing: -0.5px; margin: 0; }
	.hub-subtitle { color: var(--text-secondary); font-size: 14px; font-family: 'Calibri', sans-serif; font-weight: 400; opacity: 0.8; margin-top: -2px; text-align: center; }
	.hub-title span { display: inline-block; transform: none !important; }
	@keyframes gentleBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        .header-right { display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
        .user-badge {background: #21262d; padding: 8px 18px; border-radius: 20px; border: 1px solid var(--border-color); font-size: 14px;color: var(--text-main) !important; /* Forces light text in dark mode */display: flex;align-items: center; justify-content: center;}
/* Override for Light Theme */
body.light-theme .user-badge { 
    background: #ebf2ff; 
    border: 1px solid #d0d7de; 
    color: #24292f !important; /* Forces dark text in light mode */
}
        .btn-primary, .btn-logout, .btn-add { background: transparent !important; color: #4285F4 !important; border: 1px solid #4285F4 !important; padding: 10px 20px; border-radius: 8px; font-weight: 700 !important; cursor: pointer; transition: all 0.2s ease; box-shadow: none !important; text-shadow: none !important; display: flex; align-items: center; justify-content: center; }
        .btn-primary { width: calc(25% - 40px); margin: 25px auto 0 auto; display: block; padding: 15px; font-size: 16px; background: transparent !important; color: #4285F4 !important; border: 1px solid #4285F4 !important; border-radius: 8px; box-shadow: none !important; cursor: pointer; text-align: center; }
        .btn-logout { background: transparent !important; color: #4285F4 !important; border: 1px solid #4285F4 !important; padding: 8px 16px; border-radius: 8px; box-shadow: none !important; }
        /* Subtle hover lift for all buttons and clickable items */
        button, .btn-primary, .btn-logout, .btn-add, .sidebar-item, .toggle-btn {
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        button:hover, .btn-primary:hover, .btn-logout:hover, .btn-add:hover, .sidebar-item:hover, .toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.18);
        }
        .app-body { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: var(--sidebar-collapsed); background-color: var(--card-bg); border-right: 1px solid var(--border-color); transition: width var(--transition-speed) cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; flex-direction: column; box-shadow: none !important; }
        .sidebar.expanded { width: var(--sidebar-expanded); }
        .toggle-container { padding: 20px; text-align: center; }
        .toggle-btn { cursor: pointer; color: var(--primary-blue); font-size: 22px; background: rgba(88, 166, 255, 0.1); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; }
        .sidebar.expanded .toggle-btn { transform: rotate(180deg); }
        .sidebar-nav { flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 8px; }
        .sidebar-footer { border-top: 1px solid var(--border-color); padding: 15px 10px; display: flex; flex-direction: column; gap: 8px; }
        .sidebar-item { display: flex; align-items: center; padding: 12px 15px; color: var(--text-secondary); text-decoration: none; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; white-space: nowrap; border: 1px solid transparent; box-shadow: none !important; }
        .sidebar-item:hover { background: rgba(255, 255, 255, 0.04) !important; color: #4285F4 !important; transform: translateX(5px); box-shadow: none !important; }
	.sidebar-item.active { background: #1e1f20 !important; color: #4285F4 !important; border: 1px solid #4285F4 !important; box-shadow: none !important; border-radius: 8px; }
	body.light-theme .sidebar-item.active { background: #f1f3f4 !important; color: #0b57d0 !important; border: 1px solid #0b57d0 !important; }
        .sidebar-text { margin-left: 15px; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .sidebar.expanded .sidebar-text { opacity: 1; }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; width: 100%; }
        .course-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; margin-bottom: 15px; padding-bottom: 15px; height: 100%; }
        .course-card h3 { font-size: 18px; margin: 15px 15px 5px 15px; text-align: left; color: var(--primary-blue); }

        /* Hub Bot refreshed styles */
        .hub-bot-shell { background: linear-gradient(135deg, rgba(88, 71, 195, 0.7), rgba(32, 20, 90, 0.8)), radial-gradient(circle at 20% 20%, rgba(255,255,255,0.06), rgba(0,0,0,0)); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; padding: 22px; max-width: 980px; margin: 0 auto; box-shadow: 0 18px 36px rgba(0,0,0,0.3); backdrop-filter: blur(6px); }
        .hub-bot-hero { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap; margin-bottom:14px; }
        .hub-bot-meta { display:flex; align-items:center; gap:12px; }
        .hub-bot-avatar { width:52px; height:52px; border-radius:14px; background: linear-gradient(135deg, #ff7ce5, #6c4bff); display:flex; align-items:center; justify-content:center; font-size:26px; box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
        .hub-bot-title { color:#fff; font-weight:800; font-size:22px; letter-spacing:0.2px; }
        .hub-bot-sub { color: rgba(255,255,255,0.72); font-size:13px; }
        .hub-bot-status { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
        .pill { padding:8px 12px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid rgba(255,255,255,0.18); color:#fff; backdrop-filter: blur(4px); }
        .pill.live { background: rgba(76, 175, 80, 0.16); border-color: rgba(76,175,80,0.35); }
        .pill.alt { background: rgba(255,255,255,0.06); }
        .ghost { background: rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.18); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
        .ghost:hover { background: rgba(255,255,255,0.16); }
        .hub-bot-prompts { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 14px 0; }
        .prompt-chip { background: rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.16); border-radius:12px; padding:8px 12px; font-size:12px; cursor:pointer; transition: transform 0.12s ease, box-shadow 0.12s ease; }
        .prompt-chip:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,0.2); }
        .hub-bot-messages { background: rgba(10,12,20,0.55); border:1px solid rgba(255,255,255,0.1); border-radius:14px; padding:12px; min-height:320px; max-height:520px; overflow-y:auto; color:#e9ecf5; box-shadow: inset 0 1px 0 rgba(255,255,255,0.03); }
        .hub-bot-input { display:flex; gap:10px; margin-top:12px; background: rgba(0,0,0,0.38); border:1px solid rgba(255,255,255,0.12); border-radius:12px; padding:8px; align-items:center; }
        .hub-bot-input input { flex:1; padding:12px; background: transparent; border:none; color:#fff; outline:none; font-size:14px; }
        .hub-bot-input button { background:#6c4bff; color:white; border:none; padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:800; box-shadow: 0 10px 20px rgba(108,75,255,0.35); }
        .hub-bot-input button:hover { transform: translateY(-1px); }
        .topic-summary { padding: 0 20px; font-size: 14px; line-height: 1.6; color: var(--text-secondary); flex-grow: 1; }
        .topic-summary b { color: var(--text-main); display: block; margin-top: 12px; font-size: 13px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-bottom: 8px; }
        .caution-box { margin-top: 15px; padding: 10px; border-radius: 6px; background: rgba(248, 81, 73, 0.1); border-left: 3px solid #f85149; font-size: 13px; color: #f85149; }
        .assessment-wrapper { background: var(--card-bg); border: 1px solid var(--border-color); padding: 30px; border-radius: 12px; max-width: 900px; margin: 0 auto; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--card-bg); }
        .admin-table th, .admin-table td { text-align: left; padding: 15px; border-bottom: 1px solid var(--border-color); }
        .video-player-container { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); position: relative; box-sizing: border-box; max-width: 1100px; margin: 0 auto; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; }
        #playerContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* ====== Added: Similar Videos UI (keeps same font sizes & theme) ====== */
        .similar-section {
            margin-top: 14px;
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
        }
        .similar-title {
            font-size: 13px;
            color: var(--text-main);
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 0.3px;
        }
        .similar-list {
            max-height: 220px;
            overflow-y: auto;
            padding-right: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .similar-item {
            display: flex;
            gap: 12px;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.02);
        }
        .similar-thumb {
            width: 110px;
            height: 62px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: #000;
        }
        .similar-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .similar-meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 0;
            flex: 1;
        }
        .similar-meta .t {
            font-size: 13px;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .similar-meta .s {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .btn-secondary {
            background: transparent;
            color: var(--primary-blue);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
        }
        /* ====== End Added ====== */
    </style>
</head>

<body>
<header class="dashboard-header">
    <div class="header-left"><img src="oo new semi arch white blue (4).png" id="mainLogo"></div>
    <div class="header-center" style="display: flex; flex-direction: column; align-items: center;">
        <div class="hub-title" id="bouncingTitle"></div>
        <div class="hub-subtitle">Empowering your technical growth through AI-driven learning</div>
    </div>
    <div class="header-right"><div class="user-badge" id="userName">User</div><button class="btn-logout" onclick="logout()">Log out</button></div>
</header>

<div class="app-body">
    <aside class="sidebar" id="sidebar">
        <div class="toggle-container"><button class="toggle-btn" onclick="toggleSidebar()">‚ñ∂</button></div>
        <div class="sidebar-nav">
            <div class="sidebar-item active" onclick="switchTab('home-view', this)">üè† <span class="sidebar-text">Home</span></div>
            <div class="sidebar-item" onclick="switchTab('courses-view', this)">üìö <span class="sidebar-text">Courses</span></div>
            <div class="sidebar-item" onclick="switchTab('measure-master-view', this)">üìä <span class="sidebar-text">Measure & Master</span></div>
            <div class="sidebar-item" onclick="switchTab('my-progress-view', this)">üìà <span class="sidebar-text">My Progress</span></div>
            <div class="sidebar-item" onclick="switchTab('leaderboard-view', this)">üèÜ <span class="sidebar-text">Leaderboard</span></div>
            <div class="sidebar-item" onclick="switchTab('hub-bot-view', this)">ü§ñ <span class="sidebar-text">Hub Bot</span></div>
        </div>
        <div class="sidebar-footer">
            <div class="sidebar-item" id="courseMgmtSidebarItem" onclick="switchTab('course-mgmt-view', this)">üìñ <span class="sidebar-text">Course Mgmt</span></div>
            <div class="sidebar-item" id="roleMgmtSidebarItem" onclick="switchTab('role-mgmt-view', this)">üë• <span class="sidebar-text">Role Mgmt</span></div>
            <div class="sidebar-item" onclick="switchTab('settings-view', this)">‚öôÔ∏è <span class="sidebar-text">Settings</span></div>
        </div>
    </aside>

    <main class="main-content">
        <section id="home-view">
            <h1 id="timeGreeting"></h1>

            <div class="home-about">
                <div class="home-about-hero">
                    <div class="home-about-head">
                        <h2 class="home-about-title">About the Hub</h2>
                        <p class="home-about-subtitle">A single place to learn, track progress, and get help ‚Äî designed to keep your growth consistent and measurable. Courses are assigned and validated so they stay playable (with safe fallbacks when embeds fail), your learning data stays consistent across devices using shared storage, and Hub Bot can continue conversations with saved chat history so you can pick up where you left off.</p>
                    </div>

                    <div class="home-about-highlights">
                        <div class="home-about-pill">‚úÖ Playable tutorials</div>
                        <div class="home-about-pill">üîÑ Shared progress</div>
                        <div class="home-about-pill">üß† Chat continuity</div>
                    </div>
                </div>

                <div class="home-about-grid">
                    <div class="home-about-card">
                        <h3>üìö Courses</h3>
                        <p>Start learning with assigned tutorials that are validated to be playable and easy to continue across devices.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>You get courses assigned by your Admin (or automatically from curated sources).</li>
                            <li>Assignments prefer embeddable videos; if a video can‚Äôt be embedded, the Hub provides a safe fallback and ‚ÄúWatch on YouTube‚Äù.</li>
                            <li>Your assigned course list is stored in shared storage so it remains consistent after refresh or on another device.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Open a course, watch it in the Hub, and continue where you left off.</li>
                            <li>Stay aligned to your learning path with minimal friction.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('courses-view', null)">Go to Courses</button>
                        </div>
                    </div>

                    <div class="home-about-card">
                        <h3>üìä Measure &amp; Master</h3>
                        <p>Turn learning into measurable progress by practicing consistently and tracking your mastery.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>Use structured checkpoints to measure understanding and identify gaps.</li>
                            <li>Follow a repeatable practice rhythm (review ‚Üí apply ‚Üí reinforce).</li>
                            <li>Focus on strengthening weak areas before moving to advanced topics.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Build a practice plan and keep your learning on track.</li>
                            <li>Improve retention with intentional repetition.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('measure-master-view', null)">Go to Measure &amp; Master</button>
                        </div>
                    </div>

                    <div class="home-about-card">
                        <h3>ü§ñ Hub Bot</h3>
                        <p>Your AI assistant for learning support: summaries, troubleshooting, and next-step guidance ‚Äî with chat history for continuity.</p>
                        <div class="home-about-kicker">How it works</div>
                        <ul class="home-about-list">
                            <li>Ask questions and Hub Bot responds with context from your ongoing conversation.</li>
                            <li>Chat sessions are saved so you can revisit prior topics from the ‚ÄúChat history‚Äù list.</li>
                            <li>Use quick prompts to generate summaries, flashcards, practice plans, and debug help faster.</li>
                        </ul>
                        <div class="home-about-kicker">What you can do</div>
                        <ul class="home-about-list">
                            <li>Get explanations for errors and step-by-step troubleshooting.</li>
                            <li>Create practice plans that match your current course work.</li>
                        </ul>
                        <div class="home-about-actions">
                            <button class="btn-secondary" onclick="switchTab('hub-bot-view', null)">Go to Hub Bot</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="home-grid">
                <div class="home-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2>üì∞ Daily AI News</h2>
                        <button id="adminRefreshNewsBtn" onclick="forceRefreshNews()" style="background:#111; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold;">üîÑ Refresh News</button>
                    </div>
                    <div id="news-container"></div>
                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 8px; color: var(--primary-blue); font-size: 14px;">üöÄ AI Updates (Last 24 Hours)</h3>
                        <div id="ai-updates-container"></div>
                    </div>
                </div>
                <div class="home-card">
                    <h2>üì¢ Announcements</h2>
                    <div id="announcements-container">
                        <!-- Announcements will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Hub Bot Page -->
        <section id="hub-bot-view" style="display: none;">
            <div class="hub-bot-shell">
                <div class="hub-bot-hero">
                    <div class="hub-bot-meta">
                        <div class="hub-bot-avatar">ü§ñ</div>
                        <div>
                            <div class="hub-bot-title">Hub Bot</div>
                            <div class="hub-bot-sub">Your AI copilot for courses & troubleshooting</div>
                        </div>
                    </div>
                    <div class="hub-bot-status">
                        <span class="pill live">Live</span>
                        <span class="pill alt">Powered by Gemini</span>
                        <button class="ghost" onclick="toggleHubBotHistory()">üìú Chat history</button>
                        <button class="ghost" onclick="clearHubBotChat()">üóë Clear chat</button>
                    </div>
                </div>

                <div id="hubBotHistoryPanel" style="display:none; border:1px solid var(--border-color); border-radius:10px; background: rgba(255,255,255,0.03); padding:12px; margin: 12px 0;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div style="color:var(--text-main); font-weight:800;">Chat history</div>
                        <button class="ghost" onclick="toggleHubBotHistory()">Close</button>
                    </div>
                    <div id="hubBotHistoryList" style="max-height:220px; overflow:auto;"></div>
                </div>

                <div class="hub-bot-prompts">
                    <div class="prompt-chip" onclick="hubBotInsert('Summarize this course: ')" title="Summarize course">üìù Summarize this course</div>
                    <div class="prompt-chip" onclick="hubBotInsert('Give me a practice plan for ')" title="Practice plan">üìÖ Practice plan</div>
                    <div class="prompt-chip" onclick="hubBotInsert('Explain this error: ')" title="Debug help">üõ† Debug my issue</div>
                    <div class="prompt-chip" onclick="hubBotInsert('Create flashcards for ')" title="Flashcards">üìö Flashcards</div>
                </div>

                <div id="hubBotPageMessages" class="hub-bot-messages">
                    <!-- Messages render here -->
                </div>

                <div class="hub-bot-input">
                    <input id="hubBotPageInput" type="text" placeholder="Ask anything about courses, errors, or learning paths..." />
                    <button onclick="sendHubBotMessage('page')">Send</button>
                </div>
            </div>
        </section>
        <!-- User Management Section -->
        <section id="user-mgmt-view" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;">
                <h2 style="color: var(--primary-blue); margin: 0;">User Management</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button style="background: var(--primary-blue); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;" onclick="openAddUserModal()">+ Add User</button>
                    <label style="font-size:12px; color:var(--text-secondary)">Bulk Upload CSV</label>
                    <input type="file" accept=".csv" onchange="handleCSVUpload(event)" style="background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border-color); padding:8px; border-radius:6px;">
                </div>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Employee name</th>
                        <th>Email ID</th>
                        <th>Role</th>
                        <th>Last active date&time</th>
                    </tr>
                </thead>
                <tbody id="userMgmtTableBody">
                    <!-- User rows will be rendered here -->
                </tbody>
            </table>
        </section>

        <!-- Role Management Section -->
        <section id="role-mgmt-view" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;">
                <h2 style="color: var(--primary-blue); margin: 0;">Role Management</h2>
                <div style="display:flex; gap:10px;">
                    <button style="background: var(--primary-blue); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;" onclick="openAddUserModal()">+ Add User</button>
                    <button style="background: #f85149; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;" onclick="deleteSelectedRoles()">Delete Selected</button>
                </div>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th style="width:50px; text-align:center;">
                            <input type="checkbox" id="selectAllRoles" onchange="toggleAllRoleChecks(this.checked)">
                        </th>
                        <th>Employee ID</th>
                        <th>Employee name</th>
                        <th>Email ID</th>
                        <th>Role</th>
                        <th>Last active date&time</th>
                        <th>Reset Assessment</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="roleMgmtTableBody">
                    <!-- Rows will be populated here -->
                </tbody>
            </table>
        </section>
        <section id="courses-view" style="display: none;">
            <h2 style="color: var(--primary-blue);">Courses</h2>
            <div style="margin: 10px 0 20px; width: 100%;">
                <input id="courseSearchInput" type="search" placeholder="Search courses..." 
                    style="width: 100%; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-main);">
            </div>
            <div id="beginner-courses" class="course-section">
                <h3>Beginner</h3>
                <div class="type-grid">
                    <!-- Beginner courses -->
                </div>
            </div>
            <div id="intermediate-courses" class="course-section">
                <h3>Intermediate</h3>
                <div class="type-grid">
                    <!-- Intermediate courses -->
                </div>
            </div>
            <div id="advanced-courses" class="course-section">
                <h3>Advanced</h3>
                <div class="type-grid">
                    <!-- Advanced courses -->
                </div>
            </div>
        </section>

        <section id="course-mgmt-view" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;">
                <h2 style="color: var(--primary-blue); margin: 0;">Course Management</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="clearAllCoursesBtn" style="display:none; background:#f85149; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;" onclick="clearAllCoursesOneTime()">üßπ Clear All Courses</button>
                    <button style="background: var(--primary-blue); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;" onclick="openAddCourseModal()">+ Add Course</button>
                </div>
            </div>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Sl No.</th>
                        <th>Course name</th>
                        <th>Course Type</th>
                        <th>Video ID</th>
                        <th>Upload date</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody id="courseMgmtTableBody">
                    <!-- Rows will be populated here -->
                </tbody>
            </table>
        </section>

        <section id="measure-master-view" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--primary-blue); margin: 0;">Measure & Master</h2>
                <button id="resetAllAssessmentsBtn" onclick="resetAllAssessments()" style="background: #f85149; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold;">üîÑ Reset All</button>
            </div>
            
            <!-- Initial Assessment Button -->
            <div id="initialAssessmentContainer" style="text-align:center; padding:40px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; margin-bottom: 30px;">
                <p style="color:var(--text-secondary); margin-bottom:20px;">Test your knowledge across Web Development, LLMs, Transformers, OCR, AI and more!</p>
                <div id="initialAssessmentStatus"></div>
                <button id="startAssessmentBtn" onclick="startInitialAssessment()" style="background:var(--primary-blue); color:white; border:none; padding:15px 30px; border-radius:8px; cursor:pointer; font-size:16px; font-weight:bold;">Start Assessment</button>
            </div>

            <!-- Assessment Quiz Container -->
            <div id="assessmentQuizContainer" style="display:none; max-width:800px; margin:0 auto;">
                <div id="quizProgress" style="color:var(--text-secondary); margin-bottom:15px;"></div>
                <div id="quizQuestion" style="background:var(--card-bg); padding:20px; border:1px solid var(--border-color); border-radius:8px; margin-bottom:20px;">
                    <h3 id="questionText" style="color:var(--text-main); margin-bottom:15px;"></h3>
                    <div id="optionsContainer"></div>
                </div>
                <button id="nextQuestionBtn" onclick="nextQuestion()" style="background:var(--primary-blue); color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">Next Question</button>
                <button id="submitAssessmentBtn" onclick="submitAssessment()" style="display:none; background:#4CAF50; color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">Submit Assessment</button>
            </div>

            <!-- Results Container -->
            <div id="assessmentResults" style="display:none; max-width:800px; margin:20px auto; background:var(--card-bg); padding:30px; border:1px solid var(--border-color); border-radius:8px; text-align:center;">
                <h3 style="color:var(--primary-blue); margin-bottom:15px;">Assessment Complete!</h3>
                <div id="scoreDisplay" style="font-size:48px; font-weight:bold; color:var(--text-main); margin:20px 0;"></div>
                <div id="levelDisplay" style="font-size:24px; margin-bottom:20px;"></div>
                <div id="videoSuggestionContainer" style="margin-top:30px;">
                    <p style="color:var(--text-secondary); margin-bottom:15px;">Fetching personalized course recommendation...</p>
                </div>
                <div id="answersReviewContainer" style="margin-top:18px; text-align:left;"></div>
            </div>

            <!-- My Assigned Courses Section -->
            <div id="assignedCoursesSection" style="margin-top:40px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; padding: 20px;">
                <h3 style="color:var(--primary-blue); margin-bottom:20px;">My Assigned Courses (In Progress)</h3>
                <div id="assignedCoursesGrid" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:20px;">
                    <!-- Assigned courses will be rendered here -->
                </div>
            </div>

            <!-- Passed Courses Section -->
            <div id="passedCoursesSection" style="margin-top:30px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 10px; padding: 20px;">
                <h3 style="color:#4CAF50; margin-bottom:20px;">‚úì Passed Courses (Available Anytime)</h3>
                <div id="passedCoursesGrid" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:20px;">
                    <!-- Passed courses will be rendered here -->
                </div>
            </div>
        </section>

        <section id="my-progress-view" style="display: none;">
            <h2 style="color: var(--primary-blue); margin-top: 0;">My Progress</h2>
            <div class="progress-wrap">
                <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 14px;">
                    <div>
                        <div style="color:var(--text-main); font-size:14px;">Track your course activity and assessment results.</div>
                        <div style="color:var(--text-secondary); font-size:12px; margin-top:4px;">Assessments have <b>10 questions</b> for Beginner/Intermediate and <b>20 questions</b> for Advanced.</div>
                    </div>
                    <button class="btn-secondary" onclick="loadMyProgress()">Refresh</button>
                </div>

                <table class="admin-table" style="margin-top: 0;">
                    <thead>
                        <tr>
                            <th>Course</th>
                            <th style="width:120px;">Level</th>
                            <th style="width:210px;">Status</th>
                            <th style="width:120px;">Last Score</th>
                            <th style="width:150px;">Last Activity</th>
                            <th style="width:230px; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="myProgressTableBody">
                        <tr>
                            <td colspan="6" style="color:var(--text-secondary);">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="leaderboard-view" style="display: none;">
            <h2 style="color: var(--primary-blue); margin-top: 0;">Leaderboard</h2>
            <div class="progress-wrap">
                <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 14px;">
                    <div>
                        <div style="color:var(--text-main); font-size:14px;">Points are awarded when a course is <b>Passed</b>.</div>
                        <div style="color:var(--text-secondary); font-size:12px; margin-top:4px;">Beginner: <b>2</b> points ‚Ä¢ Intermediate: <b>5</b> points ‚Ä¢ Advanced: <b>10</b> points</div>
                    </div>
                    <button class="btn-secondary" onclick="loadLeaderboard()">Refresh</button>
                </div>

                <table class="admin-table" style="margin-top: 0;">
                    <thead>
                        <tr>
                            <th style="width:90px;">Rank</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th style="width:140px;">Points</th>
                            <th style="width:170px;">Last Updated</th>
                            <th id="leaderboardViewColView" style="width:90px; text-align:center; display:none;">View</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody">
                        <tr>
                            <td colspan="6" style="color:var(--text-secondary);">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="settings-view" style="display: none;">
            <h2 style="color: var(--primary-blue);">Settings</h2>
            <div style="padding: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; max-width: 400px;">
                <label style="display: block; margin-bottom: 10px; color: var(--text-main);">Interface Theme</label>
                <select id="themeToggle" onchange="toggleTheme(this.value)" style="width: 100%; padding: 10px; background: var(--bg-dark); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 6px;">
                    <option value="dark">Dark Theme</option>
                    <option value="light">Light Theme</option>
                </select>
            </div>
        </section>
    </main>
</div>

<!-- Floating Hub Bot Widget -->
<button id="hubBotFloatBtn" onclick="toggleHubBotWidget()" style="position:fixed; bottom:20px; right:20px; z-index:3500; background: var(--primary-blue); color: white; border: none; padding: 12px 16px; border-radius: 999px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); cursor: pointer; font-weight: 700; display:flex; align-items:center; gap:8px;">
    ü§ñ Hub Bot
</button>

<div id="hubBotWidget" style="display:none; position:fixed; bottom:80px; right:20px; width:340px; max-height:520px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 12px 32px rgba(0,0,0,0.45); z-index:4000; overflow:hidden;">
    <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border-color);">
        <div style="display:flex; align-items:center; gap:8px;">
            <div style="width:24px; height:24px; border-radius:50%; background: var(--primary-blue); display:flex; align-items:center; justify-content:center; color:white; font-weight:700;">ü§ñ</div>
            <div style="color:var(--text-main); font-weight:700;">Hub Bot</div>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <button onclick="clearHubBotChat()" title="Clear chat" style="background: transparent; color: var(--text-secondary); border:1px solid var(--border-color); padding:4px 8px; border-radius:6px; cursor:pointer;">üóë</button>
            <button onclick="minimizeHubBotWidget()" title="Minimize" style="background: transparent; color: var(--text-secondary); border:1px solid var(--border-color); padding:4px 8px; border-radius:6px; cursor:pointer; font-size:16px;">‚Äî</button>
            <button onclick="closeHubBotWidget()" title="Close" style="background: transparent; color: var(--text-secondary); border:none; cursor:pointer; font-size:18px;">‚úï</button>
        </div>
    </div>
    <div id="hubBotMessages" style="padding:10px; max-height:380px; overflow-y:auto;">
        <!-- Messages render here -->
    </div>
    <div style="display:flex; gap:6px; padding:10px; border-top:1px solid var(--border-color);">
        <input id="hubBotInput" type="text" placeholder="Ask anything..." style="flex:1; padding:10px; background: var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color: var(--text-main);">
        <button onclick="sendHubBotMessage('widget')" style="background: var(--primary-blue); color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer;">Send</button>
    </div>
</div>
<!-- Add User Modal -->
<div id="addUserModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center; animation: bounceIn 0.5s ease-out;">
    <div style="background:var(--card-bg); padding:30px; border-radius:12px; border:1px solid var(--border-color); width:420px; position:relative; animation: modalBounce 0.6s ease-out;">
        <h2 style="color:var(--primary-blue); margin-top:0;">Add User</h2>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Employee ID</label>
            <input type="text" id="newEmpId" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Employee name</label>
            <input type="text" id="newEmpName" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Email ID</label>
            <input type="email" id="newEmpEmail" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Role</label>
            <select id="newEmpRole" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
                <option value="User" selected>User</option>
                <option value="Admin">Admin</option>
            </select>
        </div>
        <div style="display:flex; gap:10px;">
            <button style="background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="saveNewUser()">Save User</button>
            <button style="background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="closeAddUserModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Add Role Modal -->
<div id="addRoleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center; animation: bounceIn 0.5s ease-out;">
    <div style="background:var(--card-bg); padding:30px; border-radius:12px; border:1px solid var(--border-color); width:420px; position:relative; animation: modalBounce 0.6s ease-out;">
        <h2 style="color:var(--primary-blue); margin-top:0;">Add Role</h2>
        <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Role name</label>
            <input type="text" id="newRoleName" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>
        <div style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Course (from Course Mgmt)</label>
            <select id="newRoleCourse" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);"></select>
            <small style="color:var(--text-secondary);">Courses listed here come from the Course Management tab.</small>
        </div>
        <div style="display:flex; gap:10px;">
            <button style="background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="saveNewRole()">Save Role</button>
            <button style="background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="closeAddRoleModal()">Cancel</button>
        </div>
    </div>
</div>

<script type="module">
// Import Firestore functions
import { 
    saveUser, getAllUsers, getUserByEmail, updateUserRole, deleteUser,
    saveCourse, getAllCourses, deleteCourse,
    saveUserCourse, getUserCourses, deleteUserCourse,
    saveAnnouncement, getAllAnnouncements,
    migrateLocalStorageToFirestore,
    upsertLeaderboardEntry, getLeaderboardEntries
} from './firestore-db.js';

// Make functions globally available
window.firestoreDB = {
    saveUser, getAllUsers, getUserByEmail, updateUserRole, deleteUser,
    saveCourse, getAllCourses, deleteCourse,
    saveUserCourse, getUserCourses, deleteUserCourse,
    saveAnnouncement, getAllAnnouncements,
    migrateLocalStorageToFirestore,
    upsertLeaderboardEntry, getLeaderboardEntries
};

// Auto-migrate on first load
const userEmail = localStorage.getItem('userEmail');
if (userEmail && !localStorage.getItem('migrated_to_firestore')) {
    migrateLocalStorageToFirestore(userEmail).then(result => {
        if (result.success) {
            localStorage.setItem('migrated_to_firestore', 'true');
            console.log('‚úÖ Data migrated to Firestore successfully!');
            location.reload(); // Reload to load from Firestore
        }
    });
}
</script>

<script>
// Check if running through server (not file://)
if (window.location.protocol === 'file:') {
    alert('‚ö†Ô∏è ERROR: Please access this app through the server!\n\nRun: npm start\nThen open: http://localhost:3000\n\nThe app cannot work from local files.');
    window.location.href = 'server-required.html';
}

function displayNews(newsArray) {
    const newsContainer = document.getElementById('news-container');
    const safeItems = Array.isArray(newsArray) ? newsArray : [];
    newsContainer.innerHTML = safeItems.map(item => {
        const url = (item && item.url) ? String(item.url).trim() : '';
        const hasGoodUrl = url && !isPlaceholderOrBadUrl(url);
        const linkHtml = hasGoodUrl
            ? `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary-blue); font-size: 13px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; background: rgba(66,133,244,0.1); border-radius: 6px; border: 1px solid var(--primary-blue); transition: all 0.2s;">
                üì∞ Read Full Article ‚Üí
            </a>`
            : `<div style="color:var(--text-secondary); font-size:12px; padding:6px 0;">Link unavailable (refreshing news...)</div>`;

        return `
        <div class="news-item">
            <span class="item-date" style="color: var(--primary-blue); font-size: 11px; font-weight: bold;">${item.date}</span>
            <div style="font-weight: 700; margin: 4px 0; color: var(--text-main); font-size: 14px;">${item.headline}</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 10px;">
                ${item.summary}
            </div>
            ${linkHtml}
        </div>
    `;
    }).join('');
}

function displayAIUpdates(items) {
    const container = document.getElementById('ai-updates-container');
    if (!container) return;

    if (!Array.isArray(items) || items.length === 0) {
        container.innerHTML = '<div class="news-item" style="color:var(--text-secondary);">No updates found.</div>';
        return;
    }

    container.innerHTML = items.map(item => `
        <div class="news-item">
            <span class="item-date" style="color: var(--primary-blue); font-size: 11px; font-weight: bold;">${item.date}</span>
            <div style="font-weight: 700; margin: 4px 0; color: var(--text-main); font-size: 14px;">${item.title}</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 10px;">
                ${item.summary}
            </div>
            <a href="${item.url}" target="_blank" rel="noopener noreferrer" style="color: var(--primary-blue); font-size: 13px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; background: rgba(66,133,244,0.1); border-radius: 6px; border: 1px solid var(--primary-blue); transition: all 0.2s;">
                üîó Open Update ‚Üí
            </a>
        </div>
    `).join('');
}

async function checkUrlAccessible(url) {
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 4500);
        const resp = await fetch(`/api/url/check?url=${encodeURIComponent(url)}`, { signal: controller.signal });
        clearTimeout(timeout);
        if (!resp.ok) return { ok: false, status: resp.status };
        return await resp.json();
    } catch (_) {
        // If the validator endpoint is unreachable, treat as NOT accessible.
        // This prevents users being sent to 404/error pages (hallucinated links).
        return { ok: false, reason: 'validator_unreachable' };
    }
}

function isPlaceholderOrBadUrl(url) {
    try {
        const u = new URL(url);
        const host = (u.hostname || '').toLowerCase();
        if (!host) return true;
        if (host === 'example.com' || host === 'example.org' || host === 'example.net') return true;
        return false;
    } catch (_) {
        return true;
    }
}

function isBlockedNewsDomain(url) {
    try {
        const u = new URL(url);
        const host = (u.hostname || '').toLowerCase();
        if (!host) return true;
        // Block known paywalled/login-first domains to keep news accessible.
        const blocked = [
            'bloomberg.com',
            'wsj.com',
            'ft.com',
            'economist.com',
            'nytimes.com',
            'theinformation.com',
        ];
        if (blocked.some(d => host === d || host.endsWith('.' + d))) return true;
        return false;
    } catch (_) {
        return true;
    }
}

function isLikelyHomepage(url) {
    try {
        const u = new URL(url);
        const path = (u.pathname || '').trim();
        return !path || path === '/' || path.length < 2;
    } catch (_) {
        return true;
    }
}

async function filterAccessibleItems(items, urlField = 'url') {
    if (!Array.isArray(items)) return [];
    const filtered = [];
    for (const item of items) {
        const url = (item && item[urlField]) ? String(item[urlField]).trim() : '';
        if (!url) continue;
        if (isPlaceholderOrBadUrl(url)) continue;
        if (isBlockedNewsDomain(url)) continue;
        if (isLikelyHomepage(url)) continue;
        const check = await checkUrlAccessible(url);
        const finalUrl = (check && check.finalUrl) ? String(check.finalUrl) : url;
        if (check && check.ok && !isPlaceholderOrBadUrl(finalUrl) && !isBlockedNewsDomain(finalUrl)) {
            filtered.push({ ...item, [urlField]: finalUrl });
        }
    }
    return filtered;
}

async function fetchAINews() {
    const newsContainer = document.getElementById('news-container');

    if (!newsContainer) return;

    // Fetch fresh news
    newsContainer.innerHTML = '<div class="news-item">Fetching real-time AI news...</div>';

    try {
        const today = promptTodayShortDate();
        const data = await callGeminiAPI(
            `Use Google Search to find exactly 10 REAL, ACCESSIBLE AI news articles published in the LAST 24 HOURS ONLY (today: ${today}).

Only use OPEN-ACCESS sources where employees can read the full article without paywall/login.

Preferred open sources (pick from these first):
- Official AI/company blogs (OpenAI, Google/DeepMind, Anthropic, Meta AI, Microsoft, NVIDIA)
- Hugging Face blog
- GitHub blog
- arXiv (papers)
- Major project release posts (PyTorch, TensorFlow, LangChain, etc.)

Avoid paywalled sources (do NOT use): Bloomberg, WSJ, Financial Times, The Economist.

CRITICAL REQUIREMENTS:
1. Articles MUST be from the LAST 24 HOURS ONLY
2. Sources MUST be reputable AND open-access. Prefer official blogs, arXiv, and release notes.
3. The "url" field MUST be the COMPLETE, DIRECT URL to the specific article page (not homepage)
4. URLs must be real, working links that users can click and read the full article WITHOUT login/paywall
5. NEVER use placeholder links like example.com (do not fabricate URLs)
6. Focus on TOP/TRENDING AI news stories only
7. Each article must have the actual publication date in "MMM D, YYYY" format
8. Summary should be 2-3 sentences about what the article covers

Return ONLY a valid JSON array with NO markdown formatting:
[{"date": "Jan 2, 2026", "headline": "Actual Article Title", "summary": "Clear 2-3 sentence summary of the article content", "url": "https://complete-direct-url-to-article"}]`,
            'gemini-2.5-flash'
        );

        if (data.error) throw new Error(data.error.message);

        const textResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const rawNewsArray = await parseJsonArrayFromGeminiText(
            textResponse,
            `[{"date":"${today}","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`
        );

        // Validate links via server so we don't show broken/blank articles
        let newsArray = await filterAccessibleItems(rawNewsArray, 'url');

        // If we got too few items after filtering, broaden slightly (still open-access) and merge.
        if (!newsArray || newsArray.length < 8) {
            const more = await callGeminiAPI(
                `Use Google Search to find 15 REAL, OPEN-ACCESS AI news links from the LAST 24 HOURS (today: ${today}).

Only include sources where the full article is readable without paywall/login.
Prefer: official AI/company blogs, Hugging Face blog, GitHub blog, arXiv, project release posts.

Return ONLY valid JSON array:
[{"date":"Jan 2, 2026","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`,
                'gemini-2.5-flash'
            );
            const txt = more?.candidates?.[0]?.content?.parts?.[0]?.text || '';
            const rawMore = await parseJsonArrayFromGeminiText(
                txt,
                `[{"date":"${today}","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`
            );
            const merged = [...rawNewsArray, ...(Array.isArray(rawMore) ? rawMore : [])];
            newsArray = await filterAccessibleItems(merged, 'url');
        }

        // Ensure we show a full set (up to 10). If validator is down, filterAccessibleItems will still pass safe URLs.
        if (Array.isArray(newsArray) && newsArray.length > 10) {
            newsArray = newsArray.slice(0, 10);
        }

        // If filtering removed everything, fall back to latest (last 7 days) so users still see real links
        if (!newsArray || newsArray.length === 0) {
            const fallback = await callGeminiAPI(
                `Use Google Search to find up to 10 REAL, ACCESSIBLE AI news articles from the LAST 7 DAYS (including today: ${today}).

Only use OPEN-ACCESS sources (no paywalls/logins). Prefer official AI blogs, Hugging Face, GitHub blog, arXiv, and project release posts.

CRITICAL REQUIREMENTS:
1. Prefer articles from the last 24 hours, but allow up to 7 days if needed
2. Provide COMPLETE, DIRECT article URLs (not homepages)
3. Avoid paywalls/login-only links
4. NEVER use placeholder links like example.com (do not fabricate URLs)

Return ONLY valid JSON array:
[{"date":"Jan 2, 2026","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`,
                'gemini-2.5-flash'
            );
            const txt = fallback?.candidates?.[0]?.content?.parts?.[0]?.text || '';
            const raw2 = await parseJsonArrayFromGeminiText(
                txt,
                `[{"date":"${today}","headline":"Title","summary":"2-3 sentences","url":"https://direct-url"}]`
            );
            newsArray = await filterAccessibleItems(raw2, 'url');
        }

        // If we still have too few (e.g., strict filtering), fill from raw list with safe non-placeholder URLs.
        if (Array.isArray(newsArray) && newsArray.length < 8) {
            const seen = new Set(newsArray.map(n => String(n.url || '').trim()));
            for (const it of (Array.isArray(rawNewsArray) ? rawNewsArray : [])) {
                if (newsArray.length >= 10) break;
                const u = String(it?.url || '').trim();
                if (!u || isPlaceholderOrBadUrl(u) || isBlockedNewsDomain(u) || isLikelyHomepage(u)) continue;
                if (seen.has(u)) continue;
                newsArray.push(it);
                seen.add(u);
            }
        }

        // Validate that we got proper news data
        if (Array.isArray(newsArray) && newsArray.length > 0) {
            displayNews(newsArray);
            console.log('Fetched and displayed fresh AI news');
        } else {
            throw new Error('Invalid news data received');
        }

    } catch (error) {
        console.error("AI News fetch error:", error);
        newsContainer.innerHTML = `<div class="news-item" style="color:#f85149;">‚ö†Ô∏è Error loading news: ${error.message}<br><small>Please click Refresh News again.</small></div>`;
    }
}

async function fetchAIUpdates() {
    const container = document.getElementById('ai-updates-container');
    if (!container) return;

    container.innerHTML = '<div class="news-item">Fetching AI updates...</div>';

async function fetchUpdatesWithPrompt(prompt) {
    const data = await callGeminiAPI(
        prompt,
        'gemini-2.5-flash'
    );
    if (data.error) throw new Error(data.error.message);

    const textResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const today = promptTodayShortDate();
    const raw = await parseJsonArrayFromGeminiText(
        textResponse,
        `[{"date":"${today}","title":"Release title","summary":"What changed","url":"https://direct-url"}]`
    );
    return await filterAccessibleItems(raw, 'url');
    }

    try {
        const today = promptTodayShortDate();
        let filtered = await fetchUpdatesWithPrompt(
            `Use Google Search to find exactly 8 REAL AI updates from the LAST 24 HOURS ONLY (today: ${today}).

These are NOT general news headlines‚Äîfocus on releases/updates such as:
- New AI model releases or updates (OpenAI, Google, Anthropic, Meta, etc.)
- Framework/library releases (PyTorch, TensorFlow, Transformers, LangChain, etc.)
- Product feature launches (Copilots, assistants, API updates)
- Security/patch releases related to AI tooling

CRITICAL REQUIREMENTS:
1. Items MUST be from the last 24 hours only
2. Provide DIRECT, WORKING URLs (no homepages)
3. Avoid paywalls/login-only links
4. NEVER use placeholder links like example.com (do not fabricate URLs)
4. Each item must have a date "MMM D, YYYY"
5. Summary must be 1-2 sentences describing what changed/released

Return ONLY a valid JSON array with NO markdown:
[{"date":"Jan 2, 2026","title":"Release title","summary":"What changed","url":"https://direct-url"}]`
        );

        // If none found in last 24h, fall back to latest available updates (last 7 days)
        if (!filtered || filtered.length === 0) {
            filtered = await fetchUpdatesWithPrompt(
                `Use Google Search to find exactly 8 REAL AI updates from the LAST 7 DAYS (including today: ${today}).

Focus on releases/updates such as model releases, library/framework releases, and product update notes.

CRITICAL REQUIREMENTS:
1. Provide DIRECT, WORKING URLs (no homepages)
2. Avoid paywalls/login-only links
3. NEVER use placeholder links like example.com (do not fabricate URLs)
4. Each item must have a date "MMM D, YYYY"
5. Summary must be 1-2 sentences describing what changed/released

Return ONLY valid JSON array:
[{"date":"Jan 2, 2026","title":"Release title","summary":"What changed","url":"https://direct-url"}]`
            );
        }
        displayAIUpdates(filtered);
    } catch (error) {
        console.error('AI Updates fetch error:', error);
        container.innerHTML = `<div class="news-item" style="color:#f85149;">‚ö†Ô∏è Error loading updates: ${error.message}</div>`;
    }
}

async function updateAnnouncements() {
    const container = document.getElementById('announcements-container');
    if (!container) return;

    // Get announcements from shared API storage
    const announcements = await getSharedAnnouncements();
    const hasStartedTechAssessment = localStorage.getItem('initialAssessmentStarted') === 'true';

    const items = [];
    if (!hasStartedTechAssessment) {
        items.push({ date: 'Urgent', message: 'New Technical Gateway Assessment is now live.', type: 'system' });
    }
    announcements.forEach(a => items.push({ date: a.date || '', message: a.message, type: a.type || 'general' }));

    if (items.length === 0) {
        container.innerHTML = '<div class="announcement-item" style="color:var(--text-secondary);">No announcements.</div>';
        return;
    }

    container.innerHTML = items.map(item => `
        <div class="announcement-item">
            ${item.date ? `<span class="item-date" style="color: var(--primary-blue); font-size: 11px; margin-right:6px;">${item.date}</span>` : ''}
            <span style="color:var(--text-main)">${item.message}</span>
        </div>
    `).join('');
}

function updateGreeting() {
    const hour = new Date().getHours();
    const greetingElement = document.getElementById('timeGreeting');
    let timeMsg = "";

    if (hour < 12) timeMsg = "Good Morning, ";
    else if (hour < 18) timeMsg = "Good Afternoon, ";
    else timeMsg = "Good Evening, ";

    if (greetingElement) {
        greetingElement.innerText = timeMsg + "Welcome to the Hub.";
    }
}

function switchTab(viewId, element) {
    // Hide all sections
    document.querySelectorAll('main > section').forEach(section => {
        section.style.display = 'none';
    });
    // Show the selected section
    document.getElementById(viewId).style.display = 'block';
    // Update active sidebar item
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
    });

    const safeElement = element || document.querySelector(`.sidebar-item[onclick*="'${viewId}'"]`);
    if (safeElement) {
        safeElement.classList.add('active');
    }
    // Load content if needed
    if (viewId === 'courses-view') {
        loadCoursesView();
    } else if (viewId === 'role-mgmt-view') {
        loadRoles();
    } else if (viewId === 'my-progress-view') {
        loadMyProgress();
    } else if (viewId === 'leaderboard-view') {
        loadLeaderboard();
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if (sidebar.classList.contains('expanded')) {
        sidebar.classList.remove('expanded');
        if (mainContent) mainContent.style.marginLeft = '';
    } else {
        sidebar.classList.add('expanded');
        if (mainContent) mainContent.style.marginLeft = '';
    }
}

function toggleTheme(theme) {
    if (theme === 'light') {
        document.body.classList.add('light-theme');
    } else {
        document.body.classList.remove('light-theme');
    }
    localStorage.setItem('hubTheme', theme);
    // Update logo if needed
    const logo = document.getElementById('mainLogo');
    if (logo) {
        logo.src = theme === 'light' ? 'new oneorigin semi arch (1) 1 (5).png' : 'oo new semi arch white blue (4).png';
    }
}

function deriveNameFromEmail(email) {
    if (!email) return '';
    const local = email.split('@')[0] || '';
    const parts = local.split(/[._]/).filter(Boolean);
    if (parts.length === 0) return '';
    return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
}

function setUserBadge() {
    const badge = document.getElementById('userName');
    if (!badge) return;
    const email = localStorage.getItem('userEmail') || '';
    const stored = (localStorage.getItem('userName') || '').trim();
    const derived = deriveNameFromEmail(email);
    badge.textContent = stored || derived || 'User';
}

// Quick insert helper for Hub Bot prompt chips
function hubBotInsert(text) {
    const input = document.getElementById('hubBotPageInput');
    if (!input) return;
    input.value = text;
    input.focus();
}

window.onload = async () => {
    // Check if user is logged in - redirect to login if not
    const userEmail = localStorage.getItem('userEmail');
    if (!userEmail) {
        window.location.href = 'index.html';
        return;
    }
    
    // Cloud-backed auto-registration + role sync + reset flag (fallback to local only if cloud not available)
    const __userSyncPromise = (async () => {
        const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
        const now = new Date().toLocaleString();
        const displayName = (localStorage.getItem('userName') || '').trim() || deriveNameFromEmail(userEmail);

        try {
            if (window.upsertSharedUser && window.getSharedUserByEmail) {
                // Upsert ensures user exists in Firestore and updates lastActive
                await window.upsertSharedUser({
                    email: userEmail,
                    name: displayName,
                    lastActive: now
                });

                const me = await window.getSharedUserByEmail(userEmail);
                if (me?.role) {
                    localStorage.setItem('userRole', String(me.role).toLowerCase() === 'admin' ? 'admin' : 'user');
                }
                if (me?.employeeId) {
                    localStorage.setItem('employeeId', me.employeeId);
                }

                if (me?.resetAssessmentFlag === true && window.setUserResetAssessmentFlag) {
                    localStorage.removeItem('initialAssessmentScore');
                    localStorage.removeItem('userLevel');
                    localStorage.removeItem('initialAssessmentStarted');
                    localStorage.setItem('assignedCourses', '[]');
                    localStorage.removeItem('upcomingCourse');
                    await window.setUserResetAssessmentFlag(userEmail, false);
                    console.log('Assessment data cleared for user via cloud flag:', userEmail);
                }

                // Ensure superadmin stays admin in local session
                if (String(userEmail).toLowerCase() === SUPERADMIN_EMAIL.toLowerCase()) {
                    localStorage.setItem('userRole', 'admin');
                }

                return;
            }
        } catch (e) {
            console.warn('Cloud user sync failed; using local fallback', e);
        }

        // Local fallback (single-device)
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const existingUserIndex = users.findIndex(u => u.email && u.email.toLowerCase() === userEmail.toLowerCase());

        if (existingUserIndex === -1 && userEmail.toLowerCase() !== SUPERADMIN_EMAIL.toLowerCase()) {
            const newUser = {
                employeeId: 'EMP-' + Date.now(),
                name: displayName,
                email: userEmail,
                role: 'User',
                lastActive: now
            };
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('userRole', 'User');
        } else if (existingUserIndex !== -1) {
            users[existingUserIndex].lastActive = now;
            if (users[existingUserIndex].resetAssessmentFlag === true) {
                localStorage.removeItem('initialAssessmentScore');
                localStorage.removeItem('userLevel');
                localStorage.removeItem('initialAssessmentStarted');
                localStorage.setItem('assignedCourses', '[]');
                localStorage.removeItem('upcomingCourse');
                delete users[existingUserIndex].resetAssessmentFlag;
            }
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('userRole', users[existingUserIndex].role || 'User');
        }
    })();
    
    // Generate Static Title
    const titleText = "OneOrigin Learning Hub";
    const titleContainer = document.getElementById('bouncingTitle');
    if (titleContainer) {
        titleContainer.innerHTML = "";
        titleText.split("").forEach((char) => {
            const span = document.createElement('span');
            if (char === " ") {
                span.className = "space";
                span.style.width = "10px";
            } else {
                span.innerText = char;
            }
            titleContainer.appendChild(span);
        });
    }

    // Update Dynamic Time-Based Greeting
    updateGreeting();

    // Fetch AI News
    fetchAINews();
    fetchAIUpdates();

    // Load saved theme
    const savedTheme = localStorage.getItem('hubTheme') || 'dark';
    toggleTheme(savedTheme);
    document.getElementById('themeToggle').value = savedTheme;

    // Backup and restore data from sessionStorage to prevent data loss
    backupAndRestoreData();

    // Update badge using email-derived full name when available
    setUserBadge();

    // Initialize role-based access control (SUPERADMIN logic is here)
    await __userSyncPromise;
    await syncCurrentUserRole();
    checkAdminStatus();
    
    // Load all course data
    loadCourses();
    loadCoursesView();
    const searchInput = document.getElementById('courseSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => loadCoursesView(e.target.value));
    }
    loadAssignedCourses();
    
    // Load user and role data
    updateAnnouncements();
    // These may be async (cloud-backed)
    Promise.resolve(loadUsers()).catch(() => {});
    Promise.resolve(loadRoles()).catch(() => {});

    // Show Home view
    const homeView = document.getElementById('home-view');
    if (homeView) homeView.style.display = 'block';
};

// Backup data to sessionStorage and restore if localStorage is cleared
function backupAndRestoreData() {
    // List of keys to backup
    const keysToBackup = ['users', 'courses', 'announcements', 'userCourses'];
    
    // Backup: Copy from localStorage to sessionStorage
    keysToBackup.forEach(key => {
        const data = localStorage.getItem(key);
        if (data && data !== '[]' && data !== 'null') {
            sessionStorage.setItem(key + '_backup', data);
        }
    });
    
    // Restore only if the key is truly missing (not when intentionally an empty array)
    keysToBackup.forEach(key => {
        const localData = localStorage.getItem(key);
        const backupData = sessionStorage.getItem(key + '_backup');
        
        if ((localData === null || localData === 'null') && backupData) {
            localStorage.setItem(key, backupData);
        }
    });
}

</script>

<!-- In-app course player overlay -->
<div id="coursePlayerOverlay" class="course-player-overlay" onclick="overlayBackdropClick(event)">
    <div class="course-player-content">
        <div class="course-player-header">
            <span id="coursePlayerTitle">Now Playing</span>
            <button class="course-player-close" onclick="closeCoursePlayer()">‚úï</button>
        </div>
        <div class="course-player-frame">
            <div id="coursePlayerFrame" style="width:100%; height:100%;"></div>
            <button id="coursePlayerPlay" class="course-player-play" onclick="startCoursePlayer()">‚ñ∂</button>
        </div>
        <div style="margin-top: 15px; padding: 15px; background: rgba(66,133,244,0.1); border: 1px solid var(--primary-blue); border-radius: 8px; text-align: center;">
            <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">Video not playing? Try watching directly on YouTube</div>
            <a id="watchOnYouTubeLink" href="#" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 8px; background: #FF0000; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: bold; margin-bottom: 10px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
                Watch on YouTube
            </a>
            <div style="font-size: 11px; color: var(--text-secondary); font-family: monospace;">
                Video ID: <span id="coursePlayerVideoId" style="color: var(--primary-blue); font-weight: bold;">-</span>
            </div>

            <div style="margin-top: 12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                <button id="coursePlayerAssessmentBtn" class="btn-secondary" onclick="startCatalogAssessmentFromPlayer()" disabled>Take Assessment</button>
            </div>
            <div id="coursePlayerAssessmentHint" style="margin-top:8px; font-size:12px; color:var(--text-secondary);">Finish watching the full video to unlock the assessment.</div>
        </div>
    </div>
</div>

<!-- Admin: View employee course progress -->
<div id="employeeProgressModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.82); z-index:3500; align-items:center; justify-content:center;">
    <div style="background:var(--card-bg); border:1px solid var(--border-color); border-radius:12px; width:min(980px, 96vw); max-height:86vh; overflow:hidden; box-shadow:0 18px 48px rgba(0,0,0,0.55);">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border-color);">
            <div>
                <div id="employeeProgressTitle" style="color:var(--text-main); font-weight:900; font-size:16px;">User Progress</div>
                <div id="employeeProgressSub" style="color:var(--text-secondary); font-size:12px; margin-top:2px;"></div>
            </div>
            <button class="course-player-close" onclick="closeEmployeeProgressModal()">‚úï</button>
        </div>
        <div style="padding:14px 16px; overflow:auto; max-height: calc(86vh - 58px);">
            <div id="employeeProgressBody" style="color:var(--text-secondary);">Loading‚Ä¶</div>
        </div>
    </div>
</div>

<!-- Course assessment overlay (Courses catalog) -->
<div id="courseAssessmentOverlay" class="assessment-overlay" onclick="courseAssessmentBackdropClick(event)">
    <div class="assessment-modal">
        <div class="assessment-modal-head">
            <div class="assessment-modal-title">
                <b id="courseAssessmentTitle">Course Assessment</b>
                <span id="courseAssessmentMeta">‚Äî</span>
            </div>
            <button class="course-player-close" onclick="closeCourseAssessment()">‚úï</button>
        </div>
        <div class="assessment-modal-body">
            <div id="courseAssessmentBody" style="color:var(--text-secondary);">Loading‚Ä¶</div>
        </div>
    </div>
</div>

<div id="addCourseModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; align-items:center; justify-content:center; animation: bounceIn 0.5s ease-out;">
    <div style="background:var(--card-bg); padding:30px; border-radius:12px; border:1px solid var(--border-color); width:400px; position:relative; animation: modalBounce 0.6s ease-out;">
        <h2 style="color:var(--primary-blue); margin-top:0;">Add New Course</h2>
        
        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Course Name</label>
            <input type="text" id="newCourseName" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>

        <div style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">Course Type</label>
            <select id="newCourseType" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
                <option value="beginner">Beginner</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
            </select>
        </div>

        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:5px; font-size:14px; color:var(--text-main);">YouTube Video ID</label>
            <input type="text" id="newVideoId" placeholder="e.g., aircAruvnKk" style="width:100%; padding:10px; background:var(--bg-dark); border:1px solid var(--border-color); border-radius:6px; color:var(--text-main);">
        </div>

        <div style="display:flex; gap:10px;">
            <button style="background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="saveNewCourse()">Save Course</button>
            <button style="background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); padding:10px 20px; border-radius:6px; cursor:pointer; flex:1;" onclick="closeAddCourseModal()">Cancel</button>
        </div>
    </div>
</div>

<style>
@keyframes bounceIn {
    0% { opacity: 0; transform: scale(0.3); }
    50% { opacity: 1; transform: scale(1.05); }
    70% { transform: scale(0.9); }
    100% { opacity: 1; transform: scale(1); }
}

@keyframes modalBounce {
    0% { transform: scale(0.7) rotate(-5deg); }
    50% { transform: scale(1.1) rotate(2deg); }
    100% { transform: scale(1) rotate(0deg); }
}
</style>

<script>
function openAddCourseModal() {
    const modal = document.getElementById('addCourseModal');
    if (modal) {
        modal.style.display = 'flex';
    } else {
        console.error('‚ùå Add Course Modal not found!');
    }
}

function closeAddCourseModal() {
    document.getElementById('addCourseModal').style.display = 'none';
}

async function saveNewCourse() {
    const name = document.getElementById('newCourseName').value.trim();
    const type = document.getElementById('newCourseType').value;
    const videoId = document.getElementById('newVideoId').value.trim();

    if (!name || !videoId) {
        alert('Please fill in all required fields.');
        return;
    }

    const uploadDate = new Date().toLocaleDateString();
    const id = Date.now();
    const newCourse = { id, name, type, videoId, uploadDate };
    
    // Save to shared API storage so ALL users can see it
    await addSharedCourse(newCourse);
    
    // Add announcement
    const announcement = {
        message: `New course added: ${name} (${type})`,
        date: new Date().toLocaleString(),
        type: 'course'
    };
    await addSharedAnnouncement(announcement);

    await loadCourses();
    await loadCoursesView();
    loadRoles();
    if (typeof updateAnnouncements === 'function') await updateAnnouncements();

    // Clear the form
    document.getElementById('newCourseName').value = '';
    document.getElementById('newVideoId').value = '';

    closeAddCourseModal();
}

async function deleteCourse(id) {
    if (!confirm('Are you sure you want to delete this course?')) return;
    
    try {
        if (!id) {
            alert('Unable to delete: missing course identifier.');
            return;
        }

        const key = String(id).trim();
        console.log('üóëÔ∏è Deleting course:', key);

        // 1. Delete from Firestore/Shared Storage
        if (window.firestoreDB && typeof window.firestoreDB.deleteCourse === 'function') {
            await window.firestoreDB.deleteCourse(key);
        } else if (window.deleteSharedCourse) {
            await window.deleteSharedCourse(key);
        } else {
            // Local fallback
            const courses = JSON.parse(localStorage.getItem('courses') || '[]')
                .filter(c => String(c.id) !== key && String(c.videoId) !== key);
            localStorage.setItem('courses', JSON.stringify(courses));
        }

        // 2. Clear session backups to prevent "ghost" data on reload
        sessionStorage.removeItem('courses_backup');

        // 3. Refresh the UI components
        await loadCourses();
        if (typeof loadCoursesView === 'function') await loadCoursesView();
        
        console.log('‚úÖ Course deleted successfully');
    } catch (error) {
        console.error('‚ùå Error deleting course:', error);
        alert('Failed to delete course: ' + error.message);
    }
}

async function loadCourses() {
    // Sync shared courses from API/Firestore
    const courses = window.syncSharedCourses ? await window.syncSharedCourses() : (JSON.parse(localStorage.getItem('courses') || '[]'));
    
    const tbody = document.getElementById('courseMgmtTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    courses.forEach((course, index) => {
        const row = tbody.insertRow();
        const deleteKey = course.id || course.videoId; // Ensure we have a valid identifier
        
        row.insertCell(0).innerText = index + 1;
        row.insertCell(1).innerText = course.name || 'Untitled';
        row.insertCell(2).innerText = course.type || '-';
        row.insertCell(3).innerText = course.videoId || '-';
        row.insertCell(4).innerText = course.uploadDate || '-';
        
        const deleteCell = row.insertCell(5);
        deleteCell.innerHTML = `<button style="background:#f85149; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" 
            onclick="deleteCourse('${deleteKey}')">Delete</button>`;
    });
}

let currentCourseVideoId = '';
let currentCourseTitle = '';
let currentCourseType = '';

// ============ Catalog Course Progress + Assessments ============
const COURSE_PROGRESS_LOCAL_KEY = 'catalogCourseProgress'; // local fallback map { [videoId]: progress }

function prettyLevel(type) {
    const t = String(type || '').toLowerCase();
    if (t === 'advanced') return 'Advanced';
    if (t === 'intermediate') return 'Intermediate';
    return 'Beginner';
}

function questionCountForType(type) {
    const t = String(type || '').toLowerCase();
    return t === 'advanced' ? 20 : 10;
}

function pointsForType(type) {
    const t = String(type || '').toLowerCase();
    if (t === 'advanced') return 10;
    if (t === 'intermediate') return 5;
    return 2;
}

function deriveDisplayName() {
    const stored = (localStorage.getItem('userName') || '').trim();
    const email = safeUserEmail();
    if (stored) return stored;
    try {
        if (!email) return 'User';
        const local = email.split('@')[0] || '';
        const parts = local.split(/[._]/).filter(Boolean);
        if (parts.length === 0) return email;
        return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
    } catch (_) {
        return 'User';
    }
}

async function computeMyPoints() {
    const courses = window.syncSharedCourses ? await window.syncSharedCourses() : JSON.parse(localStorage.getItem('courses') || '[]');
    const progressMap = await getAllProgressMap();

    let points = 0;
    const counted = new Set();
    for (const c of (Array.isArray(courses) ? courses : [])) {
        const vid = String(c?.videoId || '').trim();
        if (!vid) continue;
        const p = progressMap[vid] || {};
        const passed = Boolean(p?.assessment?.passed);
        if (!passed) continue;
        if (!counted.has(vid)) {
            points += pointsForType(c?.type || p?.courseType || 'beginner');
            counted.add(vid);
        }
    }

    // Include Measure & Master assigned courses (local) with same point rules
    try {
        const assigned = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
        for (const c of (Array.isArray(assigned) ? assigned : [])) {
            const vid = String(c?.videoId || '').trim();
            if (!vid || counted.has(vid)) continue;
            const p = progressMap[vid] || {};
            const passed = Boolean(p?.assessment?.passed) || Boolean(c?.passed);
            if (!passed) continue;
            points += pointsForType(String(c?.level || p?.courseType || 'beginner').toLowerCase());
            counted.add(vid);
        }
    } catch (_) {}

    return points;
}

async function updateMyLeaderboardPoints() {
    const email = safeUserEmail();
    if (!email) return;
    const points = await computeMyPoints();
    try {
        if (window.firestoreDB && typeof window.firestoreDB.upsertLeaderboardEntry === 'function') {
            await window.firestoreDB.upsertLeaderboardEntry(email, {
                name: deriveDisplayName(),
                points
            });
        }
    } catch (e) {
        console.warn('Failed updating leaderboard:', e);
    }
}

function safeUserEmail() {
    return (localStorage.getItem('userEmail') || '').trim();
}

function isAdminSession() {
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const userEmail = (localStorage.getItem('userEmail') || '').toLowerCase();
    const role = (localStorage.getItem('userRole') || '').toLowerCase();
    return role === 'admin' || userEmail === SUPERADMIN_EMAIL.toLowerCase();
}

function formatSecondsToHms(totalSeconds) {
    const s = Math.max(0, Math.floor(Number(totalSeconds) || 0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    const pad = (n) => String(n).padStart(2, '0');
    return h > 0 ? `${h}:${pad(m)}:${pad(ss)}` : `${m}:${pad(ss)}`;
}

function safeIsoToDate(iso) {
    try {
        if (!iso) return null;
        const d = new Date(iso);
        return Number.isNaN(d.getTime()) ? null : d;
    } catch (_) {
        return null;
    }
}

function normalizeCourseLevel(levelOrType) {
    const t = String(levelOrType || '').toLowerCase();
    if (t.includes('advanced')) return 'advanced';
    if (t.includes('intermediate')) return 'intermediate';
    if (t.includes('beginner')) return 'beginner';
    return t || 'beginner';
}

function extractJsonArrayFromText(text) {
    const raw = String(text || '').trim();
    if (!raw) throw new Error('Empty response');
    let cleaned = raw.replace(/```json\s*|```/g, '').trim();
    const m = cleaned.match(/\[[\s\S]*\]/);
    if (!m) throw new Error('API returned invalid format. Please try refreshing.');
    cleaned = m[0];
    const parsed = JSON.parse(cleaned);
    if (!Array.isArray(parsed)) throw new Error('API returned invalid format. Please try refreshing.');
    return parsed;
}

function promptTodayShortDate() {
    const d = new Date();
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function truncateForPrompt(text, maxChars = 8000) {
    const s = String(text || '');
    if (s.length <= maxChars) return s;
    return s.slice(0, maxChars) + `\n\n... (truncated ${s.length - maxChars} chars)`;
}

async function parseJsonArrayFromGeminiText(text, schemaHint = '') {
    try {
        return extractJsonArrayFromText(text);
    } catch (_) {
        // One repair attempt: ask Gemini to output only JSON.
        const repairPrompt = `Convert the following into ONLY a valid JSON array.${schemaHint ? `\n\nRequired structure example:\n${schemaHint}` : ''}

Return ONLY the JSON array, no markdown, no commentary.

TEXT TO CONVERT:\n${truncateForPrompt(text, 8000)}`;
        const repaired = await callGeminiAPI(repairPrompt, 'gemini-2.5-flash');
        if (repaired?.error) throw new Error(repaired.error.message);
        const repairedText = repaired?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        return extractJsonArrayFromText(repairedText);
    }
}

function coursePlayerSetAssessmentLock(locked, reason = '') {
    const btn = document.getElementById('coursePlayerAssessmentBtn');
    const hint = document.getElementById('coursePlayerAssessmentHint');
    if (btn) btn.disabled = !!locked;
    if (hint) {
        hint.textContent = locked
            ? (reason || 'Finish watching the full video to unlock the assessment.')
            : 'Unlocked. You can now take the assessment.';
        hint.style.color = locked ? 'var(--text-secondary)' : '#4CAF50';
    }
}

async function ensureWatchCompletedOrBlock(videoId) {
    const vid = String(videoId || '').trim();
    if (!vid) return false;
    const map = await getAllProgressMap();
    const p = map[vid] || {};
    const completed = p?.watch?.completed === true;
    if (completed) return true;
    alert('Assessment is locked until you watch the full course video.');
    return false;
}

function loadCatalogProgressLocal() {
    try {
        const raw = localStorage.getItem(COURSE_PROGRESS_LOCAL_KEY);
        const parsed = raw ? JSON.parse(raw) : {};
        return parsed && typeof parsed === 'object' ? parsed : {};
    } catch (_) {
        return {};
    }
}

function saveCatalogProgressLocal(map) {
    try {
        localStorage.setItem(COURSE_PROGRESS_LOCAL_KEY, JSON.stringify(map || {}));
    } catch (_) {}
}

async function upsertCourseProgress(videoId, patch) {
    const email = safeUserEmail();
    const key = String(videoId || '').trim();
    if (!key) return;

    // Local fallback
    const map = loadCatalogProgressLocal();
    const existing = map[key] && typeof map[key] === 'object' ? map[key] : {};
    const next = { ...existing, ...patch, videoId: key };
    map[key] = next;
    saveCatalogProgressLocal(map);

    // Firestore (best effort)
    try {
        if (email && window.firestoreDB && typeof window.firestoreDB.saveUserCourse === 'function') {
            await window.firestoreDB.saveUserCourse(email, next);
        }
    } catch (e) {
        console.warn('Failed saving progress to Firestore, using local fallback only:', e);
    }
}

async function getAllProgressMap() {
    const email = safeUserEmail();
    const merged = loadCatalogProgressLocal();

    try {
        if (email && window.firestoreDB && typeof window.firestoreDB.getUserCourses === 'function') {
            const rows = await window.firestoreDB.getUserCourses(email);
            if (Array.isArray(rows)) {
                for (const r of rows) {
                    const vid = String(r?.videoId || '').trim();
                    if (!vid) continue;
                    merged[vid] = { ...(merged[vid] || {}), ...r };
                }
            }
        }
    } catch (e) {
        console.warn('Failed loading progress from Firestore; falling back to local only:', e);
    }

    return merged;
}

async function inferCourseTypeByVideoId(videoId) {
    const vid = String(videoId || '').trim();
    if (!vid) return '';
    try {
        const list = window.syncSharedCourses ? await window.syncSharedCourses() : JSON.parse(localStorage.getItem('courses') || '[]');
        const match = Array.isArray(list) ? list.find(c => String(c?.videoId || '').trim() === vid) : null;
        return match?.type || '';
    } catch (_) {
        return '';
    }
}

async function recordCourseOpened(videoId, title, type) {
    const nowIso = new Date().toISOString();
    const key = String(videoId || '').trim();
    const existingMap = await getAllProgressMap();
    const existing = existingMap[key] || {};
    await upsertCourseProgress(videoId, {
        courseName: String(title || '').trim() || 'Untitled',
        courseType: String(type || '').toLowerCase() || '',
        lastOpenedAt: nowIso,
        startedAt: existing?.startedAt || nowIso
    });
}

function openCoursePlayer(videoId, title, type = '') {
    const overlay = document.getElementById('coursePlayerOverlay');
    const frame = document.getElementById('coursePlayerFrame');
    const titleEl = document.getElementById('coursePlayerTitle');
    const playBtn = document.getElementById('coursePlayerPlay');
    const youtubeLink = document.getElementById('watchOnYouTubeLink');
    const videoIdDisplay = document.getElementById('coursePlayerVideoId');
    
    currentCourseVideoId = videoId;
    currentCourseTitle = title || '';
    currentCourseType = type || '';
    
    if (overlay && frame && titleEl) {
        titleEl.textContent = title || 'Now Playing';
        overlay.style.display = 'flex';
        if (playBtn) playBtn.style.display = 'flex';
        
        // Set YouTube direct link
        if (youtubeLink) {
            youtubeLink.href = `https://www.youtube.com/watch?v=${videoId}`;
        }
        
        // Display Video ID
        if (videoIdDisplay) {
            videoIdDisplay.textContent = videoId;
        }

        // Do not autoplay; wait for explicit play click
        coursePlayerSetAssessmentLock(true);
    }

    // Best-effort progress tracking
    (async () => {
        let courseType = String(currentCourseType || '').trim();
        if (!courseType) courseType = await inferCourseTypeByVideoId(videoId);
        currentCourseType = courseType;
        await recordCourseOpened(videoId, title, courseType);

        // Unlock assessment only if watch is complete
        try {
            const map = await getAllProgressMap();
            const p = map[String(videoId || '').trim()] || {};
            coursePlayerSetAssessmentLock(!(p?.watch?.completed === true));
        } catch (_) {
            coursePlayerSetAssessmentLock(true);
        }
    })();
}

// ===== Catalog Course Assessment Overlay =====
let catalogAssessmentQuestions = [];
let catalogAssessmentIndex = 0;
let catalogAssessmentAnswers = [];
let catalogAssessmentMeta = null; // { videoId, title, type, questionCount }

function courseAssessmentBackdropClick(event) {
    if (event.target && event.target.id === 'courseAssessmentOverlay') closeCourseAssessment();
}

function closeCourseAssessment() {
    const overlay = document.getElementById('courseAssessmentOverlay');
    if (overlay) overlay.style.display = 'none';
    catalogAssessmentQuestions = [];
    catalogAssessmentIndex = 0;
    catalogAssessmentAnswers = [];
    catalogAssessmentMeta = null;
}

function startCatalogAssessmentFromPlayer() {
    const vid = String(currentCourseVideoId || '').trim();
    const title = String(currentCourseTitle || '').trim();
    const type = String(currentCourseType || '').trim();
    if (!vid) {
        alert('No course selected.');
        return;
    }
    startCatalogAssessment(vid, title, type);
}

async function startCatalogAssessment(videoId, title, type = '') {
    const vid = String(videoId || '').trim();
    if (!vid) return;

    // Enforce watch-before-assessment
    const ok = await ensureWatchCompletedOrBlock(vid);
    if (!ok) return;

    let courseType = String(type || '').trim();
    if (!courseType) courseType = await inferCourseTypeByVideoId(vid);
    const qCount = questionCountForType(courseType);

    catalogAssessmentMeta = {
        videoId: vid,
        title: String(title || '').trim() || currentCourseTitle || 'Course',
        type: String(courseType || '').toLowerCase() || 'beginner',
        questionCount: qCount
    };

    const overlay = document.getElementById('courseAssessmentOverlay');
    const titleEl = document.getElementById('courseAssessmentTitle');
    const metaEl = document.getElementById('courseAssessmentMeta');
    const body = document.getElementById('courseAssessmentBody');
    if (!overlay || !titleEl || !metaEl || !body) return;

    titleEl.textContent = `${catalogAssessmentMeta.title} ‚Äî Assessment`;
    metaEl.textContent = `${prettyLevel(catalogAssessmentMeta.type)} ‚Ä¢ ${qCount} questions ‚Ä¢ Pass: 80%`;
    body.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding: 10px;">Generating questions‚Ä¶</div>';
    overlay.style.display = 'flex';

    await generateCatalogAssessmentQuestions();
    renderCatalogAssessmentQuestion();
}

async function generateCatalogAssessmentQuestions() {
    try {
        const meta = catalogAssessmentMeta;
        if (!meta) throw new Error('Missing assessment metadata');

        const prompt = `Generate exactly ${meta.questionCount} multiple-choice questions for a ${prettyLevel(meta.type)} learner based on the course topic "${meta.title}".

Rules:
- Each question must have 4 options labeled A) B) C) D)
- Exactly one correct answer
- Mix practical + conceptual questions
- Keep questions relevant to the course topic

Return ONLY valid JSON array (no markdown):
[{"question":"...","options":["A) ...","B) ...","C) ...","D) ..."],"correctAnswer":"A"}]`;

        const data = await callGeminiAPI(prompt, 'gemini-2.5-flash');
        if (data.error) throw new Error(data.error.message);

        const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const clean = String(textResponse).replace(/```json|```/g, '').trim();
        const match = clean.match(/\[[\s\S]*\]/);
        const jsonStr = match ? match[0] : clean;

        const parsed = JSON.parse(jsonStr);
        if (!Array.isArray(parsed) || parsed.length === 0) throw new Error('Invalid questions format');

        catalogAssessmentQuestions = parsed;
        catalogAssessmentIndex = 0;
        catalogAssessmentAnswers = [];
    } catch (e) {
        console.error('Catalog assessment generation failed:', e);
        const body = document.getElementById('courseAssessmentBody');
        if (body) {
            body.innerHTML = `
                <div style="background:rgba(248,81,73,0.1); border:1px solid #f85149; border-radius:10px; padding:14px;">
                    <div style="color:#f85149; font-weight:800; margin-bottom:6px;">Failed to generate assessment</div>
                    <div style="color:var(--text-main); font-size:13px;">${String(e?.message || e)}</div>
                    <button class="btn-secondary" style="margin-top:12px;" onclick="startCatalogAssessment('${catalogAssessmentMeta?.videoId || ''}', '${String(catalogAssessmentMeta?.title || '').replace(/'/g, "\\'")}', '${catalogAssessmentMeta?.type || ''}')">Try again</button>
                </div>
            `;
        }
    }
}

function renderCatalogAssessmentQuestion() {
    const body = document.getElementById('courseAssessmentBody');
    if (!body) return;
    if (catalogAssessmentIndex >= catalogAssessmentQuestions.length) return;

    const q = catalogAssessmentQuestions[catalogAssessmentIndex];
    const total = catalogAssessmentQuestions.length;

    body.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
            <div style="color:var(--text-secondary);">Question ${catalogAssessmentIndex + 1} of ${total}</div>
            <div style="color:var(--text-secondary); font-size:12px;">Select one option</div>
        </div>
        <div style="background:var(--card-bg); padding:16px; border:1px solid var(--border-color); border-radius:10px; margin-bottom:12px;">
            <div style="color:var(--text-main); font-size:15px; margin-bottom:12px;">${q.question}</div>
            <div>
                ${(Array.isArray(q.options) ? q.options : []).map((opt, idx) => `
                    <div class="quiz-option" onclick="catalogAssessmentSelect(${idx})" data-ca="${idx}">${opt}</div>
                `).join('')}
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            ${catalogAssessmentIndex < total - 1
                ? '<button class="btn-secondary" onclick="catalogAssessmentNext()">Next</button>'
                : '<button class="btn-secondary" onclick="catalogAssessmentSubmit()" style="border-color: rgba(76,175,80,0.7);">Submit</button>'}
        </div>
    `;
}

function catalogAssessmentSelect(optionIndex) {
    document.querySelectorAll('[data-ca]').forEach(el => el.classList.remove('selected'));
    const selected = document.querySelector(`[data-ca="${optionIndex}"]`);
    if (selected) selected.classList.add('selected');
    catalogAssessmentAnswers[catalogAssessmentIndex] = String.fromCharCode(65 + optionIndex);
}

function catalogAssessmentNext() {
    if (!catalogAssessmentAnswers[catalogAssessmentIndex]) {
        alert('Please select an answer before proceeding.');
        return;
    }
    catalogAssessmentIndex++;
    renderCatalogAssessmentQuestion();
}

function catalogAssessmentScore() {
    let correct = 0;
    catalogAssessmentQuestions.forEach((q, idx) => {
        if (catalogAssessmentAnswers[idx] === q.correctAnswer) correct++;
    });
    return correct;
}

async function catalogAssessmentSubmit() {
    if (!catalogAssessmentAnswers[catalogAssessmentIndex]) {
        alert('Please select an answer before submitting.');
        return;
    }

    const correct = catalogAssessmentScore();
    const total = catalogAssessmentQuestions.length;
    const percent = Math.round((correct / total) * 100);
    const passed = percent >= 80;
    const nowIso = new Date().toISOString();
    const meta = catalogAssessmentMeta;

    // Update persisted progress
    const progressPatch = {
        courseName: meta?.title || 'Course',
        courseType: String(meta?.type || '').toLowerCase(),
        lastActivityAt: nowIso,
        ...(passed ? { completedAt: nowIso } : {}),
        assessment: {
            questionCount: total,
            correct,
            percent,
            passed,
            lastAttemptedAt: nowIso
        }
    };

    // Increment attempts
    const existingMap = await getAllProgressMap();
    const existing = existingMap[String(meta?.videoId || '').trim()] || {};
    const attempts = (existing?.assessment?.attempts || existing?.attempts || 0) + 1;
    progressPatch.assessment.attempts = attempts;

    await upsertCourseProgress(meta.videoId, progressPatch);

    // Update leaderboard only when passed
    if (passed) {
        await updateMyLeaderboardPoints();
    }

    const body = document.getElementById('courseAssessmentBody');
    if (body) {
        body.innerHTML = `
            <div style="background:rgba(${passed ? '76,175,80' : '248,81,73'},0.1); border:1px solid ${passed ? '#4CAF50' : '#f85149'}; border-radius:12px; padding:16px;">
                <div style="color:${passed ? '#4CAF50' : '#f85149'}; font-weight:900; font-size:16px; margin-bottom:6px;">${passed ? '‚úì Assessment Passed' : '‚úó Assessment Not Passed'}</div>
                <div style="color:var(--text-main);">Score: <b>${correct}/${total}</b> (${percent}%)</div>
                <div style="color:var(--text-secondary); font-size:12px; margin-top:6px;">Attempts: ${attempts} ‚Ä¢ Saved to My Progress</div>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px; flex-wrap:wrap;">
                    <button class="btn-secondary" onclick="closeCourseAssessment()">Close</button>
                    <button class="btn-secondary" onclick="loadMyProgress(); switchTab('my-progress-view', null)">View My Progress</button>
                </div>
            </div>
            ${renderAssessmentAnswersReviewHtml(catalogAssessmentQuestions, catalogAssessmentAnswers, {
                title: 'Answer Review'
            })}
        `;
    }

    // Soft-refresh progress table if open
    const currentView = document.querySelector('section[style*="display: block"], section[style*="display:block"]');
    if (currentView && currentView.id === 'my-progress-view') {
        loadMyProgress();
    }
}

async function loadLeaderboard() {
    const tbody = document.getElementById('leaderboardTableBody');
    if (!tbody) return;

    const admin = isAdminSession();
    const thView = document.getElementById('leaderboardViewColView');
    if (thView) thView.style.display = admin ? 'table-cell' : 'none';
    tbody.innerHTML = `<tr><td colspan="${admin ? 6 : 5}" style="color:var(--text-secondary);">Loading‚Ä¶</td></tr>`;

    // Ensure current user's points are up-to-date (best effort)
    await updateMyLeaderboardPoints();

    // 1) Load ALL registered users (Role Mgmt source)
    let users = [];
    try {
        if (typeof window.getSharedUsers === 'function') {
            const list = await window.getSharedUsers();
            users = Array.isArray(list) ? list : [];
        }
    } catch (e) {
        console.warn('Failed loading shared users for leaderboard:', e);
    }

    if (!Array.isArray(users) || users.length === 0) {
        // Local fallback (single-device)
        try {
            users = JSON.parse(localStorage.getItem('users') || '[]');
        } catch (_) {
            users = [];
        }
    }

    // Normalize users by email
    const registered = (Array.isArray(users) ? users : [])
        .filter(u => u && u.email)
        .map(u => ({
            email: String(u.email || '').trim().toLowerCase(),
            name: String(u.name || '').trim(),
            employeeId: String(u.employeeId || '').trim()
        }))
        .filter(u => u.email);

    if (registered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${admin ? 6 : 5}" style="color:var(--text-secondary);">No users found in Role Management yet.</td></tr>`;
        return;
    }

    // 2) Load leaderboard points (may be empty). Merge onto registered users.
    let entries = [];
    try {
        if (window.firestoreDB && typeof window.firestoreDB.getLeaderboardEntries === 'function') {
            entries = await window.firestoreDB.getLeaderboardEntries();
        }
    } catch (e) {
        console.warn('Failed loading leaderboard entries:', e);
    }

    const entryByEmail = new Map();
    for (const e of (Array.isArray(entries) ? entries : [])) {
        const email = String(e?.email || e?.id || '').trim().toLowerCase();
        if (!email) continue;
        entryByEmail.set(email, {
            points: Number(e?.points || 0),
            updatedAt: e?.updatedAt || ''
        });
    }

    const merged = registered.map(u => {
        const entry = entryByEmail.get(u.email);
        return {
            email: u.email,
            name: u.name,
            points: entry ? entry.points : 0,
            updatedAt: entry ? entry.updatedAt : ''
        };
    }).sort((a, b) => (b.points - a.points) || a.email.localeCompare(b.email));

    // Tie-aware ranking (dense ranking): 1,1,2,2,3...
    let lastPoints = null;
    let rank = 0;
    tbody.innerHTML = merged.map((e) => {
        if (lastPoints === null || e.points !== lastPoints) {
            rank += 1;
            lastPoints = e.points;
        }
        const last = e.updatedAt ? new Date(e.updatedAt).toLocaleDateString() : '‚Äî';
        const displayName = e.name || (e.email ? e.email.split('@')[0] : 'User');
        const viewBtn = admin
            ? `<button class="btn-secondary" title="View progress" onclick="openEmployeeProgressModal('${String(e.email).replace(/'/g, "\\'")}', '${String(displayName).replace(/'/g, "\\'")}')" style="padding:6px 10px;">üëÅ</button>`
            : '';
        return `
            <tr>
                <td>${rank}</td>
                <td>${displayName}</td>
                <td>${e.email}</td>
                <td><b>${e.points}</b></td>
                <td>${last}</td>
                ${admin ? `<td style="text-align:center;">${viewBtn}</td>` : ''}
            </tr>
        `;
    }).join('');
}

function closeEmployeeProgressModal() {
    const modal = document.getElementById('employeeProgressModal');
    if (modal) modal.style.display = 'none';
    const body = document.getElementById('employeeProgressBody');
    if (body) body.innerHTML = '';
}

async function openEmployeeProgressModal(email, name) {
    if (!isAdminSession()) {
        alert('Only Admins can view employee progress.');
        return;
    }

    const modal = document.getElementById('employeeProgressModal');
    const title = document.getElementById('employeeProgressTitle');
    const sub = document.getElementById('employeeProgressSub');
    const body = document.getElementById('employeeProgressBody');
    if (!modal || !body) return;

    const e = String(email || '').trim();
    const displayName = String(name || '').trim() || (e ? e.split('@')[0] : 'User');
    if (title) title.textContent = `${displayName} ‚Äî Progress`;
    if (sub) sub.textContent = e;
    body.innerHTML = '<div style="color:var(--text-secondary);">Loading‚Ä¶</div>';
    modal.style.display = 'flex';

    try {
        if (!window.firestoreDB || typeof window.firestoreDB.getUserCourses !== 'function') {
            throw new Error('Progress API unavailable');
        }

        const rows = await window.firestoreDB.getUserCourses(e);
        const list = Array.isArray(rows) ? rows : [];

        if (list.length === 0) {
            body.innerHTML = '<div style="color:var(--text-secondary);">No course activity found for this user yet.</div>';
            return;
        }

        const normalized = list.map(r => {
            const startedAt = safeIsoToDate(r?.startedAt || r?.lastOpenedAt);
            const completedAt = safeIsoToDate(r?.completedAt || r?.assessment?.lastAttemptedAt);
            const watchDuration = Number(r?.watch?.durationSeconds || r?.watch?.duration || 0);
            const marks = (typeof r?.assessment?.percent === 'number')
                ? `${r.assessment.percent}%`
                : (r?.assessment?.correct != null && r?.assessment?.questionCount != null)
                    ? `${r.assessment.correct}/${r.assessment.questionCount}`
                    : '‚Äî';
            const passed = !!r?.assessment?.passed;
            const timeTakenSec = (startedAt && completedAt) ? Math.round((completedAt.getTime() - startedAt.getTime()) / 1000) : null;
            const lastActivity = safeIsoToDate(r?.lastActivityAt || r?.assessment?.lastAttemptedAt || r?.lastOpenedAt || r?.updatedAt);
            return {
                courseName: String(r?.courseName || r?.topic || r?.name || r?.videoId || 'Course'),
                videoId: String(r?.videoId || ''),
                level: prettyLevel(r?.courseType || r?.level || ''),
                watchDuration,
                timeTakenSec,
                marks,
                passed,
                lastActivity
            };
        }).sort((a, b) => (b.lastActivity?.getTime?.() || 0) - (a.lastActivity?.getTime?.() || 0));

        body.innerHTML = `
            <table class="admin-table" style="margin-top: 0;">
                <thead>
                    <tr>
                        <th>Course</th>
                        <th style="width:120px;">Level</th>
                        <th style="width:140px;">Duration</th>
                        <th style="width:160px;">Time Taken</th>
                        <th style="width:130px;">Marks</th>
                        <th style="width:140px;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${normalized.map(n => {
                        const durationText = n.watchDuration ? formatSecondsToHms(n.watchDuration) : '‚Äî';
                        const timeTakenText = (n.timeTakenSec != null && n.timeTakenSec >= 0)
                            ? formatSecondsToHms(n.timeTakenSec)
                            : 'In progress';
                        const status = n.passed ? '<span style="color:#4CAF50; font-weight:800;">Passed</span>' : '<span style="color:var(--text-secondary);">In progress</span>';
                        const marks = n.passed ? `<span style="color:#4CAF50; font-weight:800;">${n.marks}</span>` : n.marks;
                        return `
                            <tr>
                                <td>
                                    <div style="color:var(--text-main); font-weight:800;">${n.courseName}</div>
                                    ${n.videoId ? `<div style="color:var(--text-secondary); font-size:11px; font-family:monospace;">${n.videoId}</div>` : ''}
                                </td>
                                <td>${n.level}</td>
                                <td>${durationText}</td>
                                <td>${timeTakenText}</td>
                                <td>${marks}</td>
                                <td>${status}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            <div style="margin-top:10px; color:var(--text-secondary); font-size:12px;">
                Time Taken is measured from first course open to assessment completion.
            </div>
        `;
    } catch (err) {
        body.innerHTML = `<div class="news-item" style="color:#f85149;">‚ö†Ô∏è Error loading progress: ${err && err.message ? err.message : 'Unknown error'}</div>`;
    }
}

async function loadMyProgress() {
    const tbody = document.getElementById('myProgressTableBody');
    if (!tbody) return;

    tbody.innerHTML = '<tr><td colspan="6" style="color:var(--text-secondary);">Loading‚Ä¶</td></tr>';
    const courses = window.syncSharedCourses ? await window.syncSharedCourses() : JSON.parse(localStorage.getItem('courses') || '[]');
    const progressMap = await getAllProgressMap();

    const list = Array.isArray(courses) ? courses : [];
    if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="color:var(--text-secondary);">No courses available.</td></tr>';
        return;
    }

    const rows = list
        .slice()
        .sort((a, b) => String(a?.type || '').localeCompare(String(b?.type || '')) || String(a?.name || '').localeCompare(String(b?.name || '')))
        .map(course => {
            const vid = String(course?.videoId || '').trim();
            const name = String(course?.name || 'Untitled');
            const type = String(course?.type || '').toLowerCase();
            const p = vid ? (progressMap[vid] || {}) : {};

            const assessment = p?.assessment || {};
            const hasOpened = Boolean(p?.lastOpenedAt || p?.startedAt);
            const hasAssessment = typeof assessment?.percent === 'number' || typeof assessment?.correct === 'number';
            const passed = Boolean(assessment?.passed);

            let statusHtml = '';
            if (passed) statusHtml = '<span class="status-badge good">‚úì Passed</span>';
            else if (hasAssessment) statusHtml = '<span class="status-badge warn">üìù Assessment Taken</span>';
            else if (hasOpened) statusHtml = '<span class="status-badge">‚ñ∂ In Progress</span>';
            else statusHtml = '<span class="status-badge bad">‚Ä¢ Not Started</span>';

            const scoreText = hasAssessment
                ? (typeof assessment.percent === 'number'
                    ? `${assessment.percent}%`
                    : `${assessment.correct || 0}/${assessment.questionCount || questionCountForType(type)}`)
                : '‚Äî';

            const lastActivity = p?.lastActivityAt || assessment?.lastAttemptedAt || p?.lastOpenedAt || '';
            const lastDate = lastActivity ? new Date(lastActivity).toLocaleDateString() : '‚Äî';

            const safeName = name.replace(/'/g, "\\'").replace(/\"/g, '&quot;');
            const safeType = String(type).replace(/'/g, "\\'");

            return `
                <tr>
                    <td>${name}</td>
                    <td>${prettyLevel(type)}</td>
                    <td>${statusHtml}</td>
                    <td>${scoreText}</td>
                    <td>${lastDate}</td>
                    <td style="text-align:right;">
                        <button class="btn-secondary" onclick="openCoursePlayer('${vid}', '${safeName}', '${safeType}')">Open</button>
                        <button class="btn-secondary" onclick="startCatalogAssessment('${vid}', '${safeName}', '${safeType}')">${hasAssessment ? 'Retake' : 'Assessment'}</button>
                    </td>
                </tr>
            `;
        });

    tbody.innerHTML = rows.join('');
}

// ===== User Management JS =====
function openAddUserModal() {
    const modal = document.getElementById('addUserModal');
    if (modal) modal.style.display = 'flex';
}
function closeAddUserModal() {
    const modal = document.getElementById('addUserModal');
    if (modal) modal.style.display = 'none';
}

function loadUsers() {
    const tbody = document.getElementById('userMgmtTableBody');
    if (!tbody) return;
    
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    // Prefer Firestore-backed shared users list
    const users = (window.getSharedUsers ? [] : null);
    
    tbody.innerHTML = '';
    const render = (list) => {
        tbody.innerHTML = '';
        list.forEach((u) => {
        const isSuperadmin = u.email && u.email.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase();
        
        const row = tbody.insertRow();
        row.insertCell(0).innerText = u.employeeId || '';
        row.insertCell(1).innerText = u.name || '';
        row.insertCell(2).innerText = u.email || '';
        const roleCell = row.insertCell(3);
        
        if (isSuperadmin) {
            // For superadmin, show locked Admin role with special styling
            roleCell.innerHTML = `<div style="padding:6px; background:rgba(66,133,244,0.1); color:var(--primary-blue); border:1px solid var(--primary-blue); border-radius:6px; font-weight:bold; display:flex; align-items:center; gap:5px;">
                <span>üîí Admin (Superadmin)</span>
            </div>`;
        } else {
            const safeEmail = String(u.email || '').replace(/'/g, "\\'");
            roleCell.innerHTML = `<select onchange="handleRoleChange('${safeEmail}', this.value)" style="padding:6px; background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); border-radius:6px;">
                <option value="User" ${u.role === 'User' ? 'selected' : ''}>User</option>
                <option value="Admin" ${u.role === 'Admin' ? 'selected' : ''}>Admin</option>
            </select>`;
        }
        
        row.insertCell(4).innerText = u.lastActive || '';
        });
    };

    if (window.getSharedUsers) {
        // Async render from cloud
        window.getSharedUsers()
            .then(list => render(Array.isArray(list) ? list : []))
            .catch(() => render(JSON.parse(localStorage.getItem('users') || '[]')));
        return;
    }

    render(JSON.parse(localStorage.getItem('users') || '[]'));
}

async function saveNewUser() {
    const employeeId = document.getElementById('newEmpId').value.trim();
    const name = document.getElementById('newEmpName').value.trim();
    const email = document.getElementById('newEmpEmail').value.trim();
    const role = document.getElementById('newEmpRole').value;
    if (!employeeId || !name || !email) {
        alert('Please fill in Employee ID, Name, and Email');
        return;
    }
    if (window.upsertSharedUser) {
        try {
            await window.upsertSharedUser({ employeeId, name, email, role, lastActive: '' });
            closeAddUserModal();
            Promise.resolve(loadUsers()).catch(() => {});
            Promise.resolve(loadRoles()).catch(() => {});
            syncCurrentUserRole();
            checkAdminStatus();
            return;
        } catch (e) {
            console.warn('Cloud save user failed; falling back to local', e);
        }
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    users.push({ employeeId, name, email, role, lastActive: '' });
    localStorage.setItem('users', JSON.stringify(users));
    closeAddUserModal();
    loadUsers();
    // In case the added user is the current session user, sync the role
    syncCurrentUserRole();
    checkAdminStatus();
}

async function handleRoleChange(userEmail, value) {
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const normalizedEmail = String(userEmail || '').trim().toLowerCase();
    if (!normalizedEmail) return;
    
    // Prevent changing superadmin role
    if (normalizedEmail === SUPERADMIN_EMAIL.toLowerCase()) {
        alert('‚ö†Ô∏è Cannot change the role of the Superadmin!\n\nravikiran@oneorigin.us always has Admin access.');
        loadUsers(); // Reload to reset the dropdown
        return;
    }

    const usersLocal = JSON.parse(localStorage.getItem('users') || '[]');
    const localMatch = usersLocal.find(u => (u.email || '').toLowerCase() === normalizedEmail);
    const oldRole = localMatch?.role || 'User';
    const employeeName = localMatch?.name || normalizedEmail;
    
    // Show confirmation dialog
    if (!confirm(`Are you sure you want to change ${employeeName}'s role from ${oldRole} to ${value}?`)) {
        // Best-effort: refresh tables to restore correct values
        Promise.resolve(loadUsers()).catch(() => {});
        Promise.resolve(loadRoles()).catch(() => {});
        return;
    }

    // Cloud-first role update
    if (window.updateSharedUserRoleByEmail) {
        try {
            await window.updateSharedUserRoleByEmail(normalizedEmail, value);
        } catch (e) {
            console.warn('Cloud role update failed; falling back to local', e);
            const idx = usersLocal.findIndex(u => (u.email || '').toLowerCase() === normalizedEmail);
            if (idx !== -1) {
                usersLocal[idx].role = value;
                localStorage.setItem('users', JSON.stringify(usersLocal));
                sessionStorage.setItem('users_backup', JSON.stringify(usersLocal));
            }
        }
    } else {
        const idx = usersLocal.findIndex(u => (u.email || '').toLowerCase() === normalizedEmail);
        if (idx !== -1) {
            usersLocal[idx].role = value;
            localStorage.setItem('users', JSON.stringify(usersLocal));
            sessionStorage.setItem('users_backup', JSON.stringify(usersLocal));
        }
    }

    // If the changed user is the current session user, sync and reload page
    const currentEmail = (localStorage.getItem('userEmail') || '').toLowerCase();
    if (currentEmail && currentEmail === normalizedEmail) {
        localStorage.setItem('userRole', String(value).toLowerCase() === 'admin' ? 'admin' : 'user');
        checkAdminStatus();
        alert(`Your role has been changed to ${value}. The page will reload to apply changes.`);
        setTimeout(() => location.reload(), 500);
        return;
    }

    syncCurrentUserRole();
    checkAdminStatus();
    Promise.resolve(loadUsers()).catch(() => {});
    Promise.resolve(loadRoles()).catch(() => {});
}

// ===== Role Management JS =====
function openAddRoleModal() {
    const modal = document.getElementById('addRoleModal');
    const select = document.getElementById('newRoleCourse');
    populateCourseOptions(select);
    if (modal) modal.style.display = 'flex';
}

function closeAddRoleModal() {
    const modal = document.getElementById('addRoleModal');
    if (modal) modal.style.display = 'none';
}

function populateCourseOptions(selectEl, selectedId = '') {
    if (!selectEl) return;
    const courses = JSON.parse(localStorage.getItem('courses') || '[]');
    selectEl.innerHTML = '';
    if (courses.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No courses available';
        selectEl.appendChild(opt);
        selectEl.disabled = true;
        return;
    }
    selectEl.disabled = false;
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Select a course';
    selectEl.appendChild(placeholder);
    let matched = false;
    courses.forEach(course => {
        const opt = document.createElement('option');
        opt.value = String(course.id);
        opt.textContent = `${course.name} (${course.type})`;
        if (String(course.id) === String(selectedId)) {
            opt.selected = true;
            matched = true;
        }
        selectEl.appendChild(opt);
    });
    if (selectedId && !matched) {
        const missing = document.createElement('option');
        missing.value = String(selectedId);
        missing.textContent = `Missing course (ID: ${selectedId})`;
        missing.selected = true;
        selectEl.appendChild(missing);
    }
}

function loadRoles() {
    const tbody = document.getElementById('roleMgmtTableBody');
    if (!tbody) return;
    
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const render = (users) => {
        tbody.innerHTML = '';
        if (!Array.isArray(users) || users.length === 0) {
            const row = tbody.insertRow();
            const cell = row.insertCell(0);
            cell.colSpan = 8;
            cell.style.color = 'var(--text-secondary)';
            cell.style.textAlign = 'center';
            cell.innerText = 'No users found. Users will be automatically registered when they log in.';
            return;
        }
        users.forEach((u) => {
            const isSuperadmin = u.email && u.email.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase();
            const safeEmail = String(u.email || '').replace(/'/g, "\\'");

            const row = tbody.insertRow();
            const selectCell = row.insertCell(0);
            selectCell.style.textAlign = 'center';
            selectCell.innerHTML = `<input type="checkbox" class="role-row-check" data-email="${String(u.email || '').replace(/"/g, '&quot;')}">`;

            row.insertCell(1).innerText = u.employeeId || '';
            row.insertCell(2).innerText = u.name || '';
            row.insertCell(3).innerText = u.email || '';

            const roleCell = row.insertCell(4);
            if (isSuperadmin) {
                roleCell.innerHTML = `<div style="padding:6px; background:rgba(66,133,244,0.1); color:var(--primary-blue); border:1px solid var(--primary-blue); border-radius:6px; font-weight:bold; display:flex; align-items:center; gap:5px; justify-content:center;">
                    <span>üîí Admin (Superadmin)</span>
                </div>`;
            } else {
                roleCell.innerHTML = `<select onchange="handleRoleChange('${safeEmail}', this.value)" style="padding:6px; background:var(--bg-dark); color:var(--text-main); border:1px solid var(--border-color); border-radius:6px;">
                    <option value="User" ${u.role === 'User' ? 'selected' : ''}>User</option>
                    <option value="Admin" ${u.role === 'Admin' ? 'selected' : ''}>Admin</option>
                </select>`;
            }

            row.insertCell(5).innerText = u.lastActive || '';

            const resetCell = row.insertCell(6);
            resetCell.innerHTML = '<button style="background:#f0ad4e; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:bold;" onclick="resetUserAssessment(\'' + safeEmail + '\')" title="Reset this user\'s assessment and assigned courses">üîÑ Reset</button>';

            const deleteCell = row.insertCell(7);
            if (isSuperadmin) {
                deleteCell.innerHTML = '<div style="padding:5px 10px; color:var(--text-secondary); font-size:12px; text-align:center;">Protected</div>';
            } else {
                deleteCell.innerHTML = '<button style="background:#f85149; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;" onclick="deleteRole(\'' + safeEmail + '\')">Delete</button>';
            }
        });
    };
    
    if (window.getSharedUsers) {
        window.getSharedUsers()
            .then(list => render(Array.isArray(list) ? list : []))
            .catch(() => render(JSON.parse(localStorage.getItem('users') || '[]')));
        return;
    }

    render(JSON.parse(localStorage.getItem('users') || '[]'));
}

function saveNewRole() {
    // Repurpose: add user via existing Add User modal
    openAddUserModal();
}

async function deleteRole(userEmail) {
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const normalizedEmail = String(userEmail || '').trim().toLowerCase();
    if (!normalizedEmail) return;
    
    // Prevent deleting superadmin
    if (normalizedEmail === SUPERADMIN_EMAIL.toLowerCase()) {
        alert('‚ö†Ô∏è Cannot delete the Superadmin!\n\nravikiran@oneorigin.us is a permanent admin.');
        return;
    }
    
    if (!confirm('Delete this user?')) return;

    if (window.deleteSharedUserByEmail) {
        try {
            await window.deleteSharedUserByEmail(normalizedEmail);
            Promise.resolve(loadUsers()).catch(() => {});
            Promise.resolve(loadRoles()).catch(() => {});
            checkAdminStatus();
            return;
        } catch (e) {
            console.warn('Cloud delete failed; falling back to local', e);
        }
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const idx = users.findIndex(u => (u.email || '').toLowerCase() === normalizedEmail);
    if (idx !== -1) {
        users.splice(idx, 1);
        localStorage.setItem('users', JSON.stringify(users));
        sessionStorage.setItem('users_backup', JSON.stringify(users));
    }
    loadUsers();
    loadRoles();
    checkAdminStatus();
}

function deleteSelectedRoles() {
    const checks = Array.from(document.querySelectorAll('.role-row-check'));
    const selectedEmails = checks
        .filter(c => c.checked)
        .map(c => String(c.dataset.email || '').trim().toLowerCase())
        .filter(Boolean);
    if (selectedEmails.length === 0) {
        alert('Select at least one entry to delete.');
        return;
    }
    
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const superadminSelected = selectedEmails.some(e => e === SUPERADMIN_EMAIL.toLowerCase());
    
    if (superadminSelected) {
        alert('‚ö†Ô∏è Cannot delete the Superadmin!\n\nravikiran@oneorigin.us cannot be removed.\nPlease deselect and try again.');
        return;
    }
    
    if (!confirm(`Delete ${selectedEmails.length} user(s)?`)) return;

    if (window.deleteSharedUserByEmail) {
        Promise.all(selectedEmails.map(e => window.deleteSharedUserByEmail(e)))
            .then(() => {
                const selectAll = document.getElementById('roleSelectAll');
                if (selectAll) selectAll.checked = false;
                Promise.resolve(loadUsers()).catch(() => {});
                Promise.resolve(loadRoles()).catch(() => {});
                checkAdminStatus();
            })
            .catch(err => {
                console.warn('Cloud bulk delete failed; falling back to local', err);
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const remaining = users.filter(u => !selectedEmails.includes(String(u.email || '').toLowerCase()));
                localStorage.setItem('users', JSON.stringify(remaining));
                const selectAll = document.getElementById('roleSelectAll');
                if (selectAll) selectAll.checked = false;
                loadUsers();
                loadRoles();
                checkAdminStatus();
            });
        return;
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const remaining = users.filter(u => !selectedEmails.includes(String(u.email || '').toLowerCase()));
    localStorage.setItem('users', JSON.stringify(remaining));
    const selectAll = document.getElementById('roleSelectAll');
    if (selectAll) selectAll.checked = false;
    loadUsers();
    loadRoles();
    checkAdminStatus();
}

function toggleSelectAllRoles(master) {
    const checks = document.querySelectorAll('.role-row-check');
    checks.forEach(c => c.checked = master.checked);
}

function toggleAllRoleChecks(isChecked) {
    const checks = document.querySelectorAll('.role-row-check');
    checks.forEach(c => c.checked = isChecked);
}

async function resetUserAssessment(userEmail) {
    if (!userEmail) {
        alert('Invalid user email');
        return;
    }

    const normalizedEmail = String(userEmail).trim().toLowerCase();
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => u.email && u.email.toLowerCase() === normalizedEmail) || { name: normalizedEmail };
    
    const confirmMsg = `Reset assessment for ${user.name}?

This will:
‚úì Clear their initial assessment score and level
‚úì Remove all assigned courses
‚úì Allow them to retake the assessment

Are you sure?`;
    
    if (!confirm(confirmMsg)) return;
    
    // Check if this is the current user
    const currentUserEmail = localStorage.getItem('userEmail') || '';
    const isCurrentUser = currentUserEmail.toLowerCase() === normalizedEmail;
    
    if (isCurrentUser) {
        // Reset current user's data in localStorage
        localStorage.removeItem('initialAssessmentScore');
        localStorage.removeItem('userLevel');
        localStorage.removeItem('initialAssessmentStarted');
        localStorage.setItem('assignedCourses', '[]');
        localStorage.removeItem('upcomingCourse');
        
        if (window.setUserResetAssessmentFlag) {
            try { await window.setUserResetAssessmentFlag(normalizedEmail, false); } catch (_) {}
        }

        try {
            updateInitialAssessmentStatus();
            loadAssignedCourses();
        } catch (_) {}

        alert(`Assessment reset successfully for ${user.name}!\n\nYou can now retake the assessment.`);
    } else {
        // For other users, set a cloud flag so it applies on their device
        if (window.setUserResetAssessmentFlag) {
            try {
                await window.setUserResetAssessmentFlag(normalizedEmail, true);
                alert(`Assessment reset queued for ${user.name}!\n\nIt will apply when they next log in or load the dashboard.`);
                return;
            } catch (e) {
                console.warn('Cloud reset flag failed; falling back to local', e);
            }
        }

        const userIndex = users.findIndex(u => u.email && u.email.toLowerCase() === normalizedEmail);
        if (userIndex !== -1) {
            users[userIndex].resetAssessmentFlag = true;
            localStorage.setItem('users', JSON.stringify(users));
        }
        alert(`Assessment reset queued for ${user.name}!\n\n(Local-only fallback; may not work across devices.)`);
    }
    
    console.log('Assessment reset for user:', userEmail);
}

function handleRoleCSVUpload(event) {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
        try {
            const text = String(reader.result || '').trim();
            const lines = text.split(/\r?\n/).filter(l => l.trim().length);
            if (lines.length < 2) throw new Error('CSV has no data');
            // Support comma or tab separated headers
            const splitRow = (row) => row.split(/[\t,]/).map(h => h.trim());
            const header = splitRow(lines[0]);
            const expected = ['Employee ID','Employee name','Email ID','Role'];
            const matches = expected.every((h, i) => (header[i] || '').toLowerCase() === h.toLowerCase());
            if (!matches) throw new Error('Invalid CSV header. Expected: ' + expected.join(', '));

            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = splitRow(lines[i]).map(c => c.replace(/^\"|\"$/g, ''));
                if (cols.length < 4) continue;
                const [employeeId, name, email, role] = cols;
                rows.push({ employeeId, name, email, role, lastActive: '' });
            }

            if (window.upsertSharedUser) {
                await Promise.all(rows.map(r => window.upsertSharedUser(r)));
            } else {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                rows.forEach(r => users.push(r));
                localStorage.setItem('users', JSON.stringify(users));
            }

            Promise.resolve(loadUsers()).catch(() => {});
            Promise.resolve(loadRoles()).catch(() => {});
            syncCurrentUserRole();
            checkAdminStatus();
            alert('Users uploaded successfully');
        } catch (err) {
            alert('CSV upload failed: ' + err.message);
        }
        event.target.value = '';
    };
    reader.onerror = () => alert('Failed reading file');
    reader.readAsText(file);
}

function handleCSVUpload(event) {
    const file = event.target.files && event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async () => {
        try {
            const text = reader.result;
            const lines = String(text).trim().split(/\r?\n/);
            if (lines.length < 2) throw new Error('CSV has no data');
            const header = lines[0].split(',').map(h => h.trim());
            const expected = ['Employee ID','Employee name','Email ID','Role','Last active date&time'];
            const matches = expected.every((h, i) => (header[i] || '').toLowerCase() === h.toLowerCase());
            if (!matches) throw new Error('Invalid CSV header. Expected: ' + expected.join(', '));

            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                if (cols.length < 5) continue;
                const [employeeId, name, email, role, lastActive] = cols;
                rows.push({ employeeId, name, email, role, lastActive: lastActive || '' });
            }

            if (window.upsertSharedUser) {
                await Promise.all(rows.map(r => window.upsertSharedUser(r)));
            } else {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                rows.forEach(r => users.push(r));
                localStorage.setItem('users', JSON.stringify(users));
            }

            Promise.resolve(loadUsers()).catch(() => {});
            alert('Users uploaded successfully');
            // After bulk upload, ensure session role is synced
            syncCurrentUserRole();
            checkAdminStatus();
        } catch (err) {
            alert('CSV upload failed: ' + err.message);
        }
        event.target.value = '';
    };
    reader.onerror = () => alert('Failed reading file');
    reader.readAsText(file);
}

let __ytApiPromise = null;
let __coursePlayer = null;
let __coursePlayerTick = null;
let __courseWatch = { videoId: '', maxSeconds: 0, durationSeconds: 0, completed: false };

function loadYouTubeIFrameApiOnce() {
    if (__ytApiPromise) return __ytApiPromise;
    __ytApiPromise = new Promise((resolve, reject) => {
        if (window.YT && window.YT.Player) {
            resolve();
            return;
        }
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        tag.async = true;
        tag.onerror = () => reject(new Error('Failed loading YouTube API'));
        document.head.appendChild(tag);
        const prev = window.onYouTubeIframeAPIReady;
        window.onYouTubeIframeAPIReady = () => {
            try { if (typeof prev === 'function') prev(); } catch (_) {}
            resolve();
        };
    });
    return __ytApiPromise;
}

function stopCoursePlayerTick() {
    if (__coursePlayerTick) {
        clearInterval(__coursePlayerTick);
        __coursePlayerTick = null;
    }
}

async function startCoursePlayer(auto = false) {
    const container = document.getElementById('coursePlayerFrame');
    const playBtn = document.getElementById('coursePlayerPlay');
    if (!container) return;

    const hasValidId = currentCourseVideoId && String(currentCourseVideoId).trim().length === 11;
    if (!hasValidId) {
        alert('Invalid course video.');
        return;
    }

    await loadYouTubeIFrameApiOnce();

    __courseWatch = { videoId: String(currentCourseVideoId).trim(), maxSeconds: 0, durationSeconds: 0, completed: false };
    coursePlayerSetAssessmentLock(true);

    const onEnded = async () => {
        stopCoursePlayerTick();
        __courseWatch.completed = true;
        const nowIso = new Date().toISOString();
        await upsertCourseProgress(__courseWatch.videoId, {
            lastActivityAt: nowIso,
            watch: {
                ...(typeof __courseWatch.durationSeconds === 'number' && __courseWatch.durationSeconds > 0 ? { durationSeconds: __courseWatch.durationSeconds } : {}),
                completed: true,
                completedAt: nowIso,
                maxSeconds: __courseWatch.maxSeconds
            }
        });
        coursePlayerSetAssessmentLock(false);
    };

    const startTick = () => {
        stopCoursePlayerTick();
        __coursePlayerTick = setInterval(async () => {
            try {
                if (!__coursePlayer || typeof __coursePlayer.getCurrentTime !== 'function') return;
                const t = Number(__coursePlayer.getCurrentTime() || 0);
                const dur = Number(__coursePlayer.getDuration?.() || 0);
                if (dur > 0) __courseWatch.durationSeconds = dur;

                // Anti-skip: prevent large forward jumps
                if (__courseWatch.maxSeconds > 0 && t > (__courseWatch.maxSeconds + 8)) {
                    __coursePlayer.seekTo(__courseWatch.maxSeconds, true);
                    return;
                }

                if (t > __courseWatch.maxSeconds) __courseWatch.maxSeconds = t;

                // Consider completed when max watched time reaches end
                if (!__courseWatch.completed && dur > 0 && __courseWatch.maxSeconds >= (dur - 3)) {
                    await onEnded();
                } else {
                    // Periodically persist duration/max progress (best-effort)
                    if (dur > 0 && Math.floor(t) % 20 === 0) {
                        await upsertCourseProgress(__courseWatch.videoId, {
                            watch: {
                                durationSeconds: dur,
                                maxSeconds: __courseWatch.maxSeconds,
                                completed: false
                            }
                        });
                    }
                }
            } catch (_) {}
        }, 1000);
    };

    if (!__coursePlayer) {
        __coursePlayer = new window.YT.Player('coursePlayerFrame', {
            videoId: __courseWatch.videoId,
            playerVars: { autoplay: 1, rel: 0, modestbranding: 1, playsinline: 1 },
            events: {
                onReady: async () => {
                    try {
                        const dur = Number(__coursePlayer.getDuration?.() || 0);
                        if (dur > 0) {
                            __courseWatch.durationSeconds = dur;
                            await upsertCourseProgress(__courseWatch.videoId, { watch: { durationSeconds: dur } });
                        }
                    } catch (_) {}
                    try { __coursePlayer.playVideo?.(); } catch (_) {}
                },
                onStateChange: async (ev) => {
                    if (!ev) return;
                    if (ev.data === 0) {
                        await onEnded();
                    } else if (ev.data === 1) {
                        startTick();
                    } else if (ev.data === 2) {
                        stopCoursePlayerTick();
                    }
                }
            }
        });
    } else {
        try {
            __coursePlayer.loadVideoById(__courseWatch.videoId);
        } catch (_) {
            try { __coursePlayer.destroy?.(); } catch (_) {}
            __coursePlayer = null;
            return startCoursePlayer(auto);
        }
    }

    if (playBtn) playBtn.style.display = 'none';
}

function closeCoursePlayer() {
    const overlay = document.getElementById('coursePlayerOverlay');
    const playBtn = document.getElementById('coursePlayerPlay');
    stopCoursePlayerTick();
    try { __coursePlayer?.stopVideo?.(); } catch (_) {}
    if (overlay) overlay.style.display = 'none';
    if (playBtn) playBtn.style.display = 'flex';
    currentCourseVideoId = '';
    coursePlayerSetAssessmentLock(true);
}

function overlayBackdropClick(event) {
    if (event.target.id === 'coursePlayerOverlay') {
        closeCoursePlayer();
    }
}

async function loadCoursesView(searchTerm = '') {
    // Sync shared courses from API first so all users see the same courses
    console.log('üîÑ loadCoursesView called with searchTerm:', searchTerm);
    const courses = await syncSharedCourses();
    
    console.log('üìä Loading courses view, found', courses.length, 'courses:', courses);
    
    const sections = {
        beginner: document.querySelector('#beginner-courses .type-grid'),
        intermediate: document.querySelector('#intermediate-courses .type-grid'),
        advanced: document.querySelector('#advanced-courses .type-grid')
    };
    
    // Check if sections exist
    if (!sections.beginner || !sections.intermediate || !sections.advanced) {
        console.error('Course sections not found in DOM');
        return;
    }
    
    // Clear
    Object.values(sections).forEach(grid => {
        if (grid) grid.innerHTML = '';
    });
    
    const term = searchTerm.trim().toLowerCase();
    const matchesTerm = (name) => {
        if (!term) return true;
        const words = name.toLowerCase().split(/\s+/);
        return words.some(w => w.startsWith(term));
    };
    
    let displayedCount = 0;
    courses
        .filter(course => matchesTerm(course.name))
        .forEach(course => {
        const card = document.createElement('div');
        card.className = 'course-card';
        const safeName = String(course.name || '').replace(/'/g, "\\'").replace(/\"/g, '&quot;');
        const safeType = String(course.type || '').replace(/'/g, "\\'");
        card.innerHTML = `
            <div onclick="openCoursePlayer('${course.videoId}', '${safeName}', '${safeType}')">
                <img src="https://img.youtube.com/vi/${course.videoId}/hqdefault.jpg" alt="${course.name}" style="width: 100%; height: auto; border-radius:8px; margin-bottom: 10px; display: block;">
            </div>
            <p style="margin:10px 0 5px 0; text-align:center; color:var(--text-main); font-weight:500;">${course.name}</p>
            <small style="color:var(--text-secondary); text-align:center; display:block;">Uploaded: ${course.uploadDate}</small>
            <small style="color:var(--text-secondary); text-align:center; display:block;">Uploaded by: Admin</small>
            <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
                <button class="btn-secondary" onclick="event.stopPropagation(); openCoursePlayer('${course.videoId}', '${safeName}', '${safeType}')">Open</button>
                <button class="btn-secondary" onclick="event.stopPropagation(); startCatalogAssessment('${course.videoId}', '${safeName}', '${safeType}')">Assessment</button>
            </div>
        `;
        const targetSection = sections[course.type];
        if (targetSection) {
            targetSection.appendChild(card);
            displayedCount++;
        } else {
            console.warn('No section found for course type:', course.type);
        }
    });
    
    console.log('Displayed', displayedCount, 'courses in the view');
}

// Note: All initialization moved to window.onload above to avoid conflicts

function checkAdminStatus() {
    // Check if user is admin (includes both Superadmin and regular Admin)
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';
    const userEmail = localStorage.getItem('userEmail') || '';
    const userRole = (localStorage.getItem('userRole') || '').toLowerCase();
    const isSuperadmin = userEmail.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase();
    const isAdmin = userRole === 'admin' || isSuperadmin;
    
    console.log('Admin check - Email:', userEmail, 'Role:', userRole, 'Is Admin:', isAdmin);
    
    // Admin Refresh News Button - Admin only
    const refreshBtn = document.getElementById('adminRefreshNewsBtn');
    if (refreshBtn) {
        refreshBtn.style.display = isAdmin ? 'block' : 'none';
    }
    
    // User Management Sidebar - Admin only
    const userMgmtItem = document.getElementById('userMgmtSidebarItem');
    if (userMgmtItem) {
        userMgmtItem.style.display = isAdmin ? 'block' : 'none';
    }
    
    // Role Management Sidebar - Admin only
    const roleMgmtItem = document.getElementById('roleMgmtSidebarItem');
    if (roleMgmtItem) {
        roleMgmtItem.style.display = isAdmin ? 'block' : 'none';
    }
    
    // Course Management Sidebar - Admin only
    const courseMgmtItem = document.getElementById('courseMgmtSidebarItem');
    if (courseMgmtItem) {
        courseMgmtItem.style.display = isAdmin ? 'block' : 'none';
    }

    // Clear All Courses button - Admin only
    const clearAllCoursesBtn = document.getElementById('clearAllCoursesBtn');
    if (clearAllCoursesBtn) {
        const alreadyCleared = localStorage.getItem('one_time_courses_cleared') === 'true';
        clearAllCoursesBtn.style.display = (isAdmin && !alreadyCleared) ? 'inline-block' : 'none';
    }
    
    // Reset All button - Admin only
    const resetAllBtn = document.getElementById('resetAllAssessmentsBtn');
    if (resetAllBtn) {
        resetAllBtn.style.display = isAdmin ? 'block' : 'none';
    }
    
    // If non-admin tries to view admin sections, redirect to home
    if (!isAdmin) {
        const currentView = document.querySelector('section[style*="display: block"], section[style*="display:block"]');
        if (currentView) {
            const viewId = currentView.id;
            if (viewId === 'admin-view' || viewId === 'role-mgmt-view' || viewId === 'course-mgmt-view') {
                switchTab('home-view', null);
            }
        }
    }
}

async function clearAllCoursesOneTime() {
    const isAdmin = (localStorage.getItem('userRole') || '').toLowerCase() === 'admin' || (localStorage.getItem('userEmail') || '').toLowerCase() === 'ravikiran@oneorigin.us';
    if (!isAdmin) {
        alert('Only Admin can clear courses.');
        return;
    }

    const alreadyCleared = localStorage.getItem('one_time_courses_cleared') === 'true';
    if (alreadyCleared) {
        alert('Courses were already cleared once.');
        return;
    }

    const typed = prompt('This will permanently delete ALL courses for ALL users (database + local).\n\nType CLEAR ALL to continue:');
    if (String(typed || '').trim().toUpperCase() !== 'CLEAR ALL') {
        alert('Cancelled.');
        return;
    }

    try {
        if (window.deleteAllSharedCourses) {
            await window.deleteAllSharedCourses();
        } else {
            // Fallback: clear local only
            localStorage.setItem('courses', '[]');
        }

        // Prevent restore from sessionStorage backup
        try { sessionStorage.removeItem('courses_backup'); } catch (_) {}

        localStorage.setItem('one_time_courses_cleared', 'true');
        const btn = document.getElementById('clearAllCoursesBtn');
        if (btn) btn.style.display = 'none';

        await loadCourses();
        await loadCoursesView();
        if (typeof loadRoles === 'function') loadRoles();
        alert('All courses cleared successfully.');
    } catch (e) {
        console.error('Failed clearing all courses:', e);
        alert('Failed to clear all courses: ' + (e?.message || e));
    }
}

async function syncCurrentUserRole() {
    const currentName = (localStorage.getItem('userName') || '').trim();
    const currentEmail = (localStorage.getItem('userEmail') || '').trim();
    const SUPERADMIN_EMAIL = 'ravikiran@oneorigin.us';

    // Superadmin always admin
    if (currentEmail.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase()) {
        localStorage.setItem('userRole', 'admin');
        return;
    }

    // Prefer cloud role
    try {
        if (window.getSharedUserByEmail) {
            const me = await window.getSharedUserByEmail(currentEmail);
            if (me?.role) {
                localStorage.setItem('userRole', String(me.role).toLowerCase() === 'admin' ? 'admin' : 'user');
                return;
            }
        }
    } catch (e) {
        console.warn('Cloud role lookup failed; using local fallback', e);
    }

    // Local fallback
    try {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const match = users.find(u =>
            (u.email && currentEmail && u.email.toLowerCase() === currentEmail.toLowerCase()) ||
            (u.name && currentName && u.name.toLowerCase() === currentName.toLowerCase())
        );
        if (match && match.role) {
            localStorage.setItem('userRole', String(match.role).toLowerCase());
        } else {
            localStorage.setItem('userRole', 'user');
        }
    } catch (_) {
        localStorage.setItem('userRole', 'user');
    }
}

function forceRefreshNews() {
    if (confirm('This will refresh the AI news for all users. Continue?')) {
        // Best-effort cleanup of old cached keys (news is now always fetched fresh)
        localStorage.removeItem('aiNews');
        localStorage.removeItem('aiNewsTimestamp');
        localStorage.removeItem('aiUpdates');
        localStorage.removeItem('aiUpdatesTimestamp');
        // Fetch fresh news (no cache)
        fetchAINews();
        fetchAIUpdates();
        alert('News refreshed successfully! All users will see the updated news.');
    }
}

function logout() {
    // Clear only session identifiers; keep all persisted data (users, roles, courses, news, etc.)
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userName');
    localStorage.removeItem('userRole');
    // Redirect to login page
    window.location.href = 'index.html';
}

// ============ Measure & Master Functions ============
let assessmentQuestions = [];
let currentQuestionIndex = 0;
let userAnswers = [];
let currentAssessmentType = 'initial'; // 'initial' or 'video'
let currentVideoAssessmentCourse = null;

async function startInitialAssessment() {
    document.getElementById('initialAssessmentContainer').style.display = 'none';
    document.getElementById('assessmentQuizContainer').innerHTML = '<p style="text-align:center; color:var(--text-secondary);">Generating personalized questions...</p>';
    document.getElementById('assessmentQuizContainer').style.display = 'block';
    
    currentAssessmentType = 'initial';
    // Mark assessment as started to hide the announcement
    localStorage.setItem('initialAssessmentStarted', 'true');
    if (typeof updateAnnouncements === 'function') updateAnnouncements();
    await generateQuestions();
    displayQuestion();
}

async function generateQuestions() {
    try {
        const prompt = currentAssessmentType === 'initial' 
            ? `Generate exactly 20 multiple-choice questions covering Web Development, Large Language Models (LLMs), Transformers, OCR tools, Artificial Intelligence, Machine Learning, and related technologies. Each question should have 4 options with only one correct answer. Return a JSON array with this exact structure: [{"question": "...", "options": ["A) ...", "B) ...", "C) ...", "D) ..."], "correctAnswer": "A"}]. Make questions challenging and practical.`
            : `Based on the video topic "${currentVideoAssessmentCourse.topic}", generate exactly 10 multiple-choice questions that test understanding of the concepts covered. Each question should have 4 options with only one correct answer. Return a JSON array with this exact structure: [{"question": "...", "options": ["A) ...", "B) ...", "C) ...", "D) ..."], "correctAnswer": "A"}]. Focus on key concepts, definitions, and applications.`;

        const data = await callGeminiAPI(prompt, 'gemini-2.5-flash');
        if (data.error) throw new Error(data.error.message);

        let textResponse = data.candidates[0].content.parts[0].text;
        const cleanJson = textResponse.replace(/```json|```/g, "").trim();
        assessmentQuestions = JSON.parse(cleanJson);
        currentQuestionIndex = 0;
        userAnswers = [];
    } catch (error) {
        console.error("Question generation error:", error);
        alert("Failed to generate questions. Please try again.");
    }
}

function displayQuestion() {
    if (currentQuestionIndex >= assessmentQuestions.length) return;

    const q = assessmentQuestions[currentQuestionIndex];
    const container = document.getElementById('assessmentQuizContainer');
    
    container.innerHTML = `
        <div id="quizProgress" style="color:var(--text-secondary); margin-bottom:15px;">Question ${currentQuestionIndex + 1} of ${assessmentQuestions.length}</div>
        <div id="quizQuestion" style="background:var(--card-bg); padding:20px; border:1px solid var(--border-color); border-radius:8px; margin-bottom:20px;">
            <h3 id="questionText" style="color:var(--text-main); margin-bottom:15px;">${q.question}</h3>
            <div id="optionsContainer">
                ${q.options.map((opt, idx) => `
                    <div class="quiz-option" onclick="selectOption(${idx})" data-option="${idx}">
                        ${opt}
                    </div>
                `).join('')}
            </div>
        </div>
        ${currentQuestionIndex < assessmentQuestions.length - 1 
            ? '<button id="nextQuestionBtn" onclick="nextQuestion()" style="background:var(--primary-blue); color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">Next Question</button>'
            : '<button id="submitAssessmentBtn" onclick="submitAssessment()" style="background:#4CAF50; color:white; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold;">Submit Assessment</button>'}
    `;
}

function selectOption(optionIndex) {
    document.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector(`[data-option="${optionIndex}"]`).classList.add('selected');
    userAnswers[currentQuestionIndex] = String.fromCharCode(65 + optionIndex); // A, B, C, D
}

function nextQuestion() {
    if (!userAnswers[currentQuestionIndex]) {
        alert('Please select an answer before proceeding.');
        return;
    }
    currentQuestionIndex++;
    displayQuestion();
}

async function submitAssessment() {
    if (!userAnswers[currentQuestionIndex]) {
        alert('Please select an answer before submitting.');
        return;
    }

    const score = calculateScore();
    
    if (currentAssessmentType === 'initial') {
        // Store initial assessment score
        localStorage.setItem('initialAssessmentScore', `${score}/${assessmentQuestions.length}`);
        await showInitialResults(score);
    } else {
        await showVideoAssessmentResults(score);
    }
}

function calculateScore() {
    let correct = 0;
    assessmentQuestions.forEach((q, idx) => {
        if (userAnswers[idx] === q.correctAnswer) correct++;
    });
    return correct;
}

async function showInitialResults(score) {
    document.getElementById('assessmentQuizContainer').style.display = 'none';
    
    const scoreOutOf10 = (score / assessmentQuestions.length * 10).toFixed(1);
    let level = '';
    const scoreNum = Number(scoreOutOf10);
    // 0‚Äì5 Beginner, 6‚Äì8 Intermediate, 9‚Äì10 Advanced
    if (scoreNum <= 5) level = 'Beginner';
    else if (scoreNum <= 8) level = 'Intermediate';
    else level = 'Advanced';

    // Persist the results
    localStorage.setItem('initialAssessmentScore', scoreOutOf10);
    localStorage.setItem('userLevel', level);

    const resultsDiv = document.getElementById('assessmentResults');
    resultsDiv.style.display = 'block';
    document.getElementById('scoreDisplay').textContent = `${scoreOutOf10}/10`;
    document.getElementById('levelDisplay').innerHTML = `Level: <span style="color:var(--primary-blue);">${level}</span>`;

    // Show answer review (selected vs correct)
    setAssessmentAnswersReview(assessmentQuestions, userAnswers, {
        title: 'Answer Review (Gateway Assessment)'
    });

    // Refresh the top status UI
    updateInitialAssessmentStatus();

    // Get video suggestion from Gemini
    await getVideoSuggestion(level, scoreOutOf10);
}

async function getVideoSuggestion(level, score) {
    const container = document.getElementById('videoSuggestionContainer');
    container.innerHTML = '<p style="color:var(--text-secondary);">üîç Searching YouTube for verified courses...</p>';

    console.log('Getting video suggestion for level:', level);

    async function checkYouTubeVideo(videoId) {
        try {
            const resp = await fetch(`/api/youtube/check?videoId=${encodeURIComponent(videoId)}`);
            if (!resp.ok) return { ok: false, reason: `HTTP ${resp.status}` };
            return await resp.json();
        } catch (e) {
            return { ok: false, reason: e && e.message ? e.message : 'Network error' };
        }
    }

    // Guaranteed fallback list (known public tutorials). This ensures employees always get a course.
    const FALLBACK_VIDEOS = {
        Beginner: [
            { videoId: 'PkZNo7MFNFg', topic: 'JavaScript Full Course (Beginner) - freeCodeCamp.org' },
            { videoId: 'pQN-pnXPaVg', topic: 'Python for Beginners - freeCodeCamp.org' },
            { videoId: 'kUMe1FH4CHE', topic: 'HTML Full Course - Build a Website Tutorial - freeCodeCamp.org' },
        ],
        Intermediate: [
            { videoId: 'Ke90Tje7VS0', topic: 'React JS Crash Course - Traversy Media' },
            { videoId: 'Oe421EPjeBE', topic: 'Node.js Crash Course - Traversy Media' },
            { videoId: '8mAITcNt710', topic: 'Complete Python Course (Intermediate) - freeCodeCamp.org' },
        ],
        Advanced: [
            { videoId: 'i_LwzRVP7bg', topic: 'Advanced JavaScript Concepts - freeCodeCamp.org' },
            { videoId: 'aircAruvnKk', topic: 'Neural Networks / Deep Learning - 3Blue1Brown' },
            { videoId: 'Z_ikDlimN6A', topic: 'System Design Interview Concepts - freeCodeCamp.org' },
        ]
    };

    // Directly fetch from YouTube using AI with Google Search grounding
    function buildPrompt(extraConstraints = '') {
        return `Use Google Search to find ONE REAL, PUBLICLY AVAILABLE, EMBEDDABLE YouTube tutorial video for a ${level} level learner.

CRITICAL REQUIREMENTS:
1. Video MUST be from verified educational channels: freeCodeCamp, Traversy Media, Programming with Mosh, Academind, The Net Ninja, Web Dev Simplified, or Fireship
2. Video MUST be PUBLIC and EMBEDDABLE (playable in YouTube embed iframe; not private, unlisted, age-restricted, region-blocked, or embed-disabled)
3. Video MUST be a FULL TUTORIAL (not a trailer, promo, or unavailable video)
4. Verify the video ID is correct - test URL: https://www.youtube.com/watch?v={videoId}
5. Extract ONLY the 11-character YouTube video ID (e.g., "dQw4w9WgXcQ")
6. Video should be for ${level === 'Beginner' ? 'beginners with no prior experience' : level === 'Intermediate' ? 'intermediate learners with basic knowledge' : 'advanced developers'}
7. Topics: Web Development (HTML/CSS/JavaScript/React), Python, AI/ML, or general programming

${extraConstraints}

Return ONLY valid JSON (no markdown):
{
  "videoId": "11_CHAR_VIDEO_ID",
  "topic": "Exact video title from YouTube",
  "definition": "What students will learn (2-3 sentences)",
  "uses": "Real-world applications and skills gained"
}

DO NOT return videos that show gray thumbnails or have embedding disabled.`;
    }

    try {
        let lastReject = '';
        let selected = null;

        for (let attempt = 1; attempt <= 3; attempt++) {
            container.innerHTML = `<p style="color:var(--text-secondary);">üîç Searching YouTube for verified courses... (attempt ${attempt}/3)</p>`;

            const extra = lastReject
                ? `IMPORTANT: The previous candidate was rejected because: ${lastReject}. Pick a DIFFERENT video that is playable in embed.`
                : `IMPORTANT: Prefer long-form tutorials (20+ minutes) from the listed channels.`;

            const data = await callGeminiAPI(buildPrompt(extra), 'gemini-2.5-flash');
            if (data.error) throw new Error(data.error.message);

            let textResponse = data.candidates[0].content.parts[0].text;
            let cleanJson = textResponse.replace(/```json|```/g, "").trim();
            const jsonMatch = cleanJson.match(/\{[\s\S]*\}/);
            if (jsonMatch) cleanJson = jsonMatch[0];

            const videoData = JSON.parse(cleanJson);
            console.log('AI suggested course:', videoData);

            if (!videoData.videoId || !videoData.topic) {
                lastReject = 'missing videoId/topic';
                continue;
            }
            if (String(videoData.videoId).length !== 11) {
                lastReject = `invalid videoId format (${videoData.videoId})`;
                continue;
            }

            const check = await checkYouTubeVideo(videoData.videoId);
            if (!check.ok) {
                lastReject = check.reason || check.status || 'video unavailable/unembeddable';
                continue;
            }

            // Use verified title from check if available
            if (check.title && !videoData.topic) videoData.topic = check.title;
            selected = videoData;
            break;
        }

        if (!selected) {
            // Fallback to curated list and validate; if validation fails, still assign the first fallback.
            const candidates = FALLBACK_VIDEOS[level] || FALLBACK_VIDEOS.Beginner;
            for (const c of candidates) {
                const check = await checkYouTubeVideo(c.videoId);
                if (check && check.ok) {
                    selected = {
                        videoId: c.videoId,
                        topic: check.title || c.topic,
                        definition: 'A curated tutorial selected as a reliable fallback when search results are unavailable.',
                        uses: 'Build core practical skills with a long-form training video.'
                    };
                    break;
                }
            }

            if (!selected && candidates.length > 0) {
                // Absolute last resort: assign first fallback without validation.
                selected = {
                    videoId: candidates[0].videoId,
                    topic: candidates[0].topic,
                    definition: 'A curated tutorial selected as a reliable fallback when validation is unavailable.',
                    uses: 'Build core practical skills with a long-form training video.'
                };
            }
        }

        if (!selected) {
            throw new Error('Unable to assign a course at this time.');
        }

        assignCourseToUser(selected, level);
        container.innerHTML = `
            <div style="background:rgba(76,175,80,0.1); padding:15px; border-radius:8px; border:1px solid #4CAF50;">
                <p style="color:#4CAF50; font-weight:bold; margin-bottom:10px;">‚úì YouTube Course Assigned!</p>
                <p style="color:var(--text-main);">The course <strong>${selected.topic}</strong> has been assigned.</p>
                <p style="color:var(--text-secondary); font-size:12px; margin-top:8px;">üìå Scroll down to "My Assigned Courses" section to start learning</p>
            </div>
        `;
    } catch (error) {
        console.error('Error fetching YouTube course:', error);
        container.innerHTML = `
            <div style="background:rgba(248,81,73,0.1); padding:15px; border-radius:8px; border:1px solid #f85149;">
                <p style="color:#f85149; font-weight:bold; margin-bottom:10px;">‚ö†Ô∏è Error Fetching Course</p>
                <p style="color:var(--text-main); font-size:13px;">${error.message}</p>
                <p style="color:var(--text-secondary); font-size:12px; margin-top:8px;">Please try the "Reset All" button and attempt the assessment again, or add a ${level} level course manually in Course Management.</p>
            </div>
        `;
    }
}

function assignCourseToUser(videoData, level) {
    console.log('Assigning course:', videoData);
    const assignedCourses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    const newCourse = {
        id: Date.now(),
        videoId: videoData.videoId,
        topic: videoData.topic,
        definition: videoData.definition,
        uses: videoData.uses,
        level: level,
        assignedDate: new Date().toLocaleDateString(),
        completed: false,
        passed: false
    };
    assignedCourses.push(newCourse);
    localStorage.setItem('assignedCourses', JSON.stringify(assignedCourses));
    console.log('Course assigned successfully. Total courses:', assignedCourses.length);
    
    // Reload the courses display
    loadAssignedCourses();
    
    // Scroll to the assigned courses section after a brief delay
    setTimeout(() => {
        const assignedSection = document.getElementById('assignedCoursesSection');
        if (assignedSection) {
            assignedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }, 500);
}

function updateInitialAssessmentStatus() {
    const initialScore = localStorage.getItem('initialAssessmentScore');
    const userLevel = localStorage.getItem('userLevel');
    const statusDiv = document.getElementById('initialAssessmentStatus');
    const startBtn = document.getElementById('startAssessmentBtn');
    const container = document.getElementById('initialAssessmentContainer');
    
    if (!statusDiv || !startBtn) return;
    
    if (initialScore) {
        // Hide the start button and instructions
        startBtn.style.display = 'none';
        container.querySelector('p').style.display = 'none';
        
        // Show the persistent result card
        statusDiv.innerHTML = `
            <div style="padding:25px; background:rgba(66, 133, 244, 0.1); border:2px solid var(--primary-blue); border-radius:12px; max-width:500px; margin: 0 auto;">
                <h3 style="color:var(--primary-blue); margin-top:0;">Your Gateway Results</h3>
                <div style="font-size:36px; font-weight:bold; color:var(--text-main); margin:15px 0;">${initialScore}/10</div>
                <div style="font-size:18px; margin-bottom:10px;">Assigned Level: <span style="color:var(--primary-blue); font-weight:800;">${userLevel}</span></div>
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:0;">Assessment locked. Courses below are tailored to this result.</p>
            </div>
        `;
    } else {
        startBtn.style.display = 'block';
        container.querySelector('p').style.display = 'block';
        statusDiv.innerHTML = '';
    }
}

async function loadAssignedCourses() {
    const courses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    const upcomingCourse = JSON.parse(localStorage.getItem('upcomingCourse') || 'null');
    const assignedGrid = document.getElementById('assignedCoursesGrid');
    const passedGrid = document.getElementById('passedCoursesGrid');
    
    // Update initial assessment button status
    updateInitialAssessmentStatus();
    
    if (!assignedGrid || !passedGrid) return;

    // Pull watch completion from the shared progress store
    const progressMap = await getAllProgressMap();

    const activeCourses = courses.filter(c => !c.passed);
    const passedCourses = courses.filter(c => c.passed);

    // Render active courses with locking logic
    if (activeCourses.length === 0) {
        assignedGrid.innerHTML = '<p style="color:var(--text-secondary); grid-column:1/-1; text-align:center;">No active courses. Complete an assessment to get personalized recommendations!</p>';
    } else {
        let activeCoursesHTML = activeCourses.map((course, index) => {
            // Only the first active course is unlocked
            const isLocked = index > 0;
            const previousCourse = index > 0 ? activeCourses[index - 1] : null;

            const vid = String(course?.videoId || '').trim();
            const p = vid ? (progressMap[vid] || {}) : {};
            const watched = p?.watch?.completed === true;
            
            return `
            <div class="assigned-course-card" style="${isLocked ? 'opacity: 0.5; position: relative;' : ''}">
                ${isLocked ? '<div style="position:absolute; top:10px; right:10px; background:#f85149; color:white; padding:5px 10px; border-radius:6px; font-size:11px; font-weight:bold;">üîí Locked</div>' : ''}
                <div class="course-thumbnail-wrapper">
                    <img src="https://img.youtube.com/vi/${course.videoId}/mqdefault.jpg" alt="${course.topic}" ${!isLocked ? `onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")'` : ''} style="max-width: 50%; margin: 0 auto; display: block; ${!isLocked ? 'cursor: pointer;' : ''} border-radius: 8px;">
                </div>
                <h4 style="color:var(--primary-blue); margin:10px 0;">${course.topic}</h4>
                <p style="color:var(--text-secondary); font-size:12px; margin-bottom:10px;">Level: ${course.level} | Assigned: ${course.assignedDate}</p>
                
                <div class="course-definition">
                    <strong style="color:var(--primary-blue);">Definition:</strong> ${course.definition}
                </div>
                
                <div class="course-uses">
                    <strong style="color:#4CAF50;">Uses:</strong> ${course.uses}
                </div>
                
                ${isLocked 
                    ? `<div style="margin-top:15px; padding:10px; background:rgba(248,81,73,0.1); border:1px solid #f85149; border-radius:6px; text-align:center; color:#f85149; font-size:12px;">üîí Complete "${previousCourse.topic}" assessment first</div>`
                    : course.attemptedDate 
                        ? `<button onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")' style="width:100%; margin-top:15px; background:var(--primary-blue); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">‚ñ∂ Start Training</button>
                           <div style="width:100%; margin-top:10px; padding:12px; background:rgba(76,175,80,0.1); border:1px solid #4CAF50; border-radius:6px; text-align:center;">
                               <div style="color:#4CAF50; font-weight:bold; margin-bottom:5px;">‚úì Already Attempted</div>
                               <div style="color:var(--text-main); font-size:14px;">Score: ${course.lastScore}% (${course.attemptCount} attempt${course.attemptCount > 1 ? 's' : ''})</div>
                               <div style="color:var(--text-secondary); font-size:12px; margin-top:3px;">Last: ${course.attemptedDate}</div>
                               ${course.lastScore < 80 ? `<button onclick="startVideoAssessment(${course.id})" style="width:100%; margin-top:8px; background:#f0ad4e; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:12px;">Retake Assessment</button>` : ''}
                           </div>`
                                : `<button onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")' style="width:100%; margin-top:15px; background:var(--primary-blue); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">‚ñ∂ Start Training</button>
                                    ${watched
                                          ? `<button onclick="startVideoAssessment(${course.id})" style="width:100%; margin-top:10px; background:#4CAF50; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">Attend Assessment</button>`
                                          : `<button disabled style="width:100%; margin-top:10px; background:#161b22; color:#484f58; border:1px solid #30363d; padding:10px; border-radius:6px; cursor:not-allowed; font-weight:bold;">Attend Assessment</button>
                                              <div style="margin-top:8px; padding:10px; background:rgba(248,81,73,0.08); border:1px solid #f85149; border-radius:6px; text-align:center; color:#f85149; font-size:12px;">Finish watching the full video to unlock the assessment.</div>`
                                    }`
                }
            </div>
        `;
        }).join('');

        // Add upcoming course preview if available
        if (upcomingCourse) {
            activeCoursesHTML += `
            <div class="assigned-course-card" style="opacity: 0.6; position: relative; border: 2px dashed var(--primary-blue);">
                <div style="position:absolute; top:10px; right:10px; background:var(--primary-blue); color:white; padding:5px 10px; border-radius:6px; font-size:11px; font-weight:bold;">‚≠ê Upcoming</div>
                <div class="course-thumbnail-wrapper">
                    <img src="https://img.youtube.com/vi/${upcomingCourse.videoId}/mqdefault.jpg" alt="${upcomingCourse.topic}" style="max-width: 50%; margin: 0 auto; display: block; border-radius: 8px; filter: grayscale(50%);">
                </div>
                <h4 style="color:var(--primary-blue); margin:10px 0;">${upcomingCourse.topic}</h4>
                <p style="color:var(--text-secondary); font-size:12px; margin-bottom:10px;">Level: ${upcomingCourse.level}</p>
                
                <div class="course-definition">
                    <strong style="color:var(--primary-blue);">Definition:</strong> ${upcomingCourse.definition}
                </div>
                
                <div class="course-uses">
                    <strong style="color:#4CAF50;">Uses:</strong> ${upcomingCourse.uses}
                </div>
                
                <div style="margin-top:15px; padding:10px; background:rgba(66,133,244,0.1); border:1px solid var(--primary-blue); border-radius:6px; text-align:center; color:var(--primary-blue); font-size:12px;">‚≠ê Available after completing current assessment</div>
            </div>
            `;
        }
        
        assignedGrid.innerHTML = activeCoursesHTML;
    }

    // Render passed courses
    if (passedCourses.length === 0) {
        passedGrid.innerHTML = '<p style="color:var(--text-secondary); grid-column:1/-1; text-align:center;">No passed courses yet. Complete assessments to unlock this section!</p>';
    } else {
        passedGrid.innerHTML = passedCourses.map(course => `
            <div class="assigned-course-card" style="border: 2px solid #4CAF50;">
                <div style="position:absolute; top:10px; right:10px; background:#4CAF50; color:white; padding:5px 10px; border-radius:6px; font-size:11px; font-weight:bold;">‚úì Passed</div>
                <div class="course-thumbnail-wrapper">
                    <img src="https://img.youtube.com/vi/${course.videoId}/mqdefault.jpg" alt="${course.topic}" onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")' style="max-width: 50%; margin: 0 auto; display: block; cursor: pointer; border-radius: 8px;">
                </div>
                <h4 style="color:#4CAF50; margin:10px 0;">${course.topic}</h4>
                <p style="color:var(--text-secondary); font-size:12px; margin-bottom:10px;">Level: ${course.level} | Completed: ${course.assignedDate}</p>
                
                <div class="course-definition">
                    <strong style="color:var(--primary-blue);">Definition:</strong> ${course.definition}
                </div>
                
                <div class="course-uses">
                    <strong style="color:#4CAF50;">Uses:</strong> ${course.uses}
                </div>
                
                <button onclick='openCoursePlayer("${course.videoId}", "${course.topic.replace(/"/g, '&quot;')}")' style="width:100%; margin-top:15px; background:#4CAF50; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">‚ñ∂ Replay Course</button>
            </div>
        `).join('');
    }
}

function openCoursePlayerAndEnableAssessment(courseId, videoId, topic) {
    openCoursePlayer(videoId, topic);
}

function resetAllAssessments() {
    if (confirm('Are you sure you want to reset all progress? This will clear your score and assigned courses.')) {
        localStorage.removeItem('assignedCourses');
        localStorage.removeItem('initialAssessmentScore');
        localStorage.removeItem('userLevel');
        localStorage.removeItem('initialAssessmentStarted');
        localStorage.removeItem('upcomingCourse');
        
        document.getElementById('assessmentResults').style.display = 'none';
        document.getElementById('assessmentQuizContainer').style.display = 'none';
        document.getElementById('initialAssessmentContainer').style.display = 'block';
        const review = document.getElementById('answersReviewContainer');
        if (review) review.innerHTML = '';
        
        assessmentQuestions = [];
        currentQuestionIndex = 0;
        userAnswers = [];
        
        loadAssignedCourses();
        updateInitialAssessmentStatus();
        alert('Profile reset successfully.');
    }
}

async function startVideoAssessment(courseId) {
    const courses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    currentVideoAssessmentCourse = courses.find(c => c.id === courseId);
    
    if (!currentVideoAssessmentCourse) return;

    // Enforce watch-before-assessment
    const ok = await ensureWatchCompletedOrBlock(currentVideoAssessmentCourse.videoId);
    if (!ok) return;

    // Hide assigned courses, show quiz
    document.getElementById('initialAssessmentContainer').style.display = 'none';
    document.getElementById('assessmentResults').style.display = 'none';
    document.getElementById('assessmentQuizContainer').innerHTML = '<p style="text-align:center; color:var(--text-secondary);">Generating questions based on the video content...</p>';
    document.getElementById('assessmentQuizContainer').style.display = 'block';
    
    // Auto-scroll to quiz section
    setTimeout(() => {
        document.getElementById('assessmentQuizContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
    
    currentAssessmentType = 'video';
    await generateQuestions();
    displayQuestion();
}

async function showVideoAssessmentResults(score) {
    document.getElementById('assessmentQuizContainer').style.display = 'none';
    
    const scorePercentage = (score / assessmentQuestions.length * 100).toFixed(0);
    const passed = scorePercentage >= 80;
    const nowIso = new Date().toISOString();
    
    // Generate upcoming course suggestion immediately (before passing)
    const nextLevel = currentVideoAssessmentCourse.level === 'Beginner' ? 'Intermediate' : currentVideoAssessmentCourse.level === 'Intermediate' ? 'Advanced' : null;
    if (nextLevel) {
        suggestNextLevelCourse(nextLevel, currentVideoAssessmentCourse.level);
    }
    
    // Update course status with score and attempt date
    const courses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    const course = courses.find(c => c.id === currentVideoAssessmentCourse.id);
    if (course) {
        course.lastScore = scorePercentage;
        course.attemptedDate = new Date().toLocaleDateString();
        course.attemptCount = (course.attemptCount || 0) + 1;
        if (passed) {
            course.passed = true;
        }
        localStorage.setItem('assignedCourses', JSON.stringify(courses));
        
        // Move upcoming course to assigned courses if available (only if passed)
        if (passed) {
            const upcomingCourse = JSON.parse(localStorage.getItem('upcomingCourse') || 'null');
            if (upcomingCourse) {
                const assignedCourses = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
                const newCourse = {
                    id: Date.now(),
                    videoId: upcomingCourse.videoId,
                    topic: upcomingCourse.topic,
                    definition: upcomingCourse.definition,
                    uses: upcomingCourse.uses,
                    level: upcomingCourse.level,
                    assignedDate: new Date().toLocaleDateString(),
                    completed: false,
                    passed: false
                };
                assignedCourses.push(newCourse);
                localStorage.setItem('assignedCourses', JSON.stringify(assignedCourses));
                localStorage.removeItem('upcomingCourse');
            }
        }
        
        loadAssignedCourses();
    }

    // Persist into shared progress so Admin can view it (and for leaderboard)
    try {
        const vid = String(currentVideoAssessmentCourse.videoId || '').trim();
        if (vid) {
            const patch = {
                courseName: String(currentVideoAssessmentCourse.topic || 'Course'),
                courseType: normalizeCourseLevel(currentVideoAssessmentCourse.level || ''),
                lastActivityAt: nowIso,
                ...(passed ? { completedAt: nowIso } : {}),
                assessment: {
                    questionCount: assessmentQuestions.length,
                    correct: score,
                    percent: Number(scorePercentage),
                    passed,
                    lastAttemptedAt: nowIso,
                    attempts: Number((course && course.attemptCount) ? course.attemptCount : 1)
                }
            };
            await upsertCourseProgress(vid, patch);
            if (passed) await updateMyLeaderboardPoints();
        }
    } catch (e) {
        console.warn('Failed persisting Measure & Master progress:', e);
    }
    
    const resultsDiv = document.getElementById('assessmentResults');
    resultsDiv.style.display = 'block';
    document.getElementById('scoreDisplay').textContent = `${score}/${assessmentQuestions.length}`;
    document.getElementById('levelDisplay').innerHTML = `Score: <span style="color:${passed ? '#4CAF50' : '#f85149'};">${scorePercentage}%</span>`;
    document.getElementById('videoSuggestionContainer').innerHTML = `
        <div style="background:rgba(${passed ? '76,175,80' : '248,81,73'},0.1); padding:20px; border-radius:8px; border:1px solid ${passed ? '#4CAF50' : '#f85149'};">
            <h4 style="color:${passed ? '#4CAF50' : '#f85149'}; margin-bottom:10px;">${passed ? '‚úì Assessment Passed!' : '‚úó Assessment Not Passed'}</h4>
            <p style="color:var(--text-main);">You scored ${score} out of ${assessmentQuestions.length} (${scorePercentage}%) on the "${currentVideoAssessmentCourse.topic}" assessment.</p>
            <p style="color:var(--text-secondary); margin-top:10px;">${passed ? 'Congratulations! You have demonstrated strong understanding of this topic and have passed the course. Your next level course has been unlocked!' : 'You need at least 80% to pass this course. Please review the video again and retake the assessment.'}</p>
            <button onclick="resetAssessment()" style="margin-top:15px; background:var(--primary-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">Back to Courses</button>
        </div>
    `;

    // Show answer review (selected vs correct)
    setAssessmentAnswersReview(assessmentQuestions, userAnswers, {
        title: `Answer Review (${currentVideoAssessmentCourse?.topic || 'Course'})`
    });
}

function resetAssessment() {
    document.getElementById('assessmentResults').style.display = 'none';
    document.getElementById('assessmentQuizContainer').style.display = 'none';
    document.getElementById('initialAssessmentContainer').style.display = 'block';
    const review = document.getElementById('answersReviewContainer');
    if (review) review.innerHTML = '';
    assessmentQuestions = [];
    currentQuestionIndex = 0;
    userAnswers = [];
    currentAssessmentType = 'initial';
    currentVideoAssessmentCourse = null;
}

async function suggestNextLevelCourse(nextLevel, previousLevel) {
    const availableCourses = JSON.parse(localStorage.getItem('courses') || '[]');
    const nextLevelCourses = availableCourses.filter(c => c.type.toLowerCase() === nextLevel.toLowerCase());

    if (nextLevelCourses.length > 0) {
        const nextCourse = nextLevelCourses[0];
        localStorage.setItem('upcomingCourse', JSON.stringify({
            videoId: nextCourse.videoId,
            topic: nextCourse.name,
            definition: `Advance your skills with this ${nextLevel} library tutorial.`,
            uses: `Deep-dive into ${nextCourse.name}.`,
            level: nextLevel
        }));
        loadAssignedCourses();
    }
}

// Make ALL functions globally available for onclick handlers
window.openAddCourseModal = openAddCourseModal;
window.closeAddCourseModal = closeAddCourseModal;
window.saveNewCourse = saveNewCourse;
window.loadCourses = loadCourses;
window.loadRoles = loadRoles;
window.deleteSelectedRoles = deleteSelectedRoles;
window.openAddUserModal = openAddUserModal;
window.closeAddUserModal = closeAddUserModal;
window.saveNewUser = saveNewUser;
window.deleteUser = deleteUser;
window.toggleSelectAllRoles = toggleSelectAllRoles;
window.switchTab = switchTab;
window.logout = logout;
window.toggleSidebar = toggleSidebar;
window.forceRefreshNews = forceRefreshNews;
window.hubBotInsert = hubBotInsert;
window.resetAllAssessments = resetAllAssessments;
window.startInitialAssessment = startInitialAssessment;
window.nextQuestion = nextQuestion;
window.submitAssessment = submitAssessment;
window.loadCoursesView = loadCoursesView;
window.openCoursePlayer = openCoursePlayer;
window.handleRoleChange = handleRoleChange;
window.startVideoAssessment = startVideoAssessment;
window.resetAssessment = resetAssessment;
window.loadAssignedCourses = loadAssignedCourses;
window.updateInitialAssessmentStatus = updateInitialAssessmentStatus;

// My Progress + catalog assessments
window.loadMyProgress = loadMyProgress;
window.startCatalogAssessment = startCatalogAssessment;
window.startCatalogAssessmentFromPlayer = startCatalogAssessmentFromPlayer;
window.closeCourseAssessment = closeCourseAssessment;
window.courseAssessmentBackdropClick = courseAssessmentBackdropClick;
window.catalogAssessmentSelect = catalogAssessmentSelect;
window.catalogAssessmentNext = catalogAssessmentNext;
window.catalogAssessmentSubmit = catalogAssessmentSubmit;

// Leaderboard
window.loadLeaderboard = loadLeaderboard;
window.updateMyLeaderboardPoints = updateMyLeaderboardPoints;
window.loadRoles = loadRoles;
window.resetUserAssessment = resetUserAssessment;
window.toggleAllRoleChecks = toggleAllRoleChecks;

</script>

<script>
// ===== Hub Bot (Gemini) =====
const HUB_BOT_HISTORY_KEY = 'hubBotHistory'; // legacy
const HUB_BOT_SESSIONS_KEY = 'hubBotSessions';
const HUB_BOT_ACTIVE_SESSION_KEY = 'hubBotActiveSessionId';
const HUB_BOT_SYSTEM_PROMPT = `You are Hub Bot, an AI assistant for the OneOrigin Learning Hub.
Your duties:
- Answer questions about courses available in the hub accurately using the provided course list.
- If asked about broader technical topics beyond the hub, explain clearly with correct, safe, neutral information.
- Be concise, friendly, and practical. Prefer short paragraphs and bullet points when helpful.
- Never provide harmful, hateful, illegal, or unsafe content.`;

function loadHubBotSessions() {
    try {
        const raw = localStorage.getItem(HUB_BOT_SESSIONS_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
    } catch (_) {
        return [];
    }
}

function saveHubBotSessions(sessions) {
    localStorage.setItem(HUB_BOT_SESSIONS_KEY, JSON.stringify(sessions || []));
}

function getActiveHubBotSessionId() {
    return localStorage.getItem(HUB_BOT_ACTIVE_SESSION_KEY) || '';
}

function setActiveHubBotSessionId(id) {
    localStorage.setItem(HUB_BOT_ACTIVE_SESSION_KEY, String(id));
}

function makeChatTitleFromMessages(messages) {
    const firstUser = (messages || []).find(m => m && m.role === 'user' && String(m.content || '').trim());
    const text = firstUser ? String(firstUser.content).trim() : 'New chat';
    return text.length > 40 ? text.slice(0, 40) + '‚Ä¶' : text;
}

function ensureActiveHubBotSession() {
    let sessions = loadHubBotSessions();
    let activeId = getActiveHubBotSessionId();

    // One-time migration from legacy single-history storage
    if (sessions.length === 0) {
        try {
            const legacy = JSON.parse(localStorage.getItem(HUB_BOT_HISTORY_KEY) || '[]');
            if (Array.isArray(legacy) && legacy.length > 0) {
                const id = 'chat-' + Date.now();
                const session = {
                    id,
                    title: makeChatTitleFromMessages(legacy),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    messages: legacy,
                };
                sessions = [session];
                saveHubBotSessions(sessions);
                setActiveHubBotSessionId(id);
                localStorage.removeItem(HUB_BOT_HISTORY_KEY);
                activeId = id;
            }
        } catch (_) {}
    }

    const exists = activeId && sessions.some(s => s.id === activeId);
    if (!exists) {
        const id = 'chat-' + Date.now();
        const seed = [{ role: 'assistant', content: "Hi! I'm Hub Bot. Ask me about our courses or any tech concept." }];
        const session = {
            id,
            title: 'New chat',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            messages: seed,
        };
        sessions.unshift(session);
        saveHubBotSessions(sessions);
        setActiveHubBotSessionId(id);
        activeId = id;
    }
    return { sessions, activeId };
}

function getActiveHubBotMessages() {
    const { sessions, activeId } = ensureActiveHubBotSession();
    const session = sessions.find(s => s.id === activeId);
    return Array.isArray(session?.messages) ? session.messages : [];
}

function setActiveHubBotMessages(messages) {
    const { sessions, activeId } = ensureActiveHubBotSession();
    const idx = sessions.findIndex(s => s.id === activeId);
    if (idx === -1) return;
    const next = Array.isArray(messages) ? messages : [];
    sessions[idx] = {
        ...sessions[idx],
        messages: next,
        title: makeChatTitleFromMessages(next),
        updatedAt: new Date().toISOString(),
    };
    // keep most recent first
    sessions.sort((a, b) => String(b.updatedAt || '').localeCompare(String(a.updatedAt || '')));
    saveHubBotSessions(sessions);
}

function getCoursesContext() {
    const courses = JSON.parse(localStorage.getItem('courses') || '[]');
    const assigned = JSON.parse(localStorage.getItem('assignedCourses') || '[]');
    const lines = [];
    if (courses.length) {
        lines.push('Courses (Library):');
        courses.forEach(c => lines.push(`- ${c.name} [${c.type}] (id:${c.id}, videoId:${c.videoId})`));
    }
    if (assigned.length) {
        lines.push('Assigned Courses (My Learning):');
        assigned.forEach(a => lines.push(`- ${a.topic} [${a.level}] (videoId:${a.videoId}) ${a.passed ? '‚úì passed' : ''}`));
    }
    return lines.join('\n');
}

function initHubBot() {
    // Initialize session storage
    ensureActiveHubBotSession();
    // Render if containers exist
    renderHubBotMessages('hubBotMessages');
    renderHubBotMessages('hubBotPageMessages');
    renderHubBotHistoryList();

    // Attach Enter-to-send handlers
    try {
        const widgetInput = document.getElementById('hubBotInput');
        if (widgetInput && !widgetInput.__enterHooked) {
            widgetInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendHubBotMessage('widget');
                }
            });
            widgetInput.__enterHooked = true;
        }
        const pageInput = document.getElementById('hubBotPageInput');
        if (pageInput && !pageInput.__enterHooked) {
            pageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendHubBotMessage('page');
                }
            });
            pageInput.__enterHooked = true;
        }
    } catch (_) { /* no-op */ }
}

function toggleHubBotHistory() {
    const panel = document.getElementById('hubBotHistoryPanel');
    if (!panel) return;
    const shown = panel.style.display === 'block';
    panel.style.display = shown ? 'none' : 'block';
    if (!shown) renderHubBotHistoryList();
}

function renderHubBotHistoryList() {
    const list = document.getElementById('hubBotHistoryList');
    if (!list) return;
    const sessions = loadHubBotSessions();
    const activeId = getActiveHubBotSessionId();
    if (!sessions.length) {
        list.innerHTML = '<div style="color:var(--text-secondary); font-size:12px;">No chats yet.</div>';
        return;
    }
    list.innerHTML = sessions
        .sort((a, b) => String(b.updatedAt || '').localeCompare(String(a.updatedAt || '')))
        .map(s => {
            const isActive = s.id === activeId;
            const title = escapeHtml(s.title || 'New chat');
            const when = escapeHtml((s.updatedAt || '').replace('T', ' ').replace('Z', ''));
            return `
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px; border-radius:8px; border:1px solid var(--border-color); background:${isActive ? 'rgba(66,133,244,0.12)' : 'transparent'}; margin-bottom:8px;">
                    <div style="min-width:0;">
                        <div style="color:var(--text-main); font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title}</div>
                        <div style="color:var(--text-secondary); font-size:11px;">${when}</div>
                    </div>
                    <button class="ghost" onclick="openHubBotChat(${JSON.stringify(s.id)})">Open</button>
                </div>
            `;
        })
        .join('');
}

function openHubBotChat(sessionId) {
    const sessions = loadHubBotSessions();
    const target = sessions.find(s => s.id === sessionId);
    if (!target) return;
    setActiveHubBotSessionId(target.id);
    renderHubBotMessages('hubBotMessages');
    renderHubBotMessages('hubBotPageMessages');
    renderHubBotHistoryList();
}

function toggleHubBotWidget() {
    const panel = document.getElementById('hubBotWidget');
    if (!panel) return;
    const isShown = panel.style.display === 'block';
    panel.style.display = isShown ? 'none' : 'block';
    if (!isShown) initHubBot();
}

function minimizeHubBotWidget() {
    const panel = document.getElementById('hubBotWidget');
    if (!panel) return;
    panel.style.display = 'none';
    // Do not clear chat
}

function closeHubBotWidget() {
    const panel = document.getElementById('hubBotWidget');
    if (!panel) return;
    // Hide only (keep history like Gemini)
    panel.style.display = 'none';
}

function escapeHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function normalizeAnswerLetter(letter) {
    const s = String(letter || '').trim().toUpperCase();
    if (!s) return '';
    // Accept "A", "A)" or "A." etc.
    const m = s.match(/^[A-D]/);
    return m ? m[0] : '';
}

function optionTextByLetter(options, letter) {
    if (!Array.isArray(options)) return '';
    const l = normalizeAnswerLetter(letter);
    if (!l) return '';
    const idx = l.charCodeAt(0) - 65;
    if (idx >= 0 && idx < options.length) return String(options[idx] ?? '');
    // Fallback: try to find "A)" style prefix
    const found = options.find(o => String(o || '').trim().toUpperCase().startsWith(`${l})`));
    return found ? String(found) : '';
}

function renderAssessmentAnswersReviewHtml(questions, answers, opts = {}) {
    if (!Array.isArray(questions) || questions.length === 0) return '';
    const title = escapeHtml(opts.title || 'Answer Review');
    const maxHeight = opts.maxHeight || 360;

    const items = questions.map((q, idx) => {
        const qText = escapeHtml(q?.question || `Question ${idx + 1}`);
        const options = Array.isArray(q?.options) ? q.options : [];
        const selected = normalizeAnswerLetter(Array.isArray(answers) ? answers[idx] : '');
        const correct = normalizeAnswerLetter(q?.correctAnswer || '');
        const isCorrect = selected && correct && selected === correct;

        const selectedText = escapeHtml(optionTextByLetter(options, selected) || '');
        const correctText = escapeHtml(optionTextByLetter(options, correct) || '');

        const border = isCorrect ? '#4CAF50' : '#f85149';
        const bg = isCorrect ? 'rgba(76,175,80,0.06)' : 'rgba(248,81,73,0.06)';

        const yourLine = selected
            ? `<span style="color:${isCorrect ? '#4CAF50' : '#f85149'}; font-weight:800;">${escapeHtml(selected)}</span>${selectedText ? ` <span style="color:var(--text-secondary); font-weight:600;">‚Äî</span> <span style="color:var(--text-main);">${selectedText}</span>` : ''}`
            : `<span style="color:#f85149; font-weight:800;">Not answered</span>`;

        const correctLine = correct
            ? `<span style="color:#4CAF50; font-weight:900;">${escapeHtml(correct)}</span>${correctText ? ` <span style="color:var(--text-secondary); font-weight:600;">‚Äî</span> <span style="color:var(--text-main);">${correctText}</span>` : ''}`
            : `<span style="color:var(--text-secondary);">(Missing correct answer)</span>`;

        return `
            <div style="border:1px solid ${border}; background:${bg}; border-radius:12px; padding:12px; margin-top:10px;">
                <div style="color:var(--text-main); font-weight:900; margin-bottom:8px;">Q${idx + 1}. ${qText}</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; font-size:13px; margin-bottom:6px;">
                    <div style="min-width:240px;"><span style="color:var(--text-secondary);">Your answer:</span> ${yourLine}</div>
                    <div style="min-width:240px;"><span style="color:var(--text-secondary);">Correct:</span> ${correctLine}</div>
                </div>
            </div>
        `;
    }).join('');

    return `
        <details style="margin-top:14px;">
            <summary style="cursor:pointer; color:var(--primary-blue); font-weight:900;">${title}</summary>
            <div style="margin-top:10px; max-height:${Number(maxHeight)}px; overflow:auto; padding-right:4px;">
                ${items}
            </div>
        </details>
    `;
}

function setAssessmentAnswersReview(questions, answers, opts = {}) {
    const container = document.getElementById('answersReviewContainer');
    if (!container) return;
    container.innerHTML = renderAssessmentAnswersReviewHtml(questions, answers, opts);
}

function renderHubBotMessages(targetId) {
    const container = document.getElementById(targetId);
    if (!container) return;
    const history = getActiveHubBotMessages();
    container.innerHTML = history.map(msg => {
        const align = msg.role === 'assistant' ? 'flex-start' : 'flex-end';
        const bg = msg.role === 'assistant' ? 'rgba(66,133,244,0.12)' : 'rgba(76,175,80,0.12)';
        const border = msg.role === 'assistant' ? '1px solid var(--border-color)' : '1px solid #4CAF50';
        return `<div style="display:flex; justify-content:${align}; margin:6px 0;">
            <div style="max-width:90%; background:${bg}; border:${border}; color:var(--text-main); padding:10px; border-radius:10px; white-space:pre-wrap;">${escapeHtml(msg.content)}</div>
        </div>`;
    }).join('');
    container.scrollTop = container.scrollHeight;
}

async function sendHubBotMessage(source) {
    const inputId = source === 'page' ? 'hubBotPageInput' : 'hubBotInput';
    const messagesId = source === 'page' ? 'hubBotPageMessages' : 'hubBotMessages';
    const input = document.getElementById(inputId);
    if (!input) return;
    const question = (input.value || '').trim();
    if (!question) return;

    // Append user message
    const history = getActiveHubBotMessages();
    history.push({ role: 'user', content: question });
    setActiveHubBotMessages(history);
    renderHubBotMessages(messagesId);
    input.value = '';

    // Show thinking bubble
    const container = document.getElementById(messagesId);
    if (container) {
        container.innerHTML += `<div style="display:flex; justify-content:flex-start; margin:6px 0;"><div style="max-width:90%; background:rgba(66,133,244,0.08); border:1px solid var(--border-color); color:var(--text-secondary); padding:10px; border-radius:10px;">Thinking...</div></div>`;
        container.scrollTop = container.scrollHeight;
    }

    try {
        const context = getCoursesContext();

        // Include conversation history so follow-ups like "Can you teach me that" work.
        const allHistory = getActiveHubBotMessages();
        const recent = allHistory.slice(-20);
        const convo = recent.map(m => `${m.role === 'assistant' ? 'Assistant' : 'User'}: ${m.content}`).join('\n');

        const fullPrompt = `${HUB_BOT_SYSTEM_PROMPT}\n\nConversation so far (do NOT repeat this back; use it only as context):\n${convo}\n\nCourse data (only if needed):\n${context}\n\nAnswer ONLY the user's last message as Hub Bot (no "User:" / "Assistant:" labels).`;
        console.log('ü§ñ Hub Bot: Sending request to Gemini API...');
        const data = await callGeminiAPI(fullPrompt, 'gemini-2.5-flash');
        console.log('ü§ñ Hub Bot: Received response:', data);
        let answer = 'Sorry, I could not fetch an answer right now.';
        if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
            answer = data.candidates[0].content.parts.map(p => p.text || '').join('\n').trim();
        }
        // If the model echoes role labels, strip them.
        answer = answer.replace(/^\s*(User:|Assistant:)\s*/i, '');
        // Append assistant message
        const updated = getActiveHubBotMessages();
        updated.push({ role: 'assistant', content: answer });
        setActiveHubBotMessages(updated);
        renderHubBotMessages(messagesId);
    } catch (err) {
        console.error('‚ùå Hub Bot error:', err);
        const updated = getActiveHubBotMessages();
        updated.push({ role: 'assistant', content: `I ran into an issue: ${err.message || 'Unknown error'}. Please check the console for details.` });
        setActiveHubBotMessages(updated);
        renderHubBotMessages(messagesId);
    }
}

function clearHubBotChat() {
    if (!confirm('Clear the Hub Bot chat history?')) return;
    try {
        // Start a NEW chat session (keep old sessions in Chat history)
        const sessions = loadHubBotSessions();
        const id = 'chat-' + Date.now();
        const seed = [{ role: 'assistant', content: "Hi! I'm Hub Bot. Ask me about our courses or any tech concept." }];
        sessions.unshift({
            id,
            title: 'New chat',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            messages: seed,
        });
        saveHubBotSessions(sessions);
        setActiveHubBotSessionId(id);
        // Re-render both views
        renderHubBotMessages('hubBotMessages');
        renderHubBotMessages('hubBotPageMessages');
        renderHubBotHistoryList();
    } catch (e) {
        alert('Unable to clear chat: ' + (e && e.message ? e.message : 'unknown error'));
    }
}

// Initialize Hub Bot on load
window.addEventListener('load', () => {
    initHubBot();
});

// Expose history actions
window.toggleHubBotHistory = toggleHubBotHistory;
window.openHubBotChat = openHubBotChat;
</script>
</script>

</body>
</html>
